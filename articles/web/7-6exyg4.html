<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ru" lang="ru" dir="ltr">	
<!-- Mirrored from localhost/index.php/%D0%A1%D1%82%D0%B0%D0%B1%D0%B8%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F_FPS_%D0%B2_%D0%B8%D0%B3%D1%80%D0%B0%D1%85 by HTTrack Website Copier/3.x [XR&CO'2007], Sat, 10 Nov 2007 05:16:50 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8"><!-- /Added by HTTrack -->
<head>		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />				<meta name="keywords" content="Стабилизация FPS в играх,SBJoker" />
		<link rel="shortcut icon" href="http://blitzetcetera.org/favicon.ico" />
		<link rel="search" type="application/opensearchdescription+xml" href="http://blitzetcetera.org/opensearch_desc.php" title="Blitz Et Cetera (Русский)" />
		<title>Стабилизация FPS в играх — Blitz Et Cetera</title>		<style type="text/css" media="screen,projection">/*<![CDATA[*/ @import "bvih5rde.css?63"; /*]]>*/</style>		<link rel="stylesheet" type="text/css" media="print" href="gcxktlm6.css?63" />		<link rel="stylesheet" type="text/css" media="handheld" href="zumsslq_.css?63" />		<!--[if lt IE 5.5000]><style type="text/css">@import "/skins/OfflineNew/IE50Fixes.css?63";</style><![endif]-->		<!--[if IE 5.5000]><style type="text/css">@import "/skins/OfflineNew/IE55Fixes.css?63";</style><![endif]-->		<!--[if IE 6]><style type="text/css">@import "/skins/OfflineNew/IE60Fixes.css?63";</style><![endif]-->		<!--[if IE 7]><style type="text/css">@import "/skins/OfflineNew/IE70Fixes.css?63";</style><![endif]-->		<!--[if lt IE 7]><script type="text/javascript" src="/skins/common/IEFixes.js?63"></script>		<meta http-equiv="imagetoolbar" content="no" /><![endif]-->		<script type= "text/javascript">/*<![CDATA[*/
var skin = "OfflineNew";
var stylepath = "/skins";
var wgArticlePath = "/index.php/$1";
var wgScriptPath = "";
var wgServer = "http://blitzetcetera.org/";
var wgCanonicalNamespace = "";
var wgCanonicalSpecialPageName = false;
var wgNamespaceNumber = 0;
var wgPageName = "Стабилизация_FPS_в_играх";
var wgTitle = "Стабилизация FPS в играх";
var wgAction = "view";
var wgArticleId = "677";
var wgIsArticle = true;
var wgUserName = null;
var wgUserGroups = null;
var wgUserLanguage = "ru";
var wgContentLanguage = "ru";
var wgBreakFrames = false;
var wgCurRevisionId = "3558";
/*]]>*/</script>
		<script type="text/javascript" src="2nq-6cel.js?63"><!-- wikibits js --></script>		<script type="text/javascript" src="http://blitzetcetera.org/index.php?title=-&amp;action=raw&amp;gen=js"><!-- site js --></script>		<style type="text/css">/*<![CDATA[*/
@import "http://blitzetcetera.org/index.php?title=MediaWiki:Common.css&amp;usemsgcache=yes&amp;action=raw&amp;ctype=text/css&amp;smaxage=18000";
@import "http://blitzetcetera.org/index.php?title=MediaWiki:OfflineNew.css&amp;usemsgcache=yes&amp;action=raw&amp;ctype=text/css&amp;smaxage=18000";
@import "http://blitzetcetera.org/index.php?title=-&amp;action=raw&amp;gen=css&amp;maxage=18000";
/*]]>*/</style>		<!-- Head Scripts -->	</head><body  class="mediawiki ns-0 ltr page-Стабилизация_FPS_в_играх">	<div id="globalWrapper">	<div id="logocontainer">		<table align="center">		  <tr>				<td id="blitzetclogo">				</td>			</tr>		</table>	</div>	<div id="magbar">	Журнал о программированнии на языках Blitz3D, BlitzMax, BlitzPlus	</div>		<div id="column-content">	<div id="content">		<a name="top" id="top"></a>				<div id="bodyContent">		<table cellspacing=0 cellpadding=0 width=100%>			<tr>			  <td class="leftside">				</td>				<td class="sheetbody">					<h1 class="sheet">Стабилизация FPS в играх</h1>			<h3 id="siteSub">Материал из Blitz Et Cetera.</h3>			<div id="contentSub"></div>			<!-- start content -->			<p>В этой статье
мы с вами разберёмся, для чего нужна стабилизация в играх и нужна ли она
вообще. А так же какая стабилизация предпочтительнее, какие у неё есть минусы и
плюсы.
</p><p>Итак, для чего
же нужна стабилизация в играх? У всех компьютеров разные вычислительные
возможности, во всех компьютерах разная графическая подсистема, обладающая
разной производительностью, поэтому наивно полагать, что игра на них будет идти
с одинаковой скоростью и равномерно.
</p><p>Те из вас кто
пытался поиграть в старые игры для пентиум-1 и аналогичных наверняка
сталкивались с проблемой чрезмерной резвости этих игр на вашем ПК, это связанно
именно с тем, что в играх не было сделано элементарной стабилизации скорости
выполнения игры на разных ПК.
</p><p>А вот теперь
другой пример, вы наверняка запускали «тяжелую» игрушку на своём ПК и она у вас
заметно «тормозила» или весь игровой процесс напоминал сон из-за медлительных
действий на экране. (Автор сам прошел GTA-3 на достаточно слабом ПК для неё, а потом спустя пару лет
удивился тому, какой игра стала динамичной на новом ПК, оказывается, тогда я
играл в сильно замедленном режиме по причине опять таки отсутствующей
стабилизации).
</p><p>Если вы не хотите,
чтобы и ваша игра выкидывала такие вот фокусы, вам необходима стабилизация
скорости выполнения игры.
</p><p>Большой
популярностью в среде Blitz-разработчиков
игр пользуется следующий стабилизатор (код для BlitzMAX):
</p>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #ffff00; font-weight: bold;">Const</span> FPS:<span style="color: #ffff00; font-weight: bold;">Int</span>=<span style="color: #FFFFFF;">75</span> <br />
<p><span style="color: #ffff00; font-weight: bold;">Global</span> period:<span style="color: #ffff00; font-weight: bold;">Float</span>=<span style="color: #FFFFFF;">1000.0</span>/FPS,elapsed:<span style="color: #ffff00; font-weight: bold;">Int</span>,Ticks:<span style="color: #ffff00; font-weight: bold;">Int</span>,tween:<span style="color: #ffff00; font-weight: bold;">Float</span>, time:<span style="color: #ffff00; font-weight: bold;">Int</span><br />
<br />
<br />
time=<span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span>-period<br />
<span style="color: #ffff00; font-weight: bold;">Repeat</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Repeat</span> <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elapsed=<span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span>-time <br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Until</span> elapsed <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />
&nbsp; &nbsp; &nbsp; &nbsp; Ticks=elapsed/period<br />
&nbsp; &nbsp; &nbsp; &nbsp; tween=<span style="color: #ffff00; font-weight: bold;">Float</span><span style=" ">&#40;</span>elapsed <span style="color: #ffff00; font-weight: bold;">mod</span> period<span style=" ">&#41;</span>/<span style="color: #ffff00; font-weight: bold;">Float</span><span style=" ">&#40;</span>period<span style=" ">&#41;</span> <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> k=<span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">To</span> Ticks <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; time=time+period <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">'############# C A L C U L A T I N G ###############</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">'logic code</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span> <br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">'###################### D R A W I N G ######################</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">'graphics code</span><br />
</p>
<span style="color: #ffff00; font-weight: bold;">Forever</span></div>
<p>Многие
используют его не задумываясь, как он работает, а ведь часто это приводит к
непредсказуемым последствиям. Давайте разберемся, что здесь к чему.
</p><p><b>FPS</b> – это максимально число кадров в секунду в вашей игре,
стабилизатор не допустит превышение этого числа, что не даст вашей игре
работать слишком резво.
</p>
<ul><li><b>Period</b> – это
</li></ul>
<p><u>расчётное</u> время подготовки одного кадра в миллисекундах.
</p>
<ul><li><b>Elapsed</b> – это <u>фактически затраченное</u> время на
</li></ul>
<p>подготовку одного (прошлого) кадра в миллисекундах.
</p>
<ul><li><b>Ticks</b> – <u>необходимое</u> число расчётов логики чтобы темп
</li></ul>
<p>игры не отставал при низком fps
от запланированного.
</p>
<ul><li><b>Time</b> – <u>расчётное</u> время начала расчёта текущего кадра.
</li></ul>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;">time=<span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span>-period</div>
<p>Эта строка
инициализирует переменную time временем, когда должен был быть окончен расчёт предыдущего
кадра.
</p>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #ffff00; font-weight: bold;">Repeat</span><br />
<p>&nbsp; &nbsp; &nbsp; &nbsp; elapsed=<span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span>-time<br />
</p>
<span style="color: #ffff00; font-weight: bold;">Until</span> elapsed</div>
<p>Смысл этого
цикла в следующем, дождаться, когда затраченное время на расчёт кадра станет
больше ноля. Теоретически время, затраченное на кадр всегда больше ноля
миллисекунд, но на практике не все микропроцессоры обладают достаточной
дискретностью таймера и/или не позволяют получать точное время с точностью до
миллисекунды, поэтому иногда эта разница может быть и отрицательной. Вот для
предотвращения возможных с этим ошибок и создан этот цикл. Он выполняется
минимум 1 раз и вычисляет затраченное время на расчёт кадра, причём это время
минимум 1мс.
</p>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;">Ticks=elapsed/period<br />
tween=<span style="color: #ffff00; font-weight: bold;">Float</span><span style=" ">&#40;</span>elapsed <span style="color: #ffff00; font-weight: bold;">mod</span> period<span style=" ">&#41;</span>/<span style="color: #ffff00; font-weight: bold;">Float</span><span style=" ">&#40;</span>period<span style=" ">&#41;</span></div>
<p>Здесь в первой
строчке вычисляется отношение расчётного времени к
реально затраченному на расчет прошлого кадра, число округляется до меньшего
целого и это является коэффициентом ускорения всех движений в игре, чтобы
запаздывающая графика успевала за темпом игры. Во второй строчке считается
точный коэффициент для ускорения анимации.
</p>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #ffff00; font-weight: bold;">For</span> k=<span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">To</span> Ticks<br />
<p>&nbsp; &nbsp; &nbsp; &nbsp; time=time+period<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">'############# C A L C U L A T I N G ###############</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">'logic code</span><br />
</p>
<span style="color: #ffff00; font-weight: bold;">Next</span></div>
<p>В этом цикле,
который выполняется от 0 до Ticks раз, рассчитывается вся логика игры, именно внутри этого цикла нужно помещать AI, обновление положения игрока и юнитов и т.д.
</p><p>Внутри цикла строчка "time+period" выполняет очевидную функцию – вычисляет расчётное время
окончания этого кадра, естественно оно не совпадёт с фактическим, но именно это
позволит сгладить эффект округления числа повторов логики до целого, за счёт
постепенно нарастающей разницы между "time" и реальным временем.
</p>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #B1E7EB;">'###################### D R A W I N G ######################</span><br />
<p><span style="color: #B1E7EB;">'graphics code</span><br />
</p>
<span style="color: #ffff00; font-weight: bold;">Forever</span></div>
<p>В этом,
последнем куске кода размещается сам графический вывод изображения, т.е.
очистка экрана, рендер мира и отображение заднего
буфера. Так же здесь же располагаются команды вывода 2д графики и текста, однако
нужно не забывать использовать их только после RenderWorld() (если
используется 3Dграфика).
</p><p>Плюсы данного стабилизатора:
</p>
<ul><li>Честно выполняет свою роль, т.е. не даст вашей
</li></ul>
<p>игре разогнаться больше допустимого, а так же скомпенсирует fps ступенчатостью
движений.
</p>
<ul><li>Простота использования
</li></ul>
<p>Минусы
</p>
<ul><li>При текущем fps выше
</li></ul>
<p>расчётного, число проходов логики равно нулю, что делает бесполезным следующий
проход графики (т.к. на экране ничего не изменится).
</p>
<ul><li>Стабилизация является неравномерной (т.е. не
</li></ul>
<p>строго пропорционально замедлению графики), т.к. Ticks – целое число, из чего следует,
что fps должен упасть в 2 раза, чтобы Ticks изменилось,
и проходов логики стало 2 вместо 1. Поэтому происходит чередование кадров с удвоенным проходом логики и с обычным
проходом логики. В результате на низких fps возможно
неравномерное подёргивание движущихся объектов.
</p><p>Советы
</p>
<ul><li>Пороговый fps лучше
</li></ul>
<p>устанавливать как можно выше, это приведёт к более плавным движениям, т.о.
минимальное значение порогового fps должно быть не менее 75, а лучше его брать равным 1,5
желаемого fps в игре.
</p><p>Целесообразность применения такой
стабилизации становится под сомнение в свете следующих фактов:
</p>
<ul><li>При экстремально низких пиковых реальных fps, отношение его к пороговому максимальному fps может достигать десятков. В результате на слабом ПК (по видео
</li></ul>
<p>части) возникает противоречие, ЦП должен отработать десятки повторов логики
чтобы сгладить запаздывание графики, что в свою очередь не оставит времени на
расчёт графики и ещё усугубит ситуацию, ввергнув игр в пучину тормозов и лагов,
это замкнутый круг.
</p>
<ul><li>С другой стороны при реальном fps выше
</li></ul>
<p>порогового, стабилизатор не даст логике игры выполняться, пропуская для части
кадров расчёт логики вообще. Но при этом выполнит графическую часть, что абсолютно
бесполезно т.к. на экране ничего не изменится. Т.е. при превышении порогового fps начинается
пустая трата процессорного времени и времени видеокарты на расчёт идентичных
предыдущим кадров, в то время когда можно было бы дать им отдохнуть, тем более
что работу под 100% нагрузкой долго не выдерживают особенно бюджетные
видеокарты и ЦП.
</p><p>Подводя итог этих фактов, следует
признать большую полезность простого ограничителя кадров на базе ждущего
таймера, т.к. он ограничивает fps и при превышении порогового fps даёт отдых
как ЦП, так и видеокарте. Так же из-за отсутствия повторителя логики он
позволяет игре выполняться чуть быстрее на слабых ПК по отношению к выше
приведённому стабилизатору. Однако минусом его является снижение игрового темпа
пропорционально падению fps.
</p><p>Как компромисс возможно
использование комбинированного стабилизатора, в котором при превышении
порогового fps направляет ход выполнения программы на ждущий таймер, и
разгружаем процессор, а при недостатке fps стабилизируем путём увеличения числа
проходов логики. И ввести ограничение на число повторов логики, например до 5,
и при превышении числа повторов логики сверх лимита не просчитывать пусть игра
начнёт снижать темп. Это лучше чем лаги на высокой скорости.
</p><p>Для аркадных же игр
нетребовательным к вычислительной мощи ПК лучше обойтись ограничением fps на
базе ждущего таймера настроенного на частоту около 50-60Гц.
</p>
<div align="right"><a href="http://blitzetcetera.org/images/6/6a/Stabilizator.bmx" class="internal" title="Stabilizator.bmx">скачать исходный код</a></div>
<hr />
<p>Автор: <a href="http://blitzetcetera.org/index.php/%D0%A3%D1%87%D0%B0%D1%81%D1%82%D0%BD%D0%B8%D0%BA:SBJoker" title="Участник:SBJoker">Жеронкин (SBJoker) Станислав</a> (admin@polynetix.com)
</p>
<!-- Saved in parser cache with key db1:pcache:idhash:677-0!1!0!!ru!2 and timestamp 20071110040917 -->
<div class="printfooter">
Получено с <a href="7-6exyg4.html">http://blitzetcetera.org/index.php/%D0%A1%D1%82%D0%B0%D0%B1%D0%B8%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F_FPS_%D0%B2_%D0%B8%D0%B3%D1%80%D0%B0%D1%85</a></div>
			<!-- end content -->			<div class="visualClear"></div>				</td>				<td class="rightside">				</td>			</tr>		</table>		</div>	</div>		</div>	
		<script type="text/javascript">if (window.runOnloadHook) runOnloadHook();</script>
</div></body>
<!-- Mirrored from localhost/index.php/%D0%A1%D1%82%D0%B0%D0%B1%D0%B8%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F_FPS_%D0%B2_%D0%B8%D0%B3%D1%80%D0%B0%D1%85 by HTTrack Website Copier/3.x [XR&CO'2007], Sat, 10 Nov 2007 05:16:50 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8"><!-- /Added by HTTrack -->
</html>