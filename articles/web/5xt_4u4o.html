<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ru" lang="ru" dir="ltr">	
<!-- Mirrored from localhost/index.php/%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B_%D1%88%D0%B8%D1%84%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F_%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2_%D1%81_%D1%80%D0%B0%D1%81%D0%BF%D0%B0%D0%BA%D0%BE%D0%B2%D0%BA%D0%BE%D0%B9_%D0%B2_%D0%BF%D0%B0%D0%BC%D1%8F%D1%82%D1%8C by HTTrack Website Copier/3.x [XR&CO'2007], Sat, 10 Nov 2007 05:16:49 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8"><!-- /Added by HTTrack -->
<head>		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />				<meta name="keywords" content="Создание системы шифрования файлов с распаковкой в память" />
		<link rel="shortcut icon" href="http://blitzetcetera.org/favicon.ico" />
		<link rel="search" type="application/opensearchdescription+xml" href="http://blitzetcetera.org/opensearch_desc.php" title="Blitz Et Cetera (Русский)" />
		<title>Создание системы шифрования файлов с распаковкой в память — Blitz Et Cetera</title>		<style type="text/css" media="screen,projection">/*<![CDATA[*/ @import "bvih5rde.css?63"; /*]]>*/</style>		<link rel="stylesheet" type="text/css" media="print" href="gcxktlm6.css?63" />		<link rel="stylesheet" type="text/css" media="handheld" href="zumsslq_.css?63" />		<!--[if lt IE 5.5000]><style type="text/css">@import "/skins/OfflineNew/IE50Fixes.css?63";</style><![endif]-->		<!--[if IE 5.5000]><style type="text/css">@import "/skins/OfflineNew/IE55Fixes.css?63";</style><![endif]-->		<!--[if IE 6]><style type="text/css">@import "/skins/OfflineNew/IE60Fixes.css?63";</style><![endif]-->		<!--[if IE 7]><style type="text/css">@import "/skins/OfflineNew/IE70Fixes.css?63";</style><![endif]-->		<!--[if lt IE 7]><script type="text/javascript" src="/skins/common/IEFixes.js?63"></script>		<meta http-equiv="imagetoolbar" content="no" /><![endif]-->		<script type= "text/javascript">/*<![CDATA[*/
var skin = "OfflineNew";
var stylepath = "/skins";
var wgArticlePath = "/index.php/$1";
var wgScriptPath = "";
var wgServer = "http://blitzetcetera.org/";
var wgCanonicalNamespace = "";
var wgCanonicalSpecialPageName = false;
var wgNamespaceNumber = 0;
var wgPageName = "Создание_системы_шифрования_файлов_с_распаковкой_в_память";
var wgTitle = "Создание системы шифрования файлов с распаковкой в память";
var wgAction = "view";
var wgArticleId = "760";
var wgIsArticle = true;
var wgUserName = null;
var wgUserGroups = null;
var wgUserLanguage = "ru";
var wgContentLanguage = "ru";
var wgBreakFrames = false;
var wgCurRevisionId = "3477";
/*]]>*/</script>
		<script type="text/javascript" src="2nq-6cel.js?63"><!-- wikibits js --></script>		<script type="text/javascript" src="http://blitzetcetera.org/index.php?title=-&amp;action=raw&amp;gen=js"><!-- site js --></script>		<style type="text/css">/*<![CDATA[*/
@import "http://blitzetcetera.org/index.php?title=MediaWiki:Common.css&amp;usemsgcache=yes&amp;action=raw&amp;ctype=text/css&amp;smaxage=18000";
@import "http://blitzetcetera.org/index.php?title=MediaWiki:OfflineNew.css&amp;usemsgcache=yes&amp;action=raw&amp;ctype=text/css&amp;smaxage=18000";
@import "http://blitzetcetera.org/index.php?title=-&amp;action=raw&amp;gen=css&amp;maxage=18000";
/*]]>*/</style>		<!-- Head Scripts -->	</head><body  class="mediawiki ns-0 ltr page-Создание_системы_шифрования_файлов_с_распаковкой_в_память">	<div id="globalWrapper">	<div id="logocontainer">		<table align="center">		  <tr>				<td id="blitzetclogo">				</td>			</tr>		</table>	</div>	<div id="magbar">	Журнал о программированнии на языках Blitz3D, BlitzMax, BlitzPlus	</div>		<div id="column-content">	<div id="content">		<a name="top" id="top"></a>				<div id="bodyContent">		<table cellspacing=0 cellpadding=0 width=100%>			<tr>			  <td class="leftside">				</td>				<td class="sheetbody">					<h1 class="sheet">Создание системы шифрования файлов с распаковкой в память</h1>			<h3 id="siteSub">Материал из Blitz Et Cetera.</h3>			<div id="contentSub"></div>			<!-- start content -->			<table id="toc" class="toc" summary="Содержание"><tr><td><div id="toctitle"><h2>Содержание</h2></div>
<ul>
<li class="toclevel-1"><a href="#.D0.9D.D0.B5.D0.BC.D0.BD.D0.BE.D0.B3.D0.BE_.D1.82.D0.B5.D0.BE.D1.80.D0.B8.D0.B8"><span class="tocnumber">1</span> <span class="toctext">Немного теории</span></a></li>
<li class="toclevel-1"><a href="#.D0.91.D0.BE.D0.BB.D1.8C.D1.88.D0.B5_.D0.BF.D1.80.D0.B0.D0.BA.D1.82.D0.B8.D0.BA.D0.B8"><span class="tocnumber">2</span> <span class="toctext">Больше практики</span></a></li>
<li class="toclevel-1"><a href="#.D0.A8.D0.B8.D1.84.D1.80.D0.BE.D0.B2.D0.B0.D0.BD.D0.B8.D0.B5_.D0.BF.D0.BE.D1.82.D0.BE.D0.BA.D0.B0"><span class="tocnumber">3</span> <span class="toctext">Шифрование потока</span></a></li>
<li class="toclevel-1"><a href="#.D0.94.D0.B5.D0.BA.D0.BE.D0.B4.D0.B8.D1.80.D0.BE.D0.B2.D0.B0.D0.BD.D0.B8.D0.B5_.D0.BF.D0.BE.D1.82.D0.BE.D0.BA.D0.B0"><span class="tocnumber">4</span> <span class="toctext">Декодирование потока</span></a></li>
<li class="toclevel-1"><a href="#.D0.A4.D1.83.D0.BD.D0.BA.D1.86.D0.B8.D0.B8_.D0.A0.D0.B0.D0.B1.D0.BE.D1.82.D1.8B_.D1.81_.D0.BF.D0.BE.D1.82.D0.BE.D0.BA.D0.B0.D0.BC.D0.B8"><span class="tocnumber">5</span> <span class="toctext">Функции Работы с потоками</span></a></li>
</ul>
</td></tr></table><script type="text/javascript"> if (window.showTocToggle) { var tocShowText = "показать"; var tocHideText = "убрать"; showTocToggle(); } </script>
<a name=".D0.9D.D0.B5.D0.BC.D0.BD.D0.BE.D0.B3.D0.BE_.D1.82.D0.B5.D0.BE.D1.80.D0.B8.D0.B8"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B_%D1%88%D0%B8%D1%84%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F_%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2_%D1%81_%D1%80%D0%B0%D1%81%D0%BF%D0%B0%D0%BA%D0%BE%D0%B2%D0%BA%D0%BE%D0%B9_%D0%B2_%D0%BF%D0%B0%D0%BC%D1%8F%D1%82%D1%8C&amp;action=edit&amp;section=1" title="Править секцию: Немного теории">править</a>]</span> <span class="mw-headline">Немного теории</span></h2>
<p>В общем, большинство любительских систем делает распаковку в tmp-файлы, потому что программа, которая использует такую систему, не может грузить ресурсы из памяти. Например Блиц3д: для того, чтобы заставить его грузить картинки из памяти, Maxus'у пришлось извратится и переопределять функции чтения файла. Такой метод не очень удобен при кроссплатформеных приложениях, но это уже выходит за рамки этой статьи.
</p><p>Итак, немного теории: в БлицМаксе это можно было сделать несколькими путями:
</p>
<ul><li>Переопределить функции чтения из файла, но это слишком сложно для нас, и много кропотливой работы
</li><li>Написать свой модуль-загрузчик (типа pngloader.mod) - не универсально, можно шифровать только файлы, которые грузит загрузчик
</li><li>Использовать возможность загрузки ресурсов из потоков - вот это мы и будем использовать
</li></ul>
<p>БлицМакс позволяет в функцию чтения файла вместо имени файла подавать поток ... И вообще, там подается url:Object, а Object'ом может быть что угодно, хоть имя файла, хоть веб-сайт. И, соответственно, наш поток тоже может туда подать. В общем, алгоритм такой&nbsp;:
</p>
<ul><li>Мы пишем функции кодировки / декодировки TStream
</li><li>Мы пишем простенькую функцию - враппер
</li><li>Потом делаем простенький пример как это использовать
</li></ul>
<a name=".D0.91.D0.BE.D0.BB.D1.8C.D1.88.D0.B5_.D0.BF.D1.80.D0.B0.D0.BA.D1.82.D0.B8.D0.BA.D0.B8"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B_%D1%88%D0%B8%D1%84%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F_%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2_%D1%81_%D1%80%D0%B0%D1%81%D0%BF%D0%B0%D0%BA%D0%BE%D0%B2%D0%BA%D0%BE%D0%B9_%D0%B2_%D0%BF%D0%B0%D0%BC%D1%8F%D1%82%D1%8C&amp;action=edit&amp;section=2" title="Править секцию: Больше практики">править</a>]</span> <span class="mw-headline">Больше практики</span></h2>
<p>Я не буду описывать сами алгоритмы шифрования, потому что их много и это совершенно другая тема. Остановимся на банальном:
</p>
<ul><li>Шифровка байта - это byte_code = byte + 10
</li><li>Расшифровка - это byte = byte_code - 10
</li></ul>
<p>Метод "шифрования" банален, но потом вы можете сделать и свои методы.
</p>
<a name=".D0.A8.D0.B8.D1.84.D1.80.D0.BE.D0.B2.D0.B0.D0.BD.D0.B8.D0.B5_.D0.BF.D0.BE.D1.82.D0.BE.D0.BA.D0.B0"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B_%D1%88%D0%B8%D1%84%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F_%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2_%D1%81_%D1%80%D0%B0%D1%81%D0%BF%D0%B0%D0%BA%D0%BE%D0%B2%D0%BA%D0%BE%D0%B9_%D0%B2_%D0%BF%D0%B0%D0%BC%D1%8F%D1%82%D1%8C&amp;action=edit&amp;section=3" title="Править секцию: Шифрование потока">править</a>]</span> <span class="mw-headline">Шифрование потока</span></h2>
<p>Так, начнем с функции шифрования потока. Напишем костяк функции&nbsp;:
</p>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #ffff00; font-weight: bold;">Function</span> CodeStream:<span style="color: #ffff00; font-weight: bold;">TStream</span><span style=" ">&#40;</span>in:<span style="color: #ffff00; font-weight: bold;">TStream</span><span style=" ">&#41;</span> <br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span></div>
<p>Теперь создадим поток, в который можно спокойно записывать и так же спокойно читать из него. Но как же его создать, если поток всегда к чему-то прикреплен? В БлицМаксе есть такая полезная штука как TBank, это, можно сказать, массив с неопределенным размером и работает он по принципу стека .. но это нам не важно. Нам важно что&nbsp;:
</p>
<ul><li>Принимает любой размер
</li><li>К нему можно прицепить поток
</li></ul>
<p>Создадим наш поток вывода:
</p>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #ffff00; font-weight: bold;">Local</span> bank:<span style="color: #ffff00; font-weight: bold;">TBank</span> = <span style="color: #ffff00; font-weight: bold;">New</span> <span style="color: #ffff00; font-weight: bold;">TBank</span> <br />
<span style="color: #ffff00; font-weight: bold;">Local</span> out_stream:<span style="color: #ffff00; font-weight: bold;">TStream</span> = <span style="color: #ffff00; font-weight: bold;">OpenStream</span><span style=" ">&#40;</span>bank<span style=" ">&#41;</span></div>
<p>Думаю, все банально ясно .. Так, идем дальше, для начала запишем какую-то фразу, пусть эта фраза будет заголовком для нашего Pak-Файла:
</p>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;">out_stream.<span style="color: #ffff00; font-weight: bold;">WriteString</span><span style=" ">&#40;</span><span style="color: #00FF66;">&quot;Start_Pak&quot;</span><span style=" ">&#41;</span></div>
<p>Потом при чтении мы будем сверяться с ней и выдавать ошибку, если заголовок не правилен. Дальше запишем размер данных для шифрования, это удобно и позволяет вычислить программерские ошибки если что:
</p>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;">out_stream.<span style="color: #ffff00; font-weight: bold;">WriteInt</span><span style=" ">&#40;</span>in.<span style="">Size</span><span style=" ">&#40;</span><span style=" ">&#41;</span><span style=" ">&#41;</span></div>
<p>Теперь перейдем к самому интересному - будем шифровать входящий поток:
</p>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #ffff00; font-weight: bold;">While</span> <span style="color: #ffff00; font-weight: bold;">Not</span> <span style="color: #ffff00; font-weight: bold;">Eof</span><span style=" ">&#40;</span>in<span style=" ">&#41;</span> <br />
<p>out_stream.<span style="color: #ffff00; font-weight: bold;">WriteByte</span><span style=" ">&#40;</span> in.<span style="color: #ffff00; font-weight: bold;">ReadByte</span><span style=" ">&#40;</span><span style=" ">&#41;</span> + <span style="color: #FFFFFF;">10</span> <span style=" ">&#41;</span><br />
</p>
<span style="color: #ffff00; font-weight: bold;">Wend</span></div>
<p>Все банально, просто и тормозно. Теперь запишем конец файла (чтобы потом при чтении сверяться):
</p>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;">out_stream.<span style="color: #ffff00; font-weight: bold;">WriteString</span><span style=" ">&#40;</span><span style="color: #00FF66;">&quot;End_Pak&quot;</span><span style=" ">&#41;</span></div>
<p>"Сбросим" на ноль потоки:
</p>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;">out_stream.<span style="">Seek</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span><span style=" ">&#41;</span><br />
in.<span style="">Seek</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span><span style=" ">&#41;</span></div>
<p>(это вообще важно, их же потом тоже будут использовать&nbsp;! ) и вернем поток из функции
</p>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #ffff00; font-weight: bold;">Return</span> out_stream</div>
<p>Вот и все, наша функция шифрования потока закончена&nbsp;!
</p>
<a name=".D0.94.D0.B5.D0.BA.D0.BE.D0.B4.D0.B8.D1.80.D0.BE.D0.B2.D0.B0.D0.BD.D0.B8.D0.B5_.D0.BF.D0.BE.D1.82.D0.BE.D0.BA.D0.B0"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B_%D1%88%D0%B8%D1%84%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F_%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2_%D1%81_%D1%80%D0%B0%D1%81%D0%BF%D0%B0%D0%BA%D0%BE%D0%B2%D0%BA%D0%BE%D0%B9_%D0%B2_%D0%BF%D0%B0%D0%BC%D1%8F%D1%82%D1%8C&amp;action=edit&amp;section=4" title="Править секцию: Декодирование потока">править</a>]</span> <span class="mw-headline">Декодирование потока</span></h2>
<p>Если вы прочитали прошлый раздел, то все для вас довольно просто. Теперь минимум объяснений и больше кода. Костяк функции:
</p>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #ffff00; font-weight: bold;">Function</span> DecodeStream:<span style="color: #ffff00; font-weight: bold;">TStream</span><span style=" ">&#40;</span>in:<span style="color: #ffff00; font-weight: bold;">TStream</span><span style=" ">&#41;</span><br />
<p>&nbsp; <span style="color: #ffff00; font-weight: bold;">Local</span> bank:<span style="color: #ffff00; font-weight: bold;">TBank</span> = <span style="color: #ffff00; font-weight: bold;">New</span> <span style="color: #ffff00; font-weight: bold;">TBank</span> <span style="color: #ffff00; font-weight: bold;">Local</span><br />
&nbsp; out_stream:<span style="color: #ffff00; font-weight: bold;">TStream</span> = <span style="color: #ffff00; font-weight: bold;">OpenStream</span><span style=" ">&#40;</span>bank<span style=" ">&#41;</span><br />
&nbsp; <span style="color: #B1E7EB;">'.... здесь будет наш последуйший код&nbsp;:)</span><br />
&nbsp; out_stream.<span style="">Seek</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span><span style=" ">&#41;</span><br />
&nbsp; in.<span style="">Seek</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span><span style=" ">&#41;</span><br />
&nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> out_stream<br />
</p>
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span></div>
<p>Теперь проверяем начальный заголовок и читаем, сколько данных записано:
</p>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #ffff00; font-weight: bold;">Local</span> Header$ = in.<span style="color: #ffff00; font-weight: bold;">ReadString</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">9</span><span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">If</span> Header &lt;&gt; <span style="color: #00FF66;">&quot;Start_Pak&quot;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #ffff00; font-weight: bold;">RuntimeError</span> <span style="color: #00FF66;">&quot;pak corrupt&quot;</span> <span style="color: #ffff00; font-weight: bold;">Local</span> DataSize% = in.<span style="color: #ffff00; font-weight: bold;">ReadInt</span><span style=" ">&#40;</span><span style=" ">&#41;</span></div>
<p>Если вам обломно считать, сколько букв в вашем заголовке, то пользуйтесь функциями ReadLine \ WriteLine для записи и чтения заголовка. Теперь дешифруем сами данные файла:
</p>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #ffff00; font-weight: bold;">For</span> <span style="color: #ffff00; font-weight: bold;">Local</span> dat% = <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">To</span> DataSize<br />
<p>&nbsp; out_stream.<span style="color: #ffff00; font-weight: bold;">WriteByte</span> <span style=" ">&#40;</span> in.<span style="color: #ffff00; font-weight: bold;">ReadByte</span><span style=" ">&#40;</span><span style=" ">&#41;</span> - <span style="color: #FFFFFF;">10</span> <span style=" ">&#41;</span><br />
</p>
<span style="color: #ffff00; font-weight: bold;">Next</span></div>
<p>Используем "1 to DataSize", потому что в БлицМаксе "for" доходит до последнего значения ... Далее сверяем фразу в конце файла, чтобы проверить, что мы не ошиблись:
</p>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #ffff00; font-weight: bold;">Local</span> EndHeader$ = in.<span style="color: #ffff00; font-weight: bold;">ReadString</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">7</span><span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">If</span> EndHeader &lt;&gt; <span style="color: #00FF66;">&quot;End_Pak&quot;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #ffff00; font-weight: bold;">RuntimeError</span> <span style="color: #00FF66;">&quot;pak data corrupt&quot;</span></div>
<p>Вот и все! Подведем итог: вот наши функции шифрования и дешифрования потока:
</p>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #ffff00; font-weight: bold;">Function</span> CodeStream:<span style="color: #ffff00; font-weight: bold;">TStream</span><span style=" ">&#40;</span>in:<span style="color: #ffff00; font-weight: bold;">TStream</span><span style=" ">&#41;</span><br />
<p>&nbsp; <span style="color: #ffff00; font-weight: bold;">Local</span> bank:<span style="color: #ffff00; font-weight: bold;">TBank</span> = <span style="color: #ffff00; font-weight: bold;">New</span> <span style="color: #ffff00; font-weight: bold;">TBank</span><br />
&nbsp; <span style="color: #ffff00; font-weight: bold;">Local</span> out_stream:<span style="color: #ffff00; font-weight: bold;">TStream</span> = <span style="color: #ffff00; font-weight: bold;">OpenStream</span><span style=" ">&#40;</span>bank<span style=" ">&#41;</span><br />
&nbsp; out_stream.<span style="color: #ffff00; font-weight: bold;">WriteString</span><span style=" ">&#40;</span><span style="color: #00FF66;">&quot;Start_Pak&quot;</span><span style=" ">&#41;</span><br />
&nbsp; out_stream.<span style="color: #ffff00; font-weight: bold;">WriteInt</span><span style=" ">&#40;</span>in.<span style="">Size</span><span style=" ">&#40;</span><span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; <span style="color: #ffff00; font-weight: bold;">While</span> <span style="color: #ffff00; font-weight: bold;">Not</span> <span style="color: #ffff00; font-weight: bold;">Eof</span><span style=" ">&#40;</span>in<span style=" ">&#41;</span><br />
&nbsp; &nbsp; out_stream.<span style="color: #ffff00; font-weight: bold;">WriteByte</span><span style=" ">&#40;</span> in.<span style="color: #ffff00; font-weight: bold;">ReadByte</span><span style=" ">&#40;</span><span style=" ">&#41;</span> + <span style="color: #FFFFFF;">10</span> <span style=" ">&#41;</span><br />
&nbsp; <span style="color: #ffff00; font-weight: bold;">Wend</span><br />
&nbsp; out_stream.<span style="color: #ffff00; font-weight: bold;">WriteString</span><span style=" ">&#40;</span><span style="color: #00FF66;">&quot;End_Pak&quot;</span><span style=" ">&#41;</span><br />
&nbsp; out_stream.<span style="">Seek</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span><span style=" ">&#41;</span><br />
&nbsp; in.<span style="">Seek</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span><span style=" ">&#41;</span><br />
&nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> out_stream<br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Function</span> DecodeStream:<span style="color: #ffff00; font-weight: bold;">TStream</span><span style=" ">&#40;</span>in:<span style="color: #ffff00; font-weight: bold;">TStream</span><span style=" ">&#41;</span><br />
&nbsp; <span style="color: #ffff00; font-weight: bold;">Local</span> bank:<span style="color: #ffff00; font-weight: bold;">TBank</span> = <span style="color: #ffff00; font-weight: bold;">New</span> <span style="color: #ffff00; font-weight: bold;">TBank</span><br />
&nbsp; <span style="color: #ffff00; font-weight: bold;">Local</span> out_stream:<span style="color: #ffff00; font-weight: bold;">TStream</span> = <span style="color: #ffff00; font-weight: bold;">OpenStream</span><span style=" ">&#40;</span>bank<span style=" ">&#41;</span><br />
&nbsp; <span style="color: #ffff00; font-weight: bold;">Local</span> Header$ = in.<span style="color: #ffff00; font-weight: bold;">ReadString</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">9</span><span style=" ">&#41;</span><br />
&nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> Header &lt;&gt; <span style="color: #00FF66;">&quot;Start_Pak&quot;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #ffff00; font-weight: bold;">RuntimeError</span> <span style="color: #00FF66;">&quot;pak corrupt&quot;</span><br />
&nbsp; <span style="color: #ffff00; font-weight: bold;">Local</span> DataSize% = in.<span style="color: #ffff00; font-weight: bold;">ReadInt</span><span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> <span style="color: #ffff00; font-weight: bold;">Local</span> dat% = <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">To</span> DataSize<br />
&nbsp; &nbsp; out_stream.<span style="color: #ffff00; font-weight: bold;">WriteByte</span> <span style=" ">&#40;</span> in.<span style="color: #ffff00; font-weight: bold;">ReadByte</span><span style=" ">&#40;</span><span style=" ">&#41;</span> - <span style="color: #FFFFFF;">10</span> <span style=" ">&#41;</span><br />
&nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; <span style="color: #ffff00; font-weight: bold;">Local</span> EndHeader$ = in.<span style="color: #ffff00; font-weight: bold;">ReadString</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">7</span><span style=" ">&#41;</span><br />
&nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> EndHeader &lt;&gt; <span style="color: #00FF66;">&quot;End_Pak&quot;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #ffff00; font-weight: bold;">RuntimeError</span> <span style="color: #00FF66;">&quot;pak data corrupt&quot;</span><br />
&nbsp; out_stream.<span style="">Seek</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span><span style=" ">&#41;</span><br />
&nbsp; in.<span style="">Seek</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span><span style=" ">&#41;</span><br />
&nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> out_stream<br />
</p>
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span></div>
<a name=".D0.A4.D1.83.D0.BD.D0.BA.D1.86.D0.B8.D0.B8_.D0.A0.D0.B0.D0.B1.D0.BE.D1.82.D1.8B_.D1.81_.D0.BF.D0.BE.D1.82.D0.BE.D0.BA.D0.B0.D0.BC.D0.B8"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B_%D1%88%D0%B8%D1%84%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F_%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2_%D1%81_%D1%80%D0%B0%D1%81%D0%BF%D0%B0%D0%BA%D0%BE%D0%B2%D0%BA%D0%BE%D0%B9_%D0%B2_%D0%BF%D0%B0%D0%BC%D1%8F%D1%82%D1%8C&amp;action=edit&amp;section=5" title="Править секцию: Функции Работы с потоками">править</a>]</span> <span class="mw-headline">Функции Работы с потоками</span></h2>
<p>Все довольно просто и особой необходимости в таких функциях нет. Они нужны, чтобы было меньше писанины, чтобы было понятнее - не сводить в одну строчку, как обычно, а расписать побольше:
</p>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #ffff00; font-weight: bold;">Function</span> ReadPakFile:<span style="color: #ffff00; font-weight: bold;">TStream</span><span style=" ">&#40;</span>filename$<span style=" ">&#41;</span><br />
<p>&nbsp; <span style="color: #ffff00; font-weight: bold;">Local</span> file:<span style="color: #ffff00; font-weight: bold;">TStream</span> = <span style="color: #ffff00; font-weight: bold;">ReadFile</span><span style=" ">&#40;</span>filename<span style=" ">&#41;</span><br />
&nbsp; <span style="color: #ffff00; font-weight: bold;">Local</span> out:<span style="color: #ffff00; font-weight: bold;">TStream</span> = DecodeStream<span style=" ">&#40;</span>file<span style=" ">&#41;</span><br />
&nbsp; <span style="color: #ffff00; font-weight: bold;">CloseFile</span><span style=" ">&#40;</span>file<span style=" ">&#41;</span><br />
&nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> out<br />
</p>
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span></div>
<p>И функция шифрования пак-файла (полезная вещь, однако):
</p>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #ffff00; font-weight: bold;">Function</span> WritePakFile<span style=" ">&#40;</span>filename_in$,filename_out$<span style=" ">&#41;</span><br />
<p>&nbsp; <span style="color: #ffff00; font-weight: bold;">Local</span> file:<span style="color: #ffff00; font-weight: bold;">TStream</span> = <span style="color: #ffff00; font-weight: bold;">ReadFile</span><span style=" ">&#40;</span>filename_in<span style=" ">&#41;</span><br />
&nbsp; <span style="color: #ffff00; font-weight: bold;">Local</span> file_out:<span style="color: #ffff00; font-weight: bold;">TStream</span> = <span style="color: #ffff00; font-weight: bold;">WriteFile</span><span style=" ">&#40;</span>filename_out<span style=" ">&#41;</span><br />
&nbsp; <span style="color: #ffff00; font-weight: bold;">Local</span> out:<span style="color: #ffff00; font-weight: bold;">TStream</span> = CodeStream<span style=" ">&#40;</span>file<span style=" ">&#41;</span><br />
&nbsp; <span style="color: #ffff00; font-weight: bold;">While</span> <span style="color: #ffff00; font-weight: bold;">Not</span> <span style="color: #ffff00; font-weight: bold;">Eof</span><span style=" ">&#40;</span>out<span style=" ">&#41;</span><br />
&nbsp; &nbsp; file_out.<span style="color: #ffff00; font-weight: bold;">WriteByte</span><span style=" ">&#40;</span>out.<span style="color: #ffff00; font-weight: bold;">ReadByte</span><span style=" ">&#40;</span><span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; <span style="color: #ffff00; font-weight: bold;">Wend</span><br />
&nbsp; <span style="color: #ffff00; font-weight: bold;">CloseFile</span> file_out out.<span style="">Close</span><span style=" ">&#40;</span><span style=" ">&#41;</span><br />
</p>
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span></div>
<p>Все довольно просто и сделано так, чтобы вам было понятно. Пример использования, очень банально:
</p>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;">WritePakFile<span style=" ">&#40;</span><span style="color: #00FF66;">&quot;test.png&quot;</span>,<span style="color: #00FF66;">&quot;test.pak&quot;</span><span style=" ">&#41;</span><br />
img:TImage = <span style="color: #ffff00; font-weight: bold;">LoadImage</span><span style=" ">&#40;</span>ReadPakFile<span style=" ">&#40;</span><span style="color: #00FF66;">&quot;test.pak&quot;</span><span style=" ">&#41;</span><span style=" ">&#41;</span></div>
<p>Вот и все. Алгоритм шифрования можно усложнить до бесконечности, но целью статьи было просто показать как это использовать в БМаксе, так что юзайте.
</p>
<hr />
<p>Автор: Jimon (jimon.j1m0n@gmail.com)
</p>
<!-- Saved in parser cache with key db1:pcache:idhash:760-0!1!0!!ru!2 and timestamp 20071110040905 -->
<div class="printfooter">
Получено с <a href="5xt_4u4o.html">http://blitzetcetera.org/index.php/%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B_%D1%88%D0%B8%D1%84%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F_%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2_%D1%81_%D1%80%D0%B0%D1%81%D0%BF%D0%B0%D0%BA%D0%BE%D0%B2%D0%BA%D0%BE%D0%B9_%D0%B2_%D0%BF%D0%B0%D0%BC%D1%8F%D1%82%D1%8C</a></div>
			<!-- end content -->			<div class="visualClear"></div>				</td>				<td class="rightside">				</td>			</tr>		</table>		</div>	</div>		</div>	
		<script type="text/javascript">if (window.runOnloadHook) runOnloadHook();</script>
</div></body>
<!-- Mirrored from localhost/index.php/%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B_%D1%88%D0%B8%D1%84%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F_%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2_%D1%81_%D1%80%D0%B0%D1%81%D0%BF%D0%B0%D0%BA%D0%BE%D0%B2%D0%BA%D0%BE%D0%B9_%D0%B2_%D0%BF%D0%B0%D0%BC%D1%8F%D1%82%D1%8C by HTTrack Website Copier/3.x [XR&CO'2007], Sat, 10 Nov 2007 05:16:49 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8"><!-- /Added by HTTrack -->
</html>