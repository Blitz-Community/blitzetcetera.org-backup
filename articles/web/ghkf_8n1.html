<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ru" lang="ru" dir="ltr">	
<!-- Mirrored from localhost/index.php/%D0%A1%D0%B5%D1%82%D1%8C_%D0%BD%D0%B0_Blitz3D:_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B0_online-updater by HTTrack Website Copier/3.x [XR&CO'2007], Sat, 10 Nov 2007 05:16:44 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8"><!-- /Added by HTTrack -->
<head>		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />				<meta name="keywords" content="Сеть на Blitz3D: программа online-updater,Grover" />
		<link rel="shortcut icon" href="http://blitzetcetera.org/favicon.ico" />
		<link rel="search" type="application/opensearchdescription+xml" href="http://blitzetcetera.org/opensearch_desc.php" title="Blitz Et Cetera (Русский)" />
		<title>Сеть на Blitz3D: программа online-updater — Blitz Et Cetera</title>		<style type="text/css" media="screen,projection">/*<![CDATA[*/ @import "bvih5rde.css?63"; /*]]>*/</style>		<link rel="stylesheet" type="text/css" media="print" href="gcxktlm6.css?63" />		<link rel="stylesheet" type="text/css" media="handheld" href="zumsslq_.css?63" />		<!--[if lt IE 5.5000]><style type="text/css">@import "/skins/OfflineNew/IE50Fixes.css?63";</style><![endif]-->		<!--[if IE 5.5000]><style type="text/css">@import "/skins/OfflineNew/IE55Fixes.css?63";</style><![endif]-->		<!--[if IE 6]><style type="text/css">@import "/skins/OfflineNew/IE60Fixes.css?63";</style><![endif]-->		<!--[if IE 7]><style type="text/css">@import "/skins/OfflineNew/IE70Fixes.css?63";</style><![endif]-->		<!--[if lt IE 7]><script type="text/javascript" src="/skins/common/IEFixes.js?63"></script>		<meta http-equiv="imagetoolbar" content="no" /><![endif]-->		<script type= "text/javascript">/*<![CDATA[*/
var skin = "OfflineNew";
var stylepath = "/skins";
var wgArticlePath = "/index.php/$1";
var wgScriptPath = "";
var wgServer = "http://blitzetcetera.org/";
var wgCanonicalNamespace = "";
var wgCanonicalSpecialPageName = false;
var wgNamespaceNumber = 0;
var wgPageName = "Сеть_на_Blitz3D:_программа_online-updater";
var wgTitle = "Сеть на Blitz3D: программа online-updater";
var wgAction = "view";
var wgArticleId = "1664";
var wgIsArticle = true;
var wgUserName = null;
var wgUserGroups = null;
var wgUserLanguage = "ru";
var wgContentLanguage = "ru";
var wgBreakFrames = false;
var wgCurRevisionId = "3240";
/*]]>*/</script>
		<script type="text/javascript" src="2nq-6cel.js?63"><!-- wikibits js --></script>		<script type="text/javascript" src="http://blitzetcetera.org/index.php?title=-&amp;action=raw&amp;gen=js"><!-- site js --></script>		<style type="text/css">/*<![CDATA[*/
@import "http://blitzetcetera.org/index.php?title=MediaWiki:Common.css&amp;usemsgcache=yes&amp;action=raw&amp;ctype=text/css&amp;smaxage=18000";
@import "http://blitzetcetera.org/index.php?title=MediaWiki:OfflineNew.css&amp;usemsgcache=yes&amp;action=raw&amp;ctype=text/css&amp;smaxage=18000";
@import "http://blitzetcetera.org/index.php?title=-&amp;action=raw&amp;gen=css&amp;maxage=18000";
/*]]>*/</style>		<!-- Head Scripts -->	</head><body  class="mediawiki ns-0 ltr page-Сеть_на_Blitz3D_программа_online-updater">	<div id="globalWrapper">	<div id="logocontainer">		<table align="center">		  <tr>				<td id="blitzetclogo">				</td>			</tr>		</table>	</div>	<div id="magbar">	Журнал о программированнии на языках Blitz3D, BlitzMax, BlitzPlus	</div>		<div id="column-content">	<div id="content">		<a name="top" id="top"></a>				<div id="bodyContent">		<table cellspacing=0 cellpadding=0 width=100%>			<tr>			  <td class="leftside">				</td>				<td class="sheetbody">					<h1 class="sheet">Сеть на Blitz3D: программа online-updater</h1>			<h3 id="siteSub">Материал из Blitz Et Cetera.</h3>			<div id="contentSub"></div>			<!-- start content -->			<table id="toc" class="toc" summary="Содержание"><tr><td><div id="toctitle"><h2>Содержание</h2></div>
<ul>
<li class="toclevel-1"><a href="#.D0.92.D0.B2.D0.B5.D0.B4.D0.B5.D0.BD.D0.B8.D0.B5"><span class="tocnumber">1</span> <span class="toctext">Введение</span></a></li>
<li class="toclevel-1"><a href="#.D0.A7.D1.82.D0.BE_.D0.BD.D0.B0.D0.B4.D0.BE"><span class="tocnumber">2</span> <span class="toctext">Что надо</span></a>
<ul>
<li class="toclevel-2"><a href="#.D0.91.D0.B0.D0.BD.D0.BA.D0.B8_.D0.BF.D0.B0.D0.BC.D1.8F.D1.82.D0.B8"><span class="tocnumber">2.1</span> <span class="toctext">Банки памяти</span></a></li>
<li class="toclevel-2"><a href="#.D0.9F.D0.BE.D1.82.D0.BE.D0.BA.D0.B8"><span class="tocnumber">2.2</span> <span class="toctext">Потоки</span></a></li>
</ul>
</li>
<li class="toclevel-1"><a href="#.D0.A1.D1.82.D1.80.D1.83.D0.BA.D1.82.D1.83.D1.80.D0.B0_.D0.B8_.D0.BA.D0.BE.D0.B4_.D1.81.D0.B5.D1.80.D0.B2.D0.B5.D1.80.D0.B0"><span class="tocnumber">3</span> <span class="toctext">Структура и код сервера</span></a>
<ul>
<li class="toclevel-2"><a href="#.D0.A1.D0.B5.D1.80.D0.B2.D0.B5.D1.80"><span class="tocnumber">3.1</span> <span class="toctext">Сервер</span></a></li>
<li class="toclevel-2"><a href="#.D0.9F.D0.BE.D1.81.D1.82.D1.80.D0.BE.D0.B5.D0.BD.D0.B8.D0.B5_.D1.81.D0.BF.D0.B8.D1.81.D0.BA.D0.B0_.D1.84.D0.B0.D0.B9.D0.BB.D0.BE.D0.B2_.D0.B8.D0.B7_.D1.83.D0.BA.D0.B0.D0.B7.D0.B0.D0.BD.D0.BD.D0.BE.D0.B9_.D0.BF.D0.B0.D0.BF.D0.BA.D0.B8"><span class="tocnumber">3.2</span> <span class="toctext">Построение списка файлов из указанной папки</span></a></li>
<li class="toclevel-2"><a href="#.D0.A1.D0.BE.D0.B7.D0.B4.D0.B0.D0.BD.D0.B8.D0.B5_.D1.81.D0.B5.D1.80.D0.B2.D0.B5.D1.80.D0.B0"><span class="tocnumber">3.3</span> <span class="toctext">Создание сервера</span></a></li>
<li class="toclevel-2"><a href="#.D0.9F.D1.80.D0.BE.D0.B2.D0.B5.D1.80.D0.BA.D0.B0_.D0.BD.D0.BE.D0.B2.D1.8B.D1.85_.D0.BF.D0.BE.D0.B4.D0.BA.D0.BB.D1.8E.D1.87.D0.B5.D0.BD.D0.B8.D0.B9"><span class="tocnumber">3.4</span> <span class="toctext">Проверка новых подключений</span></a></li>
<li class="toclevel-2"><a href="#.D0.9E.D0.B1.D1.80.D0.B0.D0.B1.D0.BE.D1.82.D0.BA.D0.B0_.D0.B7.D0.B0.D0.BF.D1.80.D0.BE.D1.81.D0.BE.D0.B2"><span class="tocnumber">3.5</span> <span class="toctext">Обработка запросов</span></a></li>
<li class="toclevel-2"><a href="#.D0.97.D0.B0.D0.BA.D0.BB.D1.8E.D1.87.D0.B8.D1.82.D0.B5.D0.BB.D1.8C.D0.BD.D1.8B.D0.B9_.D1.8D.D1.82.D0.B0.D0.BF_.D0.B2_.D1.80.D0.B5.D0.B0.D0.BB.D0.B8.D0.B7.D0.B0.D1.86.D0.B8.D0.B8_.D1.81.D1.82.D1.80.D1.83.D0.BA.D1.82.D1.83.D1.80.D1.8B"><span class="tocnumber">3.6</span> <span class="toctext">Заключительный этап в реализации структуры</span></a></li>
<li class="toclevel-2"><a href="#.D0.9E.D0.B1.D1.80.D0.B0.D0.B1.D0.BE.D1.82.D0.BA.D0.B0_.D0.BA.D0.BE.D0.BC.D0.B0.D0.BD.D0.B4_.D1.81.D0.B5.D1.80.D0.B2.D0.B5.D1.80.D0.BE.D0.BC"><span class="tocnumber">3.7</span> <span class="toctext">Обработка команд сервером</span></a></li>
</ul>
</li>
<li class="toclevel-1"><a href="#.D0.A1.D0.95.D0.A0.D0.92.D0.95.D0.A0_.D0.93.D0.9E.D0.A2.D0.9E.D0.92_.21.21.21"><span class="tocnumber">4</span> <span class="toctext">СЕРВЕР ГОТОВ&nbsp;!!!</span></a></li>
<li class="toclevel-1"><a href="#.D0.A1.D0.A2.D0.A0.D0.A3.D0.9A.D0.A2.D0.A3.D0.A0.D0.90_.D0.B8_.D0.9A.D0.9E.D0.94_.D0.9A.D0.9B.D0.98.D0.95.D0.9D.D0.A2.D0.90"><span class="tocnumber">5</span> <span class="toctext">СТРУКТУРА и КОД КЛИЕНТА</span></a>
<ul>
<li class="toclevel-2"><a href="#.D0.9F.D0.BE.D0.B4.D0.B3.D0.BE.D1.82.D0.BE.D0.B2.D0.BA.D0.B0"><span class="tocnumber">5.1</span> <span class="toctext">Подготовка</span></a></li>
<li class="toclevel-2"><a href="#.D0.9F.D0.BE.D0.B4.D0.BA.D0.BB.D1.8E.D1.87.D0.B5.D0.BD.D0.B8.D0.B5"><span class="tocnumber">5.2</span> <span class="toctext">Подключение</span></a></li>
</ul>
</li>
<li class="toclevel-1"><a href="#.D0.97.D0.B0.D0.BF.D1.80.D0.BE.D1.81_.D1.81.D0.BF.D0.B8.D1.81.D0.BA.D0.B0_.D1.84.D0.B0.D0.B9.D0.BB.D0.BE.D0.B2"><span class="tocnumber">6</span> <span class="toctext">Запрос списка файлов</span></a>
<ul>
<li class="toclevel-2"><a href="#.D0.9F.D0.BE.D0.BB.D1.83.D1.87.D0.B5.D0.BD.D0.B8.D0.B5_.D1.81.D0.BF.D0.B8.D1.81.D0.BA.D0.B0_.D1.84.D0.B0.D0.B9.D0.BB.D0.BE.D0.B2"><span class="tocnumber">6.1</span> <span class="toctext">Получение списка файлов</span></a></li>
<li class="toclevel-2"><a href="#.D0.97.D0.B0.D0.BF.D1.80.D0.BE.D1.81_.D1.84.D0.B0.D0.B9.D0.BB.D0.B0"><span class="tocnumber">6.2</span> <span class="toctext">Запрос файла</span></a></li>
<li class="toclevel-2"><a href="#.D0.9F.D0.BE.D0.BB.D1.83.D1.87.D0.B5.D0.BD.D0.B8.D0.B5_.D1.84.D0.B0.D0.B9.D0.BB.D0.B0"><span class="tocnumber">6.3</span> <span class="toctext">Получение файла</span></a></li>
</ul>
</li>
<li class="toclevel-1"><a href="#.D0.9A.D0.9B.D0.98.D0.95.D0.9D.D0.A2_.D0.93.D0.9E.D0.A2.D0.9E.D0.92_.21.21.21"><span class="tocnumber">7</span> <span class="toctext">КЛИЕНТ ГОТОВ&nbsp;!!!</span></a></li>
<li class="toclevel-1"><a href="#.D0.97.D0.90.D0.9A.D0.9B.D0.AE.D0.A7.D0.95.D0.9D.D0.98.D0.95"><span class="tocnumber">8</span> <span class="toctext">ЗАКЛЮЧЕНИЕ</span></a></li>
</ul>
</td></tr></table><script type="text/javascript"> if (window.showTocToggle) { var tocShowText = "показать"; var tocHideText = "убрать"; showTocToggle(); } </script>
<a name=".D0.92.D0.B2.D0.B5.D0.B4.D0.B5.D0.BD.D0.B8.D0.B5"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%B5%D1%82%D1%8C_%D0%BD%D0%B0_Blitz3D:_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B0_online-updater&amp;action=edit&amp;section=1" title="Править секцию: Введение">править</a>]</span> <span class="mw-headline">Введение</span></h2>
<p>Предположим мы написали многопользовательскую online игрушку – это хорошо! Запустили и она работает – это еще лучше! Появились первые пользователи – совсем круто!  И тут возникает проблема: мы внесли некие изменения в игру (устранили недостатки, изменили модели и т.п.), и что? Всем пользователям надо сообщить, что бы они скачали и установили обновления… можно и так, но нам лень. Вот именно на этом и начинается эта статья.
</p><p>Задача: написать клиент-серверное приложение, которое будет автоматически обновлять игру у пользователей при запуске игры. На сервере есть папка, все файлы в которой он отправляет подключившемся клиентам.
</p>
<a name=".D0.A7.D1.82.D0.BE_.D0.BD.D0.B0.D0.B4.D0.BE"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%B5%D1%82%D1%8C_%D0%BD%D0%B0_Blitz3D:_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B0_online-updater&amp;action=edit&amp;section=2" title="Править секцию: Что надо">править</a>]</span> <span class="mw-headline">Что надо</span></h2>
<p>Что потребуется: потребуются нам знания и умение работать с TCP/IP, файлами и банками (не майонезными, а банками памяти).
</p><p>TCP/IP: Если мы написали сетевую игру, то как работать с TCP в Blitz3D мы знаем, но на всякий случай повторим еще раз.
</p><p>TCP/IP – это стек протоколов для передачи данных по сети. На этом всё. Если хотите узнать больше, то читайте умные книги. Для нашей работы понадобятся следующие функции работы с TCP в Blitz3D:
</p><p><i>ПРИМЕЧАНИЕ: хэндл – это идентификационный номер (ID) объекта. Движок Blitz3D выполняя определенные функции должен знать с каким объектом он работает. К примеру, создавая камеру вы запоминаете её хэндл в переменную (обычно camera), в дальнейшее для поворота этой камеры вы даете движку Blitz3D команду повернуть камеру на 10 градусов по оси z и обязательно указываете хэндл камеры. Я понятно объясняю?</i>
</p>
<table border="1" width="100%">
<tr>
<td>CreateTCPServer( порт )
</td><td>Запуск сервера, который «слушает» указанный порт. Возвращает хэндл ( ID ) созданного сервера
</td></tr>
<tr>
<td>AcceptTCPStream(сервер)
</td><td>Проверяет подключился ли кто к серверу. Возвращает хэндл потока (подключения)
</td></tr>
<tr>
<td>TCPStreamIP( поток )
</td><td>Возвращает IP-адрес подключившегося по потоку. Внимание: получаемый IP в целочисленном формате
</td></tr>
<tr>
<td>DottedIP( IP% )
</td><td>Конвертирует целочисленный IP в строковый формата «ххх.ххх.ххх.ххх»
</td></tr>
<tr>
<td>OpenTCPStream ( серверIP, порт )
</td><td>Подключиться к серверу. Возвращает хэндл потока
</td></tr></table>
<p>Работа с файлами: Нам понадобится читать из файла, создавать файлы и создавать список файлов хранящиеся в определенной папке. Всё это осуществляется следующими функциями:
</p>
<table border="1" width="100%">
<tr>
<td>ReadDir( папка )
</td><td>Открывает для работы указанную папку. Возвращает хэндл открытой папки
</td></tr>
<tr>
<td>NextFile(хэндл папки)
</td><td>Возвращает имя следующего файла в папке
</td></tr>
<tr>
<td>FileType( файл )
</td><td>Возвращает тип файла (к примеру 2 – это папка)
</td></tr>
<tr>
<td>FileSize( файл )
</td><td>Возвращает размер файла в байтах
</td></tr>
<tr>
<td>CloseDir(хэндл папки)
</td><td>Закрывает папку
</td></tr>
<tr>
<td>OpenFile( файл )
</td><td>Открывает файл для работы и сим. Возвращает хэндл файла
</td></tr>
<tr>
<td>CloseFile(хэндл файла)
</td><td>Закрывает файл
</td></tr></table>
<a name=".D0.91.D0.B0.D0.BD.D0.BA.D0.B8_.D0.BF.D0.B0.D0.BC.D1.8F.D1.82.D0.B8"></a><h3><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%B5%D1%82%D1%8C_%D0%BD%D0%B0_Blitz3D:_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B0_online-updater&amp;action=edit&amp;section=3" title="Править секцию: Банки памяти">править</a>]</span> <span class="mw-headline">Банки памяти</span></h3>
<p>Банк – это выделенное в памяти компьютера пространство под наши нужды. Банки можно создавать, записывать и читать из них данные. Банки обязательно освобождать, иначе операционная система будет держать этот кусок памяти для вашей программы до следующей перезагрузки, т.е. попросту память будет захламлена. Банки нужны для быстрой работы с большими объемами информации. Перекачка 30 мегабайт данных из банка в файл занимает так мало времени, что даже моргнуть не успеешь . Более подробно о банках можно почитать в справке Blitz3D – раздел 2D – Bank.
Для работы с банками нам потребуются следующие функции:
</p>
<table border="1" width="100%">
<tr>
<td>CreateBank( размер )
</td><td>Создает банк – выделяет кусок памяти указанным размером и возвращает хэндл банка
</td></tr>
<tr>
<td>FreeBank( банк )
</td><td>Удаляет банк и освобождает память
</td></tr></table>
<a name=".D0.9F.D0.BE.D1.82.D0.BE.D0.BA.D0.B8"></a><h3><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%B5%D1%82%D1%8C_%D0%BD%D0%B0_Blitz3D:_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B0_online-updater&amp;action=edit&amp;section=4" title="Править секцию: Потоки">править</a>]</span> <span class="mw-headline">Потоки</span></h3>
<p>Для дальнейшей работы необходимо понять, как данные перекачиваются из файла в память, из памяти на другой компьютер и из памяти в файл. Не будем вникать в техническую часть, а разберемся, как это реализовано в Blitz3D. А реализовано это по средствам потоков.
</p><p>Любые данные пересылаемые из пункта А в пункт Б проходят по потокам (можно сравнить с рекой (поток) и брошенное в реку полено (данные)). Пунктами отправки и назначения могут быть файлы, блоки памяти, сетевые подключения и прочее.
</p><p>Функции, обеспечивающие запись и чтение из потоков, необходимые нам:
</p>
<table border="1" width="100%">
<tr>
<td>ReadAvail( хэндл потока )
</td><td>Возвращает размер данных находящихся в потоке. (байт)
</td></tr>
<tr>
<td>ReadLine( хэндл потока )
</td><td>Считывает из потока строку.
</td></tr>
<tr>
<td>ReadBytes (хэндл банка, хэндл потока, от, сколько)
</td><td>Считывает из потока определенную часть данных и записывает их в банк.
<ul><li>хэндл банка – указывает куда записать
</li><li>хэндл потока – откуда брать данные
</li><li>от – если нужны данные с начала потока, то пишем 0, иначе указываем сколько байт от начала нам не нужны.
</li><li>сколько – сколько байт нам надо считать.
</li></ul>
</td></tr>
<tr>
<td>WriteLine(хэндл потока, строку )
</td><td>Записать в поток указанную строку
</td></tr>
<tr>
<td>WriteBytes (хэндл банка, хэндл потока, от, сколько)
</td><td>Записывает из банка в поток.
</td></tr></table>
<p>Прочие функции работы с потоками можно найти в справке Blitz3D.
</p><p>Какие функции языка нам понадобятся мы выяснили, как они взаимодействуют друг с другом, и как мы их свяжем уже более или менее догадываемся.
</p>
<a name=".D0.A1.D1.82.D1.80.D1.83.D0.BA.D1.82.D1.83.D1.80.D0.B0_.D0.B8_.D0.BA.D0.BE.D0.B4_.D1.81.D0.B5.D1.80.D0.B2.D0.B5.D1.80.D0.B0"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%B5%D1%82%D1%8C_%D0%BD%D0%B0_Blitz3D:_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B0_online-updater&amp;action=edit&amp;section=5" title="Править секцию: Структура и код сервера">править</a>]</span> <span class="mw-headline">Структура и код сервера</span></h2>
<p>Отвлечемся в сторону и приступим к моменту проектирования. Это самое скучное мероприятие в программировании, но без него обойтись нельзя. И чем дольше вы будите программировать, тем больше вы будите в этом убеждаться.
</p>
<a name=".D0.A1.D0.B5.D1.80.D0.B2.D0.B5.D1.80"></a><h3><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%B5%D1%82%D1%8C_%D0%BD%D0%B0_Blitz3D:_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B0_online-updater&amp;action=edit&amp;section=6" title="Править секцию: Сервер">править</a>]</span> <span class="mw-headline">Сервер</span></h3>
<p>Не знаю почему, но я всегда начинаю создание сетевого приложения именно с сервера. Сервер – это программка, которая будет ожидать подключения к ней клиента и отправлять этому клиенту все файлики из указанной папочки. Сразу появился первый блок в структуре сервера: «Построение списка файлов из указанной папки». Вторым блоком будет открытие и резервирование портов, к которым будет ожидать подключения – «Создание сервера». Можно уже нарисовать начало структуры, но лучше попозже.
</p><p>Вот теперь в структуру включим основной цикл. Как обычно, из цикла выходим нажатием ESC . В цикле сервер должен ожидать новых подключений и обрабатывать запросы уже установленных ранее подключений. Достаем ручку и кусок бумаги, приступаем к рисованию:
</p>
<div class="center"><div class="floatnone"><span><a href="http://blitzetcetera.org/index.php/%D0%98%D0%B7%D0%BE%D0%B1%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5:Updater01.png" class="image" title=""><img alt="" longdesc="http://blitzetcetera.org/index.php/%D0%98%D0%B7%D0%BE%D0%B1%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5:Updater01.png" src="z2mlng_p.png" width="268" height="329" /></a></span></div></div>
<a name=".D0.9F.D0.BE.D1.81.D1.82.D1.80.D0.BE.D0.B5.D0.BD.D0.B8.D0.B5_.D1.81.D0.BF.D0.B8.D1.81.D0.BA.D0.B0_.D1.84.D0.B0.D0.B9.D0.BB.D0.BE.D0.B2_.D0.B8.D0.B7_.D1.83.D0.BA.D0.B0.D0.B7.D0.B0.D0.BD.D0.BD.D0.BE.D0.B9_.D0.BF.D0.B0.D0.BF.D0.BA.D0.B8"></a><h3><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%B5%D1%82%D1%8C_%D0%BD%D0%B0_Blitz3D:_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B0_online-updater&amp;action=edit&amp;section=7" title="Править секцию: Построение списка файлов из указанной папки">править</a>]</span> <span class="mw-headline">Построение списка файлов из указанной папки</span></h3>
<p>Этот блок можно сразу представить в коде.
	Нам надо построить список, а список это Type! Вот и определим наш тип, т.е. какие параметры нам нужны для хранения.
</p>
<div class="bb" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#225588;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #aaffff; font-weight: bold;">Type</span> ListFiles<br />
<p>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Field</span> File_Name$<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Field</span> File_Size<br />
</p>
<span style="color: #aaffff; font-weight: bold;">End Type</span></div>
<p>Хранить будем имя файла и его размер.
Приступим к заполнению списка:
</p>
<div class="bb" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#225588;color:#FFFFFF;border:1px solid #003040;padding:10px;">myDir=<span style="color: #aaffff; font-weight: bold;">ReadDir</span><span style=" ">&#40;</span><span style="color: #00ff66;">&quot;UpdateDir&quot;</span><span style=" ">&#41;</span> <span style="color: #ffee00">; открываем папку для чтения</span><br />
<p><span style="color: #aaffff; font-weight: bold;">Repeat</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffee00">; запускаем бесконечный цикл</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; File_Name$=<span style="color: #aaffff; font-weight: bold;">NextFile</span>$<span style=" ">&#40;</span>myDir<span style=" ">&#41;</span> <span style="color: #ffee00">; ищем следующий файл в папке</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">If</span> File_Name$=<span style="color: #00ff66;">&quot;&quot;</span> <span style="color: #aaffff; font-weight: bold;">Then</span> <span style="color: #aaffff; font-weight: bold;">Exit</span> &nbsp; &nbsp; <span style="color: #ffee00">; если больше файлов нет, то выходим из цикла</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">If</span> <span style="color: #aaffff; font-weight: bold;">FileType</span><span style=" ">&#40;</span><span style="color: #00ff66;">&quot;UpdateDir\&quot;</span>+File_Name$<span style=" ">&#41;</span> &lt;&gt; <span style="color: #33ffdd;">2</span> <span style="color: #aaffff; font-weight: bold;">Then</span> <span style="color: #ffee00">; если найденное является </span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #ffee00">; файлом то</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; f.ListFiles=<span style="color: #aaffff; font-weight: bold;">New</span> ListFiles&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #ffee00">; создаем новый пункт в списке</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; f\File_Name=File_Name&nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #ffee00">; запоминаем имя файла</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; f\File_Size=<span style="color: #aaffff; font-weight: bold;">FileSize</span><span style=" ">&#40;</span><span style="color: #00ff66;">&quot;UpdateDir\&quot;</span>+File_Name<span style=" ">&#41;</span> <span style="color: #ffee00">; размер файла</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Print</span> f\File_Name+<span style="color: #00ff66;">&quot; - &quot;</span>+f\File_Size &nbsp; &nbsp;<span style="color: #ffee00">; для красоты печатаем на экран</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">End</span> <span style="color: #aaffff; font-weight: bold;">If</span><br />
<span style="color: #aaffff; font-weight: bold;">Forever</span><br />
</p>
<span style="color: #aaffff; font-weight: bold;">CloseDir</span> myDir <span style="color: #ffee00">; закрываем папку</span></div>
<p>Можно запустить программу и увидеть список файлов в папке "UpdateDir".
</p>
<a name=".D0.A1.D0.BE.D0.B7.D0.B4.D0.B0.D0.BD.D0.B8.D0.B5_.D1.81.D0.B5.D1.80.D0.B2.D0.B5.D1.80.D0.B0"></a><h3><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%B5%D1%82%D1%8C_%D0%BD%D0%B0_Blitz3D:_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B0_online-updater&amp;action=edit&amp;section=8" title="Править секцию: Создание сервера">править</a>]</span> <span class="mw-headline">Создание сервера</span></h3>
<p>Тут уже интереснее, хотя и мало. Наш сервер должен открывать два порта, один для обмена сообщениями, другой для передачи файлов. Можно придумать код и с одним портом, но это сложнее. Причина тому синхронизация клиента и сервера, т.е. если сервер посылает банк памяти, то и клиент должен ждать именно банк памяти. Мы же упростили задачу: Один порт (поток) для строковых значений, второй для банков памяти. Таким образом, сервер и клиент всегда точно знают, какие данные получать.
Код:
</p><p>Порт 8880 – для строковых данных (команд)
</p>
<div class="bb" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#225588;color:#FFFFFF;border:1px solid #003040;padding:10px;">ServCom=<span style="color: #aaffff; font-weight: bold;">CreateTCPServer</span><span style=" ">&#40;</span><span style="color: #33ffdd;">8880</span><span style=" ">&#41;</span> &nbsp;<span style="color: #ffee00">; открываем и резервируем порт 8880</span><br />
<p><span style="color: #aaffff; font-weight: bold;">If</span> <span style="color: #aaffff; font-weight: bold;">Not</span> ServCom <span style="color: #aaffff; font-weight: bold;">Then</span> <span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;ServCom failed to start.&quot;</span>&nbsp;: <span style="color: #aaffff; font-weight: bold;">WaitKey</span><span style=" ">&#40;</span><span style=" ">&#41;</span>&nbsp;: <span style="color: #aaffff; font-weight: bold;">End</span> <span style="color: #ffee00">; Не вышло </span><br />
</p>
<span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;ServCom started.&quot;</span> <span style="color: #ffee00">; печатаем на экран радостное сообщение.</span></div>
<p>И порт 8881 – для массивов данных (банков)
</p>
<div class="bb" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#225588;color:#FFFFFF;border:1px solid #003040;padding:10px;">ServDat=<span style="color: #aaffff; font-weight: bold;">CreateTCPServer</span><span style=" ">&#40;</span><span style="color: #33ffdd;">8881</span><span style=" ">&#41;</span><br />
<p><span style="color: #aaffff; font-weight: bold;">If</span> <span style="color: #aaffff; font-weight: bold;">Not</span> ServDat <span style="color: #aaffff; font-weight: bold;">Then</span> <span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;ServDat failed to start.&quot;</span>&nbsp;: <span style="color: #aaffff; font-weight: bold;">WaitKey</span><span style=" ">&#40;</span><span style=" ">&#41;</span>&nbsp;: <span style="color: #aaffff; font-weight: bold;">End</span><br />
</p>
<span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;ServDat started.&quot;</span></div>
<p><i>ЗАМЕТКА: столько тексту и всего 16 строк кода  - надо заканчивать с теорией…</i>
</p>
<a name=".D0.9F.D1.80.D0.BE.D0.B2.D0.B5.D1.80.D0.BA.D0.B0_.D0.BD.D0.BE.D0.B2.D1.8B.D1.85_.D0.BF.D0.BE.D0.B4.D0.BA.D0.BB.D1.8E.D1.87.D0.B5.D0.BD.D0.B8.D0.B9"></a><h3><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%B5%D1%82%D1%8C_%D0%BD%D0%B0_Blitz3D:_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B0_online-updater&amp;action=edit&amp;section=9" title="Править секцию: Проверка новых подключений">править</a>]</span> <span class="mw-headline">Проверка новых подключений</span></h3>
<p>Т.к. мы сейчас пишем сервер, а к серверу могут подключаться много пользователей одновременно, то мы должны все подключения запоминать. Запоминать все подключения означает, построить список подключений, а список – это Type! 
</p><p>Для каждого порта придется делать свой список – то, что произошло подключение к одному порту, еще не означает, что в этот же момент и этот же пользователь подключается ко второму порту. 
</p><p>Объявляем наши списки, кроме потоков(подключений) нам хранить нечего:
</p>
<div class="bb" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#225588;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #aaffff; font-weight: bold;">Type</span> users<br />
<p>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Field</span> StreamCom<br />
<span style="color: #aaffff; font-weight: bold;">End Type</span><br />
<br />
<span style="color: #aaffff; font-weight: bold;">Type</span> Streams<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Field</span> StreamDat<br />
</p>
<span style="color: #aaffff; font-weight: bold;">End Type</span></div>
<p>Создание двух независимых списков вызывает некоторые трудности – запись номер Х в списке подключений порта 8880 может не совпадать к записи номер Х в списке порта 8881. Короче, мы не знаем соответствуют ли два выбранных подключения к одному пользователю или нет? Этот вопрос решается… назовем его вопрос ФИКС.
</p><p>Код:
Проверяем есть ли новое подключение к порту для передачи команд.
</p>
<div class="bb" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#225588;color:#FFFFFF;border:1px solid #003040;padding:10px;">ServComStream=<span style="color: #aaffff; font-weight: bold;">AcceptTCPStream</span><span style=" ">&#40;</span>ServCom<span style=" ">&#41;</span> &nbsp; <span style="color: #ffee00">; &nbsp;запоминаем поток нового подключения.</span><br />
<p><span style="color: #aaffff; font-weight: bold;">If</span> ServComStream <span style="color: #aaffff; font-weight: bold;">Then</span> &nbsp; &nbsp; &nbsp; <span style="color: #ffee00">; Если поток существует (кто то подключился)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; u.users = <span style="color: #aaffff; font-weight: bold;">New</span> users &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #ffee00">; создаем новую запись в списке</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; u\StreamCom=ServComStream &nbsp; <span style="color: #ffee00">; запоминаем сам поток – это важно</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffee00">; для радости глаз админа выводим IP подключившегося.</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;User connected to ServCom. IP = &quot;</span>+<span style="color: #aaffff; font-weight: bold;">DottedIP</span><span style=" ">&#40;</span><span style="color: #aaffff; font-weight: bold;">TCPStreamIP</span><span style=" ">&#40;</span>u\StreamCom<span style=" ">&#41;</span><span style=" ">&#41;</span> <br />
<span style="color: #aaffff; font-weight: bold;">End</span> <span style="color: #aaffff; font-weight: bold;">If</span><br />
<br />
<br />
Проверяем есть ли новое подключение к порту для передачи банков.<br />
ServDatStream=<span style="color: #aaffff; font-weight: bold;">AcceptTCPStream</span><span style=" ">&#40;</span>ServDat<span style=" ">&#41;</span> <span style="color: #ffee00">; тут уже все понятно</span><br />
<span style="color: #aaffff; font-weight: bold;">If</span> ServDatStream <span style="color: #aaffff; font-weight: bold;">Then</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #ffee00">; не понял? смотри выше!</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; us.Streams = <span style="color: #aaffff; font-weight: bold;">New</span> Streams &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffee00">; вот теперь понял?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; us\StreamDat=ServDatStream &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffee00">; наконец то дошло&nbsp;: )</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffee00">; для радости глаз админа выводим IP подключившегося.</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;User connected to ServDat. IP = &quot;</span>+<span style="color: #aaffff; font-weight: bold;">DottedIP</span><span style=" ">&#40;</span><span style="color: #aaffff; font-weight: bold;">TCPStreamIP</span><span style=" ">&#40;</span>us\StreamDat<span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">WriteLine</span><span style=" ">&#40;</span>us\StreamDat,<span style="color: #aaffff; font-weight: bold;">Str</span><span style=" ">&#40;</span>us\StreamDat<span style=" ">&#41;</span><span style=" ">&#41;</span> <span style="color: #ffee00">; ВАЖНО&nbsp;! решение проблемы ФИКС&nbsp;!!!</span><br />
</p>
<span style="color: #aaffff; font-weight: bold;">End</span> <span style="color: #aaffff; font-weight: bold;">If</span></div>
<p>Кто внимательно читал комментарии в коде, тот уже видел, что проблема ФИКС решается в одну строку. На самом деле ни в одну – больше. Принцип решения заключается в следующем:
</p><p><i>ЗАМЕТКА: Решение проблемы ФИКС нашел я сам, но такое корявое – ЖУТЬ. Если кто знает решение это проблемы более «прямым» способом, то сообщите мне.</i>
</p><p>Как только клиент подключается к порту передачи банков, ему через этот же порт и этот же поток отправляется хэндл этого потока. Затем, запрашивая банк данных через командный порт, клиент отправляет и хэндл соединения для порта данных. Таким образом, сервер узнает какие соединения на портах соответствуют одному пользователю. Вот… понятно или нет? - извините, но лучше объяснить не могу&nbsp;:( 
</p>
<a name=".D0.9E.D0.B1.D1.80.D0.B0.D0.B1.D0.BE.D1.82.D0.BA.D0.B0_.D0.B7.D0.B0.D0.BF.D1.80.D0.BE.D1.81.D0.BE.D0.B2"></a><h3><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%B5%D1%82%D1%8C_%D0%BD%D0%B0_Blitz3D:_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B0_online-updater&amp;action=edit&amp;section=10" title="Править секцию: Обработка запросов">править</a>]</span> <span class="mw-headline">Обработка запросов</span></h3>
<p>Ранее мы сохраняли все подключения (потоки). Теперь пора проверить: «а не прислали ли нам узеры команды?». Для этого мы должны перебрать все подключения и проверить их на наличие присланных данных (команд).
</p><p>Код:
Листаем список потоков и ищем в них команды.
</p>
<div class="bb" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#225588;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #aaffff; font-weight: bold;">For</span> u.users=<span style="color: #aaffff; font-weight: bold;">Each</span> users &nbsp;<span style="color: #ffee00">; запускаем перебор потоков</span><br />
<p>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">If</span> u\StreamCom <span style="color: #aaffff; font-weight: bold;">Then</span> &nbsp;<span style="color: #ffee00">; если поток (подключение) еще жив, то</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">If</span> <span style="color: #aaffff; font-weight: bold;">ReadAvail</span><span style=" ">&#40;</span>u\StreamCom<span style=" ">&#41;</span>&gt;<span style="color: #33ffdd;">0</span> <span style="color: #aaffff; font-weight: bold;">Then</span> <span style="color: #ffee00">; если данных в потоке больше 0 байта (хотя бы 1)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #ffee00">; значит что то нам прислали&nbsp;!</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; S$=<span style="color: #aaffff; font-weight: bold;">ReadLine</span><span style=" ">&#40;</span>u\StreamCom<span style=" ">&#41;</span> <span style="color: #ffee00">; Считываем с потока строку</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffee00">; ****** ОБРАБОТКА КОМАНД ***********</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Print</span> S &nbsp;<span style="color: #ffee00">; выводим на экран полученную строку.</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffee00">;******* КОНЕЦ ОБРАБОТКИ ***********</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">EndIf</span><br />
<span style="color: #aaffff; font-weight: bold;">Else</span> &nbsp;<span style="color: #ffee00">; поток не жив</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Delete</span> u &nbsp;<span style="color: #ffee00">; удаляем эту запись из списка, зачем нам трупы&nbsp;?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">EndIf</span><br />
</p>
<span style="color: #aaffff; font-weight: bold;">Next</span></div>
<p>Функция ReadAvail возвращает количество байт, присланных нам по указанному потоку. 
Так как все потоки в списке Users у нас для передачи строковых данных, то и считываем мы строку  и запоминаем ее в переменную S для дальнейшей обработки. Сейчас вся обработка присланной информации заключается в ее печати на экран. 
</p>
<a name=".D0.97.D0.B0.D0.BA.D0.BB.D1.8E.D1.87.D0.B8.D1.82.D0.B5.D0.BB.D1.8C.D0.BD.D1.8B.D0.B9_.D1.8D.D1.82.D0.B0.D0.BF_.D0.B2_.D1.80.D0.B5.D0.B0.D0.BB.D0.B8.D0.B7.D0.B0.D1.86.D0.B8.D0.B8_.D1.81.D1.82.D1.80.D1.83.D0.BA.D1.82.D1.83.D1.80.D1.8B"></a><h3><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%B5%D1%82%D1%8C_%D0%BD%D0%B0_Blitz3D:_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B0_online-updater&amp;action=edit&amp;section=11" title="Править секцию: Заключительный этап в реализации структуры">править</a>]</span> <span class="mw-headline">Заключительный этап в реализации структуры</span></h3>
<p>Весь этот этап заключатся в сборе написанных нами кусочков в единый код.
Код:
</p>
<div class="bb" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#225588;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #aaffff; font-weight: bold;">Type</span> ListFiles<br />
<p>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Field</span> File_Name$<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Field</span> File_Size<br />
<span style="color: #aaffff; font-weight: bold;">End Type</span><br />
<br />
<span style="color: #aaffff; font-weight: bold;">Type</span> users<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Field</span> StreamCom<br />
<span style="color: #aaffff; font-weight: bold;">End Type</span><br />
<br />
<span style="color: #aaffff; font-weight: bold;">Type</span> Streams<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Field</span> StreamDat<br />
<span style="color: #aaffff; font-weight: bold;">End Type</span><br />
<br />
<span style="color: #ffee00">;********* Построение списка файлов из указанной папки</span><br />
myDir=<span style="color: #aaffff; font-weight: bold;">ReadDir</span><span style=" ">&#40;</span><span style="color: #00ff66;">&quot;UpdateDir&quot;</span><span style=" ">&#41;</span><br />
<span style="color: #aaffff; font-weight: bold;">Repeat</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; File_Name$=<span style="color: #aaffff; font-weight: bold;">NextFile</span>$<span style=" ">&#40;</span>myDir<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">If</span> File_Name$=<span style="color: #00ff66;">&quot;&quot;</span> <span style="color: #aaffff; font-weight: bold;">Then</span> <span style="color: #aaffff; font-weight: bold;">Exit</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">If</span> <span style="color: #aaffff; font-weight: bold;">FileType</span><span style=" ">&#40;</span><span style="color: #00ff66;">&quot;UpdateDir\&quot;</span>+File_Name$<span style=" ">&#41;</span> &lt;&gt; <span style="color: #33ffdd;">2</span> <span style="color: #aaffff; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; f.ListFiles=<span style="color: #aaffff; font-weight: bold;">New</span> ListFiles<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; f\File_Name=File_Name<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; f\File_Size=<span style="color: #aaffff; font-weight: bold;">FileSize</span><span style=" ">&#40;</span><span style="color: #00ff66;">&quot;UpdateDir\&quot;</span>+File_Name<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Print</span> f\File_Name+<span style="color: #00ff66;">&quot; - &quot;</span>+f\File_Size<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">End</span> <span style="color: #aaffff; font-weight: bold;">If</span><br />
<span style="color: #aaffff; font-weight: bold;">Forever</span><br />
<span style="color: #aaffff; font-weight: bold;">CloseDir</span> myDir<br />
<span style="color: #ffee00">;********* Построение завершено </span><br />
<br />
<span style="color: #ffee00">;********* Создание сервера</span><br />
ServCom=<span style="color: #aaffff; font-weight: bold;">CreateTCPServer</span><span style=" ">&#40;</span><span style="color: #33ffdd;">8880</span><span style=" ">&#41;</span><br />
<span style="color: #aaffff; font-weight: bold;">If</span> <span style="color: #aaffff; font-weight: bold;">Not</span> ServCom <span style="color: #aaffff; font-weight: bold;">Then</span> <span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;ServCom failed to start.&quot;</span>&nbsp;: <span style="color: #aaffff; font-weight: bold;">WaitKey</span><span style=" ">&#40;</span><span style=" ">&#41;</span>&nbsp;: <span style="color: #aaffff; font-weight: bold;">End</span><br />
<span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;ServCom started.&quot;</span><br />
<br />
ServDat=<span style="color: #aaffff; font-weight: bold;">CreateTCPServer</span><span style=" ">&#40;</span><span style="color: #33ffdd;">8881</span><span style=" ">&#41;</span><br />
<span style="color: #aaffff; font-weight: bold;">If</span> <span style="color: #aaffff; font-weight: bold;">Not</span> ServDat <span style="color: #aaffff; font-weight: bold;">Then</span> <span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;ServDat failed to start.&quot;</span>&nbsp;: <span style="color: #aaffff; font-weight: bold;">WaitKey</span><span style=" ">&#40;</span><span style=" ">&#41;</span>&nbsp;: <span style="color: #aaffff; font-weight: bold;">End</span><br />
<span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;ServDat started.&quot;</span><br />
<span style="color: #ffee00">;**********Сервер создан</span><br />
<br />
<span style="color: #aaffff; font-weight: bold;">While</span> <span style="color: #aaffff; font-weight: bold;">Not</span> <span style="color: #aaffff; font-weight: bold;">KeyHit</span><span style=" ">&#40;</span><span style="color: #33ffdd;">1</span><span style=" ">&#41;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffee00">;********* Проверка новых подключений</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; ServComStream=<span style="color: #aaffff; font-weight: bold;">AcceptTCPStream</span><span style=" ">&#40;</span>ServCom<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">If</span> ServComStream <span style="color: #aaffff; font-weight: bold;">Then</span> <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u.users = <span style="color: #aaffff; font-weight: bold;">New</span> users<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u\StreamCom=ServComStream<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;User connected to ServCom. IP = &quot;</span>+<span style="color: #aaffff; font-weight: bold;">DottedIP</span><span style=" ">&#40;</span><span style="color: #aaffff; font-weight: bold;">TCPStreamIP</span><span style=" ">&#40;</span>u\StreamCom<span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">End</span> <span style="color: #aaffff; font-weight: bold;">If</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; ServDatStream=<span style="color: #aaffff; font-weight: bold;">AcceptTCPStream</span><span style=" ">&#40;</span>ServDat<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">If</span> ServDatStream <span style="color: #aaffff; font-weight: bold;">Then</span> <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; us.Streams = <span style="color: #aaffff; font-weight: bold;">New</span> Streams<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; us\StreamDat=ServDatStream<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;User connected to ServDat. IP = &quot;</span>+<span style="color: #aaffff; font-weight: bold;">DottedIP</span><span style=" ">&#40;</span><span style="color: #aaffff; font-weight: bold;">TCPStreamIP</span><span style=" ">&#40;</span>us\StreamDat<span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">WriteLine</span><span style=" ">&#40;</span>us\StreamDat,<span style="color: #aaffff; font-weight: bold;">Str</span><span style=" ">&#40;</span>us\StreamDat<span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">End</span> <span style="color: #aaffff; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffee00">; ************ Проверка завершена</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffee00">;*************Проверка на входящие данные</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">For</span> u.users=<span style="color: #aaffff; font-weight: bold;">Each</span> users<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">If</span> u\StreamCom <span style="color: #aaffff; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">If</span> <span style="color: #aaffff; font-weight: bold;">ReadAvail</span><span style=" ">&#40;</span>u\StreamCom<span style=" ">&#41;</span>&gt;<span style="color: #33ffdd;">1</span> <span style="color: #aaffff; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; S$=<span style="color: #aaffff; font-weight: bold;">ReadLine</span><span style=" ">&#40;</span>u\StreamCom<span style=" ">&#41;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffee00">; ****** ОБРАБОТКА КОМАНД ***********</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Print</span> S &nbsp;<span style="color: #ffee00">; выводим на экран полученную строку.</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffee00">;******* КОНЕЦ ОБРАБОТКИ ***********</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">EndIf</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Else</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Delete</span> u<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">EndIf</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffee00">;************Проверка завершена</span><br />
<br />
<span style="color: #aaffff; font-weight: bold;">Wend</span><br />
<br />
</p>
<span style="color: #aaffff; font-weight: bold;">End</span></div>
<p>Комментарии я убрал, дабы не рябило в глазах, но выделил участки кода, реализующие тот или иной блок структуры. В принципе мы получили вполне работающий сервер, но он не умеет передавать файлы! Не переживаем и без паники, сейчас все сделаем.
</p>
<a name=".D0.9E.D0.B1.D1.80.D0.B0.D0.B1.D0.BE.D1.82.D0.BA.D0.B0_.D0.BA.D0.BE.D0.BC.D0.B0.D0.BD.D0.B4_.D1.81.D0.B5.D1.80.D0.B2.D0.B5.D1.80.D0.BE.D0.BC"></a><h3><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%B5%D1%82%D1%8C_%D0%BD%D0%B0_Blitz3D:_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B0_online-updater&amp;action=edit&amp;section=12" title="Править секцию: Обработка команд сервером">править</a>]</span> <span class="mw-headline">Обработка команд сервером</span></h3>
<p>Все входящие строки, они же команды (т.к. порт командный), сохраняются в строковую переменную S. Сервер на строго определенные команды, должен строго определенно действовать. Определим список команд, которые сервер будет понимать:
</p><p><i>ЗАМЕТКА: Слышу список – думаю Type&nbsp;!!! а вот и не к месту…</i>
</p><p>Так как клиент не знает, какие файлы есть у сервера, а значит, не знает и какие файлы запрашивать, то сервер должен выдавать список файлов клиенту по запросу. Таким запросом будет фраза: "Get File List". Очень важно, чтобы отправляемая строка в программе-клиенте совпадала с ожидаемой сервером строкой! 
</p><p>Код:
</p>
<div class="bb" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#225588;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #aaffff; font-weight: bold;">If</span> S=<span style="color: #00ff66;">&quot;Get File List&quot;</span> <span style="color: #aaffff; font-weight: bold;">Then</span> &nbsp; &nbsp;$ Если присланная строка равна <span style="color: #00ff66;">&quot;Get File List&quot;</span>, то<br />
<p>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">For</span> LF.ListFiles=<span style="color: #aaffff; font-weight: bold;">Each</span> ListFiles &nbsp; &nbsp; <span style="color: #ffee00">; перебираем список файлов, подготовленных к отправке</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffee00">; отправляем имя файла и его размер клиенту. Используем команду с параметрами</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffee00">;команды с параметрами рассмотрим ниже.</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">WriteLine</span> <span style=" ">&#40;</span>u\StreamCom,<span style="color: #00ff66;">&quot;#file=&quot;</span>+LF\File_Name+<span style="color: #00ff66;">&quot;&amp;&quot;</span>+<span style="color: #aaffff; font-weight: bold;">Str</span><span style=" ">&#40;</span>LF\File_Size<span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Next</span><br />
</p>
<span style="color: #aaffff; font-weight: bold;">EndIf</span></div>
<p>Для того, что бы сервер выслал файл, недостаточно одной команды. Клиенту необходимо послать команду с параметрами. Первым параметром будет имя файла (какой файл необходимо выслать клиенту). Вторым параметром должен быть хэндл потока (подключения), по которому этот файл должен быть выслан. Если все эти параметры поместить в одну строку, то получим следующую модель команды:
</p>
<div class="center"><div class="floatnone"><span><a href="http://blitzetcetera.org/index.php/%D0%98%D0%B7%D0%BE%D0%B1%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5:Updater02.png" class="image" title=""><img alt="" longdesc="http://blitzetcetera.org/index.php/%D0%98%D0%B7%D0%BE%D0%B1%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5:Updater02.png" src="fj9pnruk.png" width="534" height="128" /></a></span></div></div>
<p>Получая строку, которая начинается со строки «GetFile=» сервер должен вычленить из строки параметры и отправить нужный файл, по указанному потоку.
</p><p>Код:
Дождались, именно в этом коде мы высылаем файл.
</p>
<div class="bb" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#225588;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #aaffff; font-weight: bold;">If</span> <span style="color: #aaffff; font-weight: bold;">Left</span><span style=" ">&#40;</span>s,<span style="color: #33ffdd;">8</span><span style=" ">&#41;</span>=<span style="color: #00ff66;">&quot;GetFile=&quot;</span> <span style="color: #aaffff; font-weight: bold;">Then</span> &nbsp;<span style="color: #ffee00">; если строка начинается с &quot;GetFile=&quot;, то</span><br />
<p>&nbsp; &nbsp; &nbsp; &nbsp; temp=<span style="color: #aaffff; font-weight: bold;">Instr</span><span style=" ">&#40;</span>s,<span style="color: #00ff66;">&quot;&amp;&quot;</span><span style=" ">&#41;</span> &nbsp;<span style="color: #ffee00">; запоминаем позицию знака разделителя в строке</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; File_Name$=<span style="color: #aaffff; font-weight: bold;">Mid</span><span style=" ">&#40;</span>s,<span style="color: #33ffdd;">9</span>,temp<span style="color: #33ffdd;">-9</span><span style=" ">&#41;</span> &nbsp; &nbsp;<span style="color: #ffee00">; вырезаем и запоминаем имя файла из строки</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; Cli_Stream=<span style="color: #aaffff; font-weight: bold;">Int</span><span style=" ">&#40;</span><span style="color: #aaffff; font-weight: bold;">Mid</span><span style=" ">&#40;</span>s,temp<span style="color: #33ffdd;">+1</span><span style=" ">&#41;</span><span style=" ">&#41;</span> &nbsp; <span style="color: #ffee00">; вырезаем и запоминаем хэндл потока для отправки</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; File_Size=<span style="color: #aaffff; font-weight: bold;">FileSize</span><span style=" ">&#40;</span><span style="color: #00ff66;">&quot;UpdateDir\&quot;</span>+File_Name<span style=" ">&#41;</span> <span style="color: #ffee00">; узнаем размер отправляемого файла</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; file=<span style="color: #aaffff; font-weight: bold;">OpenFile</span><span style=" ">&#40;</span><span style="color: #00ff66;">&quot;UpdateDir\&quot;</span>+File_Name<span style=" ">&#41;</span> &nbsp; <span style="color: #ffee00">; открываем файл</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">If</span> <span style="color: #aaffff; font-weight: bold;">Not</span> file <span style="color: #aaffff; font-weight: bold;">Then</span> <span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;File not open.&quot;</span>&nbsp;: <span style="color: #aaffff; font-weight: bold;">WaitKey</span><span style=" ">&#40;</span><span style=" ">&#41;</span>&nbsp;: <span style="color: #aaffff; font-weight: bold;">End</span> <span style="color: #ffee00">; если файл не открывается, </span><br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffee00">;то сервер падает&nbsp;: (</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffee00">; придумаете свой вариант&nbsp;: )</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;Sending file &quot;</span>+File_Name+<span style="color: #00ff66;">&quot;...&quot;</span> <span style="color: #ffee00">; сообщаем админа об отправке файла</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; bnk=<span style="color: #aaffff; font-weight: bold;">CreateBank</span><span style=" ">&#40;</span>File_Size<span style=" ">&#41;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffee00">; создаем банк памяти размером с файл.</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">ReadBytes</span><span style=" ">&#40;</span>bnk,file,<span style="color: #33ffdd;">0</span>,File_Size<span style=" ">&#41;</span>&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffee00">; заполняем банк данными из файла.</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">WriteBytes</span><span style=" ">&#40;</span>bnk,Cli_Stream,<span style="color: #33ffdd;">0</span>,File_Size<span style=" ">&#41;</span> &nbsp; <span style="color: #ffee00">; записываем банк в поток (отправляем клиенту)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">FreeBank</span> bnk &nbsp;<span style="color: #ffee00">; &nbsp;стираем банк</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">CloseFile</span><span style=" ">&#40;</span>file<span style=" ">&#41;</span> &nbsp;<span style="color: #ffee00">; закрываем файл</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;finish.&quot;</span> <span style="color: #ffee00">; сообщаем админу, что файл отправлен</span><br />
</p>
<span style="color: #aaffff; font-weight: bold;">EndIf</span></div>
<p>Теперь разберем написанный код.
</p><p>Алгоритм получения параметров из строки расписывать не буду – ни чего сложного, да и не в тему. Зато рассмотрим алгоритм передачи файла, тут все просто (если вы читали написанное выше внимательно):
</p>
<ol><li>Открываем файл.
</li><li>Если файл не открылся, то сервер падает. Это плохо, но действия на этот вариант напишите сами.
</li><li>Создаем банк памяти. Размер банка должен быть равным размеру файла. Ограничения по размеру – ваша оперативная память. Я пробовал создавать банк на 300 Мб, банк был создан секунд за 40-50 – это долго, но вряд ли вы будите пересылать такие файлы (там и алгоритм пересылки намного сложнее).
</li><li>Копируем наш файл в созданный банк.
</li><li>Отправляем весь банк целиком в поток к пользователю. Если б не ВЕЛИКИЙ и МОГУЧИЙ Blitz3D, то разбивали бы мы весь банк на кусочки по несколько килобайт и отправляли б по одному. НО ВЕЛИКИЙ и МОГУЧИЙ Blitz3D умный и все это делает сам!
</li></ol>
<p>всё&nbsp;! файл ушел.
</p>
<a name=".D0.A1.D0.95.D0.A0.D0.92.D0.95.D0.A0_.D0.93.D0.9E.D0.A2.D0.9E.D0.92_.21.21.21"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%B5%D1%82%D1%8C_%D0%BD%D0%B0_Blitz3D:_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B0_online-updater&amp;action=edit&amp;section=13" title="Править секцию: СЕРВЕР ГОТОВ&nbsp;!!!">править</a>]</span> <span class="mw-headline">СЕРВЕР ГОТОВ&nbsp;!!!</span></h2>
<p>Ура! Сервер готов к работе!!! Осталось собрать все части кода в кучу и можно запускать.
Код:
</p>
<div class="bb" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#225588;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #aaffff; font-weight: bold;">Type</span> ListFiles<br />
<p>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Field</span> File_Name$<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Field</span> File_Size<br />
<span style="color: #aaffff; font-weight: bold;">End Type</span><br />
<br />
<span style="color: #aaffff; font-weight: bold;">Type</span> users<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Field</span> StreamCom<br />
<span style="color: #aaffff; font-weight: bold;">End Type</span><br />
<br />
<span style="color: #aaffff; font-weight: bold;">Type</span> Streams<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Field</span> StreamDat<br />
<span style="color: #aaffff; font-weight: bold;">End Type</span><br />
<br />
<span style="color: #ffee00">;********* Построение списка файлов из указанной папки</span><br />
myDir=<span style="color: #aaffff; font-weight: bold;">ReadDir</span><span style=" ">&#40;</span><span style="color: #00ff66;">&quot;UpdateDir&quot;</span><span style=" ">&#41;</span><br />
<span style="color: #aaffff; font-weight: bold;">Repeat</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; File_Name$=<span style="color: #aaffff; font-weight: bold;">NextFile</span>$<span style=" ">&#40;</span>myDir<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">If</span> File_Name$=<span style="color: #00ff66;">&quot;&quot;</span> <span style="color: #aaffff; font-weight: bold;">Then</span> <span style="color: #aaffff; font-weight: bold;">Exit</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">If</span> <span style="color: #aaffff; font-weight: bold;">FileType</span><span style=" ">&#40;</span><span style="color: #00ff66;">&quot;UpdateDir\&quot;</span>+File_Name$<span style=" ">&#41;</span> &lt;&gt; <span style="color: #33ffdd;">2</span> <span style="color: #aaffff; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; f.ListFiles=<span style="color: #aaffff; font-weight: bold;">New</span> ListFiles<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; f\File_Name=File_Name<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; f\File_Size=<span style="color: #aaffff; font-weight: bold;">FileSize</span><span style=" ">&#40;</span><span style="color: #00ff66;">&quot;UpdateDir\&quot;</span>+File_Name<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Print</span> f\File_Name+<span style="color: #00ff66;">&quot; - &quot;</span>+f\File_Size<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">End</span> <span style="color: #aaffff; font-weight: bold;">If</span><br />
<span style="color: #aaffff; font-weight: bold;">Forever</span><br />
<span style="color: #aaffff; font-weight: bold;">CloseDir</span> myDir<br />
<span style="color: #ffee00">;********* Построение завершено </span><br />
<br />
<span style="color: #ffee00">;********* Создание сервера</span><br />
ServCom=<span style="color: #aaffff; font-weight: bold;">CreateTCPServer</span><span style=" ">&#40;</span><span style="color: #33ffdd;">8880</span><span style=" ">&#41;</span><br />
<span style="color: #aaffff; font-weight: bold;">If</span> <span style="color: #aaffff; font-weight: bold;">Not</span> ServCom <span style="color: #aaffff; font-weight: bold;">Then</span> <span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;ServCom failed to start.&quot;</span>&nbsp;: <span style="color: #aaffff; font-weight: bold;">WaitKey</span><span style=" ">&#40;</span><span style=" ">&#41;</span>&nbsp;: <span style="color: #aaffff; font-weight: bold;">End</span><br />
<span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;ServCom started.&quot;</span><br />
<br />
ServDat=<span style="color: #aaffff; font-weight: bold;">CreateTCPServer</span><span style=" ">&#40;</span><span style="color: #33ffdd;">8881</span><span style=" ">&#41;</span><br />
<span style="color: #aaffff; font-weight: bold;">If</span> <span style="color: #aaffff; font-weight: bold;">Not</span> ServDat <span style="color: #aaffff; font-weight: bold;">Then</span> <span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;ServDat failed to start.&quot;</span>&nbsp;: <span style="color: #aaffff; font-weight: bold;">WaitKey</span><span style=" ">&#40;</span><span style=" ">&#41;</span>&nbsp;: <span style="color: #aaffff; font-weight: bold;">End</span><br />
<span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;ServDat started.&quot;</span><br />
<span style="color: #ffee00">;**********Сервер создан</span><br />
<br />
<span style="color: #aaffff; font-weight: bold;">While</span> <span style="color: #aaffff; font-weight: bold;">Not</span> <span style="color: #aaffff; font-weight: bold;">KeyHit</span><span style=" ">&#40;</span><span style="color: #33ffdd;">1</span><span style=" ">&#41;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffee00">;********* Проверка новых подключений</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; ServComStream=<span style="color: #aaffff; font-weight: bold;">AcceptTCPStream</span><span style=" ">&#40;</span>ServCom<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">If</span> ServComStream <span style="color: #aaffff; font-weight: bold;">Then</span> <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u.users = <span style="color: #aaffff; font-weight: bold;">New</span> users<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u\StreamCom=ServComStream<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;User connected to ServCom. IP = &quot;</span>+<span style="color: #aaffff; font-weight: bold;">DottedIP</span><span style=" ">&#40;</span><span style="color: #aaffff; font-weight: bold;">TCPStreamIP</span><span style=" ">&#40;</span>u\StreamCom<span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">End</span> <span style="color: #aaffff; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; ServDatStream=<span style="color: #aaffff; font-weight: bold;">AcceptTCPStream</span><span style=" ">&#40;</span>ServDat<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">If</span> ServDatStream <span style="color: #aaffff; font-weight: bold;">Then</span> <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; us.Streams = <span style="color: #aaffff; font-weight: bold;">New</span> Streams<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; us\StreamDat=ServDatStream<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;User connected to ServDat. IP = &quot;</span>+<span style="color: #aaffff; font-weight: bold;">DottedIP</span><span style=" ">&#40;</span><span style="color: #aaffff; font-weight: bold;">TCPStreamIP</span><span style=" ">&#40;</span>us\StreamDat<span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">WriteLine</span><span style=" ">&#40;</span>us\StreamDat,<span style="color: #aaffff; font-weight: bold;">Str</span><span style=" ">&#40;</span>us\StreamDat<span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">End</span> <span style="color: #aaffff; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffee00">; ************ Проверка завершена</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffee00">;*************Проверка на входящие данные</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">For</span> u.users=<span style="color: #aaffff; font-weight: bold;">Each</span> users<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">If</span> u\StreamCom <span style="color: #aaffff; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">If</span> <span style="color: #aaffff; font-weight: bold;">ReadAvail</span><span style=" ">&#40;</span>u\StreamCom<span style=" ">&#41;</span>&gt;<span style="color: #33ffdd;">1</span> <span style="color: #aaffff; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; S$=<span style="color: #aaffff; font-weight: bold;">ReadLine</span><span style=" ">&#40;</span>u\StreamCom<span style=" ">&#41;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffee00">; ****** ОБРАБОТКА КОМАНД ***********</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">If</span> S=<span style="color: #00ff66;">&quot;Get File List&quot;</span> <span style="color: #aaffff; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">For</span> LF.ListFiles=<span style="color: #aaffff; font-weight: bold;">Each</span> ListFiles<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">WriteLine</span> <span style=" ">&#40;</span>u\StreamCom,<span style="color: #00ff66;">&quot;#file=&quot;</span>+LF\File_Name+<span style="color: #00ff66;">&quot;&amp;&quot;</span>+<span style="color: #aaffff; font-weight: bold;">Str</span><span style=" ">&#40;</span>LF\File_Size<span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Next</span><br />
<span style="color: #aaffff; font-weight: bold;">EndIf</span><br />
<br />
<span style="color: #aaffff; font-weight: bold;">If</span> <span style="color: #aaffff; font-weight: bold;">Left</span><span style=" ">&#40;</span>s,<span style="color: #33ffdd;">8</span><span style=" ">&#41;</span>=<span style="color: #00ff66;">&quot;GetFile=&quot;</span> <span style="color: #aaffff; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; temp=<span style="color: #aaffff; font-weight: bold;">Instr</span><span style=" ">&#40;</span>s,<span style="color: #00ff66;">&quot;&amp;&quot;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; File_Name$=<span style="color: #aaffff; font-weight: bold;">Mid</span><span style=" ">&#40;</span>s,<span style="color: #33ffdd;">9</span>,temp<span style="color: #33ffdd;">-9</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; Cli_Stream=<span style="color: #aaffff; font-weight: bold;">Int</span><span style=" ">&#40;</span><span style="color: #aaffff; font-weight: bold;">Mid</span><span style=" ">&#40;</span>s,temp<span style="color: #33ffdd;">+1</span><span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; File_Size=<span style="color: #aaffff; font-weight: bold;">FileSize</span><span style=" ">&#40;</span><span style="color: #00ff66;">&quot;UpdateDir\&quot;</span>+File_Name<span style=" ">&#41;</span> <br />
file=<span style="color: #aaffff; font-weight: bold;">OpenFile</span><span style=" ">&#40;</span><span style="color: #00ff66;">&quot;UpdateDir\&quot;</span>+File_Name<span style=" ">&#41;</span> <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">If</span> <span style="color: #aaffff; font-weight: bold;">Not</span> file <span style="color: #aaffff; font-weight: bold;">Then</span> <span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;File not open.&quot;</span>&nbsp;: <span style="color: #aaffff; font-weight: bold;">WaitKey</span><span style=" ">&#40;</span><span style=" ">&#41;</span>&nbsp;: <span style="color: #aaffff; font-weight: bold;">End</span> <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;Sending file &quot;</span>+File_Name+<span style="color: #00ff66;">&quot;...&quot;</span> <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bnk=<span style="color: #aaffff; font-weight: bold;">CreateBank</span><span style=" ">&#40;</span>File_Size<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">ReadBytes</span><span style=" ">&#40;</span>bnk,file,<span style="color: #33ffdd;">0</span>,File_Size<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">WriteBytes</span><span style=" ">&#40;</span>bnk,Cli_Stream,<span style="color: #33ffdd;">0</span>,File_Size<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">FreeBank</span> bnk <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">CloseFile</span><span style=" ">&#40;</span>file<span style=" ">&#41;</span> <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;finish.&quot;</span><br />
<span style="color: #aaffff; font-weight: bold;">EndIf</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffee00">;******* КОНЕЦ ОБРАБОТКИ ***********</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">EndIf</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Else</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Delete</span> u<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">EndIf</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffee00">;************Проверка завершена</span><br />
<br />
<span style="color: #aaffff; font-weight: bold;">Wend</span><br />
<br />
</p>
<span style="color: #aaffff; font-weight: bold;">End</span></div>
<p>Признаюсь честно, я запускал пять раз и каждый раз радовался сообщениям о созданном сервере и списку файлов.
</p>
<a name=".D0.A1.D0.A2.D0.A0.D0.A3.D0.9A.D0.A2.D0.A3.D0.A0.D0.90_.D0.B8_.D0.9A.D0.9E.D0.94_.D0.9A.D0.9B.D0.98.D0.95.D0.9D.D0.A2.D0.90"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%B5%D1%82%D1%8C_%D0%BD%D0%B0_Blitz3D:_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B0_online-updater&amp;action=edit&amp;section=14" title="Править секцию: СТРУКТУРА и КОД КЛИЕНТА">править</a>]</span> <span class="mw-headline">СТРУКТУРА и КОД КЛИЕНТА</span></h2>
<p>Клиент должен: подключаться к серверу по двум разным портам; уметь запрашивать и получать список файлов к загрузке; запрашивать, получать и сохранять файлы.
	Нарисуем структуру:
</p>
<div class="center"><div class="floatnone"><span><a href="http://blitzetcetera.org/index.php/%D0%98%D0%B7%D0%BE%D0%B1%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5:Updater03.png" class="image" title=""><img alt="" longdesc="http://blitzetcetera.org/index.php/%D0%98%D0%B7%D0%BE%D0%B1%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5:Updater03.png" src="wko2akuh.png" width="262" height="282" /></a></span></div></div>
<a name=".D0.9F.D0.BE.D0.B4.D0.B3.D0.BE.D1.82.D0.BE.D0.B2.D0.BA.D0.B0"></a><h3><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%B5%D1%82%D1%8C_%D0%BD%D0%B0_Blitz3D:_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B0_online-updater&amp;action=edit&amp;section=15" title="Править секцию: Подготовка">править</a>]</span> <span class="mw-headline">Подготовка</span></h3>
<p>Подготовим переменные для работы всей программы.
</p>
<div class="bb" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#225588;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #aaffff; font-weight: bold;">Type</span> ListFiles<br />
<p>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Field</span> File_Name$<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Field</span> File_Size<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Field</span> Loaded<br />
<span style="color: #aaffff; font-weight: bold;">End Type</span><br />
<br />
</p>
<span style="color: #aaffff; font-weight: bold;">Global</span> file=<span style="color: #33ffdd;">0</span></div>
<p>Список ListFiles будет хранить имена и размеры файлов для закачки. Также необходимо добавить количество уже закаченных данных, что бы знать закачался файл полностью или надо еще принять порцию данных.
Переменная file будет хранить хэндл файла, который сейчас закачивается.
</p>
<a name=".D0.9F.D0.BE.D0.B4.D0.BA.D0.BB.D1.8E.D1.87.D0.B5.D0.BD.D0.B8.D0.B5"></a><h3><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%B5%D1%82%D1%8C_%D0%BD%D0%B0_Blitz3D:_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B0_online-updater&amp;action=edit&amp;section=16" title="Править секцию: Подключение">править</a>]</span> <span class="mw-headline">Подключение</span></h3>
<p>Перед процессом подключения мы должны знать куда подключаемся. Подготовим необходимые переменные.
</p><p>Код:
</p>
<div class="bb" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#225588;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #aaffff; font-weight: bold;">Global</span> ServerIP$=<span style="color: #00ff66;">&quot;localhost&quot;</span> <span style="color: #ffee00">; где сервер. Нужно вписать IP сервера.</span><br />
<p><span style="color: #aaffff; font-weight: bold;">Global</span> PortCom=<span style="color: #33ffdd;">8880</span><br />
</p>
<span style="color: #aaffff; font-weight: bold;">Global</span> PortDat=<span style="color: #33ffdd;">8881</span></div>
<p>IP адрес сервера. Вместо строки localhost необходимо вписать IP адрес сервера, но т.к. клиент запускаем на том же компьютере, что и сервер, то оставляем всё как есть.
</p><p>Код:
Создаем два подключения. Одно для команд, второе для получения данных.
</p>
<div class="bb" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#225588;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #aaffff; font-weight: bold;">Global</span> CliCom=<span style="color: #aaffff; font-weight: bold;">OpenTCPStream</span> <span style=" ">&#40;</span>ServerIP,PortCom<span style=" ">&#41;</span> &nbsp;<span style="color: #ffee00">; подключаемся </span><br />
<p><span style="color: #aaffff; font-weight: bold;">If</span> <span style="color: #aaffff; font-weight: bold;">Not</span> CliCom <span style="color: #aaffff; font-weight: bold;">Then</span> <span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;CliCom error.&quot;</span>&nbsp;: <span style="color: #aaffff; font-weight: bold;">WaitKey</span><span style=" ">&#40;</span><span style=" ">&#41;</span>&nbsp;: <span style="color: #aaffff; font-weight: bold;">End</span> <span style="color: #ffee00">; если не вышло, то закрываем прогу</span><br />
<span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;CliCom is connected.&quot;</span> <span style="color: #ffee00">; радуем юзера красивой надписью</span><br />
<br />
<span style="color: #aaffff; font-weight: bold;">Global</span> CliDat=<span style="color: #aaffff; font-weight: bold;">OpenTCPStream</span> <span style=" ">&#40;</span>ServerIP,PortDat<span style=" ">&#41;</span> <span style="color: #ffee00">; подключаемся</span><br />
<span style="color: #aaffff; font-weight: bold;">If</span> <span style="color: #aaffff; font-weight: bold;">Not</span> CliDat <span style="color: #aaffff; font-weight: bold;">Then</span> <span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;CliDat error.&quot;</span>&nbsp;: <span style="color: #aaffff; font-weight: bold;">WaitKey</span><span style=" ">&#40;</span><span style=" ">&#41;</span>&nbsp;: <span style="color: #aaffff; font-weight: bold;">End</span><span style="color: #ffee00">; если не вышло, то закрываем прогу</span><br />
<span style="color: #aaffff; font-weight: bold;">Global</span> ServDataSteam$=<span style="color: #aaffff; font-weight: bold;">ReadLine</span><span style=" ">&#40;</span>CliDat<span style=" ">&#41;</span> <span style="color: #ffee00">; Момент решения проблемы ФИКС.</span><br />
</p>
<span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;CliDat is connected. ServDataSteam=&quot;</span>+ServDataSteam <span style="color: #ffee00">; радуем юзера красивой надписью</span></div>
<p>Момент решения проблемы ФИКС: как только подключение к порту данных на сервере выполнено, то сервер (смотри выше) отправляет хэндл подключения. Именно в этой строке кода мы считываем и запоминаем в переменную ServDataSteam этот хэндл.
</p>
<a name=".D0.97.D0.B0.D0.BF.D1.80.D0.BE.D1.81_.D1.81.D0.BF.D0.B8.D1.81.D0.BA.D0.B0_.D1.84.D0.B0.D0.B9.D0.BB.D0.BE.D0.B2"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%B5%D1%82%D1%8C_%D0%BD%D0%B0_Blitz3D:_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B0_online-updater&amp;action=edit&amp;section=17" title="Править секцию: Запрос списка файлов">править</a>]</span> <span class="mw-headline">Запрос списка файлов</span></h2>
<p>Весь запрос осуществляется одной строкой:
</p>
<div class="bb" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#225588;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #aaffff; font-weight: bold;">WriteLine</span><span style=" ">&#40;</span>CliCom,<span style="color: #00ff66;">&quot;Get File List&quot;</span><span style=" ">&#41;</span> <span style="color: #ffee00">; отправляем серверу запрос списка файлов.</span></div>
<p><i>ВНИМАНИЕ: Вы очень внимательно читали написанное выше и знаете, что отправляемая строка должна один в один совпадать с ожидаемой на сервере. Это распространенная ошибка.</i>
</p>
<a name=".D0.9F.D0.BE.D0.BB.D1.83.D1.87.D0.B5.D0.BD.D0.B8.D0.B5_.D1.81.D0.BF.D0.B8.D1.81.D0.BA.D0.B0_.D1.84.D0.B0.D0.B9.D0.BB.D0.BE.D0.B2"></a><h3><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%B5%D1%82%D1%8C_%D0%BD%D0%B0_Blitz3D:_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B0_online-updater&amp;action=edit&amp;section=18" title="Править секцию: Получение списка файлов">править</a>]</span> <span class="mw-headline">Получение списка файлов</span></h3>
<p>Вспоминаем как в серверной части организовывали проверку на входящие данные. В клиенте смысл тот же – «Если в потоке для команд данных больше чем 0, то что-то прислали». По тому же принципу, что и в серверной части проверяем команду, вычлиняем параметры и запоминаем, что надо.
</p><p>Код:
</p>
<div class="bb" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#225588;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #aaffff; font-weight: bold;">If</span> <span style="color: #aaffff; font-weight: bold;">ReadAvail</span><span style=" ">&#40;</span>CliCom<span style=" ">&#41;</span>&gt;<span style="color: #33ffdd;">0</span> <span style="color: #aaffff; font-weight: bold;">Then</span> <span style="color: #ffee00">; Если что то прислали, то</span><br />
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; S$=<span style="color: #aaffff; font-weight: bold;">ReadLine</span><span style=" ">&#40;</span>CliCom<span style=" ">&#41;</span> &nbsp; &nbsp;<span style="color: #ffee00">; запоминаем что именно прислали</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">If</span> <span style="color: #aaffff; font-weight: bold;">Left</span><span style=" ">&#40;</span>S,<span style="color: #33ffdd;">6</span><span style=" ">&#41;</span>=<span style="color: #00ff66;">&quot;#file=&quot;</span> <span style="color: #aaffff; font-weight: bold;">Then</span> &nbsp; &nbsp;<span style="color: #ffee00">; если строка начинается с &quot;#file=&quot; , добавить файл в список.</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; temp=<span style="color: #aaffff; font-weight: bold;">Instr</span><span style=" ">&#40;</span>s,<span style="color: #00ff66;">&quot;&amp;&quot;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LF.ListFiles=<span style="color: #aaffff; font-weight: bold;">New</span> ListFiles &nbsp; <span style="color: #ffee00">; создаем новый запись в списке</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LF\File_Name=<span style="color: #aaffff; font-weight: bold;">Mid</span><span style=" ">&#40;</span>s,<span style="color: #33ffdd;">7</span>,temp<span style="color: #33ffdd;">-7</span><span style=" ">&#41;</span> &nbsp; <span style="color: #ffee00">; запоминаем имя файла</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LF\File_Size=<span style="color: #aaffff; font-weight: bold;">Int</span><span style=" ">&#40;</span><span style="color: #aaffff; font-weight: bold;">Mid</span><span style=" ">&#40;</span>s,temp<span style="color: #33ffdd;">+1</span><span style=" ">&#41;</span><span style=" ">&#41;</span> <span style="color: #ffee00">; запоминаем размер файла</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LF\loaded=<span style="color: #33ffdd;">0</span> &nbsp;<span style="color: #ffee00">; обнуляем количество полученных данных по этому файлу</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Print</span> LF\File_Name+<span style="color: #00ff66;">&quot; - &quot;</span>+LF\File_Size &nbsp;<span style="color: #ffee00">; выводим на экран полученную информацию</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">EndIf</span><br />
</p>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">End</span> <span style="color: #aaffff; font-weight: bold;">If</span></div>
<p>В этом коде вопросов быть не должно.
</p>
<a name=".D0.97.D0.B0.D0.BF.D1.80.D0.BE.D1.81_.D1.84.D0.B0.D0.B9.D0.BB.D0.B0"></a><h3><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%B5%D1%82%D1%8C_%D0%BD%D0%B0_Blitz3D:_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B0_online-updater&amp;action=edit&amp;section=19" title="Править секцию: Запрос файла">править</a>]</span> <span class="mw-headline">Запрос файла</span></h3>
<p>В основной цикл после блока получения списка файлов добавляем строки:
</p>
<div class="bb" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#225588;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #aaffff; font-weight: bold;">If</span> <span style="color: #aaffff; font-weight: bold;">KeyHit</span> <span style=" ">&#40;</span><span style="color: #33ffdd;">60</span><span style=" ">&#41;</span> <span style="color: #aaffff; font-weight: bold;">Then</span> <span style="color: #ffee00">; если пользователь нажал клавишу F2, то</span><br />
<p>&nbsp; &nbsp; &nbsp; &nbsp; loadfile<span style=" ">&#40;</span><span style=" ">&#41;</span> &nbsp; <span style="color: #ffee00">; выполнить пользовательскую функцию.</span><br />
</p>
<span style="color: #aaffff; font-weight: bold;">EndIf</span></div>
<p>У запроса списка файлов и запроса файла есть одно общее&nbsp;: Выполнение запроса одной строкой. Но в отличии от запроса списка, запрос файла, дело тонкое:
</p>
<ol><li>Проверить остались ли файлы к закачке или уже все скачали.
</li><li>Надо проверить, можно ли запрашивать файл, т.е. не происходит ли закачка другого файла.
</li><li>Если все в порядке, то отправить сам запрос и создать файл на компьютере пользователя для дальнейшей записи в него.
</li></ol>
<p>Получается вот такой код:
</p>
<div class="bb" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#225588;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #aaffff; font-weight: bold;">Function</span> loadfile<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
<p>&nbsp; &nbsp; &nbsp; &nbsp; LF.ListFiles = <span style="color: #aaffff; font-weight: bold;">First</span> ListFiles &nbsp; <span style="color: #ffee00">; Выбираем первый файл в списке</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">If</span> LF=<span style="color: #aaffff; font-weight: bold;">Null</span> <span style="color: #aaffff; font-weight: bold;">Then</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffee00">; Если список пуст, то</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;File List is empty.&quot;</span> &nbsp; <span style="color: #ffee00">; сообщить пользователю, что список пуст (все скачали)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Else</span> &nbsp; <span style="color: #ffee00">; Если все-таки список не пуст, то</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">If</span> LF\Loaded=<span style="color: #33ffdd;">0</span> <span style="color: #aaffff; font-weight: bold;">Then</span> &nbsp;<span style="color: #ffee00">; Если закачка выбранного файла не начата, то</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">WriteLine</span><span style=" ">&#40;</span>CliCom,<span style="color: #00ff66;">&quot;GetFile=&quot;</span>+LF\File_Name+<span style="color: #00ff66;">&quot;&amp;&quot;</span>+ServDataSteam<span style=" ">&#41;</span> <span style="color: #ffee00">; послать запрос</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;GetFile = &quot;</span>+LF\File_Name <span style="color: #ffee00">; сообщить пользователю о запросе</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; file=<span style="color: #aaffff; font-weight: bold;">WriteFile</span><span style=" ">&#40;</span><span style="color: #00ff66;">&quot;Downloaded\&quot;</span>+LF\File_Name<span style=" ">&#41;</span> <span style="color: #ffee00">; создать файл для записи</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Else</span> &nbsp;<span style="color: #ffee00">; выбранный файл уже закачивается</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;File &quot;</span>+LF\File_Name+<span style="color: #00ff66;">&quot; loading now.&quot;</span> <span style="color: #ffee00">; огорчаем пользователя</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">EndIf</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">End</span> <span style="color: #aaffff; font-weight: bold;">If</span><br />
</p>
<span style="color: #aaffff; font-weight: bold;">End Function</span></div>
<p>Всё, запрос отправляется, если сейчас ни чего не качается и есть чего еще закачать.
Я специально сделал отправку запроса отдельной функцией, это маленькая хитрость… о ней потом.
</p>
<a name=".D0.9F.D0.BE.D0.BB.D1.83.D1.87.D0.B5.D0.BD.D0.B8.D0.B5_.D1.84.D0.B0.D0.B9.D0.BB.D0.B0"></a><h3><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%B5%D1%82%D1%8C_%D0%BD%D0%B0_Blitz3D:_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B0_online-updater&amp;action=edit&amp;section=20" title="Править секцию: Получение файла">править</a>]</span> <span class="mw-headline">Получение файла</span></h3>
<p>Если в поток для передачи данных приходит что-то, то значит файл уже создан (его хэндл хранится в переменной file). Осталось считать порцию данных и записать в файл. 
</p><p><i>ВНИМАНИЕ: то, что Blitz3D позволяет отправлять файл целиком, еще не означает, что и получите его целиком. Зависит от скорости работы сети и скорости работы программы.</i>
</p><p>Мы должны запомнить, сколько данных из файла мы получили и сравнить с размерами файла. Если полученное совпадает с ожидаемым, то файл получен полностью, можно его закрывать и удалять из списка получаемых файлов.
</p><p>Код.
</p>
<div class="bb" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#225588;color:#FFFFFF;border:1px solid #003040;padding:10px;">x=<span style="color: #aaffff; font-weight: bold;">ReadAvail</span><span style=" ">&#40;</span>CliDat<span style=" ">&#41;</span> &nbsp; <span style="color: #ffee00">; запоминаем размер полученных данных</span><br />
<p>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">If</span> x&gt;<span style="color: #33ffdd;">0</span> <span style="color: #aaffff; font-weight: bold;">Then</span> &nbsp; &nbsp;<span style="color: #ffee00">; если данных дольше чем 0, то</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bnk=<span style="color: #aaffff; font-weight: bold;">CreateBank</span><span style=" ">&#40;</span>x<span style=" ">&#41;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #ffee00">; создаем банк размером с полученных данными</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">ReadBytes</span><span style=" ">&#40;</span>bnk,CliDat,<span style="color: #33ffdd;">0</span>,x<span style=" ">&#41;</span> &nbsp;<span style="color: #ffee00">; считываем данные из потока в банк</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LF.ListFiles = <span style="color: #aaffff; font-weight: bold;">First</span> ListFiles <span style="color: #ffee00">; выбираем первый файл в списке получаемых (его уже качаем)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">WriteBytes</span><span style=" ">&#40;</span>bnk,file,<span style="color: #33ffdd;">0</span>,x<span style=" ">&#41;</span> &nbsp;<span style="color: #ffee00">; записываем банк в созданный при запросе файл</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LF\Loaded=LF\Loaded+x &nbsp; <span style="color: #ffee00">; запоминаем сколько данных получили всего</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;Loaded&nbsp;: &quot;</span>+LF\Loaded + <span style="color: #00ff66;">&quot; from&nbsp;: &quot;</span>+ LF\file_size &nbsp; <span style="color: #ffee00">; сообщаем юзеру новости</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">FreeBank</span> bnk &nbsp;<span style="color: #ffee00">; удаляем банк</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">If</span> LF\Loaded=LF\file_size <span style="color: #aaffff; font-weight: bold;">Then</span> &nbsp;<span style="color: #ffee00">; если полученное равно ожидаемому, то</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">CloseFile</span><span style=" ">&#40;</span>file<span style=" ">&#41;</span> &nbsp;<span style="color: #ffee00">; закрываем файл (сохраняем)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;File &quot;</span>+LF\File_Name+ <span style="color: #00ff66;">&quot; downloaded.&quot;</span> <span style="color: #ffee00">; радуем юзера!</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Delete</span> LF &nbsp;<span style="color: #ffee00">; удаляем запись от скаченном файле</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot; &quot;</span> &nbsp;<span style="color: #ffee00">; на экран пустую строку для красоты</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">EndIf</span><br />
</p>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">End</span> <span style="color: #aaffff; font-weight: bold;">If</span></div>
<p>Всё. Если собрать все части клиента в кучу, то можно уже проверять наше творение. Запускаем сервер, затем запускаем клиент. Радуемся красивым надписям и жмем F2. Опа! Один файл закачался! Клево&nbsp;!!! Опять жмем F2 – еще файлик!!! И что? На каждый файл нажимать F2? Господа, мы программисты, а не извращенцы, вспоминаем про маленькую хитрость и добавляем одну строчку в код:
</p>
<div class="bb" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#225588;color:#FFFFFF;border:1px solid #003040;padding:10px;">x=<span style="color: #aaffff; font-weight: bold;">ReadAvail</span><span style=" ">&#40;</span>CliDat<span style=" ">&#41;</span><br />
<p>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">If</span> x&gt;<span style="color: #33ffdd;">0</span> <span style="color: #aaffff; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bnk=<span style="color: #aaffff; font-weight: bold;">CreateBank</span><span style=" ">&#40;</span>x<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">ReadBytes</span><span style=" ">&#40;</span>bnk,CliDat,<span style="color: #33ffdd;">0</span>,x<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LF.ListFiles = <span style="color: #aaffff; font-weight: bold;">First</span> ListFiles<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">WriteBytes</span><span style=" ">&#40;</span>bnk,file,<span style="color: #33ffdd;">0</span>,x<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LF\Loaded=LF\Loaded+x<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;Loaded&nbsp;: &quot;</span>+LF\Loaded + <span style="color: #00ff66;">&quot; from&nbsp;: &quot;</span>+ LF\file_size<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">FreeBank</span> bnk<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">If</span> LF\Loaded=LF\file_size <span style="color: #aaffff; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">CloseFile</span><span style=" ">&#40;</span>file<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;File &quot;</span>+LF\File_Name+ <span style="color: #00ff66;">&quot; downloaded.&quot;</span> <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Delete</span> LF<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot; &quot;</span> <br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; loadfile<span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #ffee00">; Вот она эта «хитрая» строка&nbsp;!!!</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">EndIf</span><br />
</p>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">End</span> <span style="color: #aaffff; font-weight: bold;">If</span></div>
<p>Таким образом, как только закончится закачка одного файла, программы сразу пошлет запрос на следующий. И F2 нажимать надо только один раз для запуска закачки.
</p>
<a name=".D0.9A.D0.9B.D0.98.D0.95.D0.9D.D0.A2_.D0.93.D0.9E.D0.A2.D0.9E.D0.92_.21.21.21"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%B5%D1%82%D1%8C_%D0%BD%D0%B0_Blitz3D:_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B0_online-updater&amp;action=edit&amp;section=21" title="Править секцию: КЛИЕНТ ГОТОВ&nbsp;!!!">править</a>]</span> <span class="mw-headline">КЛИЕНТ ГОТОВ&nbsp;!!!</span></h2>
<p>Клиент дописан. Собираем все части в кучу:
</p>
<div class="bb" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#225588;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #aaffff; font-weight: bold;">Type</span> ListFiles<br />
<p>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Field</span> File_Name$<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Field</span> File_Size<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Field</span> Loaded<br />
<span style="color: #aaffff; font-weight: bold;">End Type</span><br />
<br />
<span style="color: #aaffff; font-weight: bold;">Global</span> ServerIP$=<span style="color: #00ff66;">&quot;localhost&quot;</span><br />
<span style="color: #aaffff; font-weight: bold;">Global</span> PortCom=<span style="color: #33ffdd;">8880</span><br />
<span style="color: #aaffff; font-weight: bold;">Global</span> PortDat=<span style="color: #33ffdd;">8881</span><br />
<span style="color: #aaffff; font-weight: bold;">Global</span> file=<span style="color: #33ffdd;">0</span><br />
<br />
<span style="color: #aaffff; font-weight: bold;">Global</span> CliCom=<span style="color: #aaffff; font-weight: bold;">OpenTCPStream</span> <span style=" ">&#40;</span>ServerIP,PortCom<span style=" ">&#41;</span><br />
<span style="color: #aaffff; font-weight: bold;">If</span> <span style="color: #aaffff; font-weight: bold;">Not</span> CliCom <span style="color: #aaffff; font-weight: bold;">Then</span> <span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;CliCom error.&quot;</span>&nbsp;: <span style="color: #aaffff; font-weight: bold;">WaitKey</span><span style=" ">&#40;</span><span style=" ">&#41;</span>&nbsp;: <span style="color: #aaffff; font-weight: bold;">End</span><br />
<span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;CliCom is connected.&quot;</span><br />
<br />
<span style="color: #aaffff; font-weight: bold;">Global</span> CliDat=<span style="color: #aaffff; font-weight: bold;">OpenTCPStream</span> <span style=" ">&#40;</span>ServerIP,PortDat<span style=" ">&#41;</span><br />
<span style="color: #aaffff; font-weight: bold;">If</span> <span style="color: #aaffff; font-weight: bold;">Not</span> CliDat <span style="color: #aaffff; font-weight: bold;">Then</span> <span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;CliDat error.&quot;</span>&nbsp;: <span style="color: #aaffff; font-weight: bold;">WaitKey</span><span style=" ">&#40;</span><span style=" ">&#41;</span>&nbsp;: <span style="color: #aaffff; font-weight: bold;">End</span><br />
<span style="color: #aaffff; font-weight: bold;">Global</span> ServDataSteam$=<span style="color: #aaffff; font-weight: bold;">ReadLine</span><span style=" ">&#40;</span>CliDat<span style=" ">&#41;</span><br />
<span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;CliDat is connected. ServDataSteam=&quot;</span>+ServDataSteam<br />
<br />
<span style="color: #aaffff; font-weight: bold;">WriteLine</span><span style=" ">&#40;</span>CliCom,<span style="color: #00ff66;">&quot;Get File List&quot;</span><span style=" ">&#41;</span><br />
<br />
<span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot; &quot;</span><br />
<span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;To download files press F2.&quot;</span><br />
<span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot; &quot;</span><br />
<br />
<span style="color: #aaffff; font-weight: bold;">While</span> <span style="color: #aaffff; font-weight: bold;">Not</span> <span style="color: #aaffff; font-weight: bold;">KeyHit</span><span style=" ">&#40;</span><span style="color: #33ffdd;">1</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">If</span> <span style="color: #aaffff; font-weight: bold;">ReadAvail</span><span style=" ">&#40;</span>CliCom<span style=" ">&#41;</span>&gt;<span style="color: #33ffdd;">1</span> <span style="color: #aaffff; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; S$=<span style="color: #aaffff; font-weight: bold;">ReadLine</span><span style=" ">&#40;</span>CliCom<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">If</span> <span style="color: #aaffff; font-weight: bold;">Left</span><span style=" ">&#40;</span>S,<span style="color: #33ffdd;">6</span><span style=" ">&#41;</span>=<span style="color: #00ff66;">&quot;#file=&quot;</span> <span style="color: #aaffff; font-weight: bold;">Then</span> <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; temp=<span style="color: #aaffff; font-weight: bold;">Instr</span><span style=" ">&#40;</span>s,<span style="color: #00ff66;">&quot;&amp;&quot;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LF.ListFiles=<span style="color: #aaffff; font-weight: bold;">New</span> ListFiles<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LF\File_Name=<span style="color: #aaffff; font-weight: bold;">Mid</span><span style=" ">&#40;</span>s,<span style="color: #33ffdd;">7</span>,temp<span style="color: #33ffdd;">-7</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LF\File_Size=<span style="color: #aaffff; font-weight: bold;">Int</span><span style=" ">&#40;</span><span style="color: #aaffff; font-weight: bold;">Mid</span><span style=" ">&#40;</span>s,temp<span style="color: #33ffdd;">+1</span><span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LF\loaded=<span style="color: #33ffdd;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Print</span> LF\File_Name+<span style="color: #00ff66;">&quot; - &quot;</span>+LF\File_Size<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">EndIf</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">End</span> <span style="color: #aaffff; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; x=<span style="color: #aaffff; font-weight: bold;">ReadAvail</span><span style=" ">&#40;</span>CliDat<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">If</span> x&gt;<span style="color: #33ffdd;">0</span> <span style="color: #aaffff; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bnk=<span style="color: #aaffff; font-weight: bold;">CreateBank</span><span style=" ">&#40;</span>x<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">ReadBytes</span><span style=" ">&#40;</span>bnk,CliDat,<span style="color: #33ffdd;">0</span>,x<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LF.ListFiles = <span style="color: #aaffff; font-weight: bold;">First</span> ListFiles<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">WriteBytes</span><span style=" ">&#40;</span>bnk,file,<span style="color: #33ffdd;">0</span>,x<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LF\Loaded=LF\Loaded+x<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;Loaded&nbsp;: &quot;</span>+LF\Loaded + <span style="color: #00ff66;">&quot; from&nbsp;: &quot;</span>+ LF\file_size<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">FreeBank</span> bnk<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">If</span> LF\Loaded=LF\file_size <span style="color: #aaffff; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">CloseFile</span><span style=" ">&#40;</span>file<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;File &quot;</span>+LF\File_Name+ <span style="color: #00ff66;">&quot; downloaded.&quot;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Delete</span> LF<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot; &quot;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; loadfile<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">EndIf</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">End</span> <span style="color: #aaffff; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">If</span> <span style="color: #aaffff; font-weight: bold;">KeyHit</span> <span style=" ">&#40;</span><span style="color: #33ffdd;">60</span><span style=" ">&#41;</span> <span style="color: #aaffff; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; loadfile<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">EndIf</span><br />
<span style="color: #aaffff; font-weight: bold;">Wend</span><br />
<span style="color: #aaffff; font-weight: bold;">End</span><br />
<br />
<span style="color: #aaffff; font-weight: bold;">Function</span> loadfile<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; LF.ListFiles = <span style="color: #aaffff; font-weight: bold;">First</span> ListFiles<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">If</span> LF=<span style="color: #aaffff; font-weight: bold;">Null</span> <span style="color: #aaffff; font-weight: bold;">Then</span> <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;File List is empty.&quot;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Else</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">If</span> LF\Loaded=<span style="color: #33ffdd;">0</span> <span style="color: #aaffff; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">WriteLine</span><span style=" ">&#40;</span>CliCom,<span style="color: #00ff66;">&quot;GetFile=&quot;</span>+LF\File_Name+<span style="color: #00ff66;">&quot;&amp;&quot;</span>+ServDataSteam<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;GetFile = &quot;</span>+LF\File_Name<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; file=<span style="color: #aaffff; font-weight: bold;">WriteFile</span><span style=" ">&#40;</span><span style="color: #00ff66;">&quot;Downloaded\&quot;</span>+LF\File_Name<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Else</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #00ff66;">&quot;File &quot;</span>+LF\File_Name+<span style="color: #00ff66;">&quot; loading now.&quot;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">EndIf</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">End</span> <span style="color: #aaffff; font-weight: bold;">If</span><br />
</p>
<span style="color: #aaffff; font-weight: bold;">End Function</span></div>
<p>Всё!
</p>
<a name=".D0.97.D0.90.D0.9A.D0.9B.D0.AE.D0.A7.D0.95.D0.9D.D0.98.D0.95"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%B5%D1%82%D1%8C_%D0%BD%D0%B0_Blitz3D:_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B0_online-updater&amp;action=edit&amp;section=22" title="Править секцию: ЗАКЛЮЧЕНИЕ">править</a>]</span> <span class="mw-headline">ЗАКЛЮЧЕНИЕ</span></h2>
<p>Надеюсь, мой труд не только дал вам «прикольный» код, но и научил чему-то…
Спасибо вам за терпение. Если будут вопросы, то пишите мне письма.
</p>
<hr />
<p>Автор: <a href="http://blitzetcetera.org/index.php/%D0%A3%D1%87%D0%B0%D1%81%D1%82%D0%BD%D0%B8%D0%BA:Grover" title="Участник:Grover">Grover</a> (e-mail: mail_grover@mail.ru)
</p>
<!-- Saved in parser cache with key db1:pcache:idhash:1664-0!1!0!!ru!2 and timestamp 20071110040834 -->
<div class="printfooter">
Получено с <a href="ghkf_8n1.html">http://blitzetcetera.org/index.php/%D0%A1%D0%B5%D1%82%D1%8C_%D0%BD%D0%B0_Blitz3D:_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B0_online-updater</a></div>
			<!-- end content -->			<div class="visualClear"></div>				</td>				<td class="rightside">				</td>			</tr>		</table>		</div>	</div>		</div>	
		<script type="text/javascript">if (window.runOnloadHook) runOnloadHook();</script>
</div></body>
<!-- Mirrored from localhost/index.php/%D0%A1%D0%B5%D1%82%D1%8C_%D0%BD%D0%B0_Blitz3D:_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B0_online-updater by HTTrack Website Copier/3.x [XR&CO'2007], Sat, 10 Nov 2007 05:16:44 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8"><!-- /Added by HTTrack -->
</html>