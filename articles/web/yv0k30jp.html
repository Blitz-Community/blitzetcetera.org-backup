<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ru" lang="ru" dir="ltr">	
<!-- Mirrored from localhost/index.php/%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B4%D0%B2%D1%83%D0%BC%D0%B5%D1%80%D0%BD%D0%BE%D0%B3%D0%BE_%D0%B4%D0%B2%D0%B8%D0%B6%D0%BA%D0%B0_%D0%BD%D0%B0_%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D0%B5_%D0%B8%D0%B3%D1%80%D1%8B_%22%D0%97%D0%B2%D0%B5%D1%80%D1%81%D0%BA%D0%B8%D0%B5_%D0%BA%D0%BE%D0%BB%D0%BE%D0%B1%D0%BA%D0%B8%22 by HTTrack Website Copier/3.x [XR&CO'2007], Sat, 10 Nov 2007 05:15:13 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8"><!-- /Added by HTTrack -->
<head>		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />				<meta name="keywords" content="Создание двумерного движка на примере игры «Зверские колобки»,Виртуальный художник: линейные (матричные) фильтры,Виртуальный художник: соседние пикселы,Matt Merkulov" />
		<link rel="shortcut icon" href="http://blitzetcetera.org/favicon.ico" />
		<link rel="search" type="application/opensearchdescription+xml" href="http://blitzetcetera.org/opensearch_desc.php" title="Blitz Et Cetera (Русский)" />
		<title>Создание двумерного движка на примере игры «Зверские колобки» — Blitz Et Cetera</title>		<style type="text/css" media="screen,projection">/*<![CDATA[*/ @import "bvih5rde.css?63"; /*]]>*/</style>		<link rel="stylesheet" type="text/css" media="print" href="gcxktlm6.css?63" />		<link rel="stylesheet" type="text/css" media="handheld" href="zumsslq_.css?63" />		<!--[if lt IE 5.5000]><style type="text/css">@import "/skins/OfflineNew/IE50Fixes.css?63";</style><![endif]-->		<!--[if IE 5.5000]><style type="text/css">@import "/skins/OfflineNew/IE55Fixes.css?63";</style><![endif]-->		<!--[if IE 6]><style type="text/css">@import "/skins/OfflineNew/IE60Fixes.css?63";</style><![endif]-->		<!--[if IE 7]><style type="text/css">@import "/skins/OfflineNew/IE70Fixes.css?63";</style><![endif]-->		<!--[if lt IE 7]><script type="text/javascript" src="/skins/common/IEFixes.js?63"></script>		<meta http-equiv="imagetoolbar" content="no" /><![endif]-->		<script type= "text/javascript">/*<![CDATA[*/
var skin = "OfflineNew";
var stylepath = "/skins";
var wgArticlePath = "/index.php/$1";
var wgScriptPath = "";
var wgServer = "http://blitzetcetera.org/";
var wgCanonicalNamespace = "";
var wgCanonicalSpecialPageName = false;
var wgNamespaceNumber = 0;
var wgPageName = "Создание_двумерного_движка_на_примере_игры_«Зверские_колобки»";
var wgTitle = "Создание двумерного движка на примере игры «Зверские колобки»";
var wgAction = "view";
var wgArticleId = "662";
var wgIsArticle = true;
var wgUserName = null;
var wgUserGroups = null;
var wgUserLanguage = "ru";
var wgContentLanguage = "ru";
var wgBreakFrames = false;
var wgCurRevisionId = "3532";
/*]]>*/</script>
		<script type="text/javascript" src="2nq-6cel.js?63"><!-- wikibits js --></script>		<script type="text/javascript" src="http://blitzetcetera.org/index.php?title=-&amp;action=raw&amp;gen=js"><!-- site js --></script>		<style type="text/css">/*<![CDATA[*/
@import "http://blitzetcetera.org/index.php?title=MediaWiki:Common.css&amp;usemsgcache=yes&amp;action=raw&amp;ctype=text/css&amp;smaxage=18000";
@import "http://blitzetcetera.org/index.php?title=MediaWiki:OfflineNew.css&amp;usemsgcache=yes&amp;action=raw&amp;ctype=text/css&amp;smaxage=18000";
@import "http://blitzetcetera.org/index.php?title=-&amp;action=raw&amp;gen=css&amp;maxage=18000";
/*]]>*/</style>		<!-- Head Scripts -->	</head><body  class="mediawiki ns-0 ltr page-Создание_двумерного_движка_на_примере_игры_«Зверские_колобки»">	<div id="globalWrapper">	<div id="logocontainer">		<table align="center">		  <tr>				<td id="blitzetclogo">				</td>			</tr>		</table>	</div>	<div id="magbar">	Журнал о программированнии на языках Blitz3D, BlitzMax, BlitzPlus	</div>		<div id="column-content">	<div id="content">		<a name="top" id="top"></a>				<div id="bodyContent">		<table cellspacing=0 cellpadding=0 width=100%>			<tr>			  <td class="leftside">				</td>				<td class="sheetbody">					<h1 class="sheet">Создание двумерного движка на примере игры «Зверские колобки»</h1>			<h3 id="siteSub">Материал из Blitz Et Cetera.</h3>			<div id="contentSub">(Перенаправлено с <a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B4%D0%B2%D1%83%D0%BC%D0%B5%D1%80%D0%BD%D0%BE%D0%B3%D0%BE_%D0%B4%D0%B2%D0%B8%D0%B6%D0%BA%D0%B0_%D0%BD%D0%B0_%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D0%B5_%D0%B8%D0%B3%D1%80%D1%8B_%22%D0%97%D0%B2%D0%B5%D1%80%D1%81%D0%BA%D0%B8%D0%B5_%D0%BA%D0%BE%D0%BB%D0%BE%D0%B1%D0%BA%D0%B8%22&amp;redirect=no" title="Создание двумерного движка на примере игры &quot;Зверские колобки&quot;">Создание двумерного движка на примере игры &quot;Зверские колобки&quot;</a>)</div>			<!-- start content -->			<table id="toc" class="toc" summary="Содержание"><tr><td><div id="toctitle"><h2>Содержание</h2></div>
<ul>
<li class="toclevel-1"><a href="#.D0.92.D0.B2.D0.B5.D0.B4.D0.B5.D0.BD.D0.B8.D0.B5"><span class="tocnumber">1</span> <span class="toctext">Введение</span></a></li>
<li class="toclevel-1"><a href="#.D0.9E.D1.81.D0.BD.D0.BE.D0.B2.D1.8B"><span class="tocnumber">2</span> <span class="toctext">Основы</span></a></li>
<li class="toclevel-1"><a href="#.D0.91.D0.B0.D0.B7.D0.BE.D0.B2.D1.8B.D0.B9_.D0.B2.D0.B0.D1.80.D0.B8.D0.B0.D0.BD.D1.82"><span class="tocnumber">3</span> <span class="toctext">Базовый вариант</span></a></li>
<li class="toclevel-1"><a href="#.D0.A1.D0.BE.D0.B2.D0.B5.D1.80.D1.88.D0.B5.D0.BD.D1.81.D1.82.D0.B2.D1.83.D0.B5.D0.BC_.D1.81.D0.B8.D1.81.D1.82.D0.B5.D0.BC.D1.83"><span class="tocnumber">4</span> <span class="toctext">Совершенствуем систему</span></a></li>
<li class="toclevel-1"><a href="#.D0.90.D0.BB.D1.8C.D1.84.D0.B0-.D0.BA.D0.B0.D0.BD.D0.B0.D0.BB"><span class="tocnumber">5</span> <span class="toctext">Альфа-канал</span></a></li>
<li class="toclevel-1"><a href="#.D0.92.D1.8B.D0.B1.D0.BE.D1.80_.D0.B8.D1.81.D0.BF.D0.BE.D0.BB.D1.8C.D0.B7.D1.83.D0.B5.D0.BC.D1.8B.D1.85_.D0.BC.D0.BE.D0.B4.D1.83.D0.BB.D0.B5.D0.B9"><span class="tocnumber">6</span> <span class="toctext">Выбор используемых модулей</span></a></li>
<li class="toclevel-1"><a href="#.D0.92.D0.BA.D0.BB.D1.8E.D1.87.D0.B5.D0.BD.D0.B8.D0.B5_.D0.B4.D0.BE.D0.BF.D0.BE.D0.BB.D0.BD.D0.B8.D1.82.D0.B5.D0.BB.D1.8C.D0.BD.D1.8B.D1.85_.D1.84.D0.B0.D0.B9.D0.BB.D0.BE.D0.B2_.D0.B2_.D0.B7.D0.B0.D0.BF.D1.83.D1.81.D0.BA.D0.B0.D0.B5.D0.BC.D1.8B.D0.B9_.D1.84.D0.B0.D0.B9.D0.BB"><span class="tocnumber">7</span> <span class="toctext">Включение дополнительных файлов в запускаемый файл</span></a></li>
<li class="toclevel-1"><a href="#.D0.A3.D0.BF.D1.80.D0.B0.D0.B2.D0.BB.D0.B5.D0.BD.D0.B8.D0.B5_.D0.BA.D0.B0.D0.BC.D0.B5.D1.80.D0.BE.D0.B9_.D0.B8_.D0.B2.D1.82.D0.BE.D1.80.D0.BE.D0.B9_.D0.B2.D0.B0.D1.80.D0.B8.D0.B0.D0.BD.D1.82_.D0.BF.D1.80.D0.BE.D0.B3.D1.80.D0.B0.D0.BC.D0.BC.D1.8B"><span class="tocnumber">8</span> <span class="toctext">Управление камерой и второй вариант программы</span></a></li>
<li class="toclevel-1"><a href="#.D0.A1.D0.BE.D0.B7.D0.B4.D0.B0.D0.BD.D0.B8.D0.B5_.D0.B8.D0.B3.D1.80.D0.BE.D0.B2.D0.BE.D0.B3.D0.BE_.D0.BF.D0.BE.D0.BB.D1.8F"><span class="tocnumber">9</span> <span class="toctext">Создание игрового поля</span></a></li>
<li class="toclevel-1"><a href="#.D0.93.D0.B5.D0.BD.D0.B5.D1.80.D0.B0.D1.86.D0.B8.D1.8F_.D1.82.D0.B0.D0.B9.D0.BB.D0.BE.D0.B2_.D0.BF.D0.B5.D1.80.D0.B5.D1.85.D0.BE.D0.B4.D0.B0_.D0.BC.D0.B5.D0.B6.D0.B4.D1.83_.D0.B4.D0.B2.D1.83.D0.BC.D1.8F_.D1.82.D0.B5.D0.BA.D1.81.D1.82.D1.83.D1.80.D0.B0.D0.BC.D0.B8"><span class="tocnumber">10</span> <span class="toctext">Генерация тайлов перехода между двумя текстурами</span></a></li>
<li class="toclevel-1"><a href="#.D0.9F.D0.B5.D1.80.D0.B5.D0.BC.D0.B5.D1.89.D0.B5.D0.BD.D0.B8.D0.B5_.D0.BE.D0.B1.D1.8A.D0.B5.D0.BA.D1.82.D0.BE.D0.B2"><span class="tocnumber">11</span> <span class="toctext">Перемещение объектов</span></a></li>
<li class="toclevel-1"><a href="#.D0.9F.D0.BE.D0.BB.D0.BE.D1.81.D0.B0_.D0.BE.D1.82.D0.BE.D0.B1.D1.80.D0.B0.D0.B6.D0.B5.D0.BD.D0.B8.D1.8F_.D1.85.D0.BE.D0.B4.D0.B0_.D0.BF.D1.80.D0.BE.D1.86.D0.B5.D1.81.D1.81.D0.B0"><span class="tocnumber">12</span> <span class="toctext">Полоса отображения хода процесса</span></a></li>
<li class="toclevel-1"><a href="#.D0.9A.D0.BE.D0.BB.D0.BB.D0.B8.D0.B7.D0.B8.D1.8F"><span class="tocnumber">13</span> <span class="toctext">Коллизия</span></a></li>
<li class="toclevel-1"><a href="#.D0.A2.D0.B0.D0.B9.D0.BB.D0.BE.D0.B2.D1.8B.D0.B9_.D1.81.D0.BB.D0.BE.D0.B9_.D0.BA.D0.BE.D0.BB.D0.BB.D0.B8.D0.B7.D0.B8.D0.B8"><span class="tocnumber">14</span> <span class="toctext">Тайловый слой коллизии</span></a></li>
<li class="toclevel-1"><a href="#.D0.9A.D0.BE.D0.BB.D0.BB.D0.B8.D0.B7.D0.B8.D1.8F_.D0.BE.D0.B1.D1.8A.D0.B5.D0.BA.D1.82.D0.BE.D0.B2"><span class="tocnumber">15</span> <span class="toctext">Коллизия объектов</span></a></li>
<li class="toclevel-1"><a href="#.D0.A0.D0.B0.D1.81.D1.88.D0.B8.D1.80.D0.B5.D0.BD.D0.B8.D1.8F_.D0.B1.D0.B0.D0.B7.D0.BE.D0.B2.D1.8B.D1.85_.D0.BE.D0.B1.D1.8A.D0.B5.D0.BA.D1.82.D0.BE.D0.B2"><span class="tocnumber">16</span> <span class="toctext">Расширения базовых объектов</span></a></li>
<li class="toclevel-1"><a href="#.D0.91.D0.BB.D1.83.D0.B6.D0.B4.D0.B0.D0.BD.D0.B8.D0.B5_.D0.BA.D0.BE.D0.BB.D0.BE.D0.B1.D0.BA.D0.BE.D0.B2"><span class="tocnumber">17</span> <span class="toctext">Блуждание колобков</span></a></li>
<li class="toclevel-1"><a href="#.D0.A1.D1.82.D1.80.D0.B5.D0.BB.D1.8C.D0.B1.D0.B0"><span class="tocnumber">18</span> <span class="toctext">Стрельба</span></a></li>
<li class="toclevel-1"><a href="#.D0.98.D0.B3.D1.80.D0.B0"><span class="tocnumber">19</span> <span class="toctext">Игра</span></a></li>
<li class="toclevel-1"><a href="#.D0.9F.D0.BE.D0.BB.D1.83.D1.87.D0.B5.D0.BD.D0.B8.D0.B5_.D0.BF.D0.BE.D0.B2.D1.80.D0.B5.D0.B6.D0.B4.D0.B5.D0.BD.D0.B8.D0.B9_.D0.B8_.D1.80.D0.B0.D0.B7.D1.80.D1.83.D1.88.D0.B5.D0.BD.D0.B8.D0.B5"><span class="tocnumber">20</span> <span class="toctext">Получение повреждений и разрушение</span></a></li>
<li class="toclevel-1"><a href="#.D0.98.D0.B3.D1.80.D0.BE.D0.BA"><span class="tocnumber">21</span> <span class="toctext">Игрок</span></a></li>
<li class="toclevel-1"><a href="#.D0.A5.D0.B0.D1.80.D0.B0.D0.BA.D1.82.D0.B5.D1.80.D0.B8.D1.81.D1.82.D0.B8.D0.BA.D0.B8_.D0.BA.D0.BE.D0.BB.D0.BE.D0.B1.D0.BA.D0.BE.D0.B2"><span class="tocnumber">22</span> <span class="toctext">Характеристики колобков</span></a></li>
<li class="toclevel-1"><a href="#.D0.92.D1.80.D0.B0.D0.B3.D0.B8:_.D0.B4.D0.B2.D0.B8.D0.B6.D0.B5.D0.BD.D0.B8.D0.B5_.D0.BA_.D0.B8.D0.B3.D1.80.D0.BE.D0.BA.D1.83.2C_.D1.83.D0.BA.D1.83.D1.81.D1.8B.2C_.D1.81.D1.82.D1.80.D0.B5.D0.BB.D1.8C.D0.B1.D0.B0_.D0.B2_.D0.BD.D0.B5.D0.B3.D0.BE"><span class="tocnumber">23</span> <span class="toctext">Враги: движение к игроку, укусы, стрельба в него</span></a></li>
<li class="toclevel-1"><a href="#.D0.91.D0.BE.D0.BD.D1.83.D1.81.D1.8B"><span class="tocnumber">24</span> <span class="toctext">Бонусы</span></a></li>
<li class="toclevel-1"><a href="#.D0.A7.D0.B0.D1.81.D1.82.D0.B8.D1.86.D1.8B:_.D1.80.D0.B0.D0.B7.D1.80.D1.83.D1.88.D0.B5.D0.BD.D0.B8.D0.B5_.D1.8F.D1.89.D0.B8.D0.BA.D0.BE.D0.B2"><span class="tocnumber">25</span> <span class="toctext">Частицы: разрушение ящиков</span></a></li>
<li class="toclevel-1"><a href="#.D0.92.D1.80.D0.B5.D0.BC.D0.B5.D0.BD.D0.BD.D1.8B.D0.B5_.D1.81.D0.BE.D1.81.D1.82.D0.BE.D1.8F.D0.BD.D0.B8.D1.8F"><span class="tocnumber">26</span> <span class="toctext">Временные состояния</span></a></li>
<li class="toclevel-1"><a href="#.D0.98.D0.B3.D1.80.D0.BE.D0.BA:_.D1.82.D0.B5.D0.BB.D0.B5.D0.BF.D0.BE.D1.80.D1.82.D0.B0.D1.86.D0.B8.D1.8F.2C_.D0.A1.D0.B8.D0.BB.D0.B0"><span class="tocnumber">27</span> <span class="toctext">Игрок: телепортация, Сила</span></a></li>
<li class="toclevel-1"><a href="#.D0.97.D0.B0.D0.BA.D0.BB.D1.8E.D1.87.D0.B5.D0.BD.D0.B8.D0.B5"><span class="tocnumber">28</span> <span class="toctext">Заключение</span></a></li>
</ul>
</td></tr></table><script type="text/javascript"> if (window.showTocToggle) { var tocShowText = "показать"; var tocHideText = "убрать"; showTocToggle(); } </script>
<a name=".D0.92.D0.B2.D0.B5.D0.B4.D0.B5.D0.BD.D0.B8.D0.B5"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B4%D0%B2%D1%83%D0%BC%D0%B5%D1%80%D0%BD%D0%BE%D0%B3%D0%BE_%D0%B4%D0%B2%D0%B8%D0%B6%D0%BA%D0%B0_%D0%BD%D0%B0_%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D0%B5_%D0%B8%D0%B3%D1%80%D1%8B_%C2%AB%D0%97%D0%B2%D0%B5%D1%80%D1%81%D0%BA%D0%B8%D0%B5_%D0%BA%D0%BE%D0%BB%D0%BE%D0%B1%D0%BA%D0%B8%C2%BB&amp;action=edit&amp;section=1" title="Править секцию: Введение">править</a>]</span> <span class="mw-headline">Введение</span></h2>
<p>В течение последнего десятка лет можно было наблюдать, как игры с трехмерной графикой методично вытесняют двумерные из всех игровых жанров (даже тех, где, казалось бы, трехмерная графика будет явным излишеством). Начав с космо/авиа/автоимитаторов и боевиков, трехмерщина проникла в ролевые игры, квесты, стратегии, аркады. Даже головоломки, карточные и настольные игры теперь вовсю стремятся блеснуть 3D-антуражом. На прилавках магазинов уже днем с огнем не сыщешь игру, где нельзя было бы повертеть камерой. Однако, двумерщина еще живет (и даже припеваючи) на дисплеях сотовых телефонов и в Shareware-секторе. Трудно выделиться среди огромного наследия двумерных игр, но все еще попадаются жемчужины наподобие Gish, Crimsonland или Zuma, вполне оригинальные и успешно продающиеся.
</p><p>Вообще, никто бы не создавал сейчас двумерные игры, кроме ностальгирующих по старым добрым временам ZX Speccy и японских ролевиков, если бы не две детали: двумерные игры проще делать и они неприхотливы к ресурсам. А результат может получиться весьма интересным, что я и попробую вам продемонстрировать в этой статье. Впрочем, механизмы, рассмотренные здесь, могут заинтересовать и трехмерщиков, ведь действие многих трехмерных игр происходит все-таки на двумерной поверхности.
</p>
<a name=".D0.9E.D1.81.D0.BD.D0.BE.D0.B2.D1.8B"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B4%D0%B2%D1%83%D0%BC%D0%B5%D1%80%D0%BD%D0%BE%D0%B3%D0%BE_%D0%B4%D0%B2%D0%B8%D0%B6%D0%BA%D0%B0_%D0%BD%D0%B0_%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D0%B5_%D0%B8%D0%B3%D1%80%D1%8B_%C2%AB%D0%97%D0%B2%D0%B5%D1%80%D1%81%D0%BA%D0%B8%D0%B5_%D0%BA%D0%BE%D0%BB%D0%BE%D0%B1%D0%BA%D0%B8%C2%BB&amp;action=edit&amp;section=2" title="Править секцию: Основы">править</a>]</span> <span class="mw-headline">Основы</span></h2>
<p>С незапамятных времен повелось так, что в двумерной графике выделяют два основных элемента - тайл и спрайт. Слова эти уже стали частью компьютерного сленга, поэтому лучше называть их по-английски во избежание путаницы.
</p><p>Тайл - это квадратный (очень редко - прямоугольный, тре- или шестиугольный) кусок, которым заполняется игровое пространство (в переводе - кафель, да, очень похоже). Изображения тайлов берутся из набора, который предварительно рисуют и загружают либо генерируют. Также создается т. н. карта тайлов - грубо - двумерный массив, в каждой ячейке которого стоит номер тайла из набора. Поэтому, для отображения тайлового поля достаточно пройтись циклом по всем ячейкам массива тайловой карты и нарисовать тайл под номером, взятым из этой ячейки, в соотв. координатах. Координаты вычисляются по следующим формулам:
</p>
<ul><li>X<sub>Экрана</sub> = X<sub>ТайловойКарты</sub> * РазмерТайлаВПикселах + X<sub>ОтступВПикселах</sub>
</li><li>Y<sub>Экрана</sub> = Y<sub>ТайловойКарты</sub> * РазмерТайлаВПикселах + Y<sub>ОтступВПикселах</sub>
</li></ul>
<p>Отступы позволяют перемещать обзор поля либо поместить его в центре экрана.
</p><p>Возня с тайлами обусловлена тем, что рисовать поле целиком - это часто непозволительная трата дискового пространства, времени на загрузку и отображение (особенно для больших уровней), к тому же, нарисовать тайлы, а затем распихать их по десятку больших карт зачастую удобнее, чем рисовать все целиком. Однако, тайловое поле приобретает некую блочность и однообразие, поэтому иногда обходятся без тайлов (Another World, Postal).
</p><p>Теперь, объясню, что же такое спрайт. Это произвольный объект, который может располагаться в любой части поля и перемещаться по нему. Это игрок, монстры, некоторые объекты интерьера, NPC и т. д. В простой модели спрайт отображается в своих координатах минус отступ.
</p>
<a name=".D0.91.D0.B0.D0.B7.D0.BE.D0.B2.D1.8B.D0.B9_.D0.B2.D0.B0.D1.80.D0.B8.D0.B0.D0.BD.D1.82"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B4%D0%B2%D1%83%D0%BC%D0%B5%D1%80%D0%BD%D0%BE%D0%B3%D0%BE_%D0%B4%D0%B2%D0%B8%D0%B6%D0%BA%D0%B0_%D0%BD%D0%B0_%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D0%B5_%D0%B8%D0%B3%D1%80%D1%8B_%C2%AB%D0%97%D0%B2%D0%B5%D1%80%D1%81%D0%BA%D0%B8%D0%B5_%D0%BA%D0%BE%D0%BB%D0%BE%D0%B1%D0%BA%D0%B8%C2%BB&amp;action=edit&amp;section=3" title="Править секцию: Базовый вариант">править</a>]</span> <span class="mw-headline">Базовый вариант</span></h2>
<p>Чтобы понять, что такое типы, списки и как с ними работать, рекомендую прочитать <a href="http://blitzetc.viewport.info/add/wave.htm" class="external text" title="http://blitzetc.viewport.info/add/wave.htm" rel="nofollow">Руководство по BlitzMax для начинающих</a>. То же относится и к тем, кто программировал только в Blitz3D или BlitzPlus, но не в BlitzMax - в руководстве описываются некоторые различия в синтаксах этих языков (кстати, в MaxIDE есть полезная опция - импортировать код Blitz3D / BlitzPlus: File - Import BB Project). Добавлю одну не документированную, но удобную вещь: следующий код:
</p>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #ffff00; font-weight: bold;">For</span> x = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">To</span> width - <span style="color: #FFFFFF;">1</span><br />
<p>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Print</span> x<br />
</p>
<span style="color: #ffff00; font-weight: bold;">Next</span></div>
<p>можно заменить на такой:
</p>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #ffff00; font-weight: bold;">For</span> x = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> width<br />
<p>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Print</span> x<br />
</p>
<span style="color: #ffff00; font-weight: bold;">Next</span></div>
<p>Давайте попробуем изобразить на экране тайловое поле со спрайтами. Добавим еще счетчик кадров в секунду.
</p>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #ffff00; font-weight: bold;">Const</span> sxsize = <span style="color: #FFFFFF;">800</span>, sysize = <span style="color: #FFFFFF;">600</span>, color_depth = <span style="color: #FFFFFF;">32</span> <span style="color: #B1E7EB;">' Размеры экрана и глубина цвета</span><br />
<p><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> tilesize = <span style="color: #FFFFFF;">64</span> <span style="color: #B1E7EB;">' Размер тайла / спрайта</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Const</span> fxsize = <span style="color: #FFFFFF;">80</span>, fysize = <span style="color: #FFFFFF;">60</span> <span style="color: #B1E7EB;">' Размеры поля в тайлах </span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Const</span> objq = <span style="color: #FFFFFF;">200</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Global</span> frame<span style=" ">&#91;</span>fxsize, fysize<span style=" ">&#93;</span> <span style="color: #B1E7EB;">' Номера тайлов для каждой клетки</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> imageq = <span style="color: #FFFFFF;">25</span> <span style="color: #B1E7EB;">' Kол-во изображений в наборе</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> tileq = <span style="color: #FFFFFF;">3</span> <span style="color: #B1E7EB;">' Kол-во тайлов в наборе</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Type</span> obj<br />
&nbsp;<span style="color: #ffff00; font-weight: bold;">Field</span> x, y, frame, angle#, size#, r, g, b<br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Type</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">SeedRnd</span> <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Для того, чтобы каждый раз получать новую последовательность случайных чисел</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">SetGraphicsDriver</span> <span style="color: #ffff00; font-weight: bold;">GLMax2DDriver</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Установка драйвера отображения графики OpenGL</span><br />
<span style="color: #ffff00; font-weight: bold;">Graphics</span> sxsize, sysize, color_depth<br />
<span style="color: #ffff00; font-weight: bold;">SetMaskColor</span> <span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">0</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Cls</span><br />
<span style="color: #ffff00; font-weight: bold;">DrawImage</span> <span style="color: #ffff00; font-weight: bold;">LoadImage</span><span style=" ">&#40;</span><span style="color: #00FF66;">&quot;2DEngine-Images.png&quot;</span><span style=" ">&#41;</span>, <span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">0</span><br />
images = <span style="color: #ffff00; font-weight: bold;">CreateImage</span><span style=" ">&#40;</span>tilesize, tilesize, imageq<span style=" ">&#41;</span><br />
<br />
<span style="color: #B1E7EB;">' Вырезаем текстуры для тайлов</span><br />
<span style="color: #ffff00; font-weight: bold;">For</span> n = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">To</span> imageq - <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">GrabImage</span> images, tilesize * <span style=" ">&#40;</span>n <span style="color: #ffff00; font-weight: bold;">Mod</span> <span style="color: #FFFFFF;">4</span><span style=" ">&#41;</span>, tilesize * <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>n / <span style="color: #FFFFFF;">4</span><span style=" ">&#41;</span>, n<br />
<span style="color: #ffff00; font-weight: bold;">Next</span><br />
<br />
<span style="color: #B1E7EB;">' Генерируем поле</span><br />
<span style="color: #ffff00; font-weight: bold;">For</span> y = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> fysize<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> x = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> fxsize<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; frame<span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> = <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, tileq - <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
<span style="color: #ffff00; font-weight: bold;">Next</span><br />
<br />
objs:<span style="color: #ffff00; font-weight: bold;">TList</span> = <span style="color: #ffff00; font-weight: bold;">CreateList</span><span style=" ">&#40;</span><span style=" ">&#41;</span><br />
<span style="color: #ffff00; font-weight: bold;">For</span> n = <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">To</span> objq<br />
&nbsp; &nbsp; &nbsp; &nbsp; o:obj = <span style="color: #ffff00; font-weight: bold;">New</span> obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">x</span> = <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style=" ">&#40;</span>fxsize - <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span> * tilesize<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">y</span> = <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style=" ">&#40;</span>fysize - <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span> * tilesize<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">size</span># = <span style="color: #ffff00; font-weight: bold;">Rnd</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0.5</span>, <span style="color: #FFFFFF;">1.0</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">angle</span># = <span style="color: #ffff00; font-weight: bold;">Rnd</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0.0</span>, <span style="color: #FFFFFF;">360.0</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">r</span> = <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">255</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">g</span> = <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">255</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">b</span> = <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">255</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">frame</span> = <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span>tileq, imageq - <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; objs.<span style="">addlast</span> o<br />
<span style="color: #ffff00; font-weight: bold;">Next</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">HideMouse</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Repeat</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> y = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> fysize<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; yy = tilesize * y + fdy<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> x = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> fxsize<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xx = tilesize * x + fdx<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawImage</span> images, xx, yy, frame<span style=" ">&#91;</span>x, y<span style=" ">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> o:obj = <span style="color: #ffff00; font-weight: bold;">EachIn</span> objs<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetColor</span> o.<span style="">r</span>, o.<span style="">g</span>, o.<span style="">b</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetRotation</span> o.<span style="">angle</span>#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetScale</span> o.<span style="">size</span>#, o.<span style="">size</span>#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawImage</span> images, o.<span style="">x</span> + fdx, o.<span style="">y</span> + fdy, o.<span style="">frame</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetColor</span> <span style="color: #FFFFFF;">255</span>, <span style="color: #FFFFFF;">255</span>, <span style="color: #FFFFFF;">255</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetScale</span> <span style="color: #FFFFFF;">1.0</span>, <span style="color: #FFFFFF;">1.0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetRotation</span> <span style="color: #FFFFFF;">0.0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; fdx = fdx + <span style="color: #FFFFFF;">4</span> * <span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">KeyDown</span><span style=" ">&#40;</span>KEY_LEFT<span style=" ">&#41;</span> - <span style="color: #ffff00; font-weight: bold;">KeyDown</span><span style=" ">&#40;</span>KEY_RIGHT<span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; fdy = fdy + <span style="color: #FFFFFF;">4</span> * <span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">KeyDown</span><span style=" ">&#40;</span>KEY_UP<span style=" ">&#41;</span> - <span style="color: #ffff00; font-weight: bold;">KeyDown</span><span style=" ">&#40;</span>KEY_DOWN<span style=" ">&#41;</span><span style=" ">&#41;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Обновление счетчика кадров в секунду</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> fpstim&lt;= <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fpstim = <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> + <span style="color: #FFFFFF;">1000</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fps = cnt<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cnt = <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cnt:<span style="color: #FFFFFF;">+1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawText</span> <span style="color: #00FF66;">&quot;Frames/sec:&quot;</span> + fps, <span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Flip</span> <span style="color: #ffff00; font-weight: bold;">False</span><br />
<br />
</p>
<span style="color: #ffff00; font-weight: bold;">Until</span> <span style="color: #ffff00; font-weight: bold;">KeyHit</span><span style=" ">&#40;</span>KEY_ESCAPE<span style=" ">&#41;</span></div>
<p>Изображения будем вырезать из этого набора:
</p>
<div class="center"><div class="floatnone"><span><a href="http://blitzetcetera.org/index.php/%D0%98%D0%B7%D0%BE%D0%B1%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5:2DEngine-Images.png" class="image" title=""><img alt="" longdesc="http://blitzetcetera.org/index.php/%D0%98%D0%B7%D0%BE%D0%B1%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5:2DEngine-Images.png" src="im-1swz5.png" width="256" height="448" /></a></span></div></div>
<a name=".D0.A1.D0.BE.D0.B2.D0.B5.D1.80.D1.88.D0.B5.D0.BD.D1.81.D1.82.D0.B2.D1.83.D0.B5.D0.BC_.D1.81.D0.B8.D1.81.D1.82.D0.B5.D0.BC.D1.83"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B4%D0%B2%D1%83%D0%BC%D0%B5%D1%80%D0%BD%D0%BE%D0%B3%D0%BE_%D0%B4%D0%B2%D0%B8%D0%B6%D0%BA%D0%B0_%D0%BD%D0%B0_%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D0%B5_%D0%B8%D0%B3%D1%80%D1%8B_%C2%AB%D0%97%D0%B2%D0%B5%D1%80%D1%81%D0%BA%D0%B8%D0%B5_%D0%BA%D0%BE%D0%BB%D0%BE%D0%B1%D0%BA%D0%B8%C2%BB&amp;action=edit&amp;section=4" title="Править секцию: Совершенствуем систему">править</a>]</span> <span class="mw-headline">Совершенствуем систему</span></h2>
<p>А теперь попробуйте увеличить поле и кол-во объектов раз этак в 4. Тормоза становятся заметными уже невооруженным глазом. Вот и первый минус подхода "в лоб" - рисуется слишком много изображений (если быть точным, то (80 * 60 + 200) * 4 = 20000). Но ведь подавляющее большинство тайлов и объектов выходят за пределы экрана, значит, их можно как-нибудь отфильтровать.
</p><p>Начнем с тайлов. Давайте сразу введем переменную масштаба, чтобы можно было удалять / приближать поле. Теперь нужно определиться с трансформацией системы координат из координат поля в экранные координаты. Экранная система координат имеет начало (0, 0) в верхнем левом углу экрана, единица измерения - пиксел. Заметьте, что ее ось OY направлена не вверх, как в школьных учебниках, а вниз. Зададим координатную систему поля подобным образом: начало - верхний левый угол поля, единица измерения - тайл, ось OY направлена вниз. Значит, функции перехода будут выглядеть следующим образом (2 это на сленге "to", использую цифру, потому что она хорошо разделяет два слова):
</p>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #B1E7EB;">' Перевод из экранных координат в тайловые</span><br />
<p><span style="color: #ffff00; font-weight: bold;">Function</span> scr2field<span style=" ">&#40;</span>sx#, sy#, tx# <span style="color: #ffff00; font-weight: bold;">Var</span>, ty# <span style="color: #ffff00; font-weight: bold;">Var</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; tx# = sx# / sc# + fdx#<br />
&nbsp; &nbsp; &nbsp; &nbsp; ty# = sy# / sc# + fdy#<br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Перевод из тайловых координат в экранные</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> field2scr<span style=" ">&#40;</span>tx#, ty#, sx# <span style="color: #ffff00; font-weight: bold;">Var</span>, sy# <span style="color: #ffff00; font-weight: bold;">Var</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; sx = <span style=" ">&#40;</span>tx# - fdx#<span style=" ">&#41;</span> * sc#<br />
&nbsp; &nbsp; &nbsp; &nbsp; sy = <span style=" ">&#40;</span>ty# - fdy#<span style=" ">&#41;</span> * sc#<br />
</p>
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span></div>
<p>Все очень просто: переводим координаты верхнего левого угла экрана (0, 0) в координаты поля (х1#, y1#), и координаты нижнего правого угла экрана (sxsize - 1, sysize - 1) в соотв. (x2#, y2#). Затем округляем x1# и y1# в меньшую, а x2# и y2# - в большую сторону и рисуем тайлы в прямоугольном диапазоне (x1#, y1#) - (x2#, y2#). Округление нужно, чтобы в диапазон попали и частично видимые на экране тайлы. Передача переменных из подпрограммы, как вы могли заметить, реализуется добавлением после имени переменной в списке переменных функции ключевого слова "Var".
</p><p>Теперь объекты. Тут уже все не так просто. Ведь каждый объект может быть в любой точке поля, проверять все объекты на нахождение в пределах экрана - непозволительная трата ресурсов. А что будет, когда начнутся проверки на столкновения! Проверять каждый раз каждый объект с каждым (n * n / 2 проверок)? Это не подходит, поэтому сделаем вот что: привяжем к каждому тайлу список и будем заносить в него все объекты, которые располагаются на этом тайле. Тогда для того, чтобы узнать, какие объекты попадут в видимую область поля, достаточно просмотреть все списки для тайлов диапазона (x1# - r#, y1# - r#) - (x2# + r#, y2# + r#), где r# - максимальный радиус объекта (значения округляются аналогично). Для простоты не будем использовать объекты размером больше тайла (т.е с радиусом больше 0.5, r# = 0.5). Уточню, что объекты в таком случае целесообразней "отцентровать", т.е. сделать так, чтобы при отображении на экране командой DrawImage(i, x, y), координаты (x, y) соответствовали не верхнему левому углу объекта, а его центру. Для этого есть функция MidHandle(image).
</p><p>Второй недостаток: представим, что возникла необходимость добавить в игру новый тип объектов, например облака. Если мы просто добавим их в список объектов, то объекты, относящиеся к следующим тайлам смогут слегка наползать на облака, а ведь надо, чтобы облака всегда рисовались поверх остальных объектов. Придется "отделить мух от котлет", т. е. в первом цикле рисовать "наземные" объекты, а во втором - облака. То есть сделать слой облаков и слой других объектов. Дальше - больше. Возможно, в конечном счете, придется отображать подряд несколько слоев объектов, вкрапляя между ними тайловые слои. Поэтому не будем нагромождать циклы, а просто создадим тип "слой", а затем сделаем два расширения этого базового типа - "тайловый слой" и "слой объектов". Для каждого слоя будет свой метод Draw, выводящий слой на экран. Если вы еще не знаете, что такое "типы", "расширения типов", "методы" и что с ними можно делать, самое время прочитать соотв. главы руководства (см. выше). Полезно будет создать и базовый тип для объектов, а потом расширять его, добавляя переменные и замещая методы. Также, создадим список, содержащий слои в порядке их отображения, в этом случае для отрисовки достаточно следующего цикла:
</p>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #ffff00; font-weight: bold;">For</span> l:layer_obj = <span style="color: #ffff00; font-weight: bold;">EachIn</span> layer_order<br />
<p>&nbsp; &nbsp; &nbsp; &nbsp; l.<span style="">draw</span><br />
</p>
<span style="color: #ffff00; font-weight: bold;">Next</span></div>
<a name=".D0.90.D0.BB.D1.8C.D1.84.D0.B0-.D0.BA.D0.B0.D0.BD.D0.B0.D0.BB"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B4%D0%B2%D1%83%D0%BC%D0%B5%D1%80%D0%BD%D0%BE%D0%B3%D0%BE_%D0%B4%D0%B2%D0%B8%D0%B6%D0%BA%D0%B0_%D0%BD%D0%B0_%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D0%B5_%D0%B8%D0%B3%D1%80%D1%8B_%C2%AB%D0%97%D0%B2%D0%B5%D1%80%D1%81%D0%BA%D0%B8%D0%B5_%D0%BA%D0%BE%D0%BB%D0%BE%D0%B1%D0%BA%D0%B8%C2%BB&amp;action=edit&amp;section=5" title="Править секцию: Альфа-канал">править</a>]</span> <span class="mw-headline">Альфа-канал</span></h2>
<p>"Что сие такое?" - спросит неискушенный программист. Альфа-канал - это дополнительный коэффициент (к оттенкам красного, зеленого и синего), указывающий, насколько прозрачен данный пиксел. Стандартный диапазон - от 0 (полностью прозрачный) до 255 (полностью непрозрачный). Соответственно, при 128 пиксел будет наполовину прозрачным и в (почти) равных пропорциях смешается с фоновым при наложении. Данная компонента не только избавляет вас от необходимости использовать "маску", но и добавляет возможность использования многих интересных эффектов, вроде anti-aliasing (сглаживания краев). Если кто не в курсе: маска служит для того, чтобы не печатать некоторые пискелы, например, черные пискелы вокруг колобков из предыдущего примера - попробуйте закомментировать команду "SetMaskColor" и увидите разницу.
</p><p>Альфа-канал можно добавить в рисунки с помощью, например, Adobe Photoshop, но сделаем по-другому (для тех, у кого нет дистрибутива или навыков работы в этом очень мощном, но непростом для понимания редакторе): напишем утилиту, создающую из двух изображений - обычного цветного рисунка и изображения альфа канала в оттенках серого, где белый цвет означает полную непрозрачность, а черный - полную прозрачность:
</p>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;">images = <span style="color: #ffff00; font-weight: bold;">LoadPixmapPNG</span><span style=" ">&#40;</span><span style="color: #00FF66;">&quot;2DEngine-Images.png&quot;</span><span style=" ">&#41;</span><br />
<p>xsize = <span style="color: #ffff00; font-weight: bold;">PixmapWidth</span><span style=" ">&#40;</span>images<span style=" ">&#41;</span><br />
ysize = <span style="color: #ffff00; font-weight: bold;">PixmapHeight</span><span style=" ">&#40;</span>images<span style=" ">&#41;</span><br />
images_alpha = <span style="color: #ffff00; font-weight: bold;">LoadPixmapPNG</span><span style=" ">&#40;</span><span style="color: #00FF66;">&quot;2DEngine-ImagesAlpha.png&quot;</span><span style=" ">&#41;</span><br />
new_images = <span style="color: #ffff00; font-weight: bold;">CreatePixmap</span><span style=" ">&#40;</span>xsize, ysize, PF_RGBA8888<span style=" ">&#41;</span><br />
<span style="color: #ffff00; font-weight: bold;">For</span> y = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> ysize<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> x = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> xsize<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">WritePixel</span> new_images, x, y, <span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">ReadPixel</span><span style=" ">&#40;</span>images, x, y<span style=" ">&#41;</span> &amp; $FFFFFF<span style=" ">&#41;</span> |..<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style=""><span style=" ">&#40;</span></span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">ReadPixel</span><span style=" ">&#40;</span>images_alpha, x, y<span style=" ">&#41;</span> &amp; $FF<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Shl</span> <span style="color: #FFFFFF;">24</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
<span style="color: #ffff00; font-weight: bold;">Next</span><br />
<span style="color: #ffff00; font-weight: bold;">SavePixmapPNG</span> new_images, <span style="color: #00FF66;">&quot;2DEngine-NewImages.png&quot;</span>, <span style="color: #FFFFFF;">9</span><br />
</p>
<span style="color: #ffff00; font-weight: bold;">DebugLog</span> <span style="color: #00FF66;">&quot;Done!&quot;</span></div>
<p>Вот альфа-канал:
</p>
<div class="center"><div class="floatnone"><span><a href="http://blitzetcetera.org/index.php/%D0%98%D0%B7%D0%BE%D0%B1%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5:2DEngine-ImagesAlpha.png" class="image" title=""><img alt="" longdesc="http://blitzetcetera.org/index.php/%D0%98%D0%B7%D0%BE%D0%B1%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5:2DEngine-ImagesAlpha.png" src="-bi2q-rb.png" width="256" height="448" /></a></span></div></div>
<p>Просто запустите утилиту в папке с двумя изображениями (2DEngine-Images.png и 2DEngine-ImagesAlpha.png), чтобы создать изображение с цветами и альфа-каналом (2DEngine-NewImages.png).
</p>
<a name=".D0.92.D1.8B.D0.B1.D0.BE.D1.80_.D0.B8.D1.81.D0.BF.D0.BE.D0.BB.D1.8C.D0.B7.D1.83.D0.B5.D0.BC.D1.8B.D1.85_.D0.BC.D0.BE.D0.B4.D1.83.D0.BB.D0.B5.D0.B9"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B4%D0%B2%D1%83%D0%BC%D0%B5%D1%80%D0%BD%D0%BE%D0%B3%D0%BE_%D0%B4%D0%B2%D0%B8%D0%B6%D0%BA%D0%B0_%D0%BD%D0%B0_%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D0%B5_%D0%B8%D0%B3%D1%80%D1%8B_%C2%AB%D0%97%D0%B2%D0%B5%D1%80%D1%81%D0%BA%D0%B8%D0%B5_%D0%BA%D0%BE%D0%BB%D0%BE%D0%B1%D0%BA%D0%B8%C2%BB&amp;action=edit&amp;section=6" title="Править секцию: Выбор используемых модулей">править</a>]</span> <span class="mw-headline">Выбор используемых модулей</span></h2>
<p>Не очень приятно, когда запускаемый файл простенькой демошки занимает больше мегабайта. Так получается из-за того, что по умолчанию компилятор включает в файл все модули. Для уменьшения размера exe-файла, нужно указать, какие модули компилировать. Команда Framework указывает базовый модуль, в нашем случае это двумерный движок. Другие модули подключаются командой Import. Вот, что нам сейчас понадобится:
</p>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #ffff00; font-weight: bold;">Framework</span> brl.<span style="">glmax2d</span> <span style="color: #B1E7EB;">' Базовый модуль - движок на основе OpenGL</span><br />
<p><span style="color: #ffff00; font-weight: bold;">Import</span> brl.<span style="">random</span> <span style="color: #B1E7EB;">' Генератор случайных чисел</span><br />
<span style="color: #ffff00; font-weight: bold;">Import</span> BRL.<span style="">Basic</span> <span style="color: #B1E7EB;">' Из этого модуля используется команда Incbin</span><br />
</p>
<span style="color: #ffff00; font-weight: bold;">Import</span> BRL.<span style="">PNGLoader</span> <span style="color: #B1E7EB;">' Загрузка PNG-изображений</span></div>
<a name=".D0.92.D0.BA.D0.BB.D1.8E.D1.87.D0.B5.D0.BD.D0.B8.D0.B5_.D0.B4.D0.BE.D0.BF.D0.BE.D0.BB.D0.BD.D0.B8.D1.82.D0.B5.D0.BB.D1.8C.D0.BD.D1.8B.D1.85_.D1.84.D0.B0.D0.B9.D0.BB.D0.BE.D0.B2_.D0.B2_.D0.B7.D0.B0.D0.BF.D1.83.D1.81.D0.BA.D0.B0.D0.B5.D0.BC.D1.8B.D0.B9_.D1.84.D0.B0.D0.B9.D0.BB"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B4%D0%B2%D1%83%D0%BC%D0%B5%D1%80%D0%BD%D0%BE%D0%B3%D0%BE_%D0%B4%D0%B2%D0%B8%D0%B6%D0%BA%D0%B0_%D0%BD%D0%B0_%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D0%B5_%D0%B8%D0%B3%D1%80%D1%8B_%C2%AB%D0%97%D0%B2%D0%B5%D1%80%D1%81%D0%BA%D0%B8%D0%B5_%D0%BA%D0%BE%D0%BB%D0%BE%D0%B1%D0%BA%D0%B8%C2%BB&amp;action=edit&amp;section=7" title="Править секцию: Включение дополнительных файлов в запускаемый файл">править</a>]</span> <span class="mw-headline">Включение дополнительных файлов в запускаемый файл</span></h2>
<p>Чтобы не таскать вместе с exeшником кучу директорий и файлов, их можно включить в исполняемый файл. Делается это командой Incbin. Тогда перед связкой путь+имя файла в командах открытия/загрузки ставится "incbin::". При этом, файлы, естественно, нельзя изменять. Не используйте фиксированные пути (типа "D:/games/my_game/2DEngine-Image.png") и не забудьте подключить модуль BRL.Basic, если не пользуетесь набором модулей по умолчанию.
</p>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #ffff00; font-weight: bold;">Incbin</span> <span style="color: #00FF66;">&quot;2DEngine-2DEngine-Image.png&quot;</span> <span style="color: #B1E7EB;">' Сохраняем в exe-файле изображение</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> image:TImage = <span style="color: #ffff00; font-weight: bold;">LoadImage</span><span style=" ">&#40;</span><span style="color: #00FF66;">&quot;incbin::2DEngine-Images.png&quot;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Загружаем изображение из exe-файла</span></div>
<p><br />
</p>
<a name=".D0.A3.D0.BF.D1.80.D0.B0.D0.B2.D0.BB.D0.B5.D0.BD.D0.B8.D0.B5_.D0.BA.D0.B0.D0.BC.D0.B5.D1.80.D0.BE.D0.B9_.D0.B8_.D0.B2.D1.82.D0.BE.D1.80.D0.BE.D0.B9_.D0.B2.D0.B0.D1.80.D0.B8.D0.B0.D0.BD.D1.82_.D0.BF.D1.80.D0.BE.D0.B3.D1.80.D0.B0.D0.BC.D0.BC.D1.8B"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B4%D0%B2%D1%83%D0%BC%D0%B5%D1%80%D0%BD%D0%BE%D0%B3%D0%BE_%D0%B4%D0%B2%D0%B8%D0%B6%D0%BA%D0%B0_%D0%BD%D0%B0_%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D0%B5_%D0%B8%D0%B3%D1%80%D1%8B_%C2%AB%D0%97%D0%B2%D0%B5%D1%80%D1%81%D0%BA%D0%B8%D0%B5_%D0%BA%D0%BE%D0%BB%D0%BE%D0%B1%D0%BA%D0%B8%C2%BB&amp;action=edit&amp;section=8" title="Править секцию: Управление камерой и второй вариант программы">править</a>]</span> <span class="mw-headline">Управление камерой и второй вариант программы</span></h2>
<p>Стандартные варианты: отобразить все поле на экране; разбить поле на кадры и переключаться между ними по мере перемещения игрока; привязать центр камеры к игроку (возможно, ограничивая камеру полем, т. е. когда игрок подходит к краю поля, камера  останавливается и не перемещается за пределы поля). Мы уже реализовали упрощенный третий вариант, только вместо игрока пока просто точка на поле, перемещаемая клавишами. Сделаем удобнее - пусть камера следует за курсором, перемещаемым мышью. Однако, если просто привязать камеру к мыши, то перемещения экрана будут дергаными (это происходит потому что перемещения мыши отслеживаются скачками). Гораздо приятнее выглядит вариант, когда камера стремится к точке курсора. Сделаем еще одно добавление (его я в играх не встречал, но получается очень удобно и эффектно) - масштабирование колесиком мыши. Аналогично, чтобы избавиться от скачкообразности, сделаем стремление к уровню увеличения. В реализации этого стремления тоже есть пара загвоздок. Во-первых, если сделать его фиксированным, то при резком перемещении курсора камера будет долго ехать на свое место, а при небольшом - наоборот скакать (зависит от коэффициента перемещения). Поэтому лучше сделать перемещение зависимым от расстояния, так камера по мере приближения к заданной точке будет плавно снижать скорость. Во-вторых, на компьютерах с разной производительностью перемещение будет неодинаковым по скорости, значит нужно ввести зависимость от времени прорисовки кадра. Также стоит ограничить минимальное увеличение, чтобы поле не стало меньше экрана и сдвиг экрана, чтобы камера не залезала за границы поля. 
</p>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #ffff00; font-weight: bold;">Framework</span> brl.<span style="">glmax2d</span> <span style="color: #B1E7EB;">' Базовый модуль - движок на основе OpenGL</span><br />
<p><span style="color: #ffff00; font-weight: bold;">Import</span> brl.<span style="">random</span> <span style="color: #B1E7EB;">' Генератор случайных чисел</span><br />
<span style="color: #ffff00; font-weight: bold;">Import</span> BRL.<span style="">Basic</span> <span style="color: #B1E7EB;">' Из этого модуля используется команда Incbin</span><br />
<span style="color: #ffff00; font-weight: bold;">Import</span> BRL.<span style="">PNGLoader</span> <span style="color: #B1E7EB;">' Загрузка PNG-изображений</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Incbin</span> <span style="color: #00FF66;">&quot;2DEngine-NewImages.png&quot;</span> <span style="color: #B1E7EB;">' Сохраняем в exe-файле изображение</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Const</span> sxsize = <span style="color: #FFFFFF;">800</span>, sysize = <span style="color: #FFFFFF;">600</span>, color_depth = <span style="color: #FFFFFF;">32</span> <span style="color: #B1E7EB;">' Размеры экрана и глубина цвета</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> sxsize2 = sxsize / <span style="color: #FFFFFF;">2</span>, sysize2 = sysize / <span style="color: #FFFFFF;">2</span> <span style="color: #B1E7EB;">' Вспомогательные константы</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Const</span> tilesize = <span style="color: #FFFFFF;">64</span> <span style="color: #B1E7EB;">' Размер тайла / спрайта</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Const</span> fxsize = <span style="color: #FFFFFF;">160</span>, fysize = <span style="color: #FFFFFF;">120</span> <span style="color: #B1E7EB;">' Размеры поля в тайлах </span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> fdx#, fdy# <span style="color: #B1E7EB;">' Сдвиг отображаемой части поля</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Global</span> sc# = <span style="color: #FFFFFF;">1.0</span>, tilesc# <span style="color: #B1E7EB;">' Увеличение в пикселах и тайлах</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> dtim# <span style="color: #B1E7EB;">' Время обработки предыдущего кадра</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> cam_speed# = <span style="color: #FFFFFF;">2.0</span> <span style="color: #B1E7EB;">' Относительная скорость реакции камеры на движения мышью</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> magn_speed# = <span style="color: #FFFFFF;">2.0</span> <span style="color: #B1E7EB;">' Относительная скорость реакции масштаба на вращение колесика мыши</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> camx# = <span style="color: #FFFFFF;">0.5</span> * fxsize, camy# = &nbsp;<span style="color: #FFFFFF;">0.5</span> * fysize <span style="color: #B1E7EB;">' Текущие координаты камеры</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Const</span> objq = <span style="color: #FFFFFF;">800</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Global</span> layer_order:<span style="color: #ffff00; font-weight: bold;">TList</span> = <span style="color: #ffff00; font-weight: bold;">CreateList</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Список слоев в порядке отображения</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Global</span> frame<span style=" ">&#91;</span>fxsize, fysize<span style=" ">&#93;</span> <span style="color: #B1E7EB;">' Номера тайлов для каждой клетки</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> tile_imageq = <span style="color: #FFFFFF;">3</span> <span style="color: #B1E7EB;">' Kол-во тайлов в наборе</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> obj_imageq = <span style="color: #FFFFFF;">22</span> <span style="color: #B1E7EB;">' Kол-во объектов в наборе</span><br />
<br />
<span style="color: #B1E7EB;">' Слой</span><br />
<span style="color: #ffff00; font-weight: bold;">Type</span> layer_obj <span style="color: #ffff00; font-weight: bold;">Abstract</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> draw<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Type</span><br />
<br />
<span style="color: #B1E7EB;">' Тайловый слой</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> TILE_DONT_DRAW = <span style="color: #FFFFFF;">-1</span> <span style="color: #B1E7EB;">' Kонстанта &quot;Не рисовать тайл&quot;</span><br />
<span style="color: #ffff00; font-weight: bold;">Type</span> tile_layer_obj <span style="color: #ffff00; font-weight: bold;">Extends</span> layer_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> image:TImage <span style="color: #B1E7EB;">' Изображения тайлов</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> frame<span style=" ">&#91;</span>fxsize, fysize<span style=" ">&#93;</span> <span style="color: #B1E7EB;">' Номера тайлов для каждой клетки</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Function</span> add:tile_layer_obj<span style=" ">&#40;</span>tile_image:TImage<span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Добавление тайлового слоя</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; l:tile_layer_obj = <span style="color: #ffff00; font-weight: bold;">New</span> tile_layer_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; l.<span style="">image</span> = tile_image<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; layer_order.<span style="">addlast</span> l <span style="color: #B1E7EB;">' Занесение слоя в список отображения</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> l<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> draw<span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Прорисовка слоя</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetScale</span> tilesc#, tilesc#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; scr2field <span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">0</span>, x1#, y1#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; scr2field sxsize - <span style="color: #FFFFFF;">1</span>, sysize - <span style="color: #FFFFFF;">1</span>, x2#, y2#<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xx1 = <span style="color: #ffff00; font-weight: bold;">Max</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>x1#<span style=" ">&#41;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Определение границ куска поля, попадающего в облась зрения</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xx2 = <span style="color: #ffff00; font-weight: bold;">Min</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Ceil</span><span style=" ">&#40;</span>x2#<span style=" ">&#41;</span>, fxsize - <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; yy1 = <span style="color: #ffff00; font-weight: bold;">Max</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>y1#<span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; yy2 = <span style="color: #ffff00; font-weight: bold;">Min</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Ceil</span><span style=" ">&#40;</span>y2#<span style=" ">&#41;</span>, fysize - <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> y = yy1 <span style="color: #ffff00; font-weight: bold;">To</span> yy2<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> x = xx1 <span style="color: #ffff00; font-weight: bold;">To</span> xx2<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> frame<span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> &gt;= TILE_DRAW <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Проверка, нужно ли рисовать тайл</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; field2scr x, y, sx#, sy#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawImage</span> image, sx#, sy#, frame<span style=" ">&#91;</span>x, y<span style=" ">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Type</span><br />
<br />
&nbsp;<span style="color: #B1E7EB;">' Слой объектов</span><br />
<span style="color: #ffff00; font-weight: bold;">Type</span> object_layer_obj <span style="color: #ffff00; font-weight: bold;">Extends</span> layer_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> objects:<span style="color: #ffff00; font-weight: bold;">TList</span><span style=" ">&#91;</span>fxsize, fysize<span style=" ">&#93;</span> <span style="color: #B1E7EB;">' Список объектов для каждой клетки, находящихся на ней</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Function</span> add:object_layer_obj<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; l:object_layer_obj = <span style="color: #ffff00; font-weight: bold;">New</span> object_layer_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> y = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> fysize <span style="color: #B1E7EB;">' Инициализация списков</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> x = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> fxsize<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; l.<span style="">objects</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> = <span style="color: #ffff00; font-weight: bold;">CreateList</span><span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; layer_order.<span style="">addlast</span> l<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> l<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> draw<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; scr2field <span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">0</span>, x1#, y1#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; scr2field sxsize - <span style="color: #FFFFFF;">1</span>, sysize - <span style="color: #FFFFFF;">1</span>, x2#, y2#<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xx1 = <span style="color: #ffff00; font-weight: bold;">Max</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>x1# - <span style="color: #FFFFFF;">0.5</span><span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xx2 = <span style="color: #ffff00; font-weight: bold;">Min</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>x2# + <span style="color: #FFFFFF;">0.5</span><span style=" ">&#41;</span>, fxsize - <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; yy1 = <span style="color: #ffff00; font-weight: bold;">Max</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>y1# - <span style="color: #FFFFFF;">0.5</span><span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; yy2 = <span style="color: #ffff00; font-weight: bold;">Min</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>y2# + <span style="color: #FFFFFF;">0.5</span><span style=" ">&#41;</span>, fysize - <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> y = yy1 <span style="color: #ffff00; font-weight: bold;">To</span> yy2<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> x = xx1 <span style="color: #ffff00; font-weight: bold;">To</span> xx2<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> o:base_obj = <span style="color: #ffff00; font-weight: bold;">EachIn</span> objects<span style=" ">&#91;</span>x, y<span style=" ">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">draw</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; reset_transformations<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Type</span><br />
<br />
<span style="color: #B1E7EB;">' Базовый тип для объектов</span><br />
<span style="color: #ffff00; font-weight: bold;">Type</span> base_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> x#, y#, size# = <span style="color: #FFFFFF;">1</span>, angle# <span style="color: #B1E7EB;">' Kоординаты, размер (в тайлах), угол поворота спрайта объекта</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> r = <span style="color: #FFFFFF;">255</span>, g = <span style="color: #FFFFFF;">255</span>, b = <span style="color: #FFFFFF;">255</span> <span style="color: #B1E7EB;">' Цвет объекта (по умолчанию белый)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> image:TImage, frame <span style="color: #B1E7EB;">' Изображение для объекта, кадр</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> tile_link:<span style="color: #ffff00; font-weight: bold;">TLink</span> <span style="color: #B1E7EB;">' Ссылка на этот объект из списка объектов клетки</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> layer:object_layer_obj <span style="color: #B1E7EB;">' Слой объекта</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> random_color<span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Задание случайного (но не очень темного) цвета для объекта</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Repeat</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r = <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">255</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; g = <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">255</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b = <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">255</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Until</span> r + g + b &gt;= <span style="color: #FFFFFF;">255</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> register<span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Занесение объекта в списки (регистрация)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tilex = <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>x<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tiley = <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>y<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tile_link = layer.<span style="">objects</span><span style=" ">&#91;</span>tilex, tiley<span style=" ">&#93;</span>.<span style="">addlast</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Self</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Занесение в список объектов клетки</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> draw<span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Рисование объекта</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; field2scr x#, y#, sx#, sy#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetColor</span> r, g, b<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetScale</span> size# * tilesc#, size# * tilesc#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetRotation</span> angle#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawImage</span> image, sx#, sy#, frame<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Type</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">SeedRnd</span> <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Для того, чтобы каждый раз получать новую последовательность случайных чисел</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">SetGraphicsDriver</span> <span style="color: #ffff00; font-weight: bold;">GLMax2DDriver</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Установка драйвера отображения графики OpenGL</span><br />
<span style="color: #ffff00; font-weight: bold;">Graphics</span> sxsize, sysize, color_depth<br />
<span style="color: #ffff00; font-weight: bold;">AutoImageFlags</span> FILTEREDIMAGE | MIPMAPPEDIMAGE | DYNAMICIMAGE<br />
<span style="color: #ffff00; font-weight: bold;">SetBlend</span> ALPHABLEND<br />
<br />
<span style="color: #B1E7EB;">' Загружаем изображения с альфа-каналом из exe-файла</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> images:<span style="color: #ffff00; font-weight: bold;">TPixmap</span> = <span style="color: #ffff00; font-weight: bold;">LoadPixmapPNG</span><span style=" ">&#40;</span><span style="color: #00FF66;">&quot;incbin::2DEngine-NewImages.png&quot;</span><span style=" ">&#41;</span><br />
<br />
<span style="color: #B1E7EB;">' Вырезаем изображения</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> tile_images:TImage = tiles_grab<span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">3</span>, <span style="color: #ffff00; font-weight: bold;">False</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Тайлы</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> obj_images:TImage = tiles_grab<span style=" ">&#40;</span><span style="color: #FFFFFF;">3</span>, <span style="color: #FFFFFF;">22</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Объекты</span><br />
<br />
field_generate <span style="color: #B1E7EB;">' Создаем поле</span><br />
objects_generate <span style="color: #B1E7EB;">' Создаем объекты</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">HideMouse</span><br />
<br />
cx# = camx#<br />
cy# = camy#<br />
<span style="color: #B1E7EB;">'DebugStop</span><br />
<span style="color: #ffff00; font-weight: bold;">Repeat</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; cx# = limit<span style=" ">&#40;</span>cx# + <span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">MouseX</span><span style=" ">&#40;</span><span style=" ">&#41;</span> - sxsize2<span style=" ">&#41;</span> / sc#, <span style="color: #FFFFFF;">0</span>, fxsize<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; cy# = limit<span style=" ">&#40;</span>cy# + <span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">MouseY</span><span style=" ">&#40;</span><span style=" ">&#41;</span> - sysize2<span style=" ">&#41;</span> / sc#, <span style="color: #FFFFFF;">0</span>, fysize<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; camera_change cx#, cy#, <span style="color: #FFFFFF;">1.1</span> ^ <span style="color: #ffff00; font-weight: bold;">MouseZ</span><span style=" ">&#40;</span><span style=" ">&#41;</span> * <span style="color: #FFFFFF;">64.0</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; tim = <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Засекаем время</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">MoveMouse</span> sxsize2, sysize2 <span style="color: #B1E7EB;">' Установка курсора мыши в центр экрана</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Прорисовка слоев</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> l:layer_obj = <span style="color: #ffff00; font-weight: bold;">EachIn</span> layer_order<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; l.<span style="">draw</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Отображение курсора</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; reset_transformations<br />
&nbsp; &nbsp; &nbsp; &nbsp; field2scr cx#, cy#, sx#, sy#<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawImage</span> obj_images, sx#, sy#, <span style="color: #FFFFFF;">21</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Обновление счетчика кадров в секунду</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> fpstim&lt;= <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fpstim = <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> + <span style="color: #FFFFFF;">1000</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fps = cnt<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cnt = <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cnt:<span style="color: #FFFFFF;">+1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawText</span> <span style="color: #00FF66;">&quot;Frames/sec:&quot;</span> + fps, <span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Flip</span> <span style="color: #ffff00; font-weight: bold;">False</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Вычисление времени, затраченного на виток цикла (в секундах) для вычисления множителей скоростей</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; dtim# = <span style="color: #FFFFFF;">0.001</span> * <span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> - tim<span style=" ">&#41;</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Until</span> <span style="color: #ffff00; font-weight: bold;">KeyHit</span><span style=" ">&#40;</span>KEY_ESCAPE<span style=" ">&#41;</span><br />
<br />
<span style="color: #B1E7EB;">' Генерация поля</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> field_generate<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; layer:tile_layer_obj = tile_layer_obj.<span style="">add</span><span style=" ">&#40;</span>tile_images<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> y = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> fysize<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> x = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> fxsize<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; layer.<span style="">frame</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> = <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, tile_imageq - <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Генерация объектов</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> objects_generate<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; objs:<span style="color: #ffff00; font-weight: bold;">TList</span> = <span style="color: #ffff00; font-weight: bold;">CreateList</span><span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; layer:object_layer_obj = object_layer_obj.<span style="">add</span><span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> n = <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">To</span> objq<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o:base_obj = <span style="color: #ffff00; font-weight: bold;">New</span> base_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">x</span> = <span style="color: #ffff00; font-weight: bold;">Rnd</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, fxsize - <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">y</span> = <span style="color: #ffff00; font-weight: bold;">Rnd</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, fysize - <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">angle</span># = <span style="color: #ffff00; font-weight: bold;">Rnd</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">360</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">size</span># = <span style="color: #ffff00; font-weight: bold;">Rnd</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0.5</span>, <span style="color: #FFFFFF;">1.0</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">layer</span> = layer<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">image</span> = obj_images<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">frame</span> = <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, obj_imageq - <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">random_color</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">register</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Функция изменения координат камеры и увеличения</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> camera_change<span style=" ">&#40;</span>x#, y#, scale#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Приращения координат камеры и увеличения</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; sc# = sc# + magn_speed# * <span style=" ">&#40;</span>scale# - sc#<span style=" ">&#41;</span> * dtim#<br />
&nbsp; &nbsp; &nbsp; &nbsp; camx# = camx# + cam_speed# * <span style=" ">&#40;</span>x# - camx#<span style=" ">&#41;</span> * dtim#<br />
&nbsp; &nbsp; &nbsp; &nbsp; camy# = camy# + cam_speed# * <span style=" ">&#40;</span>y# - camy#<span style=" ">&#41;</span> * dtim#<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; sc# = limit<span style=" ">&#40;</span>sc#, <span style="color: #ffff00; font-weight: bold;">Max</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">1.0</span> * sxsize / fxsize, <span style="color: #FFFFFF;">1.0</span> * sysize / fysize<span style=" ">&#41;</span>, <span style="color: #FFFFFF;">256.0</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Ограничение увеличения</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; tilesc# = sc# / tilesize <span style="color: #B1E7EB;">' Вычисление коэффициента увеличения для тайлов</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; xsize# = sxsize / sc#&nbsp; &nbsp;<span style="color: #B1E7EB;">' Размеры отображаемого прямоугольного куска поля</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; ysize# = sysize / sc#<br />
&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; fdx# = limit<span style=" ">&#40;</span>camx# - xsize# * <span style="color: #FFFFFF;">0.5</span>, <span style="color: #FFFFFF;">0</span>, fxsize - xsize#<span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Ограничения смещения поля (по границам)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; fdy# = limit<span style=" ">&#40;</span>camy# - ysize# * <span style="color: #FFFFFF;">0.5</span>, <span style="color: #FFFFFF;">0</span>, fysize - ysize#<span style=" ">&#41;</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Функция вырезания изображения из другого изображения</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> new_grab:TImage<span style=" ">&#40;</span>image:TImage, x, y, frame<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; pixmap:<span style="color: #ffff00; font-weight: bold;">TPixmap</span> = <span style="color: #ffff00; font-weight: bold;">LockImage</span><span style=" ">&#40;</span>image, frame<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; w:<span style="color: #ffff00; font-weight: bold;">TPixmap</span> = images.<span style="">window</span><span style=" ">&#40;</span>x, y, <span style="color: #ffff00; font-weight: bold;">ImageWidth</span><span style=" ">&#40;</span>image<span style=" ">&#41;</span>, <span style="color: #ffff00; font-weight: bold;">ImageHeight</span><span style=" ">&#40;</span>image<span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; pixmap.<span style="">paste</span> w, <span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">UnlockImage</span> image<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> image<br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Функция вырезания тайла или серии тайлов из изображения</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> tiles_grab:TImage<span style=" ">&#40;</span>num, frameq = <span style="color: #FFFFFF;">1</span>, midhn = <span style="color: #ffff00; font-weight: bold;">True</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; image:TImage = <span style="color: #ffff00; font-weight: bold;">CreateImage</span><span style=" ">&#40;</span>tilesize, tilesize, frameq<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> midhn <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #ffff00; font-weight: bold;">MidHandleImage</span> image <span style="color: #B1E7EB;">' флаг midhn означает, что изображение нужно отцентровать</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> n = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">To</span> frameq - <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pos = num + n<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; new_grab image, <span style=" ">&#40;</span>pos <span style="color: #ffff00; font-weight: bold;">Mod</span> <span style="color: #FFFFFF;">4</span><span style=" ">&#41;</span> * tilesize, <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>pos / <span style="color: #FFFFFF;">4</span><span style=" ">&#41;</span> * tilesize, n <span style="color: #B1E7EB;">' По умолчанию</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' тайлы располагаются на изображении в 4 столбца</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> image<br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Функция сброса трансформаций</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> reset_transformations<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetColor</span> <span style="color: #FFFFFF;">255</span>, <span style="color: #FFFFFF;">255</span>, <span style="color: #FFFFFF;">255</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetRotation</span> <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetAlpha</span> <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetScale</span> <span style="color: #FFFFFF;">1.0</span>, <span style="color: #FFFFFF;">1.0</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Перевод из экранных координат в тайловые</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> scr2field<span style=" ">&#40;</span>sx#, sy#, tx# <span style="color: #ffff00; font-weight: bold;">Var</span>, ty# <span style="color: #ffff00; font-weight: bold;">Var</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; tx# = sx# / sc# + fdx#<br />
&nbsp; &nbsp; &nbsp; &nbsp; ty# = sy# / sc# + fdy#<br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Перевод из тайловых координат в экранные</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> field2scr<span style=" ">&#40;</span>tx#, ty#, sx# <span style="color: #ffff00; font-weight: bold;">Var</span>, sy# <span style="color: #ffff00; font-weight: bold;">Var</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; sx# = <span style=" ">&#40;</span>tx# - fdx#<span style=" ">&#41;</span> * sc#<br />
&nbsp; &nbsp; &nbsp; &nbsp; sy# = <span style=" ">&#40;</span>ty# - fdy#<span style=" ">&#41;</span> * sc#<br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Ограничение переменной минимальным и максимальным значениями</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> limit#<span style=" ">&#40;</span>v#, vmin#, vmax#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> v# &lt; vmin# <span style="color: #ffff00; font-weight: bold;">Then</span> v = vmin# <span style="color: #ffff00; font-weight: bold;">ElseIf</span> v# &gt; vmax# <span style="color: #ffff00; font-weight: bold;">Then</span> v# = vmax#<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> v#<br />
</p>
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span></div>
<p><br />
</p>
<a name=".D0.A1.D0.BE.D0.B7.D0.B4.D0.B0.D0.BD.D0.B8.D0.B5_.D0.B8.D0.B3.D1.80.D0.BE.D0.B2.D0.BE.D0.B3.D0.BE_.D0.BF.D0.BE.D0.BB.D1.8F"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B4%D0%B2%D1%83%D0%BC%D0%B5%D1%80%D0%BD%D0%BE%D0%B3%D0%BE_%D0%B4%D0%B2%D0%B8%D0%B6%D0%BA%D0%B0_%D0%BD%D0%B0_%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D0%B5_%D0%B8%D0%B3%D1%80%D1%8B_%C2%AB%D0%97%D0%B2%D0%B5%D1%80%D1%81%D0%BA%D0%B8%D0%B5_%D0%BA%D0%BE%D0%BB%D0%BE%D0%B1%D0%BA%D0%B8%C2%BB&amp;action=edit&amp;section=9" title="Править секцию: Создание игрового поля">править</a>]</span> <span class="mw-headline">Создание игрового поля</span></h2>
<p>Мешанину из тайлов, которую мы сделали для примера, игровым полем, конечно же, не назовешь. Попробуем сгенерировать что-нибудь более определенное (к тому же, генерация разных полей при повторных запусках добавит играбельности). Заглянем в какую-нибудь тайловую игру с видом сверху. Можно увидеть, что карта состоит из нескольких видов областей - свободного перемещения (вода, трава, земля, ...) и ограничивающие (горы, лес, пропасти, здания, ...). Возьмем три области - воду, траву и песок. Причем, песок окружает вода, а траву - песок. Самый простой, на мой взгляд, способ создания областей с плавными краями - создать случайную карту высот (задать каждому тайлу случайную высоту в заданном диапазоне), сгладить ее и задать две границы - "песочную" и "травяную". Все тайлы, что ниже "песочной" - вода, между "песочной" и "травяной" - песок, выше "травяной" - трава. 
</p><p>Ну, заполнение массива высот случайными значениями от 0 до 1, думаю, проблем не вызовет. Сглаживание мы разбирали в <a href="y6qhek8x.html" title="Виртуальный художник: соседние пикселы">третьей</a> и <a href="w7dh-dh6.html" title="Виртуальный художник: линейные (матричные) фильтры">четвертой</a> статье из цикла "Виртуальный художник". Это просто - суммируются значения высоты соседних тайлов и высота текущего тайла, учетверенная, например, затем сумма делится на 8 + 4 = 12 и заносится в буфер (т. к. старое значение высоты понадобится при вычислениях высоты других тайлов). Чтобы сумма оставалась постоянной, зациклим поле, т.е. соседи для крайних тайлов находятся на противоположном краю. Ну а после обработки всех тайлов, буфер и поле меняются местами, операция повторяется несколько раз и вот карта высот приобретает подходящий вид. Однако, "размывая" карту, мы сузили диапазон значений, граничные 0 и 1 приблизились к 0.5 и теперь все высоты лежат в диапазоне (0.4, 0.6), например. Поэтому необходимо выяснить максимальное и минимальное значения и растянуть поле, чтобы минимальное соответствовало 0, максимальное - 1. Формула проста: h' = (h - h<sub>min</sub>) / (h<sub>max</sub> - h<sub>min</sub>)
</p>
<a name=".D0.93.D0.B5.D0.BD.D0.B5.D1.80.D0.B0.D1.86.D0.B8.D1.8F_.D1.82.D0.B0.D0.B9.D0.BB.D0.BE.D0.B2_.D0.BF.D0.B5.D1.80.D0.B5.D1.85.D0.BE.D0.B4.D0.B0_.D0.BC.D0.B5.D0.B6.D0.B4.D1.83_.D0.B4.D0.B2.D1.83.D0.BC.D1.8F_.D1.82.D0.B5.D0.BA.D1.81.D1.82.D1.83.D1.80.D0.B0.D0.BC.D0.B8"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B4%D0%B2%D1%83%D0%BC%D0%B5%D1%80%D0%BD%D0%BE%D0%B3%D0%BE_%D0%B4%D0%B2%D0%B8%D0%B6%D0%BA%D0%B0_%D0%BD%D0%B0_%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D0%B5_%D0%B8%D0%B3%D1%80%D1%8B_%C2%AB%D0%97%D0%B2%D0%B5%D1%80%D1%81%D0%BA%D0%B8%D0%B5_%D0%BA%D0%BE%D0%BB%D0%BE%D0%B1%D0%BA%D0%B8%C2%BB&amp;action=edit&amp;section=10" title="Править секцию: Генерация тайлов перехода между двумя текстурами">править</a>]</span> <span class="mw-headline">Генерация тайлов перехода между двумя текстурами</span></h2>
<p>В графически продвинутых играх области не просто заданы разными видами текстур, еще существуют переходы от одной области к другой. Например, если есть две области - вода и суша, то между "полностью сушей" и "полностью водой" ставят промежуточные тайлы. На иллюстрации такие тайлы выделены (игра - Percussor by TMB):
</p>
<div class="center"><div class="floatnone"><span><a href="http://blitzetcetera.org/index.php/%D0%98%D0%B7%D0%BE%D0%B1%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5:2DEngine01.png" class="image" title=""><img alt="" longdesc="http://blitzetcetera.org/index.php/%D0%98%D0%B7%D0%BE%D0%B1%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5:2DEngine01.png" src="roln5dwv.png" width="320" height="200" /></a></span></div></div>
<p>Добавлю еще одно замечание: для подавляющего большинства игр в любом тайле соприкасаются максимум две области. Это ограничение освобождает художника от рисования массы дополнительных переходных тайлов, которые обычно просто излишни (впрочем, это ограничение легко обойти, накладывая друг на друга несколько частично прозрачных слоев). Часто упрощают больше - задают фоновую область и на нее уже лепят остальные, которые не соприкасаются между собой (на иллюстрации фоновая область - земля, вспомогательные - трава и вода)
</p><p>Итак, разберемся с оформлением областей. Сначала ограничимся двумя. Тогда задача ставится так: дана карта тайлов, где каждый тайл может быть либо черным, либо белым. Нужно сгенерить набор тайлов перехода от черного к белому и расставить его элементы так, чтобы между областями белого и черного существовал плавный градиентный переход.
</p><p>Сначала нужно определиться, какие тайлы будут содержать в себе переходы - белые, черные или и те и другие. Выберем белые. Рассмотрим один черный тайл. К нему непосредственно прилегают 8 соседей. Каждый сосед "по своей сути" может быть либо черным, либо белым (т. е. 2 возможных состояния). Значит, полный набор состоит из 2^8 = 256 вариантов (он включает в себя "чистый" белый тайл, значит всего тайлов будет 256 + 1 (чистый черный тайл) = 257). Вот он: 
</p>
<div class="center"><div class="floatnone"><span><a href="http://blitzetcetera.org/index.php/%D0%98%D0%B7%D0%BE%D0%B1%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5:2DEngine02.png" class="image" title=""><img alt="" longdesc="http://blitzetcetera.org/index.php/%D0%98%D0%B7%D0%BE%D0%B1%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5:2DEngine02.png" src="gm33f9mo.png" width="513" height="513" /></a></span></div></div>
<p>А вот поле, созданное с его помощью:
</p>
<div class="center"><div class="floatnone"><span><a href="http://blitzetcetera.org/index.php/%D0%98%D0%B7%D0%BE%D0%B1%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5:2DEngine03.png" class="image" title=""><img alt="" longdesc="http://blitzetcetera.org/index.php/%D0%98%D0%B7%D0%BE%D0%B1%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5:2DEngine03.png" src="1xar43mr.png" width="496" height="310" /></a></span></div></div>
<p>Если условиться, что длина каждой стороны области - более 1 тайла, то остается 50 штук. Если, вдобавок, составлять области из одноцветных квадратов, размером 2х2 тайла, в наборе останется всего 32 тайла. Можно ограничить число соседей 4-мя прилегающими сторонами - 16 вариантов. Кроме того, количество вспомогательных тайлов зависит от метода организации "перехода" и построения поля. Но чем меньше тайлов в наборе, тем меньше возможностей и поле визуально более блочно. Выбор баланса между качеством и количеством тайлов особенно важен в том случае, если вы рисуете каждый тайл вручную. Вот 16-тайловый набор:
</p>
<div class="center"><div class="floatnone"><span><a href="http://blitzetcetera.org/index.php/%D0%98%D0%B7%D0%BE%D0%B1%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5:2DEngine04.png" class="image" title=""><img alt="" longdesc="http://blitzetcetera.org/index.php/%D0%98%D0%B7%D0%BE%D0%B1%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5:2DEngine04.png" src="3h0k_1zt.png" width="513" height="363" /></a></span></div></div>
<p>Что касается конкретно нашего случая, будем генерировать полный 256-тайловый набор перехода. Понадобятся два таких набора (переход от воды к песку и от песка к траве) плюс чистый тайл воды - итого 513 тайлов.
</p>
<a name=".D0.9F.D0.B5.D1.80.D0.B5.D0.BC.D0.B5.D1.89.D0.B5.D0.BD.D0.B8.D0.B5_.D0.BE.D0.B1.D1.8A.D0.B5.D0.BA.D1.82.D0.BE.D0.B2"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B4%D0%B2%D1%83%D0%BC%D0%B5%D1%80%D0%BD%D0%BE%D0%B3%D0%BE_%D0%B4%D0%B2%D0%B8%D0%B6%D0%BA%D0%B0_%D0%BD%D0%B0_%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D0%B5_%D0%B8%D0%B3%D1%80%D1%8B_%C2%AB%D0%97%D0%B2%D0%B5%D1%80%D1%81%D0%BA%D0%B8%D0%B5_%D0%BA%D0%BE%D0%BB%D0%BE%D0%B1%D0%BA%D0%B8%C2%BB&amp;action=edit&amp;section=11" title="Править секцию: Перемещение объектов">править</a>]</span> <span class="mw-headline">Перемещение объектов</span></h2>
<p>Предположим, нужно переместить объект из одной точки в другую. Но просто изменить координаты недостаточно, нужно проверить, не вышел ли объект за пределы тайла, на котором находился. Если вышел, то необходимо вычеркнуть объект из списка тайла - старого местонахождения и вписать его в список тайла - нового местонахождения. Дадим возможность некоторым объектам двигаться. Для этого, нужно ввести еще одну переменную - скорость (зависящую, как и скорость камеры, от времени, затраченного на прорисовку кадра) и список активных (в данном случае - движущихся) объектов.
</p>
<a name=".D0.9F.D0.BE.D0.BB.D0.BE.D1.81.D0.B0_.D0.BE.D1.82.D0.BE.D0.B1.D1.80.D0.B0.D0.B6.D0.B5.D0.BD.D0.B8.D1.8F_.D1.85.D0.BE.D0.B4.D0.B0_.D0.BF.D1.80.D0.BE.D1.86.D0.B5.D1.81.D1.81.D0.B0"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B4%D0%B2%D1%83%D0%BC%D0%B5%D1%80%D0%BD%D0%BE%D0%B3%D0%BE_%D0%B4%D0%B2%D0%B8%D0%B6%D0%BA%D0%B0_%D0%BD%D0%B0_%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D0%B5_%D0%B8%D0%B3%D1%80%D1%8B_%C2%AB%D0%97%D0%B2%D0%B5%D1%80%D1%81%D0%BA%D0%B8%D0%B5_%D0%BA%D0%BE%D0%BB%D0%BE%D0%B1%D0%BA%D0%B8%C2%BB&amp;action=edit&amp;section=12" title="Править секцию: Полоса отображения хода процесса">править</a>]</span> <span class="mw-headline">Полоса отображения хода процесса</span></h2>
<p>Генерация переходных тайлов занимает некоторое время, поэтому хорошо бы сделать так, чтобы игрок мог наблюдать за ходом процесса, вместо того, чтобы пялиться в черный экран (даже с надписью "Please wait"). Сделаем полосу, постепенно заполняющуюся цветом, меняющимся от красного к зеленому. А вот, собственно, код со всем тем, о чем было сказано (плюс система генерации переходных тайлов, описанная в комментариях).  
</p>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #ffff00; font-weight: bold;">Framework</span> brl.<span style="">glmax2d</span> <span style="color: #B1E7EB;">' Базовый модуль - движок на основе OpenGL</span><br />
<p><span style="color: #ffff00; font-weight: bold;">Import</span> brl.<span style="">random</span> <span style="color: #B1E7EB;">' Генератор случайных чисел</span><br />
<span style="color: #ffff00; font-weight: bold;">Import</span> BRL.<span style="">Basic</span> <span style="color: #B1E7EB;">' Из этого модуля используется команда Incbin</span><br />
<span style="color: #ffff00; font-weight: bold;">Import</span> BRL.<span style="">PNGLoader</span> <span style="color: #B1E7EB;">' Загрузка PNG-изображений</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Incbin</span> <span style="color: #00FF66;">&quot;2DEngine-NewImages.png&quot;</span> <span style="color: #B1E7EB;">' Сохраняем в exe-файле изображение</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Const</span> sxsize = <span style="color: #FFFFFF;">800</span>, sysize = <span style="color: #FFFFFF;">600</span>, color_depth = <span style="color: #FFFFFF;">32</span> <span style="color: #B1E7EB;">' Размеры экрана и глубина цвета</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Const</span> tilesize = <span style="color: #FFFFFF;">64</span> <span style="color: #B1E7EB;">' Размер тайла / спрайта</span><br />
<br />
&nbsp;<span style="color: #B1E7EB;">' Вспомогательные константы</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> tilesize2 = tilesize / <span style="color: #FFFFFF;">2</span>, tilesize4 = tilesize / <span style="color: #FFFFFF;">4</span>, tilesize8 = tilesize / <span style="color: #FFFFFF;">8</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> tilesize16 = tilesize / <span style="color: #FFFFFF;">16</span>, tilesize32 = tilesize / <span style="color: #FFFFFF;">32</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Const</span> sxsize2 = sxsize / <span style="color: #FFFFFF;">2</span>, sysize2 = sysize / <span style="color: #FFFFFF;">2</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> sxsize4 = sxsize / <span style="color: #FFFFFF;">4</span>, sxsize34 = sxsize * <span style="color: #FFFFFF;">3</span> / <span style="color: #FFFFFF;">4</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> sysize34 = sysize * <span style="color: #FFFFFF;">3</span> / <span style="color: #FFFFFF;">4</span>, sxsize24 = sxsize / <span style="color: #FFFFFF;">2</span> - <span style="color: #FFFFFF;">4</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Const</span> fxsize = <span style="color: #FFFFFF;">160</span>, fysize = <span style="color: #FFFFFF;">120</span> <span style="color: #B1E7EB;">' Размеры поля в тайлах </span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> fblurq = <span style="color: #FFFFFF;">5</span> <span style="color: #B1E7EB;">' Kол-во размытий для временно генерируемой вспомогательной карты высот поля</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> sand_threshold# = <span style="color: #FFFFFF;">0.4</span>, grass_threshold# = <span style="color: #FFFFFF;">0.5</span> <span style="color: #B1E7EB;">' Пороги высоты для песка и травы</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> fdx#, fdy# <span style="color: #B1E7EB;">' Сдвиг отображаемой части поля</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Global</span> speedpersec# = <span style="color: #FFFFFF;">1.0</span> <span style="color: #B1E7EB;">' Модификатор скорости (тайлов / сек)</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Global</span> sc# = <span style="color: #FFFFFF;">1.0</span>, tilesc# <span style="color: #B1E7EB;">' Увеличение в пикселах и тайлах</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> dtim# <span style="color: #B1E7EB;">' Время обработки предыдущего кадра</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> timspeed# <span style="color: #B1E7EB;">' Модификатор для перемещения с учетом прошедшего времени</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> cam_speed# = <span style="color: #FFFFFF;">2.0</span> <span style="color: #B1E7EB;">' Относительная скорость реакции камеры на движения мышью</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> magn_speed# = <span style="color: #FFFFFF;">2.0</span> <span style="color: #B1E7EB;">' Относительная скорость реакции масштаба на вращение колесика мыши</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> camx# = <span style="color: #FFFFFF;">0.5</span> * fxsize, camy# = &nbsp;<span style="color: #FFFFFF;">0.5</span> * fysize <span style="color: #B1E7EB;">' Текущие координаты камеры</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Const</span> objq = <span style="color: #FFFFFF;">1000</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Global</span> layer_order:<span style="color: #ffff00; font-weight: bold;">TList</span> = <span style="color: #ffff00; font-weight: bold;">CreateList</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Список слоев в порядке отображения</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> actingobj:<span style="color: #ffff00; font-weight: bold;">TList</span> = <span style="color: #ffff00; font-weight: bold;">CreateList</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Список для активных объектов</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Global</span> frame<span style=" ">&#91;</span>fxsize, fysize<span style=" ">&#93;</span> <span style="color: #B1E7EB;">' Номера тайлов для каждой клетки</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> tile_imageq = <span style="color: #FFFFFF;">3</span> <span style="color: #B1E7EB;">' Kол-во тайлов в наборе</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> obj_imageq = <span style="color: #FFFFFF;">22</span> <span style="color: #B1E7EB;">' Kол-во объектов в наборе</span><br />
<br />
<span style="color: #B1E7EB;">' Слой</span><br />
<span style="color: #ffff00; font-weight: bold;">Type</span> layer_obj <span style="color: #ffff00; font-weight: bold;">Abstract</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> draw<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Type</span><br />
<br />
<span style="color: #B1E7EB;">' Тайловый слой</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> TILE_DONT_DRAW = <span style="color: #FFFFFF;">-1</span> <span style="color: #B1E7EB;">' Kонстанта &quot;Не рисовать тайл&quot;</span><br />
<span style="color: #ffff00; font-weight: bold;">Type</span> tile_layer_obj <span style="color: #ffff00; font-weight: bold;">Extends</span> layer_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> image:TImage <span style="color: #B1E7EB;">' Изображения тайлов</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> frame<span style=" ">&#91;</span>fxsize, fysize<span style=" ">&#93;</span> <span style="color: #B1E7EB;">' Номера тайлов для каждой клетки</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Function</span> add:tile_layer_obj<span style=" ">&#40;</span>tile_image:TImage<span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Добавление тайлового слоя</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; l:tile_layer_obj = <span style="color: #ffff00; font-weight: bold;">New</span> tile_layer_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; l.<span style="">image</span> = tile_image<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; layer_order.<span style="">addlast</span> l <span style="color: #B1E7EB;">' Занесение слоя в список отображения</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> l<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> draw<span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Прорисовка слоя</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetScale</span> tilesc#, tilesc#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; scr2field <span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">0</span>, x1#, y1#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; scr2field sxsize - <span style="color: #FFFFFF;">1</span>, sysize - <span style="color: #FFFFFF;">1</span>, x2#, y2#<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xx1 = <span style="color: #ffff00; font-weight: bold;">Max</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>x1#<span style=" ">&#41;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Определение границ куска поля, попадающего в облась зрения</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xx2 = <span style="color: #ffff00; font-weight: bold;">Min</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Ceil</span><span style=" ">&#40;</span>x2#<span style=" ">&#41;</span>, fxsize - <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; yy1 = <span style="color: #ffff00; font-weight: bold;">Max</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>y1#<span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; yy2 = <span style="color: #ffff00; font-weight: bold;">Min</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Ceil</span><span style=" ">&#40;</span>y2#<span style=" ">&#41;</span>, fysize - <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> y = yy1 <span style="color: #ffff00; font-weight: bold;">To</span> yy2<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> x = xx1 <span style="color: #ffff00; font-weight: bold;">To</span> xx2<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> frame<span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> &gt;= TILE_DRAW <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Проверка, нужно ли рисовать тайл</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; field2scr x, y, sx#, sy#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawImage</span> image, sx#, sy#, frame<span style=" ">&#91;</span>x, y<span style=" ">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Type</span><br />
<br />
&nbsp;<span style="color: #B1E7EB;">' Слой объектов</span><br />
<span style="color: #ffff00; font-weight: bold;">Type</span> object_layer_obj <span style="color: #ffff00; font-weight: bold;">Extends</span> layer_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> objects:<span style="color: #ffff00; font-weight: bold;">TList</span><span style=" ">&#91;</span>fxsize, fysize<span style=" ">&#93;</span> <span style="color: #B1E7EB;">' Список объектов для каждой клетки, находящихся на ней</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Function</span> add:object_layer_obj<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; l:object_layer_obj = <span style="color: #ffff00; font-weight: bold;">New</span> object_layer_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> y = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> fysize <span style="color: #B1E7EB;">' Инициализация списков</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> x = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> fxsize<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; l.<span style="">objects</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> = <span style="color: #ffff00; font-weight: bold;">CreateList</span><span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; layer_order.<span style="">addlast</span> l<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> l<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> draw<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; scr2field <span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">0</span>, x1#, y1#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; scr2field sxsize - <span style="color: #FFFFFF;">1</span>, sysize - <span style="color: #FFFFFF;">1</span>, x2#, y2#<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xx1 = <span style="color: #ffff00; font-weight: bold;">Max</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>x1# - <span style="color: #FFFFFF;">0.5</span><span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xx2 = <span style="color: #ffff00; font-weight: bold;">Min</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>x2# + <span style="color: #FFFFFF;">0.5</span><span style=" ">&#41;</span>, fxsize - <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; yy1 = <span style="color: #ffff00; font-weight: bold;">Max</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>y1# - <span style="color: #FFFFFF;">0.5</span><span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; yy2 = <span style="color: #ffff00; font-weight: bold;">Min</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>y2# + <span style="color: #FFFFFF;">0.5</span><span style=" ">&#41;</span>, fysize - <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> y = yy1 <span style="color: #ffff00; font-weight: bold;">To</span> yy2<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> x = xx1 <span style="color: #ffff00; font-weight: bold;">To</span> xx2<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> o:base_obj = <span style="color: #ffff00; font-weight: bold;">EachIn</span> objects<span style=" ">&#91;</span>x, y<span style=" ">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">draw</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; reset_transformations<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Type</span><br />
<br />
<span style="color: #B1E7EB;">' Базовый тип для объектов</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> ACTIVE = <span style="color: #ffff00; font-weight: bold;">True</span>, INACTIVE = <span style="color: #ffff00; font-weight: bold;">False</span> <span style="color: #B1E7EB;">' Kонстанты &quot;Активный&quot;, &quot;Не активный&quot;</span><br />
<span style="color: #ffff00; font-weight: bold;">Type</span> base_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> x#, y#, size# = <span style="color: #FFFFFF;">1</span>, angle# <span style="color: #B1E7EB;">' Kоординаты, размер (в тайлах), угол поворота спрайта объекта</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> speed# <span style="color: #B1E7EB;">' Скорость объекта (тайлов / сек)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> r = <span style="color: #FFFFFF;">255</span>, g = <span style="color: #FFFFFF;">255</span>, b = <span style="color: #FFFFFF;">255</span> <span style="color: #B1E7EB;">' Цвет объекта (по умолчанию белый)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> image:TImage, frame <span style="color: #B1E7EB;">' Изображение для объекта, кадр</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> tilex, tiley <span style="color: #B1E7EB;">' Kоординаты тайла, на котором находится объект</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> tile_link:<span style="color: #ffff00; font-weight: bold;">TLink</span> <span style="color: #B1E7EB;">' Ссылка на этот объект из списка объектов клетки</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> layer:object_layer_obj <span style="color: #B1E7EB;">' Слой объекта</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> random_color<span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Задание случайного (но не очень темного) цвета для объекта</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Repeat</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r = <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">255</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; g = <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">255</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b = <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">255</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Until</span> r + g + b &gt;= <span style="color: #FFFFFF;">255</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> register<span style=" ">&#40;</span>acting = ACTIVE<span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Занесение объекта в списки (регистрация)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tilex = <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>x#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tiley = <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>y#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tile_link = layer.<span style="">objects</span><span style=" ">&#91;</span>tilex, tiley<span style=" ">&#93;</span>.<span style="">addlast</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Self</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Занесение в список объектов клетки</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> acting <span style="color: #ffff00; font-weight: bold;">Then</span> act_link = actingobj.<span style="">addlast</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Self</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Занесение в список активных объектов</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> draw<span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Рисование объекта</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; field2scr x#, y#, sx#, sy#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetColor</span> r, g, b<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetScale</span> size# * tilesc#, size# * tilesc#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetRotation</span> angle#<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawImage</span> image, sx#, sy#, frame<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> act<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; newx# = x# + timspeed# * speed# * <span style="color: #ffff00; font-weight: bold;">Cos</span><span style=" ">&#40;</span>angle#<span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Перемещение объекта в направлении угла обзора</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; newy# = y# + timspeed# * speed# * <span style="color: #ffff00; font-weight: bold;">Sin</span><span style=" ">&#40;</span>angle#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; newx# = newx# - <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>newx# / fxsize<span style=" ">&#41;</span> * fxsize <span style="color: #B1E7EB;">' Эти формулы не дают объектам выйти за пределы поля</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; newy# = newy# - <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>newy# / fysize<span style=" ">&#41;</span> * fysize <span style="color: #B1E7EB;">' При переходе через границу поля, объект появляется с другой стороны</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; move newx#, newy#<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> move<span style=" ">&#40;</span>newx#, newy#<span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Kорректное перемещение</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; newtilex = <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>newx#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; newtiley = <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>newy#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> tilex &lt;&gt; newtilex <span style="color: #ffff00; font-weight: bold;">Or</span> tiley &lt;&gt; newtiley <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Если объект переместился в другую клетку, то</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">removeLink</span> tile_link <span style="color: #B1E7EB;">' Удаление из списка старой клетки</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tilex = newtilex<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tiley = newtiley<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tile_link = layer.<span style="">objects</span><span style=" ">&#91;</span>tilex, tiley<span style=" ">&#93;</span>.<span style="">addlast</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Self</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Занесение в список новой</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; x# = newx#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; y# = newy#<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Type</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">SeedRnd</span> <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Для того, чтобы каждый раз получать новую последовательность случайных чисел</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">SetGraphicsDriver</span> <span style="color: #ffff00; font-weight: bold;">GLMax2DDriver</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Установка драйвера отображения графики OpenGL</span><br />
<span style="color: #ffff00; font-weight: bold;">Graphics</span> sxsize, sysize, color_depth<br />
<span style="color: #ffff00; font-weight: bold;">AutoImageFlags</span> FILTEREDIMAGE | MIPMAPPEDIMAGE | DYNAMICIMAGE<br />
<span style="color: #ffff00; font-weight: bold;">SetBlend</span> ALPHABLEND<br />
<br />
<span style="color: #B1E7EB;">' Загружаем изображения с альфа-каналом из exe-файла</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> images:<span style="color: #ffff00; font-weight: bold;">TPixmap</span> = <span style="color: #ffff00; font-weight: bold;">LoadPixmapPNG</span><span style=" ">&#40;</span><span style="color: #00FF66;">&quot;incbin::2DEngine-NewImages.png&quot;</span><span style=" ">&#41;</span><br />
<br />
<span style="color: #B1E7EB;">' Вырезаем изображения</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> obj_images:TImage = tiles_grab<span style=" ">&#40;</span><span style="color: #FFFFFF;">3</span>, <span style="color: #FFFFFF;">22</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Объекты</span><br />
<span style="color: #B1E7EB;">' Создаем текстуры для тайлов</span><br />
tex_water:TImage = tiles_grab<span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">1</span>, <span style="color: #ffff00; font-weight: bold;">False</span><span style=" ">&#41;</span><br />
tex_sand:TImage = tiles_grab<span style=" ">&#40;</span><span style="color: #FFFFFF;">1</span>, <span style="color: #FFFFFF;">1</span>, <span style="color: #ffff00; font-weight: bold;">False</span><span style=" ">&#41;</span><br />
tex_grass:TImage = tiles_grab<span style=" ">&#40;</span><span style="color: #FFFFFF;">2</span>, <span style="color: #FFFFFF;">1</span>, <span style="color: #ffff00; font-weight: bold;">False</span><span style=" ">&#41;</span><br />
<br />
<span style="color: #B1E7EB;">' Создаем в пакете изображений тайлов текстуру воды</span><br />
tile_tex:TImage = <span style="color: #ffff00; font-weight: bold;">CreateImage</span><span style=" ">&#40;</span>tilesize, tilesize, <span style="color: #FFFFFF;">513</span><span style=" ">&#41;</span><br />
pixmap:<span style="color: #ffff00; font-weight: bold;">TPixmap</span> = <span style="color: #ffff00; font-weight: bold;">LockImage</span><span style=" ">&#40;</span>tile_tex,<span style="color: #FFFFFF;">0</span><span style=" ">&#41;</span><br />
pixmap.<span style="">paste</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">LockImage</span><span style=" ">&#40;</span>tex_water<span style=" ">&#41;</span><span style=" ">&#41;</span>, <span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">0</span><br />
<span style="color: #ffff00; font-weight: bold;">UnlockImage</span> tile_tex, <span style="color: #FFFFFF;">0</span><br />
<span style="color: #ffff00; font-weight: bold;">UnlockImage</span> tex_water<br />
<span style="color: #B1E7EB;">' И две библиотеки - переход от воды к песку и от песка к траве</span><br />
tile_lib_create tex_water, tex_sand, <span style="color: #FFFFFF;">4.0</span> / tilesize, <span style="color: #FFFFFF;">360.0</span>, tile_tex, <span style="color: #FFFFFF;">1</span><br />
tile_lib_create tex_sand, tex_grass, <span style="color: #FFFFFF;">4.0</span> / tilesize, <span style="color: #FFFFFF;">720.0</span>, tile_tex, <span style="color: #FFFFFF;">257</span><br />
<br />
<span style="color: #B1E7EB;">' Делаем &quot;пирог&quot; из слоев</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> layer_tiles:tile_layer_obj = tile_layer_obj.<span style="">add</span><span style=" ">&#40;</span>tile_tex<span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Сначала - тайлы</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> layer_objects:object_layer_obj = object_layer_obj.<span style="">add</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Потом - объекты</span><br />
<br />
field_generate <span style="color: #B1E7EB;">' Создаем поле</span><br />
objects_generate <span style="color: #B1E7EB;">' Создаем объекты</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">HideMouse</span><br />
<br />
cx# = camx#<br />
cy# = camy#<br />
<span style="color: #ffff00; font-weight: bold;">Repeat</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; cx# = limit<span style=" ">&#40;</span>cx# + <span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">MouseX</span><span style=" ">&#40;</span><span style=" ">&#41;</span> - sxsize2<span style=" ">&#41;</span> / sc#, <span style="color: #FFFFFF;">0</span>, fxsize<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; cy# = limit<span style=" ">&#40;</span>cy# + <span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">MouseY</span><span style=" ">&#40;</span><span style=" ">&#41;</span> - sysize2<span style=" ">&#41;</span> / sc#, <span style="color: #FFFFFF;">0</span>, fysize<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; camera_change cx#, cy#, <span style="color: #FFFFFF;">1.1</span> ^ <span style="color: #ffff00; font-weight: bold;">MouseZ</span><span style=" ">&#40;</span><span style=" ">&#41;</span> * <span style="color: #FFFFFF;">64.0</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; tim = <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Засекаем время</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">MoveMouse</span> sxsize2, sysize2 <span style="color: #B1E7EB;">' Установка курсора мыши в центр экрана</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; timspeed# = speedpersec# * dtim# <span style="color: #B1E7EB;">' Определение множителя к скорости на основе прошедшего времени</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Действия активных объектов</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> o:base_obj = <span style="color: #ffff00; font-weight: bold;">EachIn</span> actingobj<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">act</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Прорисовка слоев</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> l:layer_obj = <span style="color: #ffff00; font-weight: bold;">EachIn</span> layer_order<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; l.<span style="">draw</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Отображение курсора</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; reset_transformations<br />
&nbsp; &nbsp; &nbsp; &nbsp; field2scr cx#, cy#, sx#, sy#<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawImage</span> obj_images, sx#, sy#, <span style="color: #FFFFFF;">21</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Обновление счетчика кадров в секунду</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> fpstim&lt;= <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fpstim = <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> + <span style="color: #FFFFFF;">1000</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fps = cnt<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cnt = <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cnt:<span style="color: #FFFFFF;">+1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawText</span> <span style="color: #00FF66;">&quot;Frames/sec:&quot;</span> + fps, <span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Flip</span> <span style="color: #ffff00; font-weight: bold;">False</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Вычисление времени, затраченного на виток цикла (в секундах) для вычисления множителей скоростей</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; dtim# = <span style="color: #FFFFFF;">0.001</span> * <span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> - tim<span style=" ">&#41;</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Until</span> <span style="color: #ffff00; font-weight: bold;">KeyHit</span><span style=" ">&#40;</span>KEY_ESCAPE<span style=" ">&#41;</span><br />
<br />
<span style="color: #B1E7EB;">' Генерация поля</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> field_generate<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Const</span> tile_water = <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Const</span> tile_sand = <span style="color: #FFFFFF;">256</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Const</span> tile_grass = <span style="color: #FFFFFF;">512</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Local</span> ff#<span style=" ">&#91;</span>fxsize, fysize, <span style="color: #FFFFFF;">2</span><span style=" ">&#93;</span> <span style="color: #B1E7EB;">' Вспомогательный буферизованный массив высот для тайловой карты</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Local</span> pos2bit<span style=" ">&#91;</span><span style=" ">&#93;</span> = <span style=" ">&#91;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">6</span>, <span style="color: #FFFFFF;">1</span>, <span style="color: #FFFFFF;">4</span>, <span style="color: #FFFFFF;">5</span>, <span style="color: #FFFFFF;">2</span>, <span style="color: #FFFFFF;">7</span>, <span style="color: #FFFFFF;">3</span><span style=" ">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; fmin# = <span style="color: #FFFFFF;">1.0</span>; fmax# = <span style="color: #FFFFFF;">0</span> <span style="color: #B1E7EB;">' Переменные минимума и максимума значений высот</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> n = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">To</span> fblurq + <span style="color: #FFFFFF;">3</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; loadingbar <span style="color: #00FF66;">&quot;Generating field...&quot;</span>, n, fblurq + <span style="color: #FFFFFF;">4</span> <span style="color: #B1E7EB;">' Индикатор завершенности процесса</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; maxd# = <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> y = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> fysize <span style="color: #B1E7EB;">' Цикл по всем тайлам</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> x = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> fxsize<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Select</span> n<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Case</span> <span style="color: #FFFFFF;">0</span> <span style="color: #B1E7EB;">' Сначала заполняем массив высот случайными значениями</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ff#<span style=" ">&#91;</span>x, y, <span style="color: #FFFFFF;">1</span><span style=" ">&#93;</span> = <span style="color: #ffff00; font-weight: bold;">Rnd</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Case</span> fblurq + <span style="color: #FFFFFF;">1</span> <span style="color: #B1E7EB;">' После этапов сглаживания - этап формирования тайловых слоев</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; d# = <span style=" ">&#40;</span>ff#<span style=" ">&#91;</span>x, y, k<span style=" ">&#93;</span> - fmin#<span style=" ">&#41;</span> / <span style=" ">&#40;</span>fmax# - fmin#<span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Kорректируем значение высоты, чтобы минимум соответствовал значению 0.0, максимум - 1.0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> d# &lt; sand_threshold# <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' До порога песка</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> = tile_water <span style="color: #B1E7EB;">' Отображаем чистый тайл воды</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">ElseIf</span> d# &lt; grass_threshold# <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' От порога песка до порога травы</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> = tile_sand <span style="color: #B1E7EB;">' Пока отображаем чистый тайл песка</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span> <span style="color: #B1E7EB;">' После порога травы</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> = tile_grass <span style="color: #B1E7EB;">' Пока отображаем чистый тайл травы</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Case</span> fblurq + <span style="color: #FFFFFF;">2</span> <span style="color: #B1E7EB;">' Этап устранения травы, примыкающей к воде</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x,y<span style=" ">&#93;</span> = tile_grass <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Если тайл - трава, то</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> yy = - <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #FFFFFF;">1</span> <span style="color: #B1E7EB;">' Цикл по всем соседним тайлам</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> xx = - <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; x2 = <span style=" ">&#40;</span>x + xx + fxsize<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Mod</span> fxsize <span style="color: #B1E7EB;">' Расчет координат соседнего тайла</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; y2 = <span style=" ">&#40;</span>y + yy + fysize<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Mod</span> fysize <span style="color: #B1E7EB;">' &nbsp;(поле зациклено)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x2, y2<span style=" ">&#93;</span> = tile_water <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Если один из тайлов - вода</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> = tile_sand <span style="color: #B1E7EB;">' То меняем тайл травы на тайл песка</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Case</span> fblurq + <span style="color: #FFFFFF;">3</span> <span style="color: #B1E7EB;">' Этап сглаживания тайлов (выбора кадра из библиотеки)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> &gt; tile_water <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Если чистая вода, то пропускаем этот тайл</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bitpos = <span style="color: #FFFFFF;">0</span>; mask = <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> yy = - <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #FFFFFF;">1</span> <span style="color: #B1E7EB;">' Цикл по всем соседним тайлам</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> xx = - <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> xx&lt;&gt;<span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Or</span> yy&lt;&gt;<span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; x2 = <span style=" ">&#40;</span>x + xx + fxsize<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Mod</span> fxsize<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; y2 = <span style=" ">&#40;</span>y + yy + fysize<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Mod</span> fysize<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> &gt; tile_sand <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Если данный тайл - трава, то</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Если соседний тайл - трава, то включаем бит присутствия соседа для данного тайла</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x2, y2<span style=" ">&#93;</span> &gt; tile_sand <span style="color: #ffff00; font-weight: bold;">Then</span> setbit mask, pos2bit<span style=" ">&#91;</span>bitpos<span style=" ">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span> <span style="color: #B1E7EB;">' Иначе это тайл песка</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Если соседний тайл - песок, то включаем бит присутствия соседа для данного тайла</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x2, y2<span style=" ">&#93;</span> &gt; tile_water <span style="color: #ffff00; font-weight: bold;">Then</span> setbit mask, pos2bit<span style=" ">&#91;</span>bitpos<span style=" ">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bitpos:<span style="color: #FFFFFF;">+1</span> <span style="color: #B1E7EB;">' Увеличиваем счетчик номера бита</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> = <span style="color: #FFFFFF;">1</span> + <span style="color: #FFFFFF;">256</span> &nbsp;* <span style=" ">&#40;</span>layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> = tile_grass<span style=" ">&#41;</span> + mask<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Default</span> <span style="color: #B1E7EB;">' Этапы сглаживания массива высот</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sum# = <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> yy = - <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #FFFFFF;">1</span> <span style="color: #B1E7EB;">' Суммируем значения высот соседних тайлов и высоту данного тайла * 8</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> xx = - <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sum# = sum# + ff#<span style=" ">&#91;</span><span style=" ">&#40;</span>x + xx + fxsize<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Mod</span> fxsize, <span style=" ">&#40;</span>y + yy + fysize<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Mod</span> fysize, k<span style=" ">&#93;</span> * <span style=" ">&#40;</span><span style="color: #FFFFFF;">1.0</span> + <span style="color: #FFFFFF;">7.0</span> * <span style=" ">&#40;</span>xx = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">And</span> yy = <span style="color: #FFFFFF;">0</span><span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sum# = sum# / <span style="color: #FFFFFF;">16.0</span> <span style="color: #B1E7EB;">' Вычисляем среднее значение (центральный тайл имеет такой же вес, что и все 8 соседних в сумме)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> n = fblurq <span style="color: #ffff00; font-weight: bold;">Then</span> setminmax sum#, fmin#, fmax# <span style="color: #B1E7EB;">' Kорректируем значения максимума и минимума высоты</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ff#<span style=" ">&#91;</span>x, y, <span style="color: #FFFFFF;">1</span> - k<span style=" ">&#93;</span> = sum# <span style="color: #B1E7EB;">' Устанавливаем значение высоты в буфере</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Select</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; k = <span style="color: #FFFFFF;">1</span> - k <span style="color: #B1E7EB;">' Меняем буфер и текущую карту местами</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> n = fblurq + <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Окантовка карты водой после этапа формирования слоев</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> x = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> fxsize<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; waterize x, <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; waterize x, fysize - <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> y = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> fysize<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; waterize <span style="color: #FFFFFF;">0</span>, y<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; waterize fxsize - <span style="color: #FFFFFF;">1</span>, y<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Залитие тайла водой</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> waterize<span style=" ">&#40;</span>x, y<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> = <span style="color: #FFFFFF;">0</span> <span style="color: #B1E7EB;">' Рисуем тайл воды</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Создание библиотеки тайлов перехода между текстурами</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> tile_lib_create<span style=" ">&#40;</span>bottom_tile:TImage, top_tile:TImage, rowd#, period#, tile_lib:TImage, offset = <span style="color: #FFFFFF;">0</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Local</span> dt#<span style=" ">&#91;</span>tilesize2<span style=" ">&#93;</span> <span style="color: #B1E7EB;">' Заполнение массива колебаний ровной границы</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> dn = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> tilesize2<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dt#<span style=" ">&#91;</span>dn<span style=" ">&#93;</span> = <span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Sin</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">90</span> + dn * period# / tilesize2<span style=" ">&#41;</span> - <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span> * tilesize32<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; bottom_pixmap:<span style="color: #ffff00; font-weight: bold;">TPixmap</span> = <span style="color: #ffff00; font-weight: bold;">LockImage</span><span style=" ">&#40;</span>bottom_tile<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; top_pixmap:<span style="color: #ffff00; font-weight: bold;">TPixmap</span> = <span style="color: #ffff00; font-weight: bold;">LockImage</span><span style=" ">&#40;</span>top_tile<span style=" ">&#41;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> n = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #FFFFFF;">255</span> <span style="color: #B1E7EB;">' Восемь клеток вокруг тайла могут быть такими же либо отличными (2 состояния),</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #B1E7EB;">' поэтому всего - 2 ^ 8 = 256 вариантов</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; loadingbar <span style="color: #00FF66;">&quot;Generating transition tiles...&quot;</span>, n, <span style="color: #FFFFFF;">256</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lib_pixmap:<span style="color: #ffff00; font-weight: bold;">TPixmap</span> = <span style="color: #ffff00; font-weight: bold;">LockImage</span><span style=" ">&#40;</span>tile_lib, n + offset<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> n1 = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> n2 = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v = biton<span style=" ">&#40;</span>n, n1 + n2 * <span style="color: #FFFFFF;">2</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vx = biton<span style=" ">&#40;</span>n, n1 + <span style="color: #FFFFFF;">4</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vy = biton<span style=" ">&#40;</span>n, n2 + <span style="color: #FFFFFF;">6</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> yy = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> tilesize2<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> xx = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> tilesize2<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> vx <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> vy <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> v <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; k1# = <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; k1# = rowd# * <span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Sqr</span><span style=" ">&#40;</span>xx * xx + yy * yy<span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; k1# = <span style=" ">&#40;</span>yy + dt#<span style=" ">&#91;</span>xx<span style=" ">&#93;</span><span style=" ">&#41;</span> * rowd#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span> <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> vy <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; k1# = <span style=" ">&#40;</span>xx + dt#<span style=" ">&#91;</span>yy<span style=" ">&#93;</span><span style=" ">&#41;</span> * rowd#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; k1# = <span style="color: #FFFFFF;">2.0</span> - rowd# * <span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Sqr</span><span style=" ">&#40;</span><span style=" ">&#40;</span>tilesize2 - xx<span style=" ">&#41;</span> * <span style=" ">&#40;</span>tilesize2 - xx<span style=" ">&#41;</span> + <span style=" ">&#40;</span>tilesize2 - yy<span style=" ">&#41;</span> * <span style=" ">&#40;</span>tilesize2 - yy<span style=" ">&#41;</span><span style=" ">&#41;</span> + <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span> <span style="color: #FFFFFF;">-1</span>, <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> k1# &gt; <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">Then</span> k1# = <span style="color: #FFFFFF;">1</span> <span style="color: #B1E7EB;">' Ограничиваем коэффициент в пределах интервала [0, 1]</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> k1# &lt; <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Then</span> k1# = <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; k2# = <span style="color: #FFFFFF;">1.0</span> - k1# <span style="color: #B1E7EB;">' Kоэффициент прозрачности для пикселей другого тайла</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> n1 <span style="color: #ffff00; font-weight: bold;">Then</span> x = tilesize - <span style="color: #FFFFFF;">1</span> - xx <span style="color: #ffff00; font-weight: bold;">Else</span> x = xx <span style="color: #B1E7EB;">' Отражения отн. осей (если нужно)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> n2 <span style="color: #ffff00; font-weight: bold;">Then</span> y = tilesize - <span style="color: #FFFFFF;">1</span> - yy <span style="color: #ffff00; font-weight: bold;">Else</span> y = yy<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fromrgba <span style="color: #ffff00; font-weight: bold;">ReadPixel</span><span style=" ">&#40;</span>top_pixmap, x, y<span style=" ">&#41;</span>, r1, g1, b1, dummy <span style="color: #B1E7EB;">' Получаем цветовые компоненты пикселей тайлов</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fromrgba <span style="color: #ffff00; font-weight: bold;">ReadPixel</span><span style=" ">&#40;</span>bottom_pixmap, x, y<span style=" ">&#41;</span>, r2, g2, b2, dummy<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Печатаем пиксел, смешивая цвета с заданными коэффициентами</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">WritePixel</span> lib_pixmap, x, y, torgba<span style=" ">&#40;</span>k1# * r1 + k2# * r2, k1# * g1 + k2# * g2, k1# * b1 + k2# * b2, <span style="color: #FFFFFF;">255</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">UnlockImage</span> bottom_tile<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">UnlockImage</span> top_tile<br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Генерация объектов</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> objects_generate<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> n = <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">To</span> objq<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o:base_obj = <span style="color: #ffff00; font-weight: bold;">New</span> base_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">x</span> = <span style="color: #ffff00; font-weight: bold;">Rnd</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, fxsize - <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">y</span> = <span style="color: #ffff00; font-weight: bold;">Rnd</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, fysize - <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">angle</span># = <span style="color: #ffff00; font-weight: bold;">Rnd</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">360</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">size</span># = <span style="color: #ffff00; font-weight: bold;">Rnd</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0.5</span>, <span style="color: #FFFFFF;">1.0</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">speed</span># = <span style="color: #ffff00; font-weight: bold;">Rnd</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0.5</span>, <span style="color: #FFFFFF;">3.0</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">layer</span> = layer_objects<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">image</span> = obj_images<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">random_color</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; acting = <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>,<span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> acting <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">frame</span> = <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">3</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">frame</span> = <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">4</span>, obj_imageq - <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">register</span> acting<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Функция изменения координат камеры и увеличения</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> camera_change<span style=" ">&#40;</span>x#, y#, scale#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Приращения координат камеры и увеличения</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; sc# = sc# + magn_speed# * <span style=" ">&#40;</span>scale# - sc#<span style=" ">&#41;</span> * dtim#<br />
&nbsp; &nbsp; &nbsp; &nbsp; camx# = camx# + cam_speed# * <span style=" ">&#40;</span>x# - camx#<span style=" ">&#41;</span> * dtim#<br />
&nbsp; &nbsp; &nbsp; &nbsp; camy# = camy# + cam_speed# * <span style=" ">&#40;</span>y# - camy#<span style=" ">&#41;</span> * dtim#<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; sc# = limit<span style=" ">&#40;</span>sc#, <span style="color: #ffff00; font-weight: bold;">Max</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">1.0</span> * sxsize / fxsize, <span style="color: #FFFFFF;">1.0</span> * sysize / fysize<span style=" ">&#41;</span>, <span style="color: #FFFFFF;">256.0</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Ограничение увеличения</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; tilesc# = sc# / tilesize <span style="color: #B1E7EB;">' Вычисление коэффициента увеличения для тайлов</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; xsize# = sxsize / sc#&nbsp; &nbsp;<span style="color: #B1E7EB;">' Размеры отображаемого прямоугольного куска поля</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; ysize# = sysize / sc#<br />
&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; fdx# = limit<span style=" ">&#40;</span>camx# - xsize# * <span style="color: #FFFFFF;">0.5</span>, <span style="color: #FFFFFF;">0</span>, fxsize - xsize#<span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Ограничения смещения поля (по границам)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; fdy# = limit<span style=" ">&#40;</span>camy# - ysize# * <span style="color: #FFFFFF;">0.5</span>, <span style="color: #FFFFFF;">0</span>, fysize - ysize#<span style=" ">&#41;</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Функция вырезания изображения из другого изображения</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> new_grab:TImage<span style=" ">&#40;</span>image:TImage, x, y, frame<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; pixmap:<span style="color: #ffff00; font-weight: bold;">TPixmap</span> = <span style="color: #ffff00; font-weight: bold;">LockImage</span><span style=" ">&#40;</span>image, frame<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; w:<span style="color: #ffff00; font-weight: bold;">TPixmap</span> = images.<span style="">window</span><span style=" ">&#40;</span>x, y, <span style="color: #ffff00; font-weight: bold;">ImageWidth</span><span style=" ">&#40;</span>image<span style=" ">&#41;</span>, <span style="color: #ffff00; font-weight: bold;">ImageHeight</span><span style=" ">&#40;</span>image<span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; pixmap.<span style="">paste</span> w, <span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">UnlockImage</span> image<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> image<br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Функция вырезания тайла или серии тайлов из изображения</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> tiles_grab:TImage<span style=" ">&#40;</span>num, frameq = <span style="color: #FFFFFF;">1</span>, midhn = <span style="color: #ffff00; font-weight: bold;">True</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; image:TImage = <span style="color: #ffff00; font-weight: bold;">CreateImage</span><span style=" ">&#40;</span>tilesize, tilesize, frameq<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> midhn <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #ffff00; font-weight: bold;">MidHandleImage</span> image <span style="color: #B1E7EB;">' флаг midhn означает, что изображение нужно отцентровать</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> n = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">To</span> frameq - <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pos = num + n<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; new_grab image, <span style=" ">&#40;</span>pos <span style="color: #ffff00; font-weight: bold;">Mod</span> <span style="color: #FFFFFF;">4</span><span style=" ">&#41;</span> * tilesize, <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>pos / <span style="color: #FFFFFF;">4</span><span style=" ">&#41;</span> * tilesize, n <span style="color: #B1E7EB;">' По умолчанию тайлы располагаются на изображении в 4 столбца</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> image<br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Установка цвета - оттенка серого</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> SetGrayColor<span style=" ">&#40;</span>col<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetColor</span> col, col, col<br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Полоса отображения завершенности процесса</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> loadingbar<span style=" ">&#40;</span>txt$, pos, maximum<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Cls</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetColor</span> <span style="color: #FFFFFF;">128</span>, <span style="color: #FFFFFF;">128</span>, <span style="color: #FFFFFF;">255</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawText</span> txt$, <span style=" ">&#40;</span>sxsize - <span style="color: #ffff00; font-weight: bold;">TextWidth</span><span style=" ">&#40;</span>txt$<span style=" ">&#41;</span><span style=" ">&#41;</span> / <span style="color: #FFFFFF;">2</span>, sysize34<br />
&nbsp; &nbsp; &nbsp; &nbsp; col = <span style="color: #FFFFFF;">255</span> * pos / maximum<br />
&nbsp; &nbsp; &nbsp; &nbsp; SetGrayColor <span style="color: #FFFFFF;">255</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; DrawEmptyRect sxsize4, sysize34 + <span style="color: #FFFFFF;">20</span>, sxsize2, <span style="color: #FFFFFF;">30</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetColor</span> <span style="color: #FFFFFF;">255</span> - col, col, <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawRect</span> sxsize4 + <span style="color: #FFFFFF;">2</span>, sysize34 + <span style="color: #FFFFFF;">22</span>, sxsize24 * pos / maximum, <span style="color: #FFFFFF;">26</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Flip</span> <span style="color: #ffff00; font-weight: bold;">False</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; SetGrayColor <span style="color: #FFFFFF;">255</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Функция, рисующая пустой прямоугольник</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> DrawEmptyRect<span style=" ">&#40;</span>x#, y#, xsize#, ysize#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; xsize# = xsize# - <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; ysize# = ysize# - <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawLine</span> x#, y#, x# + xsize#, y#<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawLine</span> x# + xsize#, y#, x# + xsize#,y# + ysize#<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawLine</span> x# + xsize#, y# + ysize#, x#, y# + ysize#<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawLine</span> x#, y# + ysize#, x#, y#<br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Функция, переводящая Write/ReadPixel-значение в значения цветовых компонент и альфа канала</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> fromRGBa<span style=" ">&#40;</span>from, r <span style="color: #ffff00; font-weight: bold;">Var</span>, g <span style="color: #ffff00; font-weight: bold;">Var</span>, b <span style="color: #ffff00; font-weight: bold;">Var</span>, a <span style="color: #ffff00; font-weight: bold;">Var</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; b = from &amp; $FF<br />
&nbsp; &nbsp; &nbsp; &nbsp; g = <span style=" ">&#40;</span>from <span style="color: #ffff00; font-weight: bold;">Shr</span> <span style="color: #FFFFFF;">8</span><span style=" ">&#41;</span> &amp; $FF<br />
&nbsp; &nbsp; &nbsp; &nbsp; r = <span style=" ">&#40;</span>from <span style="color: #ffff00; font-weight: bold;">Shr</span> <span style="color: #FFFFFF;">16</span><span style=" ">&#41;</span> &amp; $FF<br />
&nbsp; &nbsp; &nbsp; &nbsp; a = <span style=" ">&#40;</span>from <span style="color: #ffff00; font-weight: bold;">Shr</span> <span style="color: #FFFFFF;">24</span><span style=" ">&#41;</span> &amp; $FF<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Функция, переводящая значения цветовых компонент и альфа канала в Write/ReadPixel-значение</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> toRGBa<span style=" ">&#40;</span>r, g, b, a = <span style="color: #FFFFFF;">255</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> b | <span style=" ">&#40;</span>g <span style="color: #ffff00; font-weight: bold;">Shl</span> <span style="color: #FFFFFF;">8</span><span style=" ">&#41;</span> | <span style=" ">&#40;</span>r <span style="color: #ffff00; font-weight: bold;">Shl</span> <span style="color: #FFFFFF;">16</span><span style=" ">&#41;</span> | <span style=" ">&#40;</span>a <span style="color: #ffff00; font-weight: bold;">Shl</span> <span style="color: #FFFFFF;">24</span><span style=" ">&#41;</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Функция сброса трансформаций</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> reset_transformations<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; SetGrayColor <span style="color: #FFFFFF;">255</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetRotation</span> <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetAlpha</span> <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetScale</span> <span style="color: #FFFFFF;">1.0</span>, <span style="color: #FFFFFF;">1.0</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Перевод из экранных координат в тайловые</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> scr2field<span style=" ">&#40;</span>sx#, sy#, tx# <span style="color: #ffff00; font-weight: bold;">Var</span>, ty# <span style="color: #ffff00; font-weight: bold;">Var</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; tx# = sx# / sc# + fdx#<br />
&nbsp; &nbsp; &nbsp; &nbsp; ty# = sy# / sc# + fdy#<br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Перевод из тайловых координат в экранные</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> field2scr<span style=" ">&#40;</span>tx#, ty#, sx# <span style="color: #ffff00; font-weight: bold;">Var</span>, sy# <span style="color: #ffff00; font-weight: bold;">Var</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; sx# = <span style=" ">&#40;</span>tx# - fdx#<span style=" ">&#41;</span> * sc#<br />
&nbsp; &nbsp; &nbsp; &nbsp; sy# = <span style=" ">&#40;</span>ty# - fdy#<span style=" ">&#41;</span> * sc#<br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Ограничение переменной минимальным и максимальным значениями</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> limit#<span style=" ">&#40;</span>v#, vmin#, vmax#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> v# &lt; vmin# <span style="color: #ffff00; font-weight: bold;">Then</span> v = vmin# <span style="color: #ffff00; font-weight: bold;">ElseIf</span> v# &gt; vmax# <span style="color: #ffff00; font-weight: bold;">Then</span> v# = vmax#<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> v#<br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Функция, возвращающая значение бита под номером bitnum</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> biton<span style=" ">&#40;</span>v, bitnum<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> v &amp; <span style=" ">&#40;</span><span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">Shl</span> bitnum<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #ffff00; font-weight: bold;">Return</span> <span style="color: #ffff00; font-weight: bold;">True</span> <span style="color: #ffff00; font-weight: bold;">Else</span> <span style="color: #ffff00; font-weight: bold;">Return</span> <span style="color: #ffff00; font-weight: bold;">False</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Включение бита под номером bitnum в значении переменной</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> setbit<span style=" ">&#40;</span>v <span style="color: #ffff00; font-weight: bold;">Var</span>, bitnum<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; v = v | <span style=" ">&#40;</span><span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">Shl</span> bitnum<span style=" ">&#41;</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Изменение минимума и максимума на основе переменной</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> setminmax<span style=" ">&#40;</span>v#, vmin# <span style="color: #ffff00; font-weight: bold;">Var</span>, vmax# <span style="color: #ffff00; font-weight: bold;">Var</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> v#&lt;vmin# <span style="color: #ffff00; font-weight: bold;">Then</span> vmin# = v#<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> v#&gt;vmax# <span style="color: #ffff00; font-weight: bold;">Then</span> vmax# = v#<br />
</p>
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span></div>
<p><br />
</p>
<a name=".D0.9A.D0.BE.D0.BB.D0.BB.D0.B8.D0.B7.D0.B8.D1.8F"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B4%D0%B2%D1%83%D0%BC%D0%B5%D1%80%D0%BD%D0%BE%D0%B3%D0%BE_%D0%B4%D0%B2%D0%B8%D0%B6%D0%BA%D0%B0_%D0%BD%D0%B0_%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D0%B5_%D0%B8%D0%B3%D1%80%D1%8B_%C2%AB%D0%97%D0%B2%D0%B5%D1%80%D1%81%D0%BA%D0%B8%D0%B5_%D0%BA%D0%BE%D0%BB%D0%BE%D0%B1%D0%BA%D0%B8%C2%BB&amp;action=edit&amp;section=13" title="Править секцию: Коллизия">править</a>]</span> <span class="mw-headline">Коллизия</span></h2>
<p>Наш мир пока еще аморфен - настало время добавить ему материальности. Для этого нужно создать коллизионную систему (collision по-английски - столкновение). Это часть программы, следящая за столкновениями объектов и задающая реакцию объектов на эти столкновения. Для каждого объекта задается тип и параметры его коллизионной формы, эта форма обычно максимально упрощена. Например, для объекта, похожего на круг, целесообразно задать коллизионную форму круга, она определяется центром и радиусом. Небольшими выступами можно пренебречь (это даже даст некоторые преимущества). Определение коллизии делится на две процедуры: определения наползания двух данных объектов друг на друга (их коллизии) и выявления объектов, коллизирующих с данным (от ее оптимизированности в значительной степени зависит кол-во FPS, а значит и плавность хода игры).
</p><p>Система действует так: если объект появился / переместился, он проверяется на коллизию со всеми подозрительными объектами процедурой для двух объектов. Если коллизия зафиксирована, то во-первых активный объект либо ищет другое место для появления либо не перемещается либо скользит вдоль того, с которым столкнулся. Во-вторых, запускается процедура обработки коллизии этого объекта с указанием объекта наталкивания в качестве параметра (это метод, он находится в пользовательском типе объекта). Процедура выполняет все связанные с актом столкновения действия (например, если пуля столкнулась с персонажем, пуля исчезает, а персонаж получает повреждения).
</p>
<a name=".D0.A2.D0.B0.D0.B9.D0.BB.D0.BE.D0.B2.D1.8B.D0.B9_.D1.81.D0.BB.D0.BE.D0.B9_.D0.BA.D0.BE.D0.BB.D0.BB.D0.B8.D0.B7.D0.B8.D0.B8"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B4%D0%B2%D1%83%D0%BC%D0%B5%D1%80%D0%BD%D0%BE%D0%B3%D0%BE_%D0%B4%D0%B2%D0%B8%D0%B6%D0%BA%D0%B0_%D0%BD%D0%B0_%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D0%B5_%D0%B8%D0%B3%D1%80%D1%8B_%C2%AB%D0%97%D0%B2%D0%B5%D1%80%D1%81%D0%BA%D0%B8%D0%B5_%D0%BA%D0%BE%D0%BB%D0%BE%D0%B1%D0%BA%D0%B8%C2%BB&amp;action=edit&amp;section=14" title="Править секцию: Тайловый слой коллизии">править</a>]</span> <span class="mw-headline">Тайловый слой коллизии</span></h2>
<p>Этот слой создается исключительно для коллизии с объектами. Здесь пока все будет максимально просто: тайл либо не коллизирует, либо коллизирует полностью (как квадрат). То есть если объект наползет на коллизирующий тайл, значит с этим тайлом он столкнулся. Для хранения информации о том, какой тайл "материален", а какой нет, создадим новое расширение базового слоя - слой тайловой коллизии. Он будет хранить двумерный массив аналогичный тайловому, только вместо номеров тайлов в ячейках будет True(1), если тайл коллизирует и False(0), если нет.  
</p>
<a name=".D0.9A.D0.BE.D0.BB.D0.BB.D0.B8.D0.B7.D0.B8.D1.8F_.D0.BE.D0.B1.D1.8A.D0.B5.D0.BA.D1.82.D0.BE.D0.B2"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B4%D0%B2%D1%83%D0%BC%D0%B5%D1%80%D0%BD%D0%BE%D0%B3%D0%BE_%D0%B4%D0%B2%D0%B8%D0%B6%D0%BA%D0%B0_%D0%BD%D0%B0_%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D0%B5_%D0%B8%D0%B3%D1%80%D1%8B_%C2%AB%D0%97%D0%B2%D0%B5%D1%80%D1%81%D0%BA%D0%B8%D0%B5_%D0%BA%D0%BE%D0%BB%D0%BE%D0%B1%D0%BA%D0%B8%C2%BB&amp;action=edit&amp;section=15" title="Править секцию: Коллизия объектов">править</a>]</span> <span class="mw-headline">Коллизия объектов</span></h2>
<p>В примере будет 3 типа коллизионных форм объектов - круг (центр - координаты объекта, радиус), квадрат (центр - координаты объекта, половина стороны) и нематериальность. Соответственно, получается 3 * (3 + 1) / 2 = 6 типов коллизии:
</p>
<ul><li>Коллизия нематериального объекта с любым всегда отсутствует (False).
</li><li>Круги коллизируют, если расстояние между их центрами меньше суммы радиусов (рис. 1).
</li><li>Прямоугольники коллизируют, если разница между соответствующими координатами центра меньше суммы полусторон (рис. 2).  
</li><li>Коллизия прямоугольника и круга:
</li></ul>
<p>Временно поместим центр круга в начало координат и рассмотрим два случая:
</p>
<ul><li><ul><li>Если прямоугольник пересекает ось координат, то можно заменить круг описанным квадратом и рассмотреть коллизию квадратов (рис. 3).
</li><li>Если прямоугольник полностью находится внутри одной из координатных четвертей, коллизия будет лишь в том случае, если расстояние от его угла, ближайшего к центру круга, до этого центра меньше радиуса круга (рис. 4).
</li></ul>
</li></ul>
<div class="center"><div class="floatnone"><span><a href="http://blitzetcetera.org/index.php/%D0%98%D0%B7%D0%BE%D0%B1%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5:2DEngine05.png" class="image" title=""><img alt="" longdesc="http://blitzetcetera.org/index.php/%D0%98%D0%B7%D0%BE%D0%B1%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5:2DEngine05.png" src="-prxhvb1.png" width="600" height="300" /></a></span></div></div>
<p>Для определения всех объектов, с которыми может коллизировать данный, нужно обследовать все списки близлежащих тайлов, на которых могут находиться возможные участники столкновения и проверить на столкновение с данным все находящиеся там объекты. Так как мы уже условились, что не будем создавать объекты размером больше тайла, то диапазон возможных участников столкновения для данного объекта будет определяться так: (Floor(x#) - 1, Floor(y#) - 1, Floor(x#) + 1, Floor(y#) - 1). Можно еще урезать диапазон, учтя размер данного объекта.
</p><p>Пусть у нас пока будут два типа объектов - колобки и пули. Добавим также слой тайловой коллизии, чтобы можно было ограничить движение колобков сушей. Итого имеем 3 коллизионных слоя - тайлы, колобки и пули. Теперь важно определить, кто с кем может коллизировать. Программно это выражается в создании для каждого типа активных объектов (это у нас колобки и пули) списка слоев, с которыми он коллизирует.
</p>
<ul><li>Во-первых, колобки коллизируют между собой - вносим в коллизионный список слоя "колобки" его же.
</li><li>Во-вторых, колобки коллизируют с водой - вносим туда же слой тайловой коллизии
</li><li>В-третьих, пули втыкаются в колобков - вносим в список коллизий для слоя пуль слой колобков. Заметьте, что здесь коллизия односторонняя, т. е. нет необходимости проверять "наталкивания" колобков на пули. 
</li></ul>
<p>Всего типов столкновений - 3: объект - объект, объект - тайл и объект - границы поля. И для каждого случая целесообразно выделить метод обработки в базовом типе объекта.
</p><p>Теперь сравним подход "в лоб" и подход выборочной коллизии (на коллизию проверяются все объекты, без нашего алгоритма со списками объектов для тайла): пусть будет 100 колобков и 200 пуль. Значит всего объектов - 300 и при топорном способе нужно выполнить 300 х 300 = 90 000 проверок. Оптимизированный метод: колобки с колобками (100 х 100) + пули с колобками (200 х 100) =  30 000 проверок - в 3 раза меньше. Как говорится, почувствуйте разницу.
</p>
<a name=".D0.A0.D0.B0.D1.81.D1.88.D0.B8.D1.80.D0.B5.D0.BD.D0.B8.D1.8F_.D0.B1.D0.B0.D0.B7.D0.BE.D0.B2.D1.8B.D1.85_.D0.BE.D0.B1.D1.8A.D0.B5.D0.BA.D1.82.D0.BE.D0.B2"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B4%D0%B2%D1%83%D0%BC%D0%B5%D1%80%D0%BD%D0%BE%D0%B3%D0%BE_%D0%B4%D0%B2%D0%B8%D0%B6%D0%BA%D0%B0_%D0%BD%D0%B0_%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D0%B5_%D0%B8%D0%B3%D1%80%D1%8B_%C2%AB%D0%97%D0%B2%D0%B5%D1%80%D1%81%D0%BA%D0%B8%D0%B5_%D0%BA%D0%BE%D0%BB%D0%BE%D0%B1%D0%BA%D0%B8%C2%BB&amp;action=edit&amp;section=16" title="Править секцию: Расширения базовых объектов">править</a>]</span> <span class="mw-headline">Расширения базовых объектов</span></h2>
<p>Ранее мы ограничивались одним типом объектов. Теперь у нас есть два объекта, отличающиеся поведением - колобки и пули. Еще можно выделить статические (неподвижные) объекты. Создадим на основе типа базового объекта тип колобков, статических объектов и пуль. Будем добавлять в них специфические методы и переменные по мере необходимости. Во-первых, неплохо бы добавить возможность создавать каждый из типов объектов. Для этого в типе объекта пишется функция create (вы можете назвать ее и по-другому). В ней создается объект данного типа и задаются его параметры. Функция возвращает указатель на этот созданный объект. Т. к. наборы их параметров для разных типов различны, то понадобится по одной функции создания объекта в каждом типе. Если нужно создать объект, то сначала пишется тип объекта, затем точка, потом название функции - create. Например - kolobok_obj.create() или k:kolobok_obj = kolobok_obj.create(). 
</p>
<a name=".D0.91.D0.BB.D1.83.D0.B6.D0.B4.D0.B0.D0.BD.D0.B8.D0.B5_.D0.BA.D0.BE.D0.BB.D0.BE.D0.B1.D0.BA.D0.BE.D0.B2"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B4%D0%B2%D1%83%D0%BC%D0%B5%D1%80%D0%BD%D0%BE%D0%B3%D0%BE_%D0%B4%D0%B2%D0%B8%D0%B6%D0%BA%D0%B0_%D0%BD%D0%B0_%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D0%B5_%D0%B8%D0%B3%D1%80%D1%8B_%C2%AB%D0%97%D0%B2%D0%B5%D1%80%D1%81%D0%BA%D0%B8%D0%B5_%D0%BA%D0%BE%D0%BB%D0%BE%D0%B1%D0%BA%D0%B8%C2%BB&amp;action=edit&amp;section=17" title="Править секцию: Блуждание колобков">править</a>]</span> <span class="mw-headline">Блуждание колобков</span></h2>
<p>Для начала, колобки пусть просто идут вперед, а, столкнувшись с препятствием, поворачиваются, пока путь не будет свободен. Этот простой метод и реализуется просто - на основе угла поворота, скорости и прошедшего времени вычисляем новое положение колобка. Смотрим, будут ли коллизии, если переместить колобка. Если нет, то перемещаем, иначе поворачиваемся по часовой стрелке, увеличивая угол поворота.
</p>
<a name=".D0.A1.D1.82.D1.80.D0.B5.D0.BB.D1.8C.D0.B1.D0.B0"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B4%D0%B2%D1%83%D0%BC%D0%B5%D1%80%D0%BD%D0%BE%D0%B3%D0%BE_%D0%B4%D0%B2%D0%B8%D0%B6%D0%BA%D0%B0_%D0%BD%D0%B0_%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D0%B5_%D0%B8%D0%B3%D1%80%D1%8B_%C2%AB%D0%97%D0%B2%D0%B5%D1%80%D1%81%D0%BA%D0%B8%D0%B5_%D0%BA%D0%BE%D0%BB%D0%BE%D0%B1%D0%BA%D0%B8%C2%BB&amp;action=edit&amp;section=18" title="Править секцию: Стрельба">править</a>]</span> <span class="mw-headline">Стрельба</span></h2>
<p>Здесь все тоже довольно просто, но есть несколько нюансов. Колобок делает выстрел - создаем новый объект - пулю, направление - такое же, как у колобка, скорость чуть больше. Пуля летит в данном направлении до столкновения с объектом, после чего разрушается (нужно удалить объект из списков). Чтобы пуля не появлялась на пустом месте, создадим ее внутри колобка, а чтобы она сразу же не впилась в того, кто ее выпустил, нужно исключить реакцию на столкновение пули со стреляющим. Для этого внесем в тип объекта "пуля" переменную для хранения указателя на стреляющего.
</p><p>Далее, чтобы колобок не стрелял в каждом цикле действия, зададим переменную "перезарядки" в типе колобка, которая будет хранить время, через которое можно будет сделать следующий выстрел. Варьируя эту переменную, можно сделать так, чтобы некоторые колобки стреляли одиночными выстрелами, а некоторые - очередями. При выстреле просто прибавляем к количеству прошедших миллисекунд (Millisecs()) это значение - получим время, по достижении которого можно стрелять (внесем и этот параметр в тип колобка). И не делаем выстрел, если текущее время меньше, чем в переменной.
</p><p>Еще один момент: если объектов будет не очень много, некоторые пули будут долго лететь через все поле, не встречая на пути объектов. Поэтому, со временем, пуль станет очень много, и они будут тормозить программу. Чтобы этого не происходило, зададим время жизни пули, чтобы она, пролетев некоторое время, исчезала. Для этого введем в тип колобка еще переменную - время жизни его пуль, а также константу - время "затухания" пули.
</p>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #ffff00; font-weight: bold;">Framework</span> brl.<span style="">glmax2d</span> <span style="color: #B1E7EB;">' Базовый модуль - движок на основе OpenGL</span><br />
<p><span style="color: #ffff00; font-weight: bold;">Import</span> brl.<span style="">random</span> <span style="color: #B1E7EB;">' Генератор случайных чисел</span><br />
<span style="color: #ffff00; font-weight: bold;">Import</span> BRL.<span style="">Basic</span> <span style="color: #B1E7EB;">' Из этого модуля используется команда Incbin</span><br />
<span style="color: #ffff00; font-weight: bold;">Import</span> BRL.<span style="">PNGLoader</span> <span style="color: #B1E7EB;">' Загрузка PNG-изображений</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Incbin</span> <span style="color: #00FF66;">&quot;2DEngine-NewImages.png&quot;</span> <span style="color: #B1E7EB;">' Сохраняем в exe-файле изображение</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Const</span> sxsize = <span style="color: #FFFFFF;">800</span>, sysize = <span style="color: #FFFFFF;">600</span>, color_depth = <span style="color: #FFFFFF;">32</span> <span style="color: #B1E7EB;">' Размеры экрана и глубина цвета</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Const</span> tilesize = <span style="color: #FFFFFF;">64</span> <span style="color: #B1E7EB;">' Размер тайла / спрайта</span><br />
<br />
<span style="color: #B1E7EB;">' Вспомогательные константы</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> tilesize2 = tilesize / <span style="color: #FFFFFF;">2</span>, tilesize4 = tilesize / <span style="color: #FFFFFF;">4</span>, tilesize8 = tilesize / <span style="color: #FFFFFF;">8</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> tilesize16 = tilesize / <span style="color: #FFFFFF;">16</span>, tilesize32 = tilesize / <span style="color: #FFFFFF;">32</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Const</span> sxsize2 = sxsize / <span style="color: #FFFFFF;">2</span>, sysize2 = sysize / <span style="color: #FFFFFF;">2</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> sxsize4 = sxsize / <span style="color: #FFFFFF;">4</span>, sxsize34 = sxsize * <span style="color: #FFFFFF;">3</span> / <span style="color: #FFFFFF;">4</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> sysize34 = sysize * <span style="color: #FFFFFF;">3</span> / <span style="color: #FFFFFF;">4</span>, sxsize24 = sxsize / <span style="color: #FFFFFF;">2</span> - <span style="color: #FFFFFF;">4</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Const</span> fxsize = <span style="color: #FFFFFF;">160</span>, fysize = <span style="color: #FFFFFF;">120</span> <span style="color: #B1E7EB;">' Размеры поля в тайлах </span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> fblurq = <span style="color: #FFFFFF;">5</span> <span style="color: #B1E7EB;">' Kол-во размытий для временно генерируемой вспомогательной карты высот поля</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> sand_threshold# = <span style="color: #FFFFFF;">0.4</span>, grass_threshold# = <span style="color: #FFFFFF;">0.5</span> <span style="color: #B1E7EB;">' Пороги высоты для песка и травы</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> fdx#, fdy# <span style="color: #B1E7EB;">' Сдвиг отображаемой части поля</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Const</span> objq = <span style="color: #FFFFFF;">1000</span> <span style="color: #B1E7EB;">' Kол-во объектов</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> speedpersec# = <span style="color: #FFFFFF;">1.0</span> <span style="color: #B1E7EB;">' Модификатор скорости (тайлов / сек)</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> angpersec# = <span style="color: #FFFFFF;">90.0</span> <span style="color: #B1E7EB;">' Модификатор угловой скорости (градусов / сек)</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Global</span> sc# = <span style="color: #FFFFFF;">1.0</span>, tilesc# <span style="color: #B1E7EB;">' Увеличение в пикселах и тайлах</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> dtim# <span style="color: #B1E7EB;">' Время обработки предыдущего кадра</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> timspeed# <span style="color: #B1E7EB;">' Модификатор для перемещения с учетом прошедшего времени</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> timang# <span style="color: #B1E7EB;">' Модификатор для поворота с учетом прошедшего времени</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> minms = <span style="color: #FFFFFF;">100</span> <span style="color: #B1E7EB;">' Ограничитель кадров в секунду для действий объектов</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> cam_speed# = <span style="color: #FFFFFF;">2.0</span> <span style="color: #B1E7EB;">' Относительная скорость реакции камеры на движения мышью</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> magn_speed# = <span style="color: #FFFFFF;">2.0</span> <span style="color: #B1E7EB;">' Относительная скорость реакции масштаба на вращение колесика мыши</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> camx# = <span style="color: #FFFFFF;">0.5</span> * fxsize, camy# = &nbsp;<span style="color: #FFFFFF;">0.5</span> * fysize <span style="color: #B1E7EB;">' Текущие координаты камеры</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Const</span> showcollisions = <span style="color: #ffff00; font-weight: bold;">False</span> <span style="color: #B1E7EB;">' Показ коллизий (отключен)</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> ccnt, objcnt, chcnt <span style="color: #B1E7EB;">' Счетчики коллизий, объектов, проверок коллизий в секунду</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Global</span> layer_order:<span style="color: #ffff00; font-weight: bold;">TList</span> = <span style="color: #ffff00; font-weight: bold;">CreateList</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Список слоев в порядке отображения</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> actingobj:<span style="color: #ffff00; font-weight: bold;">TList</span> = <span style="color: #ffff00; font-weight: bold;">CreateList</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Список для активных объектов</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Global</span> frame<span style=" ">&#91;</span>fxsize, fysize<span style=" ">&#93;</span> <span style="color: #B1E7EB;">' Номера тайлов для каждой клетки</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> tile_imageq = <span style="color: #FFFFFF;">3</span> <span style="color: #B1E7EB;">' Kол-во тайлов в наборе</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> obj_imageq = <span style="color: #FFFFFF;">21</span> <span style="color: #B1E7EB;">' Kол-во объектов в наборе</span><br />
<br />
<span style="color: #B1E7EB;">' Слой</span><br />
<span style="color: #ffff00; font-weight: bold;">Type</span> layer_obj <span style="color: #ffff00; font-weight: bold;">Abstract</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> collision_with:<span style="color: #ffff00; font-weight: bold;">TList</span> = <span style="color: #ffff00; font-weight: bold;">CreateList</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Список слоев, с которыми коллизирует данный</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> collides_with<span style=" ">&#40;</span>layer:layer_obj<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> tile_layer_obj<span style=" ">&#40;</span>layer<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #ffff00; font-weight: bold;">RuntimeError</span> <span style="color: #00FF66;">&quot;Tile layers can't collide - use tile collision layer&quot;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; collision_with.<span style="">addlast</span> layer<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> draw<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Type</span><br />
<br />
<span style="color: #B1E7EB;">' Тайловый слой</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> TILE_DONT_DRAW = <span style="color: #FFFFFF;">-1</span> <span style="color: #B1E7EB;">' Kонстанта &quot;Не рисовать тайл&quot;</span><br />
<span style="color: #ffff00; font-weight: bold;">Type</span> tile_layer_obj <span style="color: #ffff00; font-weight: bold;">Extends</span> layer_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> image:TImage <span style="color: #B1E7EB;">' Изображения тайлов</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> frame<span style=" ">&#91;</span>fxsize, fysize<span style=" ">&#93;</span> <span style="color: #B1E7EB;">' Номера тайлов для каждой клетки</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Function</span> add:tile_layer_obj<span style=" ">&#40;</span>tile_image:TImage<span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Добавление тайлового слоя</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; l:tile_layer_obj = <span style="color: #ffff00; font-weight: bold;">New</span> tile_layer_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; l.<span style="">image</span> = tile_image<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; layer_order.<span style="">addlast</span> l <span style="color: #B1E7EB;">' Занесение слоя в список отображения</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> l<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> draw<span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Прорисовка слоя</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetScale</span> tilesc#, tilesc#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; scr2field <span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">0</span>, x1#, y1#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; scr2field sxsize - <span style="color: #FFFFFF;">1</span>, sysize - <span style="color: #FFFFFF;">1</span>, x2#, y2#<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xx1 = <span style="color: #ffff00; font-weight: bold;">Max</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>x1#<span style=" ">&#41;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Определение границ куска поля, попадающего в облась зрения</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xx2 = <span style="color: #ffff00; font-weight: bold;">Min</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Ceil</span><span style=" ">&#40;</span>x2#<span style=" ">&#41;</span>, fxsize - <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; yy1 = <span style="color: #ffff00; font-weight: bold;">Max</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>y1#<span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; yy2 = <span style="color: #ffff00; font-weight: bold;">Min</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Ceil</span><span style=" ">&#40;</span>y2#<span style=" ">&#41;</span>, fysize - <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> y = yy1 <span style="color: #ffff00; font-weight: bold;">To</span> yy2<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> x = xx1 <span style="color: #ffff00; font-weight: bold;">To</span> xx2<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> frame<span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> &gt;= TILE_DRAW <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Проверка, нужно ли рисовать тайл</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; field2scr x, y, sx#, sy#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawImage</span> image, sx#, sy#, frame<span style=" ">&#91;</span>x, y<span style=" ">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Type</span><br />
<br />
&nbsp;<span style="color: #B1E7EB;">' Слой объектов</span><br />
<span style="color: #ffff00; font-weight: bold;">Type</span> object_layer_obj <span style="color: #ffff00; font-weight: bold;">Extends</span> layer_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> objects:<span style="color: #ffff00; font-weight: bold;">TList</span><span style=" ">&#91;</span>fxsize, fysize<span style=" ">&#93;</span> <span style="color: #B1E7EB;">' Список объектов для каждой клетки, находящихся на ней</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Function</span> add:object_layer_obj<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; l:object_layer_obj = <span style="color: #ffff00; font-weight: bold;">New</span> object_layer_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> y = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> fysize <span style="color: #B1E7EB;">' Инициализация списков</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> x = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> fxsize<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; l.<span style="">objects</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> = <span style="color: #ffff00; font-weight: bold;">CreateList</span><span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; layer_order.<span style="">addlast</span> l<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> l<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> draw<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; scr2field <span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">0</span>, x1#, y1#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; scr2field sxsize - <span style="color: #FFFFFF;">1</span>, sysize - <span style="color: #FFFFFF;">1</span>, x2#, y2#<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xx1 = <span style="color: #ffff00; font-weight: bold;">Max</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>x1# - <span style="color: #FFFFFF;">0.5</span><span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xx2 = <span style="color: #ffff00; font-weight: bold;">Min</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>x2# + <span style="color: #FFFFFF;">0.5</span><span style=" ">&#41;</span>, fxsize - <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; yy1 = <span style="color: #ffff00; font-weight: bold;">Max</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>y1# - <span style="color: #FFFFFF;">0.5</span><span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; yy2 = <span style="color: #ffff00; font-weight: bold;">Min</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>y2# + <span style="color: #FFFFFF;">0.5</span><span style=" ">&#41;</span>, fysize - <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> y = yy1 <span style="color: #ffff00; font-weight: bold;">To</span> yy2<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> x = xx1 <span style="color: #ffff00; font-weight: bold;">To</span> xx2<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> o:base_obj = <span style="color: #ffff00; font-weight: bold;">EachIn</span> objects<span style=" ">&#91;</span>x, y<span style=" ">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">draw</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; reset_transformations<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Type</span><br />
<br />
<span style="color: #B1E7EB;">' Слой тайловой коллизии</span><br />
<span style="color: #ffff00; font-weight: bold;">Type</span> tile_collision_layer_obj <span style="color: #ffff00; font-weight: bold;">Extends</span> layer_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> collision<span style=" ">&#91;</span>fxsize, fysize<span style=" ">&#93;</span> <span style="color: #B1E7EB;">' Kоллизия с тайлом (да / нет)</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Function</span> add:tile_collision_layer_obj<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> <span style="color: #ffff00; font-weight: bold;">New</span> tile_collision_layer_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Type</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Const</span> CT_IMMATERIAL = <span style="color: #FFFFFF;">0</span> <span style="color: #B1E7EB;">' Тип коллизионной модели - нематериальный</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> CT_CIRCULAR = <span style="color: #FFFFFF;">1</span> <span style="color: #B1E7EB;">' Тип коллизионной модели - круг</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> CT_SQUARE = <span style="color: #FFFFFF;">2</span> <span style="color: #B1E7EB;">' Тип коллизионной модели - квадрат</span><br />
<span style="color: #B1E7EB;">' Базовый тип для объектов</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> ACTIVE = <span style="color: #ffff00; font-weight: bold;">True</span>, INACTIVE = <span style="color: #ffff00; font-weight: bold;">False</span> <span style="color: #B1E7EB;">' Kонстанты &quot;Активный&quot;, &quot;Не активный&quot;</span><br />
<span style="color: #ffff00; font-weight: bold;">Type</span> base_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> x#, y#, size# = <span style="color: #FFFFFF;">1</span>, angle# <span style="color: #B1E7EB;">' Kоординаты, размер (в тайлах), угол поворота спрайта объекта</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> speed# <span style="color: #B1E7EB;">' Скорость объекта (тайлов / сек)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> r = <span style="color: #FFFFFF;">255</span>, g = <span style="color: #FFFFFF;">255</span>, b = <span style="color: #FFFFFF;">255</span> <span style="color: #B1E7EB;">' Цвет объекта (по умолчанию белый)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> image:TImage, frame <span style="color: #B1E7EB;">' Изображение для объекта, кадр</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> tilex, tiley <span style="color: #B1E7EB;">' Kоординаты тайла, на котором находится объект</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> act_link:<span style="color: #ffff00; font-weight: bold;">TLink</span>, tile_link:<span style="color: #ffff00; font-weight: bold;">TLink</span> <span style="color: #B1E7EB;">' Ссылки на этот объект из списков активных объектов и объектов клетки</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> layer:object_layer_obj <span style="color: #B1E7EB;">' Слой объекта</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> coll_type = CT_CIRCULAR, radius# = <span style="color: #FFFFFF;">0.5</span> <span style="color: #B1E7EB;">' Тип модели коллизии и ее радиус</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> place_find<span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Поиск места для размещения объекта</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Repeat</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; x# = <span style="color: #ffff00; font-weight: bold;">Rnd</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">1.0</span>, fxsize - <span style="color: #FFFFFF;">1.01</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; y# = <span style="color: #ffff00; font-weight: bold;">Rnd</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">1.0</span>, fysize - <span style="color: #FFFFFF;">1.01</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tilex = <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>x#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tiley = <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>y#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Проверка на отсутствие коллизий (в т. ч. и с водой)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">Not</span> collision<span style=" ">&#40;</span>x#, y#<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #ffff00; font-weight: bold;">Exit</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Forever</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> random_color<span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Задание случайного (но не очень темного) цвета для объекта</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Repeat</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r = <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">255</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; g = <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">255</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b = <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">255</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Until</span> r + g + b &gt;= <span style="color: #FFFFFF;">255</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> register<span style=" ">&#40;</span>acting = ACTIVE<span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Занесение объекта в списки (регистрация)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; objcnt:<span style="color: #FFFFFF;">+1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tilex = <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>x#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tiley = <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>y#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tile_link = layer.<span style="">objects</span><span style=" ">&#91;</span>tilex, tiley<span style=" ">&#93;</span>.<span style="">addlast</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Self</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Занесение в список объектов клетки</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> acting <span style="color: #ffff00; font-weight: bold;">Then</span> act_link = actingobj.<span style="">addlast</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Self</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Занесение в список активных объектов</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> draw<span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Рисование объекта</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; field2scr x#, y#, sx#, sy#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetColor</span> r, g, b<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetScale</span> size# * tilesc#, size# * tilesc#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetRotation</span> angle#<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawImage</span> image, sx#, sy#, frame<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> act<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> move<span style=" ">&#40;</span>newx#, newy#<span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Kорректное перемещение</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; newtilex = <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>newx#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; newtiley = <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>newy#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> tilex &lt;&gt; newtilex <span style="color: #ffff00; font-weight: bold;">Or</span> tiley &lt;&gt; newtiley <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Если объект переместился в другую клетку, то</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">removeLink</span> tile_link <span style="color: #B1E7EB;">' Удаление из списка старой клетки</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tilex = newtilex<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tiley = newtiley<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tile_link = layer.<span style="">objects</span><span style=" ">&#91;</span>tilex, tiley<span style=" ">&#93;</span>.<span style="">addlast</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Self</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Занесение в список новой</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; x# = newx#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; y# = newy#<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> try_move<span style=" ">&#40;</span>newx#, newy#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">Not</span> collision<span style=" ">&#40;</span>newx#, newy#<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> move newx#, newy#; <span style="color: #ffff00; font-weight: bold;">Return</span> <span style="color: #ffff00; font-weight: bold;">True</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> try_move_ang<span style=" ">&#40;</span>ang#, spd#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> try_move<span style=" ">&#40;</span>x# + timspeed# * <span style="color: #ffff00; font-weight: bold;">Cos</span><span style=" ">&#40;</span>ang#<span style=" ">&#41;</span> * spd#, y# + timspeed# * <span style="color: #ffff00; font-weight: bold;">Sin</span><span style=" ">&#40;</span>ang#<span style=" ">&#41;</span> * spd#<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #ffff00; font-weight: bold;">Return</span> <span style="color: #ffff00; font-weight: bold;">True</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> collision2<span style=" ">&#40;</span>o:base_obj, newx#, newy#<span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Проверка объекта на столкновение с другим</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Select</span> <span style="color: #ffff00; font-weight: bold;">True</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Case</span> coll_type = CT_CIRCULAR <span style="color: #B1E7EB;">' Если модель данного объекта - круг</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Select</span> <span style="color: #ffff00; font-weight: bold;">True</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Case</span> o.<span style="">coll_type</span> = CT_CIRCULAR <span style="color: #B1E7EB;">' И модель второго объекта - тоже круг (круг с кругом)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dx# = newx# - o.<span style="">x</span>#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dy# = newy# - o.<span style="">y</span>#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Проверяем, меньше ли расстояние между объектами, чем сумма их радиусов</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">Sqr</span><span style=" ">&#40;</span>dx# * dx# + dy# * dy#<span style=" ">&#41;</span> &lt; o.<span style="">radius</span># + radius# <span style="color: #ffff00; font-weight: bold;">Then</span> ccnt:<span style="color: #FFFFFF;">+1</span>; <span style="color: #ffff00; font-weight: bold;">Return</span> <span style="color: #ffff00; font-weight: bold;">True</span> <span style="color: #ffff00; font-weight: bold;">Else</span> <span style="color: #ffff00; font-weight: bold;">Return</span> <span style="color: #ffff00; font-weight: bold;">False</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Case</span> o.<span style="">coll_type</span> = CT_SQUARE <span style="color: #B1E7EB;">' А если модель второго объекта - квадрат (круг с квадратом)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style=" ">&#40;</span>o.<span style="">x</span># - o.<span style="">radius</span># &lt;= newx# <span style="color: #ffff00; font-weight: bold;">And</span> newx# &lt;= o.<span style="">x</span># + o.<span style="">radius</span>#<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Or</span> <span style=" ">&#40;</span>o.<span style="">y</span># - o.<span style="">radius</span># &lt;= newy# <span style="color: #ffff00; font-weight: bold;">And</span> newy# &lt;= o.<span style="">y</span># + o.<span style="">radius</span>#<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dx# = <span style="color: #ffff00; font-weight: bold;">Abs</span><span style=" ">&#40;</span>newx# - o.<span style="">x</span>#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dy# = <span style="color: #ffff00; font-weight: bold;">Abs</span><span style=" ">&#40;</span>newy# - o.<span style="">y</span>#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sumr# = o.<span style="">radius</span># + radius#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> dx# &lt; sumr# <span style="color: #ffff00; font-weight: bold;">And</span> dy# &lt; sumr# <span style="color: #ffff00; font-weight: bold;">Then</span> ccnt:<span style="color: #FFFFFF;">+1</span>; <span style="color: #ffff00; font-weight: bold;">Return</span> <span style="color: #ffff00; font-weight: bold;">True</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dx# = <span style="color: #ffff00; font-weight: bold;">Min</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Abs</span><span style=" ">&#40;</span>newx# - o.<span style="">x</span># - o.<span style="">radius</span>#<span style=" ">&#41;</span>, <span style="color: #ffff00; font-weight: bold;">Abs</span><span style=" ">&#40;</span>newx# - o.<span style="">x</span># + o.<span style="">radius</span>#<span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dy# = <span style="color: #ffff00; font-weight: bold;">Min</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Abs</span><span style=" ">&#40;</span>newy# - o.<span style="">y</span># - o.<span style="">radius</span>#<span style=" ">&#41;</span>, <span style="color: #ffff00; font-weight: bold;">Abs</span><span style=" ">&#40;</span>newy# - o.<span style="">y</span># + o.<span style="">radius</span>#<span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">Sqr</span><span style=" ">&#40;</span>dx# * dx# + dy# * dy#<span style=" ">&#41;</span> &lt; radius# <span style="color: #ffff00; font-weight: bold;">Then</span> ccnt:<span style="color: #FFFFFF;">+1</span>; <span style="color: #ffff00; font-weight: bold;">Return</span> <span style="color: #ffff00; font-weight: bold;">True</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Default</span> <span style="color: #B1E7EB;">' Но вот если второй объект нематериален - столкновения нет</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> <span style="color: #ffff00; font-weight: bold;">False</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Select</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Case</span> coll_type = CT_SQUARE <span style="color: #B1E7EB;">' Если модель данного объекта - квадрат</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> o.<span style="">coll_type</span> = CT_SQUARE <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' И модель второго объекта - тоже квадрат</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dx# = <span style="color: #ffff00; font-weight: bold;">Abs</span><span style=" ">&#40;</span>newx# - o.<span style="">x</span>#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dy# = <span style="color: #ffff00; font-weight: bold;">Abs</span><span style=" ">&#40;</span>newy# - o.<span style="">y</span>#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sumr# = o.<span style="">radius</span># + radius#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Проверяем, меньше ли модуль разности соотв. координат, чем сумма радиусов</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> dx# &lt; sumr# <span style="color: #ffff00; font-weight: bold;">And</span> dy# &lt; sumr# <span style="color: #ffff00; font-weight: bold;">Then</span> ccnt:<span style="color: #FFFFFF;">+1</span>; <span style="color: #ffff00; font-weight: bold;">Return</span> <span style="color: #ffff00; font-weight: bold;">True</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span> <span style="color: #B1E7EB;">' Иначе проверяем столкновение второго объекта с данным (меняем местами)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> o.<span style="">collision2</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Self</span>, newx#, newy#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Default</span> <span style="color: #B1E7EB;">' Нематериальный объект не коллизирует</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> <span style="color: #ffff00; font-weight: bold;">False</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Select</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> collision<span style=" ">&#40;</span>newx#, newy#<span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Проверка данного объекта на столкновение с чем бы то ни было</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Столкновение с границами поля (это осложнит другие проверки, поэтому выходим)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> newx# &lt; <span style="color: #FFFFFF;">1.0</span> <span style="color: #ffff00; font-weight: bold;">Or</span> newy# &lt; <span style="color: #FFFFFF;">1.0</span> <span style="color: #ffff00; font-weight: bold;">Or</span> newx# &gt;= fxsize - <span style="color: #FFFFFF;">1.0</span> <span style="color: #ffff00; font-weight: bold;">Or</span> newy# &gt;= fysize - <span style="color: #FFFFFF;">1.0</span> <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; boundaries_collision_act<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> <span style="color: #ffff00; font-weight: bold;">True</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> l:layer_obj = <span style="color: #ffff00; font-weight: bold;">EachIn</span> layer.<span style="">collision_with</span> <span style="color: #B1E7EB;">' Цикл по всем слоям коллизии</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tl:tile_collision_layer_obj = tile_collision_layer_obj<span style=" ">&#40;</span>l<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> tl <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Если слой - тайлово-коллизионный, то</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> yy = <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>newy# - radius#<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>newy# + radius#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> xx = <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>newx# - radius#<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>newx# + radius#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> tl.<span style="">collision</span><span style=" ">&#40;</span>xx, yy<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tile_object.<span style="">x</span># = xx + <span style="color: #FFFFFF;">0.5</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tile_object.<span style="">y</span># = yy + <span style="color: #FFFFFF;">0.5</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> collision2<span style=" ">&#40;</span>tile_object, newx#, newy#<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> collided = <span style="color: #ffff00; font-weight: bold;">True</span>; tile_collision_act xx, yy<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span> <span style="color: #B1E7EB;">' Иначе слой - объектный, тогда</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ol:object_layer_obj = object_layer_obj<span style=" ">&#40;</span>l<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; x2 = <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>newx#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; y2 = <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>newy#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> yy = y2 - <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">To</span> y2 + <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> xx = x2 - <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">To</span> x2 + <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> o:base_obj = <span style="color: #ffff00; font-weight: bold;">EachIn</span> ol.<span style="">objects</span><span style=" ">&#91;</span>xx, yy<span style=" ">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> Self&lt;&gt;o <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; chcnt:<span style="color: #FFFFFF;">+1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> showcollisions <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Показ проверок коллизий линиями</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; field2scr o.<span style="">x</span>#, o.<span style="">y</span>#, sx1#, sy1#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; field2scr newx#, newy#, sx2#, sy2#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawLine</span> sx1#, sy1#, sx2#, sy2#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> collision2<span style=" ">&#40;</span>o, newx#, newy#<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> collided = <span style="color: #ffff00; font-weight: bold;">True</span>; object_collision_act o<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> collided<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> object_collision_act<span style=" ">&#40;</span>o:base_obj<span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Действия при столкновении с объектами</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> tile_collision_act<span style=" ">&#40;</span>xx, yy<span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Действия при столкновении с тайлами</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> boundaries_collision_act<span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Действия при столкновении с границами карты</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> destroy<span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Kорректное уничтожение объекта</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> act_link&lt;&gt;Null <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #ffff00; font-weight: bold;">removeLink</span> act_link <span style="color: #B1E7EB;">' Удаление объекта из списка активных</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">removeLink</span> tile_link <span style="color: #B1E7EB;">' Удаление объекта из списка объектов клетки</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; objcnt:<span style="color: #FFFFFF;">-1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Type</span><br />
<br />
<span style="color: #B1E7EB;">' Тип для колобков</span><br />
<span style="color: #ffff00; font-weight: bold;">Type</span> kolobok_obj <span style="color: #ffff00; font-weight: bold;">Extends</span> base_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> bullet_reload, bullet_reload_time <span style="color: #B1E7EB;">' Время окончания перезарядки, время перезарядки</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> bullet_speed#, bullet_lifetime = <span style="color: #FFFFFF;">2000</span> <span style="color: #B1E7EB;">' Скорость и время жизни пули этого колобка</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Function</span> create:kolobok_obj<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o:kolobok_obj = <span style="color: #ffff00; font-weight: bold;">New</span> kolobok_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">angle</span># = <span style="color: #ffff00; font-weight: bold;">Rnd</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0.0</span>, <span style="color: #FFFFFF;">360.0</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">size</span># = <span style="color: #ffff00; font-weight: bold;">Rnd</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0.5</span>, <span style="color: #FFFFFF;">1.0</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">random_color</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">layer</span> = layer_koloboks<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">image</span> = obj_images<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">frame</span> = <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">2</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">radius</span># = <span style="color: #FFFFFF;">0.4</span> * o.<span style="">size</span>#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">speed</span># = <span style="color: #ffff00; font-weight: bold;">Rnd</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0.5</span>, <span style="color: #FFFFFF;">3.0</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">bullet_reload_time</span> = <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">200</span>, <span style="color: #FFFFFF;">1000</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">bullet_speed</span># = <span style="color: #ffff00; font-weight: bold;">Rnd</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">1.0</span>, <span style="color: #FFFFFF;">2.0</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">bullet_lifetime</span> = <span style="color: #FFFFFF;">2000</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">place_find</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">register</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> o<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> act<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Перемещение объекта в направлении угла обзора, если путь свободен</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' &nbsp;и поворот, если уперлись в препятствие</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">Not</span> try_move_ang<span style=" ">&#40;</span>angle#, speed#<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> angle# = angle# + timang#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> bullet_reload &lt; <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bullet_obj.<span style="">create</span> <span style="color: #ffff00; font-weight: bold;">Self</span> <span style="color: #B1E7EB;">' Если пришло время стрелять - стреляем</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bullet_reload = <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> + bullet_reload_time&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Type</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Type</span> static_obj <span style="color: #ffff00; font-weight: bold;">Extends</span> base_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Function</span> create:static_obj<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o:static_obj = <span style="color: #ffff00; font-weight: bold;">New</span> static_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">angle</span># = <span style="color: #ffff00; font-weight: bold;">Rnd</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0.0</span>, <span style="color: #FFFFFF;">360.0</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">size</span># = <span style="color: #ffff00; font-weight: bold;">Rnd</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0.5</span>, <span style="color: #FFFFFF;">1.0</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">random_color</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">layer</span> = layer_koloboks<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">image</span> = obj_images<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">frame</span> = <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">4</span>, obj_imageq - <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">radius</span># = <span style="color: #FFFFFF;">0.5</span> * o.<span style="">size</span>#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> o.<span style="">frame</span> &gt;= <span style="color: #FFFFFF;">16</span> <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">angle</span># = <span style="color: #FFFFFF;">0.0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">coll_type</span> = CT_SQUARE<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">place_find</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">register</span> INACTIIVE<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> o<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Type</span><br />
<br />
<br />
<span style="color: #B1E7EB;">' Пуля</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> NOT_YET = <span style="color: #FFFFFF;">1000000000</span> <span style="color: #B1E7EB;">' Kонстанта &quot;еще не умер&quot;</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> fading_time = <span style="color: #FFFFFF;">1000</span> <span style="color: #B1E7EB;">' Время &quot;затухания&quot;</span><br />
<span style="color: #ffff00; font-weight: bold;">Type</span> bullet_obj <span style="color: #ffff00; font-weight: bold;">Extends</span> base_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> parent:base_obj <span style="color: #B1E7EB;">' Указатель на стреляющего</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> death = NOT_YET <span style="color: #B1E7EB;">' Время смерти (еще не определено)</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Создаем пулю: начальные координаты, размер, угол, скорость, время жизни, повреждения, стреляющий, отступ от координат</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Function</span> create:bullet_obj<span style=" ">&#40;</span>o:kolobok_obj<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bul:bullet_obj = <span style="color: #ffff00; font-weight: bold;">New</span> bullet_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bul.<span style="">layer</span> = layer_bullets<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bul.<span style="">x</span># = o.<span style="">x</span># + <span style="color: #ffff00; font-weight: bold;">Cos</span><span style=" ">&#40;</span>o.<span style="">angle</span>#<span style=" ">&#41;</span> * d# <span style="color: #B1E7EB;">' Смещение отн. данных координат</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bul.<span style="">y</span># = o.<span style="">y</span># + <span style="color: #ffff00; font-weight: bold;">Sin</span><span style=" ">&#40;</span>o.<span style="">angle</span>#<span style=" ">&#41;</span> * d#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bul.<span style="">r</span> = o.<span style="">r</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bul.<span style="">g</span> = o.<span style="">g</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bul.<span style="">b</span> = o.<span style="">b</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bul.<span style="">image</span> = obj_images<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bul.<span style="">frame</span> = <span style="color: #FFFFFF;">3</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bul.<span style="">parent</span> = o<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bul.<span style="">angle</span># = o.<span style="">angle</span>#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bul.<span style="">size</span># = o.<span style="">size</span># * <span style="color: #FFFFFF;">0.5</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bul.<span style="">speed</span># = o.<span style="">speed</span># + <span style="color: #FFFFFF;">1.5</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bul.<span style="">radius</span> = bsize# * <span style="color: #FFFFFF;">0.25</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bul.<span style="">death</span> = <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> + o.<span style="">bullet_lifetime</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bul.<span style="">register</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> bul<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> draw<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> death = NOT_YET <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetAlpha</span> <span style="color: #FFFFFF;">1</span> <span style="color: #B1E7EB;">' Если пуля еще не начала исчезать, то прозрачность не меняется</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetAlpha</span> limit<span style=" ">&#40;</span>.<span style="color: #FFFFFF;">001</span> * <span style=" ">&#40;</span>death - <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span><span style=" ">&#41;</span>, <span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Иначе потихоньку исчезает</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> death&lt;MilliSecs<span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> destroy <span style="color: #B1E7EB;">' И в конце уничтожается совсем</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">super</span>.<span style="">draw</span> <span style="color: #B1E7EB;">' Запускаем процедуру рисования объекта из base_obj</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> act<span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Действует просто - летит вперед до столкновения</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; move x# + timspeed# * <span style="color: #ffff00; font-weight: bold;">Cos</span><span style=" ">&#40;</span>angle#<span style=" ">&#41;</span> * speed#, y# + timspeed# * <span style="color: #ffff00; font-weight: bold;">Sin</span><span style=" ">&#40;</span>angle#<span style=" ">&#41;</span> * speed#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; collision x#, y#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> &gt; death <span style="color: #ffff00; font-weight: bold;">Then</span> destroy <span style="color: #B1E7EB;">' Время жизни ограничено с появления</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> object_collision_act<span style=" ">&#40;</span>o:base_obj<span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Столкновение с объектом</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> o &lt;&gt; parent <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ccnt:<span style="color: #FFFFFF;">+1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; destroy<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> boundaries_collision_act<span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Уничтожается при столкновении с границами</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; destroy<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Type</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Global</span> tile_object:base_obj = <span style="color: #ffff00; font-weight: bold;">New</span> base_obj<br />
tile_object.<span style="">radius</span># = <span style="color: #FFFFFF;">0.5</span><br />
tile_object.<span style="">coll_type</span> = CT_SQUARE<br />
<br />
<span style="color: #ffff00; font-weight: bold;">SeedRnd</span> <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Для того, чтобы каждый раз получать новую последовательность случайных чисел</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">SetGraphicsDriver</span> <span style="color: #ffff00; font-weight: bold;">GLMax2DDriver</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Установка драйвера отображения графики OpenGL</span><br />
<span style="color: #ffff00; font-weight: bold;">Graphics</span> sxsize, sysize, color_depth<br />
<span style="color: #ffff00; font-weight: bold;">AutoImageFlags</span> FILTEREDIMAGE | MIPMAPPEDIMAGE | DYNAMICIMAGE<br />
<span style="color: #ffff00; font-weight: bold;">SetBlend</span> ALPHABLEND<br />
<br />
<span style="color: #B1E7EB;">' Загружаем изображения с альфа-каналом из exe-файла</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> images:<span style="color: #ffff00; font-weight: bold;">TPixmap</span> = <span style="color: #ffff00; font-weight: bold;">LoadPixmapPNG</span><span style=" ">&#40;</span><span style="color: #00FF66;">&quot;incbin::2DEngine-NewImages.png&quot;</span><span style=" ">&#41;</span><br />
<br />
<span style="color: #B1E7EB;">' Вырезаем изображения</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> obj_images:TImage = tiles_grab<span style=" ">&#40;</span><span style="color: #FFFFFF;">3</span>, <span style="color: #FFFFFF;">22</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Объекты</span><br />
<span style="color: #B1E7EB;">' Создаем текстуры для тайлов</span><br />
tex_water:TImage = tiles_grab<span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">1</span>, <span style="color: #ffff00; font-weight: bold;">False</span><span style=" ">&#41;</span><br />
tex_sand:TImage = tiles_grab<span style=" ">&#40;</span><span style="color: #FFFFFF;">1</span>, <span style="color: #FFFFFF;">1</span>, <span style="color: #ffff00; font-weight: bold;">False</span><span style=" ">&#41;</span><br />
tex_grass:TImage = tiles_grab<span style=" ">&#40;</span><span style="color: #FFFFFF;">2</span>, <span style="color: #FFFFFF;">1</span>, <span style="color: #ffff00; font-weight: bold;">False</span><span style=" ">&#41;</span><br />
<br />
<span style="color: #B1E7EB;">' Создаем в пакете изображений тайлов текстуру воды</span><br />
tile_tex:TImage = <span style="color: #ffff00; font-weight: bold;">CreateImage</span><span style=" ">&#40;</span>tilesize, tilesize, <span style="color: #FFFFFF;">513</span><span style=" ">&#41;</span><br />
pixmap:<span style="color: #ffff00; font-weight: bold;">TPixmap</span> = <span style="color: #ffff00; font-weight: bold;">LockImage</span><span style=" ">&#40;</span>tile_tex,<span style="color: #FFFFFF;">0</span><span style=" ">&#41;</span><br />
pixmap.<span style="">paste</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">LockImage</span><span style=" ">&#40;</span>tex_water<span style=" ">&#41;</span><span style=" ">&#41;</span>, <span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">0</span><br />
<span style="color: #ffff00; font-weight: bold;">UnlockImage</span> tile_tex, <span style="color: #FFFFFF;">0</span><br />
<span style="color: #ffff00; font-weight: bold;">UnlockImage</span> tex_water<br />
<span style="color: #B1E7EB;">' И две библиотеки - переход от воды к песку и от песка к траве</span><br />
tile_lib_create tex_water, tex_sand, <span style="color: #FFFFFF;">4.0</span> / tilesize, <span style="color: #FFFFFF;">360.0</span>, tile_tex, <span style="color: #FFFFFF;">1</span><br />
tile_lib_create tex_sand, tex_grass, <span style="color: #FFFFFF;">4.0</span> / tilesize, <span style="color: #FFFFFF;">720.0</span>, tile_tex, <span style="color: #FFFFFF;">257</span><br />
<br />
<span style="color: #B1E7EB;">' Делаем &quot;пирог&quot; из слоев</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> layer_tiles:tile_layer_obj = tile_layer_obj.<span style="">add</span><span style=" ">&#40;</span>tile_tex<span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Сначала - тайлы</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> layer_bullets:object_layer_obj = object_layer_obj.<span style="">add</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Затем пули</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> layer_koloboks:object_layer_obj = object_layer_obj.<span style="">add</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Потом - колобки и другие объекты</span><br />
<br />
<span style="color: #B1E7EB;">' Создаем слой тайловой коллизии - слой &quot;непроходимой&quot; воды</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> layer_water:tile_collision_layer_obj = tile_collision_layer_obj.<span style="">add</span><span style=" ">&#40;</span><span style=" ">&#41;</span><br />
<br />
<span style="color: #B1E7EB;">' Определяем что с чем коллизирует</span><br />
layer_koloboks.<span style="">collides_with</span> layer_koloboks <span style="color: #B1E7EB;">' Kолобки - между собой</span><br />
layer_koloboks.<span style="">collides_with</span> layer_water <span style="color: #B1E7EB;">' Kолобки - с коллизионным слоем воды</span><br />
layer_bullets.<span style="">collides_with</span> layer_koloboks <span style="color: #B1E7EB;">' Пули - с колобками</span><br />
<br />
field_generate <span style="color: #B1E7EB;">' Создаем поле</span><br />
objects_generate <span style="color: #B1E7EB;">' Создаем объекты</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">HideMouse</span><br />
<br />
cx# = <span style="color: #FFFFFF;">0.5</span> * fxsize<br />
cy# = <span style="color: #FFFFFF;">0.5</span> * fysize<br />
<span style="color: #ffff00; font-weight: bold;">Repeat</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; cx# = limit<span style=" ">&#40;</span>cx# + <span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">MouseX</span><span style=" ">&#40;</span><span style=" ">&#41;</span> - sxsize2<span style=" ">&#41;</span> / sc#, <span style="color: #FFFFFF;">0</span>, fxsize<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; cy# = limit<span style=" ">&#40;</span>cy# + <span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">MouseY</span><span style=" ">&#40;</span><span style=" ">&#41;</span> - sysize2<span style=" ">&#41;</span> / sc#, <span style="color: #FFFFFF;">0</span>, fysize<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; camera_change cx#, cy#, <span style="color: #FFFFFF;">1.1</span> ^ <span style="color: #ffff00; font-weight: bold;">MouseZ</span><span style=" ">&#40;</span><span style=" ">&#41;</span> * <span style="color: #FFFFFF;">64.0</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; tim = <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Засекаем время</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">MoveMouse</span> sxsize2, sysize2 <span style="color: #B1E7EB;">' Установка курсора мыши в центр экрана</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; timspeed# = speedpersec# * dtim# <span style="color: #B1E7EB;">' Определение множителя к скорости на основе прошедшего времени</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; timang# = angpersec# * dtim# <span style="color: #B1E7EB;">' То же для угловой скорости</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Прорисовка слоев</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> l:layer_obj = <span style="color: #ffff00; font-weight: bold;">EachIn</span> layer_order<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; l.<span style="">draw</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; reset_transformations<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Действия активных объектов</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> o:base_obj = <span style="color: #ffff00; font-weight: bold;">EachIn</span> actingobj<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">act</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Отображение курсора</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; field2scr cx#, cy#, sx#, sy#<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawImage</span> obj_images, sx#, sy#, <span style="color: #FFFFFF;">21</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Обновление счетчика кадров в секунду</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> fpstim&lt;= <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fpstim = <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> + <span style="color: #FFFFFF;">1000</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fps = cnt<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cnt = <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cnt:<span style="color: #FFFFFF;">+1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawText</span> <span style="color: #00FF66;">&quot;Frames/sec:&quot;</span> + fps + <span style="color: #00FF66;">&quot;, objects:&quot;</span> + objcnt + <span style="color: #00FF66;">&quot;, collision checks/frame:&quot;</span> + chcnt + <span style="color: #00FF66;">&quot;, collisions/frame:&quot;</span> + ccnt, <span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; ccnt = <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; chcnt = <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Flip</span> <span style="color: #ffff00; font-weight: bold;">False</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Вычисление времени, затраченного на виток цикла (в секундах) для вычисления множителей скоростей</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; dtim# = <span style="color: #FFFFFF;">0.001</span> * <span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Min</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> - tim, minms<span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Время ограниченно пределом для недопущения слишком больших множителей, отрицательно</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' &nbsp;сказывающихся на определении столкновений</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Until</span> <span style="color: #ffff00; font-weight: bold;">KeyHit</span><span style=" ">&#40;</span>KEY_ESCAPE<span style=" ">&#41;</span><br />
<br />
<span style="color: #B1E7EB;">' Генерация поля</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> field_generate<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Const</span> tile_water = <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Const</span> tile_sand = <span style="color: #FFFFFF;">256</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Const</span> tile_grass = <span style="color: #FFFFFF;">512</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Local</span> ff#<span style=" ">&#91;</span>fxsize, fysize, <span style="color: #FFFFFF;">2</span><span style=" ">&#93;</span> <span style="color: #B1E7EB;">' Вспомогательный буферизованный массив высот для тайловой карты</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Local</span> pos2bit<span style=" ">&#91;</span><span style=" ">&#93;</span> = <span style=" ">&#91;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">6</span>, <span style="color: #FFFFFF;">1</span>, <span style="color: #FFFFFF;">4</span>, <span style="color: #FFFFFF;">5</span>, <span style="color: #FFFFFF;">2</span>, <span style="color: #FFFFFF;">7</span>, <span style="color: #FFFFFF;">3</span><span style=" ">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; fmin# = <span style="color: #FFFFFF;">1.0</span>; fmax# = <span style="color: #FFFFFF;">0</span> <span style="color: #B1E7EB;">' Переменные минимума и максимума значений высот</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> n = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">To</span> fblurq + <span style="color: #FFFFFF;">3</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; loadingbar <span style="color: #00FF66;">&quot;Generating field...&quot;</span>, n, fblurq + <span style="color: #FFFFFF;">4</span> <span style="color: #B1E7EB;">' Индикатор завершенности процесса</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; maxd# = <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> y = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> fysize <span style="color: #B1E7EB;">' Цикл по всем тайлам</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> x = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> fxsize<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Select</span> n<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Case</span> <span style="color: #FFFFFF;">0</span> <span style="color: #B1E7EB;">' Сначала заполняем массив высот случайными значениями</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ff#<span style=" ">&#91;</span>x, y, <span style="color: #FFFFFF;">1</span><span style=" ">&#93;</span> = <span style="color: #ffff00; font-weight: bold;">Rnd</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Case</span> fblurq + <span style="color: #FFFFFF;">1</span> <span style="color: #B1E7EB;">' После этапов сглаживания - этап формирования тайловых слоев</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; d# = <span style=" ">&#40;</span>ff#<span style=" ">&#91;</span>x, y, k<span style=" ">&#93;</span> - fmin#<span style=" ">&#41;</span> / <span style=" ">&#40;</span>fmax# - fmin#<span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Kорректируем значение высоты, чтобы минимум соответствовал значению 0.0, максимум - 1.0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> d# &lt; sand_threshold# <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' До порога песка</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> = tile_water <span style="color: #B1E7EB;">' Отображаем чистый тайл воды</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; layer_water.<span style="">collision</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> = <span style="color: #ffff00; font-weight: bold;">True</span> <span style="color: #B1E7EB;">' Установка коллизии с этим тайлом в водном слое</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">ElseIf</span> d# &lt; grass_threshold# <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' От порога песка до порога травы</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> = tile_sand <span style="color: #B1E7EB;">' Пока отображаем чистый тайл песка</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span> <span style="color: #B1E7EB;">' После порога травы</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> = tile_grass <span style="color: #B1E7EB;">' Пока отображаем чистый тайл травы</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Case</span> fblurq + <span style="color: #FFFFFF;">2</span> <span style="color: #B1E7EB;">' Этап устранения травы, примыкающей к воде</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x,y<span style=" ">&#93;</span> = tile_grass <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Если тайл - трава, то</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> yy = - <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #FFFFFF;">1</span> <span style="color: #B1E7EB;">' Цикл по всем соседним тайлам</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> xx = - <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; x2 = <span style=" ">&#40;</span>x + xx + fxsize<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Mod</span> fxsize <span style="color: #B1E7EB;">' Расчет координат соседнего тайла</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; y2 = <span style=" ">&#40;</span>y + yy + fysize<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Mod</span> fysize <span style="color: #B1E7EB;">' &nbsp;(поле зациклено)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x2, y2<span style=" ">&#93;</span> = tile_water <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Если один из тайлов - вода</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> = tile_sand <span style="color: #B1E7EB;">' То меняем тайл травы на тайл песка</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Case</span> fblurq + <span style="color: #FFFFFF;">3</span> <span style="color: #B1E7EB;">' Этап сглаживания тайлов (выбора кадра из библиотеки)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> &gt; tile_water <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Если чистая вода, то пропускаем этот тайл</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bitpos = <span style="color: #FFFFFF;">0</span>; mask = <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> yy = - <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #FFFFFF;">1</span> <span style="color: #B1E7EB;">' Цикл по всем соседним тайлам</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> xx = - <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> xx&lt;&gt;<span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Or</span> yy&lt;&gt;<span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; x2 = <span style=" ">&#40;</span>x + xx + fxsize<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Mod</span> fxsize<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; y2 = <span style=" ">&#40;</span>y + yy + fysize<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Mod</span> fysize<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> &gt; tile_sand <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Если данный тайл - трава, то</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Если соседний тайл - трава, то включаем бит присутствия соседа для данного тайла</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x2, y2<span style=" ">&#93;</span> &gt; tile_sand <span style="color: #ffff00; font-weight: bold;">Then</span> setbit mask, pos2bit<span style=" ">&#91;</span>bitpos<span style=" ">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span> <span style="color: #B1E7EB;">' Иначе это тайл песка</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Если соседний тайл - песок, то включаем бит присутствия соседа для данного тайла</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x2, y2<span style=" ">&#93;</span> &gt; tile_water <span style="color: #ffff00; font-weight: bold;">Then</span> setbit mask, pos2bit<span style=" ">&#91;</span>bitpos<span style=" ">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bitpos:<span style="color: #FFFFFF;">+1</span> <span style="color: #B1E7EB;">' Увеличиваем счетчик номера бита</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> = <span style="color: #FFFFFF;">1</span> + <span style="color: #FFFFFF;">256</span> &nbsp;* <span style=" ">&#40;</span>layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> = tile_grass<span style=" ">&#41;</span> + mask<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Default</span> <span style="color: #B1E7EB;">' Этапы сглаживания массива высот</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sum# = <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> yy = - <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #FFFFFF;">1</span> <span style="color: #B1E7EB;">' Суммируем значения высот соседних тайлов и высоту данного тайла * 8</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> xx = - <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sum# = sum# + ff#<span style=" ">&#91;</span><span style=" ">&#40;</span>x + xx + fxsize<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Mod</span> fxsize, <span style=" ">&#40;</span>y + yy + fysize<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Mod</span> fysize, k<span style=" ">&#93;</span> * <span style=" ">&#40;</span><span style="color: #FFFFFF;">1.0</span> + <span style="color: #FFFFFF;">7.0</span> * <span style=" ">&#40;</span>xx = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">And</span> yy = <span style="color: #FFFFFF;">0</span><span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sum# = sum# / <span style="color: #FFFFFF;">16.0</span> <span style="color: #B1E7EB;">' Вычисляем среднее значение (центральный тайл имеет такой же вес, что и все 8 соседних в сумме)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> n = fblurq <span style="color: #ffff00; font-weight: bold;">Then</span> setminmax sum#, fmin#, fmax# <span style="color: #B1E7EB;">' Kорректируем значения максимума и минимума высоты</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ff#<span style=" ">&#91;</span>x, y, <span style="color: #FFFFFF;">1</span> - k<span style=" ">&#93;</span> = sum# <span style="color: #B1E7EB;">' Устанавливаем значение высоты в буфере</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Select</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; k = <span style="color: #FFFFFF;">1</span> - k <span style="color: #B1E7EB;">' Меняем буфер и текущую карту местами</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> n = fblurq + <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Окантовка карты водой после этапа формирования слоев</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> x = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> fxsize<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; waterize x, <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; waterize x, fysize - <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> y = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> fysize<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; waterize <span style="color: #FFFFFF;">0</span>, y<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; waterize fxsize - <span style="color: #FFFFFF;">1</span>, y<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Залитие тайла водой</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> waterize<span style=" ">&#40;</span>x, y<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> = <span style="color: #FFFFFF;">0</span> <span style="color: #B1E7EB;">' Рисуем тайл воды</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; layer_water.<span style="">collision</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> = <span style="color: #ffff00; font-weight: bold;">True</span> <span style="color: #B1E7EB;">' Kоллизия для тайла водного слоя</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Создание библиотеки тайлов перехода между текстурами</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> tile_lib_create<span style=" ">&#40;</span>bottom_tile:TImage, top_tile:TImage, rowd#, period#, tile_lib:TImage, offset = <span style="color: #FFFFFF;">0</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Local</span> dt#<span style=" ">&#91;</span>tilesize2<span style=" ">&#93;</span> <span style="color: #B1E7EB;">' Заполнение массива колебаний ровной границы</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> dn = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> tilesize2<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dt#<span style=" ">&#91;</span>dn<span style=" ">&#93;</span> = <span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Sin</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">90</span> + dn * period# / tilesize2<span style=" ">&#41;</span> - <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span> * tilesize32<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; bottom_pixmap:<span style="color: #ffff00; font-weight: bold;">TPixmap</span> = <span style="color: #ffff00; font-weight: bold;">LockImage</span><span style=" ">&#40;</span>bottom_tile<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; top_pixmap:<span style="color: #ffff00; font-weight: bold;">TPixmap</span> = <span style="color: #ffff00; font-weight: bold;">LockImage</span><span style=" ">&#40;</span>top_tile<span style=" ">&#41;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> n = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #FFFFFF;">255</span> <span style="color: #B1E7EB;">' Восемь клеток вокруг тайла могут быть такими же либо отличными (2 состояния),</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #B1E7EB;">' поэтому всего - 2 ^ 8 = 256 вариантов</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; loadingbar <span style="color: #00FF66;">&quot;Generating transition tiles...&quot;</span>, n, <span style="color: #FFFFFF;">256</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lib_pixmap:<span style="color: #ffff00; font-weight: bold;">TPixmap</span> = <span style="color: #ffff00; font-weight: bold;">LockImage</span><span style=" ">&#40;</span>tile_lib, n + offset<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> n1 = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> n2 = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v = biton<span style=" ">&#40;</span>n, n1 + n2 * <span style="color: #FFFFFF;">2</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vx = biton<span style=" ">&#40;</span>n, n1 + <span style="color: #FFFFFF;">4</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vy = biton<span style=" ">&#40;</span>n, n2 + <span style="color: #FFFFFF;">6</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> yy = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> tilesize2<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> xx = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> tilesize2<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> vx <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> vy <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> v <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; k1# = <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; k1# = rowd# * <span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Sqr</span><span style=" ">&#40;</span>xx * xx + yy * yy<span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; k1# = <span style=" ">&#40;</span>yy + dt#<span style=" ">&#91;</span>xx<span style=" ">&#93;</span><span style=" ">&#41;</span> * rowd#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span> <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> vy <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; k1# = <span style=" ">&#40;</span>xx + dt#<span style=" ">&#91;</span>yy<span style=" ">&#93;</span><span style=" ">&#41;</span> * rowd#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; k1# = <span style="color: #FFFFFF;">2.0</span> - rowd# * <span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Sqr</span><span style=" ">&#40;</span><span style=" ">&#40;</span>tilesize2 - xx<span style=" ">&#41;</span> * <span style=" ">&#40;</span>tilesize2 - xx<span style=" ">&#41;</span> + <span style=" ">&#40;</span>tilesize2 - yy<span style=" ">&#41;</span> * <span style=" ">&#40;</span>tilesize2 - yy<span style=" ">&#41;</span><span style=" ">&#41;</span> + <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span> <span style="color: #FFFFFF;">-1</span>, <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> k1# &gt; <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">Then</span> k1# = <span style="color: #FFFFFF;">1</span> <span style="color: #B1E7EB;">' Ограничиваем коэффициент в пределах интервала [0, 1]</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> k1# &lt; <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Then</span> k1# = <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; k2# = <span style="color: #FFFFFF;">1.0</span> - k1# <span style="color: #B1E7EB;">' Kоэффициент прозрачности для пикселей другого тайла</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> n1 <span style="color: #ffff00; font-weight: bold;">Then</span> x = tilesize - <span style="color: #FFFFFF;">1</span> - xx <span style="color: #ffff00; font-weight: bold;">Else</span> x = xx <span style="color: #B1E7EB;">' Отражения отн. осей (если нужно)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> n2 <span style="color: #ffff00; font-weight: bold;">Then</span> y = tilesize - <span style="color: #FFFFFF;">1</span> - yy <span style="color: #ffff00; font-weight: bold;">Else</span> y = yy<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fromrgba <span style="color: #ffff00; font-weight: bold;">ReadPixel</span><span style=" ">&#40;</span>top_pixmap, x, y<span style=" ">&#41;</span>, r1, g1, b1, dummy <span style="color: #B1E7EB;">' Получаем цветовые компоненты пикселей тайлов</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fromrgba <span style="color: #ffff00; font-weight: bold;">ReadPixel</span><span style=" ">&#40;</span>bottom_pixmap, x, y<span style=" ">&#41;</span>, r2, g2, b2, dummy<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Печатаем пиксел, смешивая цвета с заданными коэффициентами</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">WritePixel</span> lib_pixmap, x, y, torgba<span style=" ">&#40;</span>k1# * r1 + k2# * r2, k1# * g1 + k2# * g2, k1# * b1 + k2# * b2, <span style="color: #FFFFFF;">255</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">UnlockImage</span> bottom_tile<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">UnlockImage</span> top_tile<br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Генерация объектов</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> objects_generate<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> n = <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">To</span> objq<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style=" ">&#40;</span>n <span style="color: #ffff00; font-weight: bold;">Mod</span> <span style="color: #FFFFFF;">100</span><span style=" ">&#41;</span> = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Then</span> loadingbar <span style="color: #00FF66;">&quot;Generating objects...&quot;</span>, n, objq<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">2</span><span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> kolobok_obj.<span style="">create</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Else</span> static_obj.<span style="">create</span><span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Функция изменения координат камеры и увеличения</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> camera_change<span style=" ">&#40;</span>x#, y#, scale#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Приращения координат камеры и увеличения</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; sc# = sc# + magn_speed# * <span style=" ">&#40;</span>scale# - sc#<span style=" ">&#41;</span> * dtim#<br />
&nbsp; &nbsp; &nbsp; &nbsp; camx# = camx# + cam_speed# * <span style=" ">&#40;</span>x# - camx#<span style=" ">&#41;</span> * dtim#<br />
&nbsp; &nbsp; &nbsp; &nbsp; camy# = camy# + cam_speed# * <span style=" ">&#40;</span>y# - camy#<span style=" ">&#41;</span> * dtim#<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; sc# = limit<span style=" ">&#40;</span>sc#, <span style="color: #ffff00; font-weight: bold;">Max</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">1.0</span> * sxsize / fxsize, <span style="color: #FFFFFF;">1.0</span> * sysize / fysize<span style=" ">&#41;</span>, <span style="color: #FFFFFF;">256.0</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Ограничение увеличения</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; tilesc# = sc# / tilesize <span style="color: #B1E7EB;">' Вычисление коэффициента увеличения для тайлов</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; xsize# = sxsize / sc#&nbsp; &nbsp;<span style="color: #B1E7EB;">' Размеры отображаемого прямоугольного куска поля</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; ysize# = sysize / sc#<br />
&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; fdx# = limit<span style=" ">&#40;</span>camx# - xsize# * <span style="color: #FFFFFF;">0.5</span>, <span style="color: #FFFFFF;">0</span>, fxsize - xsize#<span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Ограничения смещения поля (по границам)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; fdy# = limit<span style=" ">&#40;</span>camy# - ysize# * <span style="color: #FFFFFF;">0.5</span>, <span style="color: #FFFFFF;">0</span>, fysize - ysize#<span style=" ">&#41;</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Функция вырезания изображения из другого изображения</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> new_grab:TImage<span style=" ">&#40;</span>image:TImage, x, y, frame<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; pixmap:<span style="color: #ffff00; font-weight: bold;">TPixmap</span> = <span style="color: #ffff00; font-weight: bold;">LockImage</span><span style=" ">&#40;</span>image, frame<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; w:<span style="color: #ffff00; font-weight: bold;">TPixmap</span> = images.<span style="">window</span><span style=" ">&#40;</span>x, y, <span style="color: #ffff00; font-weight: bold;">ImageWidth</span><span style=" ">&#40;</span>image<span style=" ">&#41;</span>, <span style="color: #ffff00; font-weight: bold;">ImageHeight</span><span style=" ">&#40;</span>image<span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; pixmap.<span style="">paste</span> w, <span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">UnlockImage</span> image<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> image<br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Функция вырезания тайла или серии тайлов из изображения</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> tiles_grab:TImage<span style=" ">&#40;</span>num, frameq = <span style="color: #FFFFFF;">1</span>, midhn = <span style="color: #ffff00; font-weight: bold;">True</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; image:TImage = <span style="color: #ffff00; font-weight: bold;">CreateImage</span><span style=" ">&#40;</span>tilesize, tilesize, frameq<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> midhn <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #ffff00; font-weight: bold;">MidHandleImage</span> image <span style="color: #B1E7EB;">' флаг midhn означает, что изображение нужно отцентровать</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> n = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">To</span> frameq - <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pos = num + n<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; new_grab image, <span style=" ">&#40;</span>pos <span style="color: #ffff00; font-weight: bold;">Mod</span> <span style="color: #FFFFFF;">4</span><span style=" ">&#41;</span> * tilesize, <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>pos / <span style="color: #FFFFFF;">4</span><span style=" ">&#41;</span> * tilesize, n <span style="color: #B1E7EB;">' По умолчанию тайлы располагаются на изображении в 4 столбца</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> image<br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Установка цвета - оттенка серого</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> SetGrayColor<span style=" ">&#40;</span>col<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetColor</span> col, col, col<br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Полоса отображения завершенности процесса</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> loadingbar<span style=" ">&#40;</span>txt$, pos, maximum<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Cls</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetColor</span> <span style="color: #FFFFFF;">128</span>, <span style="color: #FFFFFF;">128</span>, <span style="color: #FFFFFF;">255</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawText</span> txt$, <span style=" ">&#40;</span>sxsize - <span style="color: #ffff00; font-weight: bold;">TextWidth</span><span style=" ">&#40;</span>txt$<span style=" ">&#41;</span><span style=" ">&#41;</span> / <span style="color: #FFFFFF;">2</span>, sysize34<br />
&nbsp; &nbsp; &nbsp; &nbsp; col = <span style="color: #FFFFFF;">255</span> * pos / maximum<br />
&nbsp; &nbsp; &nbsp; &nbsp; SetGrayColor <span style="color: #FFFFFF;">255</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; DrawEmptyRect sxsize4, sysize34 + <span style="color: #FFFFFF;">20</span>, sxsize2, <span style="color: #FFFFFF;">30</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetColor</span> <span style="color: #FFFFFF;">255</span> - col, col, <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawRect</span> sxsize4 + <span style="color: #FFFFFF;">2</span>, sysize34 + <span style="color: #FFFFFF;">22</span>, sxsize24 * pos / maximum, <span style="color: #FFFFFF;">26</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Flip</span> <span style="color: #ffff00; font-weight: bold;">False</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; SetGrayColor <span style="color: #FFFFFF;">255</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Функция, рисующая пустой прямоугольник</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> DrawEmptyRect<span style=" ">&#40;</span>x#, y#, xsize#, ysize#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; xsize# = xsize# - <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; ysize# = ysize# - <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawLine</span> x#, y#, x# + xsize#, y#<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawLine</span> x# + xsize#, y#, x# + xsize#,y# + ysize#<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawLine</span> x# + xsize#, y# + ysize#, x#, y# + ysize#<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawLine</span> x#, y# + ysize#, x#, y#<br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Функция, переводящая Write/ReadPixel-значение в значения цветовых компонент и альфа канала</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> fromRGBa<span style=" ">&#40;</span>from, r <span style="color: #ffff00; font-weight: bold;">Var</span>, g <span style="color: #ffff00; font-weight: bold;">Var</span>, b <span style="color: #ffff00; font-weight: bold;">Var</span>, a <span style="color: #ffff00; font-weight: bold;">Var</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; b = from &amp; $FF<br />
&nbsp; &nbsp; &nbsp; &nbsp; g = <span style=" ">&#40;</span>from <span style="color: #ffff00; font-weight: bold;">Shr</span> <span style="color: #FFFFFF;">8</span><span style=" ">&#41;</span> &amp; $FF<br />
&nbsp; &nbsp; &nbsp; &nbsp; r = <span style=" ">&#40;</span>from <span style="color: #ffff00; font-weight: bold;">Shr</span> <span style="color: #FFFFFF;">16</span><span style=" ">&#41;</span> &amp; $FF<br />
&nbsp; &nbsp; &nbsp; &nbsp; a = <span style=" ">&#40;</span>from <span style="color: #ffff00; font-weight: bold;">Shr</span> <span style="color: #FFFFFF;">24</span><span style=" ">&#41;</span> &amp; $FF<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Функция, переводящая значения цветовых компонент и альфа канала в Write/ReadPixel-значение</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> toRGBa<span style=" ">&#40;</span>r, g, b, a = <span style="color: #FFFFFF;">255</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> b | <span style=" ">&#40;</span>g <span style="color: #ffff00; font-weight: bold;">Shl</span> <span style="color: #FFFFFF;">8</span><span style=" ">&#41;</span> | <span style=" ">&#40;</span>r <span style="color: #ffff00; font-weight: bold;">Shl</span> <span style="color: #FFFFFF;">16</span><span style=" ">&#41;</span> | <span style=" ">&#40;</span>a <span style="color: #ffff00; font-weight: bold;">Shl</span> <span style="color: #FFFFFF;">24</span><span style=" ">&#41;</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Функция сброса трансформаций</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> reset_transformations<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; SetGrayColor <span style="color: #FFFFFF;">255</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetRotation</span> <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetAlpha</span> <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetScale</span> <span style="color: #FFFFFF;">1.0</span>, <span style="color: #FFFFFF;">1.0</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Перевод из экранных координат в тайловые</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> scr2field<span style=" ">&#40;</span>sx#, sy#, tx# <span style="color: #ffff00; font-weight: bold;">Var</span>, ty# <span style="color: #ffff00; font-weight: bold;">Var</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; tx# = sx# / sc# + fdx#<br />
&nbsp; &nbsp; &nbsp; &nbsp; ty# = sy# / sc# + fdy#<br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Перевод из тайловых координат в экранные</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> field2scr<span style=" ">&#40;</span>tx#, ty#, sx# <span style="color: #ffff00; font-weight: bold;">Var</span>, sy# <span style="color: #ffff00; font-weight: bold;">Var</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; sx# = <span style=" ">&#40;</span>tx# - fdx#<span style=" ">&#41;</span> * sc#<br />
&nbsp; &nbsp; &nbsp; &nbsp; sy# = <span style=" ">&#40;</span>ty# - fdy#<span style=" ">&#41;</span> * sc#<br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Ограничение переменной минимальным и максимальным значениями</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> limit#<span style=" ">&#40;</span>v#, vmin#, vmax#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> v# &lt; vmin# <span style="color: #ffff00; font-weight: bold;">Then</span> v = vmin# <span style="color: #ffff00; font-weight: bold;">ElseIf</span> v# &gt; vmax# <span style="color: #ffff00; font-weight: bold;">Then</span> v# = vmax#<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> v#<br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Функция, возвращающая значение бита под номером bitnum</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> biton<span style=" ">&#40;</span>v, bitnum<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> v &amp; <span style=" ">&#40;</span><span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">Shl</span> bitnum<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #ffff00; font-weight: bold;">Return</span> <span style="color: #ffff00; font-weight: bold;">True</span> <span style="color: #ffff00; font-weight: bold;">Else</span> <span style="color: #ffff00; font-weight: bold;">Return</span> <span style="color: #ffff00; font-weight: bold;">False</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Включение бита под номером bitnum в значении переменной</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> setbit<span style=" ">&#40;</span>v <span style="color: #ffff00; font-weight: bold;">Var</span>, bitnum<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; v = v | <span style=" ">&#40;</span><span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">Shl</span> bitnum<span style=" ">&#41;</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Изменение минимума и максимума на основе переменной</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> setminmax<span style=" ">&#40;</span>v#, vmin# <span style="color: #ffff00; font-weight: bold;">Var</span>, vmax# <span style="color: #ffff00; font-weight: bold;">Var</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> v#&lt;vmin# <span style="color: #ffff00; font-weight: bold;">Then</span> vmin# = v#<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> v#&gt;vmax# <span style="color: #ffff00; font-weight: bold;">Then</span> vmax# = v#<br />
</p>
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span></div>
<p><br />
</p>
<a name=".D0.98.D0.B3.D1.80.D0.B0"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B4%D0%B2%D1%83%D0%BC%D0%B5%D1%80%D0%BD%D0%BE%D0%B3%D0%BE_%D0%B4%D0%B2%D0%B8%D0%B6%D0%BA%D0%B0_%D0%BD%D0%B0_%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D0%B5_%D0%B8%D0%B3%D1%80%D1%8B_%C2%AB%D0%97%D0%B2%D0%B5%D1%80%D1%81%D0%BA%D0%B8%D0%B5_%D0%BA%D0%BE%D0%BB%D0%BE%D0%B1%D0%BA%D0%B8%C2%BB&amp;action=edit&amp;section=19" title="Править секцию: Игра">править</a>]</span> <span class="mw-headline">Игра</span></h2>
<p>Итак, движок готов, теперь перейдем непосредственно к созданию игры. Возможно, некоторые из вас уже проводят аналогии с нашумевшим хитом Crimsonland от Reflexive. Разовьем основную идею (отражение атаки толпы монстров) в несколько ином направлении. У нас уже есть ландшафт и стреляющие колобки. Пусть главный герой - колобок будет отбиваться от нападения диких колобков. Колобки будут двух видов - водные и сухопутные. Разбросаем по полю ящики с бонусами. Цель - собрать некоторое кол-во определенных предметов. Для этого главный герой должен будет искать их, разбивая ящики. Таким образом, он будет вынужден обойти большую часть поля, отбиваясь от врагов. Сделаем это занятие увлекательным и по возможности долгим (но не до такой степени, чтобы игроку осточертело однообразие).
</p><p>Хоть это и необязательно для демошки, но обоснуем тот факт, что колобок игрока оказывается на острове в окружении враждебных колобков и ящиков. Слушайте сказку: однажды в одном из секторов одного киберпространства жили цивилизованные колобки. Группа ученых колобков занималась исследованиями в дальних слаборазведанных областях. Однажды они были атакованы ордой диких колобков, вторгшихся из "пространства хаоса". Ученых было мало, они были слабо защищены и поэтому дикари выбросили их далеко за пределы исследовательской области. Наш главный герой был в это время в краткосрочной экспедиции на киберпространственном транспортере. Вернувшись и просканировав местность, он увидел, что произошло, и решил отвоевать плацдарм. На борту было оружие и оборудование, но вот незадача - зверские колобки дестабилизировали поле сектора и забарахливший навигационный модуль телепортатора разбросал ящики по всему острову. Теперь нужно активировать все энергетические источники, чтобы создать шоковую волну, которая выбросит диких колобков из этого и смежных секторов. А там и остальные ученые подтянутся...  
</p>
<a name=".D0.9F.D0.BE.D0.BB.D1.83.D1.87.D0.B5.D0.BD.D0.B8.D0.B5_.D0.BF.D0.BE.D0.B2.D1.80.D0.B5.D0.B6.D0.B4.D0.B5.D0.BD.D0.B8.D0.B9_.D0.B8_.D1.80.D0.B0.D0.B7.D1.80.D1.83.D1.88.D0.B5.D0.BD.D0.B8.D0.B5"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B4%D0%B2%D1%83%D0%BC%D0%B5%D1%80%D0%BD%D0%BE%D0%B3%D0%BE_%D0%B4%D0%B2%D0%B8%D0%B6%D0%BA%D0%B0_%D0%BD%D0%B0_%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D0%B5_%D0%B8%D0%B3%D1%80%D1%8B_%C2%AB%D0%97%D0%B2%D0%B5%D1%80%D1%81%D0%BA%D0%B8%D0%B5_%D0%BA%D0%BE%D0%BB%D0%BE%D0%B1%D0%BA%D0%B8%C2%BB&amp;action=edit&amp;section=20" title="Править секцию: Получение повреждений и разрушение">править</a>]</span> <span class="mw-headline">Получение повреждений и разрушение</span></h2>
<p>Сделаем для каждого объекта "запас прочности" (назовем кратко - здоровьем) и пусть попадания пуль этот запас расходуют. При этом, чтобы показать, что в объект попали, пусть он на мгновение покраснеет. Когда здоровье упадет до 0, объект будет в течение некоторого времени исчезать и, затем, уничтожится. Для этих состояний введем переменную в тип объекта - damage_end (время окончания покраснения от повреждений) и перенесем death (время смерти, хотя по сюжету - выброса за пределы сектора) из объекта пули в базовый. Если эти переменные больше Millisecs(), то на основе разницы можно определить коэффициент "покраснения" и прозрачность. Добавим в основной тип метод получения повреждений (возможно, приводящий к смерти) - damage.
</p>
<a name=".D0.98.D0.B3.D1.80.D0.BE.D0.BA"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B4%D0%B2%D1%83%D0%BC%D0%B5%D1%80%D0%BD%D0%BE%D0%B3%D0%BE_%D0%B4%D0%B2%D0%B8%D0%B6%D0%BA%D0%B0_%D0%BD%D0%B0_%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D0%B5_%D0%B8%D0%B3%D1%80%D1%8B_%C2%AB%D0%97%D0%B2%D0%B5%D1%80%D1%81%D0%BA%D0%B8%D0%B5_%D0%BA%D0%BE%D0%BB%D0%BE%D0%B1%D0%BA%D0%B8%C2%BB&amp;action=edit&amp;section=21" title="Править секцию: Игрок">править</a>]</span> <span class="mw-headline">Игрок</span></h2>
<p>Главный объект в игре, конечно, сам игрок, точнее то, чем он управляет. Создадим для него отдельный тип на основе типа колобка, ведь это колобок, но ведет он себя иначе. Управление - стандартное Квейкеровское - WASD. Причем, кнопки задают угол движения и если нажаты две одновременно, колобок движется по диагонали (как это реализовано, посмотрите в программе). Компьютерные миры - не Солнечная Система, поэтому мир вертится не вокруг Солнца, а вокруг игрока. То есть, камеру нужно привязать к колобку - главному герою (если просто передвигать обычным образом за ним, то перемещение будет дерганым). И границы перемещения прицела тоже будут зависеть от положения игрока. Для удобства обзора, лучше сделать, чтобы камера стремилась в точку, находящуюся на середине отрезка "игрок - прицел". Так можно будет "глядеть по сторонам". Стрелять игрок будет в направлении прицела, как в Crimsonland. 
</p>
<a name=".D0.A5.D0.B0.D1.80.D0.B0.D0.BA.D1.82.D0.B5.D1.80.D0.B8.D1.81.D1.82.D0.B8.D0.BA.D0.B8_.D0.BA.D0.BE.D0.BB.D0.BE.D0.B1.D0.BA.D0.BE.D0.B2"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B4%D0%B2%D1%83%D0%BC%D0%B5%D1%80%D0%BD%D0%BE%D0%B3%D0%BE_%D0%B4%D0%B2%D0%B8%D0%B6%D0%BA%D0%B0_%D0%BD%D0%B0_%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D0%B5_%D0%B8%D0%B3%D1%80%D1%8B_%C2%AB%D0%97%D0%B2%D0%B5%D1%80%D1%81%D0%BA%D0%B8%D0%B5_%D0%BA%D0%BE%D0%BB%D0%BE%D0%B1%D0%BA%D0%B8%C2%BB&amp;action=edit&amp;section=22" title="Править секцию: Характеристики колобков">править</a>]</span> <span class="mw-headline">Характеристики колобков</span></h2>
<p>В программе уже есть несколько. Добавим еще и сформируем полный список (в скобках дан диапазон для случайных значений):
</p>
<ul><li>Цвет 
</li><li>Размер (1/4 - 4/4 тайла)
</li><li>Скорость (0.5 - 2.0 тайлов / сек)
</li><li>Максимальное здоровье (50 - 200)
</li><li>Время перезарядки (300 - 1000 мс)
</li><li>Скорость и время жизни пули (1 - 4 с)
</li><li>Повреждения от попадания пули (1 - 5)
</li><li>Повреждение от укуса (4 - 12)
</li><li>Интервал между укусами (200 - 500 мс)
</li></ul>
<p>Но если все так и оставить, то некоторые колобки будут быстрыми, кусачими и скорострельными - просто смертоносными, а другие - обделенным по всем параметрам пушечным мясом. Введем некоторые ограничения. Разделим колобков на тех, кто может (сюда войдут все водные колобки, иначе они будут просто тупо толпиться у берега, не в силах достать игрока) и кто не может стрелять, а скорость и размер определим исходя из остальных параметров. То есть если колобок хорошо стреляет, то пусть он будет большим (чтобы было легче попасть) и неповоротливым, а кусачие-only пусть будут мелкие и быстрые.  
</p>
<a name=".D0.92.D1.80.D0.B0.D0.B3.D0.B8:_.D0.B4.D0.B2.D0.B8.D0.B6.D0.B5.D0.BD.D0.B8.D0.B5_.D0.BA_.D0.B8.D0.B3.D1.80.D0.BE.D0.BA.D1.83.2C_.D1.83.D0.BA.D1.83.D1.81.D1.8B.2C_.D1.81.D1.82.D1.80.D0.B5.D0.BB.D1.8C.D0.B1.D0.B0_.D0.B2_.D0.BD.D0.B5.D0.B3.D0.BE"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B4%D0%B2%D1%83%D0%BC%D0%B5%D1%80%D0%BD%D0%BE%D0%B3%D0%BE_%D0%B4%D0%B2%D0%B8%D0%B6%D0%BA%D0%B0_%D0%BD%D0%B0_%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D0%B5_%D0%B8%D0%B3%D1%80%D1%8B_%C2%AB%D0%97%D0%B2%D0%B5%D1%80%D1%81%D0%BA%D0%B8%D0%B5_%D0%BA%D0%BE%D0%BB%D0%BE%D0%B1%D0%BA%D0%B8%C2%BB&amp;action=edit&amp;section=23" title="Править секцию: Враги: движение к игроку, укусы, стрельба в него">править</a>]</span> <span class="mw-headline">Враги: движение к игроку, укусы, стрельба в него</span></h2>
<p>Бесцельное блуждание врагов - это неспортивно (да и игроку неприятно такое игнорирование), поэтому установим им особое отношение к главному герою. А именно - пусть бегут к нему, стреляют и пытаются укусить. Это реализовать несложно - определяем угол движения функцией ATan2(разница y-координат, разница х-координат) и двигаем колобка в эту сторону, он начинает стрелять, если расстояние между ним и игроком меньше определенного предела (чтобы враги не калечили друг друга вдали от игрока, где попасть в него они в принципе не могут). 
</p><p>Но просто поворачиваться при столкновении с чем-нибудь недостаточно. Сделаем более эффективный алгоритм обхода препятствий. Пусть колобки при столкновении с препятствием пробуют переместиться влево / вправо (или в обратном порядке), а если не вышло, то повернуться на случайный угол. Но если колобок отойдет от препятствия, то на следующем цикле снова пойдет к игроку и опять окажется в той же ситуации, т. е. застрянет. Чтобы этого не произошло, пусть колобки плавно поворачиваются к игроку (зависимость от времени такая же, как и при движении). Если все это реализовать, то получится довольно сносно: колобки будут перемещаться скачками вдоль препятствий ландшафта и отпрыгивать в сторону, образуя толпу поразряженней.
</p><p>Еще стоит добавить алгоритм исключения "стрельбы своим в спину", но его я пока детально описывать не буду.
</p><p>С укусами разберемся так - если колобок столкнулся с игроком, он кусает его и отнимает здоровье, после чего в переменную "перезарядки" укуса заносится время, по достижении которого можно будет куснуть снова. Если колобок "присосался" к игроку, то он просто стоит.
</p>
<a name=".D0.91.D0.BE.D0.BD.D1.83.D1.81.D1.8B"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B4%D0%B2%D1%83%D0%BC%D0%B5%D1%80%D0%BD%D0%BE%D0%B3%D0%BE_%D0%B4%D0%B2%D0%B8%D0%B6%D0%BA%D0%B0_%D0%BD%D0%B0_%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D0%B5_%D0%B8%D0%B3%D1%80%D1%8B_%C2%AB%D0%97%D0%B2%D0%B5%D1%80%D1%81%D0%BA%D0%B8%D0%B5_%D0%BA%D0%BE%D0%BB%D0%BE%D0%B1%D0%BA%D0%B8%C2%BB&amp;action=edit&amp;section=24" title="Править секцию: Бонусы">править</a>]</span> <span class="mw-headline">Бонусы</span></h2>
<p>Просто так бродить по полю в поисках источников, даже отбиваясь от колобков - занятие однообразное. Нужно поощрить игрока за его борьбу. Пусть в ящиках будут бонусы, повышающие характеристики игрока. Тогда при сборе большей их части, игрок из вечно убегающего и уворачивающегося солдатика превратится в скоростной танк. Вот список характеристик игрока (в скобках - начальное и максимальное/минимальное значение).
</p>
<ul><li>Цвет - белый 
</li><li>Размер (3/4 тайла)
</li><li>Скорость (2 - 4 тайлов / сек)
</li><li>Максимальное здоровье (300 - 800)
</li><li>Время перезарядки (450 - 50 мс)
</li><li>Скорость и время жизни пули (2 - 5 с)
</li><li>Повреждения от попадания пули (2.5 - 12.5)
</li></ul>
<p>Причем, лучше, чтобы на поле было фиксированное кол-во ящиков с каждым бонусом, чтобы игрок смог при желании достигнуть максимума и не смог бы "переборщить". Сделаем так, чтобы можно было менять кол-во ящиков с бонусами. Тогда улучшения характеристик будут зависеть от этой константы (меньше ящиков - значительнее изменение характеристики при сборе одного бонуса и наоборот).
</p><p>Создадим два новых типа - ящик (коллизионная модель - квадрат, размер - 1.0, доп. переменная - тип бонуса внутри) и бонус (коллизионная модель - круг, метод get (когда игрок берет бонус)). Чтобы бонус привлекал внимание, пусть раскачивается и пульсирует. Для этого внесем пару переменных (чтобы бонусы пульсировали по-разному).
</p>
<a name=".D0.A7.D0.B0.D1.81.D1.82.D0.B8.D1.86.D1.8B:_.D1.80.D0.B0.D0.B7.D1.80.D1.83.D1.88.D0.B5.D0.BD.D0.B8.D0.B5_.D1.8F.D1.89.D0.B8.D0.BA.D0.BE.D0.B2"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B4%D0%B2%D1%83%D0%BC%D0%B5%D1%80%D0%BD%D0%BE%D0%B3%D0%BE_%D0%B4%D0%B2%D0%B8%D0%B6%D0%BA%D0%B0_%D0%BD%D0%B0_%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D0%B5_%D0%B8%D0%B3%D1%80%D1%8B_%C2%AB%D0%97%D0%B2%D0%B5%D1%80%D1%81%D0%BA%D0%B8%D0%B5_%D0%BA%D0%BE%D0%BB%D0%BE%D0%B1%D0%BA%D0%B8%C2%BB&amp;action=edit&amp;section=25" title="Править секцию: Частицы: разрушение ящиков">править</a>]</span> <span class="mw-headline">Частицы: разрушение ящиков</span></h2>
<p>Простое исчезновение ящиков с последующим появлением бонуса выглядит неэффектно. Сделаем так, чтобы они разваливались на части. Метод довольно простой - есть несколько наборов кусочков ящика (он разбивается на 16 квадратов). Они появляются вместо ящика вместе с бонусом, который частично скрывают (создадим еще один слой сверху, чтобы осколки были над колобками), и тут же разлетаются в стороны с затуханием.  
</p>
<a name=".D0.92.D1.80.D0.B5.D0.BC.D0.B5.D0.BD.D0.BD.D1.8B.D0.B5_.D1.81.D0.BE.D1.81.D1.82.D0.BE.D1.8F.D0.BD.D0.B8.D1.8F"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B4%D0%B2%D1%83%D0%BC%D0%B5%D1%80%D0%BD%D0%BE%D0%B3%D0%BE_%D0%B4%D0%B2%D0%B8%D0%B6%D0%BA%D0%B0_%D0%BD%D0%B0_%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D0%B5_%D0%B8%D0%B3%D1%80%D1%8B_%C2%AB%D0%97%D0%B2%D0%B5%D1%80%D1%81%D0%BA%D0%B8%D0%B5_%D0%BA%D0%BE%D0%BB%D0%BE%D0%B1%D0%BA%D0%B8%C2%BB&amp;action=edit&amp;section=26" title="Править секцию: Временные состояния">править</a>]</span> <span class="mw-headline">Временные состояния</span></h2>
<p>Но до танка расти долго, а задать зверским колобкам взбучку хочется уже сейчас. Сделаем временный бонус, увеличивающий огневую мощь. Тоже введем переменную (можно глобальную, т. к. игрок - один), определяющую, когда действие бонуса закончится. А до этого времени пусть колобок мигает желтым цветом (для введения периодичности хорошо подходит функция синуса). Чтобы дикие колобки не лезли, как последнее мясо, на мега-пули, пусть во время расцвета ваших сил драпают от вас (просто прибавить к углу наведения на игрока 180 градусов). Так гораздо интереснее - не так-то просто попасть. Аналогично делаем неуязвимость (индицируется полупрозрачностью), суперскорость. Просто вносим условия, проверяющие, действует ли бонус, и если да, то меняющие характеристики (огневая мощь, скорость) / пресекающие повреждения (неуязвимость). Еще веселая штука - бомба: просто генерируем несколько колец из увеличенных сверхповреждающих пуль. Плюс добавим бонус "здоровье" - восстановление 10% от максимума.
</p>
<a name=".D0.98.D0.B3.D1.80.D0.BE.D0.BA:_.D1.82.D0.B5.D0.BB.D0.B5.D0.BF.D0.BE.D1.80.D1.82.D0.B0.D1.86.D0.B8.D1.8F.2C_.D0.A1.D0.B8.D0.BB.D0.B0"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B4%D0%B2%D1%83%D0%BC%D0%B5%D1%80%D0%BD%D0%BE%D0%B3%D0%BE_%D0%B4%D0%B2%D0%B8%D0%B6%D0%BA%D0%B0_%D0%BD%D0%B0_%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D0%B5_%D0%B8%D0%B3%D1%80%D1%8B_%C2%AB%D0%97%D0%B2%D0%B5%D1%80%D1%81%D0%BA%D0%B8%D0%B5_%D0%BA%D0%BE%D0%BB%D0%BE%D0%B1%D0%BA%D0%B8%C2%BB&amp;action=edit&amp;section=27" title="Править секцию: Игрок: телепортация, Сила">править</a>]</span> <span class="mw-headline">Игрок: телепортация, Сила</span></h2>
<p>Очень неприятно, когда враги зажмут в кольцо и начнут закусывание до смерти. Ну так сделаем нашего героя Джедаем и дадим ему Силу. При нажатии на правую кнопку мыши, пусть Сила активируется, некоторое время отталкивая колобков от игрока в некотором радиусе. Уже есть возможность вырваться, но не стоит давать игроку возможность применять Силу постоянно. Пусть она восстанавливается в течение 5 секунд. Все это реализуется введением нескольких глобальных временнЫх переменных (как делали ранее) и несколькими условиями. Да, и еще для эффекту добавим кратковременное "взбухание" игрока, тоже через переменные, хранящие время.
</p><p>Часть ящиков, в том числе с источниками энергии, могут оказаться на недоступном островке. Поэтому сделаем возможность телепортации. А чтобы игрок не злоупотреблял этим, пусть нужно будет 5 секунд готовиться - стоять и мужественно терпеть укусы и попадания. Что до эффектов, пусть во время подготовки колобок мигает (меняется прозрачность), затем уменьшается до 0 и появляется, увеличиваясь, в новом месте (если к тому времени его еще никто не занял). В итоге - 4 статуса телепортации - нормальная игра, подготовка, уменьшение, увеличение. Вдобавок, зафиксируем камеру на колобке в период телепортации.
</p><p>Ну и, наконец, когда все источники энергии собраны, постепенно "забелим" экран, рисуя поверх всего белый прямоугольник с увеличивающимся коэффициентом непрозрачности. А потом выведем сообщение с поздравлением. 
</p>
<a name=".D0.97.D0.B0.D0.BA.D0.BB.D1.8E.D1.87.D0.B5.D0.BD.D0.B8.D0.B5"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B4%D0%B2%D1%83%D0%BC%D0%B5%D1%80%D0%BD%D0%BE%D0%B3%D0%BE_%D0%B4%D0%B2%D0%B8%D0%B6%D0%BA%D0%B0_%D0%BD%D0%B0_%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D0%B5_%D0%B8%D0%B3%D1%80%D1%8B_%C2%AB%D0%97%D0%B2%D0%B5%D1%80%D1%81%D0%BA%D0%B8%D0%B5_%D0%BA%D0%BE%D0%BB%D0%BE%D0%B1%D0%BA%D0%B8%C2%BB&amp;action=edit&amp;section=28" title="Править секцию: Заключение">править</a>]</span> <span class="mw-headline">Заключение</span></h2>
<p>На этом, создание игры, разумеется, не заканчивается. Еще нужно сделать оформление: заставку, предысторию, меню; придумать уровни: нарисовать тайлы, сделать карты, разместить врагов (а также нарисовать и придумать новых, в т. ч. боссов); написать музыку; подобрать звуки. В общем, поле для улучшения весьма обширное, есть где развернуться перфекционисту&nbsp;:). Но начинать советую именно с базы, с движка (а то некоторые сначала делают меню, настройки управления, а потом, столкнувшись с трудностями создания движка, все бросают).
</p><p>Теперь о управлении для тех, кто все быстренько пролистал и хочет сыграть в игру: WSAD - перемещение, колесико мыши - увеличение, левая кнопка мыши - огонь, правая - Сила, пробел - телепорт.  
</p><p>И еще: если игра покажется вам сложной - используйте несколько приемов:
</p>
<ul><li>Старайтесь уходить от скоплений колобков
</li><li>Если вас зажали - применяйте Силу и немедленно выбирайтесь из окружения.
</li><li>Если вы взяли неуязвимость, можно смело телепортироваться подальше от толпы
</li><li>Старайтесь брать скорость и огневую мощь одновременно - так вы устраните больше врагов
</li><li>Перед взятием бомбы, подождите, пока колобки ее окружат.
</li><li>Не спешите брать огневую мощь, если колобки далеко, подождите, пока они подойдут поближе.
</li><li>Во время пользования огневой мощью, не забирайтесь глубоко в рассеянную массу колобков - когда закончится бонус, они опять стянутся к вам и вы можете оказаться в ловушке.
</li><li>Ипользуйте большое увеличение, чтобы определить, где больше ящиков, и старайтесь прорваться туда.
</li></ul>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #ffff00; font-weight: bold;">Framework</span> brl.<span style="">glmax2d</span> <span style="color: #B1E7EB;">' Базовый модуль - движок на основе OpenGL</span><br />
<p><span style="color: #ffff00; font-weight: bold;">Import</span> brl.<span style="">random</span> <span style="color: #B1E7EB;">' Генератор случайных чисел</span><br />
<span style="color: #ffff00; font-weight: bold;">Import</span> BRL.<span style="">Basic</span> <span style="color: #B1E7EB;">' Из этого модуля используется команда Incbin</span><br />
<span style="color: #ffff00; font-weight: bold;">Import</span> BRL.<span style="">PNGLoader</span> <span style="color: #B1E7EB;">' Загрузка PNG-изображений</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Incbin</span> <span style="color: #00FF66;">&quot;2DEngine-NewImages.png&quot;</span> <span style="color: #B1E7EB;">' Сохраняем в exe-файле изображение</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Const</span> sxsize = <span style="color: #FFFFFF;">800</span>, sysize = <span style="color: #FFFFFF;">600</span>, color_depth = <span style="color: #FFFFFF;">32</span> <span style="color: #B1E7EB;">' Размеры экрана и глубина цвета</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Const</span> tilesize = <span style="color: #FFFFFF;">64</span> <span style="color: #B1E7EB;">' Размер тайла / спрайта</span><br />
<br />
<span style="color: #B1E7EB;">' Вспомогательные константы</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> tilesize2 = tilesize / <span style="color: #FFFFFF;">2</span>, tilesize4 = tilesize / <span style="color: #FFFFFF;">4</span>, tilesize8 = tilesize / <span style="color: #FFFFFF;">8</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> tilesize16 = tilesize / <span style="color: #FFFFFF;">16</span>, tilesize32 = tilesize / <span style="color: #FFFFFF;">32</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Const</span> sxsize2 = sxsize / <span style="color: #FFFFFF;">2</span>, sysize2 = sysize / <span style="color: #FFFFFF;">2</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> sxsize4 = sxsize / <span style="color: #FFFFFF;">4</span>, sxsize34 = sxsize * <span style="color: #FFFFFF;">3</span> / <span style="color: #FFFFFF;">4</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> sysize34 = sysize * <span style="color: #FFFFFF;">3</span> / <span style="color: #FFFFFF;">4</span>, sxsize24 = sxsize / <span style="color: #FFFFFF;">2</span> - <span style="color: #FFFFFF;">4</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Const</span> fxsize = <span style="color: #FFFFFF;">160</span>, fysize = <span style="color: #FFFFFF;">120</span> <span style="color: #B1E7EB;">' Размеры поля в тайлах </span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> fblurq = <span style="color: #FFFFFF;">5</span> <span style="color: #B1E7EB;">' Kол-во размытий для временно генерируемой вспомогательной карты высот поля</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> sand_threshold# = <span style="color: #FFFFFF;">0.4</span>, grass_threshold# = <span style="color: #FFFFFF;">0.5</span> <span style="color: #B1E7EB;">' Пороги высоты для песка и травы</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> fdx#, fdy# <span style="color: #B1E7EB;">' Сдвиг отображаемой части поля</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Const</span> kolobokq = <span style="color: #FFFFFF;">500</span> <span style="color: #B1E7EB;">' Kол-во диких колобков</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> speedpersec# = <span style="color: #FFFFFF;">1.0</span> <span style="color: #B1E7EB;">' Модификатор скорости (тайлов / сек)</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> angpersec# = <span style="color: #FFFFFF;">90.0</span> <span style="color: #B1E7EB;">' Модификатор угловой скорости (градусов / сек)</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Global</span> sc# = <span style="color: #FFFFFF;">1.0</span>, tilesc# <span style="color: #B1E7EB;">' Увеличение в пикселах и тайлах</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> dtim# <span style="color: #B1E7EB;">' Время обработки предыдущего кадра</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> timspeed# <span style="color: #B1E7EB;">' Модификатор для перемещения с учетом прошедшего времени</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> timang# <span style="color: #B1E7EB;">' Модификатор для поворота с учетом прошедшего времени</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> minms = <span style="color: #FFFFFF;">100</span> <span style="color: #B1E7EB;">' Ограничитель кадров в секунду для действий объектов</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> cam_speed# = <span style="color: #FFFFFF;">2.0</span> <span style="color: #B1E7EB;">' Относительная скорость реакции камеры на движения мышью</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> magn_speed# = <span style="color: #FFFFFF;">2.0</span> <span style="color: #B1E7EB;">' Относительная скорость реакции масштаба на вращение колесика мыши</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> camx#, camy# <span style="color: #B1E7EB;">' Текущие координаты камеры</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Global</span> layer_order:<span style="color: #ffff00; font-weight: bold;">TList</span> = <span style="color: #ffff00; font-weight: bold;">CreateList</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Список слоев в порядке отображения</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> actingobj:<span style="color: #ffff00; font-weight: bold;">TList</span> = <span style="color: #ffff00; font-weight: bold;">CreateList</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Список для активных объектов</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Const</span> showcollisions = <span style="color: #ffff00; font-weight: bold;">False</span> <span style="color: #B1E7EB;">' Показ коллизий (отключен)</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> ccnt, objcnt, chcnt <span style="color: #B1E7EB;">' Счетчики коллизий, объектов, проверок коллизий в секунду</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Const</span> force_reload_time = <span style="color: #FFFFFF;">7000</span>, force_power# = <span style="color: #FFFFFF;">3.0</span> <span style="color: #B1E7EB;">' Время &quot;перезарядки&quot; Силы, ее мощность</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> force_time = <span style="color: #FFFFFF;">1000</span>, force_radius# = <span style="color: #FFFFFF;">5.0</span> <span style="color: #B1E7EB;">' Время действия Силы, радиус действия</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> force_reload, force_effect <span style="color: #B1E7EB;">' Время завершения перезарядки и эффекта Силы</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Const</span> fireable_percent = <span style="color: #FFFFFF;">25</span> <span style="color: #B1E7EB;">' Процент стрелющих сухопутных колобков</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> min_fire_distance# = <span style="color: #FFFFFF;">7.0</span> <span style="color: #B1E7EB;">' Минимальная дистанция ведения огня</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> min_enemy_distance = <span style="color: #FFFFFF;">20</span> <span style="color: #B1E7EB;">' Минимальное расстояние до врага в начале игры</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Const</span> constant_bonustypeq = <span style="color: #FFFFFF;">7</span>, temporary_bonustypeq = <span style="color: #FFFFFF;">5</span> <span style="color: #B1E7EB;">' Kол-ва постоянных и временных бонусов</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> constant_bonus_crateq = <span style="color: #FFFFFF;">10</span> <span style="color: #B1E7EB;">' Kол-во ящиков с постоянными бонусами (для каждого)</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> temporary_bonus_crateq = <span style="color: #FFFFFF;">100</span> <span style="color: #B1E7EB;">' Kол-во ящиков с временными бонусами</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> empty_crates_percent = <span style="color: #FFFFFF;">30</span> <span style="color: #B1E7EB;">' Процент пустых ящиков</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> crate_bits_packq = <span style="color: #FFFFFF;">4</span> <span style="color: #B1E7EB;">' Kол-во вариантов кусочков ящика</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> bonustypeq = constant_bonustypeq + temporary_bonustypeq<br />
<br />
<span style="color: #B1E7EB;">' Постоянные бонусы</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> BONUS_BULLET_DAMAGE = <span style="color: #FFFFFF;">0</span> <span style="color: #B1E7EB;">' Увеличение повреждений от пуль</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> BONUS_BULLET_SPEED = <span style="color: #FFFFFF;">1</span> <span style="color: #B1E7EB;">' Увеличение скорости пуль</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> BONUS_BULLET_LIFETIME = <span style="color: #FFFFFF;">2</span> <span style="color: #B1E7EB;">' Увеличение времени жизни пули</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> BONUS_RELOAD_TIME = <span style="color: #FFFFFF;">3</span> <span style="color: #B1E7EB;">' Уменьшение интервалов между выстрелами</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> BONUS_MAX_HEALTH = <span style="color: #FFFFFF;">4</span> <span style="color: #B1E7EB;">' Увеличение максимального кол-ва здоровья</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> BONUS_SPEED = <span style="color: #FFFFFF;">5</span> <span style="color: #B1E7EB;">' Увеличение скорости колобка</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> BONUS_ESOURCE = <span style="color: #FFFFFF;">6</span> <span style="color: #B1E7EB;">' Источники энергии (необходимо собрать все для завершения игры)</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> esource_collected, light<br />
<br />
<span style="color: #B1E7EB;">' Временные бонусы</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> bonus_threshold = constant_bonustypeq<br />
<span style="color: #ffff00; font-weight: bold;">Const</span> BONUS_HEALTH = bonus_threshold + <span style="color: #FFFFFF;">0</span> <span style="color: #B1E7EB;">' Здоровье</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> BONUS_TEMPORARY_FIREPOWER = bonus_threshold + <span style="color: #FFFFFF;">1</span> <span style="color: #B1E7EB;">' Временное повышение огневой мощи</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> BONUS_BOMB = bonus_threshold + <span style="color: #FFFFFF;">2</span> <span style="color: #B1E7EB;">' Бомба!</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> BONUS_TEMPORARY_SPEED = bonus_threshold + <span style="color: #FFFFFF;">3</span> <span style="color: #B1E7EB;">' Временное ускорение</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> BONUS_TEMPORARY_INVULNERABILITY = bonus_threshold + <span style="color: #FFFFFF;">4</span> <span style="color: #B1E7EB;">' Временная неуязвимость</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Global</span> temporary_firepower, temporary_speed, temporary_invulnerability <span style="color: #B1E7EB;">' Время окончания действия бонусов</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Const</span> fading_time = <span style="color: #FFFFFF;">1000</span>, damage_time = <span style="color: #FFFFFF;">400</span> <span style="color: #B1E7EB;">' Время &quot;затухания&quot;, &quot;покраснения&quot; от повреждений</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> NOT_YET = <span style="color: #FFFFFF;">1000000000</span>, INDESTRUCTIBLE = <span style="color: #FFFFFF;">1000000000</span> <span style="color: #B1E7EB;">' Kонстанты &quot;еще не умер&quot;, &quot;неразрушимый&quot;</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Const</span> TM_IDLE = <span style="color: #FFFFFF;">0</span> <span style="color: #B1E7EB;">' Играем как обычно</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> TM_READY = <span style="color: #FFFFFF;">1</span> <span style="color: #B1E7EB;">' Готовимся к телепортации (ждем)</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> TM_DECREASING = <span style="color: #FFFFFF;">2</span> <span style="color: #B1E7EB;">' Уменьшаемся</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> TM_ENLARGING = <span style="color: #FFFFFF;">3</span> <span style="color: #B1E7EB;">' Вырастаем на новом месте</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> teleport = NOT_YET, teleport_mode = TM_IDLE <span style="color: #B1E7EB;">' Время окончания цикла телепортации, режим</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> teleport_ready_time = <span style="color: #FFFFFF;">5000</span> <span style="color: #B1E7EB;">' Время подготовки к телепортации</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> max_teleport_radius = <span style="color: #FFFFFF;">50</span> <span style="color: #B1E7EB;">' Максимальное расстояние в тайлах для телепортации</span><br />
<br />
<span style="color: #B1E7EB;">' Слой</span><br />
<span style="color: #ffff00; font-weight: bold;">Type</span> layer_obj <span style="color: #ffff00; font-weight: bold;">Abstract</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> collision_with:<span style="color: #ffff00; font-weight: bold;">TList</span> = <span style="color: #ffff00; font-weight: bold;">CreateList</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Список слоев, с которыми коллизирует данный</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> collides_with<span style=" ">&#40;</span>layer:layer_obj<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> tile_layer_obj<span style=" ">&#40;</span>layer<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #ffff00; font-weight: bold;">RuntimeError</span> <span style="color: #00FF66;">&quot;Tile layers can't collide - use tile collision layer&quot;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; collision_with.<span style="">addlast</span> layer<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> draw<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Type</span><br />
<br />
<span style="color: #B1E7EB;">' Тайловый слой</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> TILE_DONT_DRAW = <span style="color: #FFFFFF;">-1</span> <span style="color: #B1E7EB;">' Kонстанта &quot;Не рисовать тайл&quot;</span><br />
<span style="color: #ffff00; font-weight: bold;">Type</span> tile_layer_obj <span style="color: #ffff00; font-weight: bold;">Extends</span> layer_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> image:TImage <span style="color: #B1E7EB;">' Изображения тайлов</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> frame<span style=" ">&#91;</span>fxsize, fysize<span style=" ">&#93;</span> <span style="color: #B1E7EB;">' Номера тайлов для каждой клетки</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> collides_with<span style=" ">&#40;</span>layer:layer_obj<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">RuntimeError</span> <span style="color: #00FF66;">&quot;Tile layers can't collide - use tile collision layer&quot;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Function</span> add:tile_layer_obj<span style=" ">&#40;</span>tile_image:TImage, clearing = <span style="color: #ffff00; font-weight: bold;">True</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Добавление тайлового слоя</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; l:tile_layer_obj = <span style="color: #ffff00; font-weight: bold;">New</span> tile_layer_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; l.<span style="">image</span> = tile_image<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> clearing <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> y = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> fysize <span style="color: #B1E7EB;">' Установка &quot;не рисовать тайл&quot; для всех клеток</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> x = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> fxsize<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; l.<span style="">frame</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> = TILE_DONT_DRAW<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; layer_order.<span style="">addlast</span> l <span style="color: #B1E7EB;">' Занесение слоя в список отображения</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> l<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> draw<span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Прорисовка слоя</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetScale</span> tilesc#, tilesc#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; scr2field <span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">0</span>, x1#, y1#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; scr2field sxsize - <span style="color: #FFFFFF;">1</span>, sysize - <span style="color: #FFFFFF;">1</span>, x2#, y2#<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xx1 = <span style="color: #ffff00; font-weight: bold;">Max</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>x1#<span style=" ">&#41;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Определение границ куска поля, попадающего в облась зрения</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xx2 = <span style="color: #ffff00; font-weight: bold;">Min</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Ceil</span><span style=" ">&#40;</span>x2#<span style=" ">&#41;</span>, fxsize - <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; yy1 = <span style="color: #ffff00; font-weight: bold;">Max</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>y1#<span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; yy2 = <span style="color: #ffff00; font-weight: bold;">Min</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Ceil</span><span style=" ">&#40;</span>y2#<span style=" ">&#41;</span>, fysize - <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> y = yy1 <span style="color: #ffff00; font-weight: bold;">To</span> yy2<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> x = xx1 <span style="color: #ffff00; font-weight: bold;">To</span> xx2<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> frame<span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> &gt;= TILE_DRAW <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Проверка, нужно ли рисовать тайл</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; field2scr x, y, sx#, sy#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawImage</span> image, sx#, sy#, frame<span style=" ">&#91;</span>x, y<span style=" ">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Type</span><br />
<br />
<span style="color: #B1E7EB;">' Слой тайловой коллизии</span><br />
<span style="color: #ffff00; font-weight: bold;">Type</span> tile_collision_layer_obj <span style="color: #ffff00; font-weight: bold;">Extends</span> layer_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> collision<span style=" ">&#91;</span>fxsize, fysize<span style=" ">&#93;</span> <span style="color: #B1E7EB;">' Kоллизия с тайлом (да / нет)</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Function</span> add:tile_collision_layer_obj<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> <span style="color: #ffff00; font-weight: bold;">New</span> tile_collision_layer_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Type</span><br />
<br />
&nbsp;<span style="color: #B1E7EB;">' Слой объектов</span><br />
<span style="color: #ffff00; font-weight: bold;">Type</span> object_layer_obj <span style="color: #ffff00; font-weight: bold;">Extends</span> layer_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> objects:<span style="color: #ffff00; font-weight: bold;">TList</span><span style=" ">&#91;</span>fxsize, fysize<span style=" ">&#93;</span> <span style="color: #B1E7EB;">' Список объектов для каждой клетки, находящихся на ней</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Function</span> add:object_layer_obj<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; l:object_layer_obj = <span style="color: #ffff00; font-weight: bold;">New</span> object_layer_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> y = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> fysize <span style="color: #B1E7EB;">' Инициализация списков</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> x = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> fxsize<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; l.<span style="">objects</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> = <span style="color: #ffff00; font-weight: bold;">CreateList</span><span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; layer_order.<span style="">addlast</span> l<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> l<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> draw<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; scr2field <span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">0</span>, x1#, y1#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; scr2field sxsize - <span style="color: #FFFFFF;">1</span>, sysize - <span style="color: #FFFFFF;">1</span>, x2#, y2#<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xx1 = <span style="color: #ffff00; font-weight: bold;">Max</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>x1# - <span style="color: #FFFFFF;">0.5</span><span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xx2 = <span style="color: #ffff00; font-weight: bold;">Min</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>x2# + <span style="color: #FFFFFF;">0.5</span><span style=" ">&#41;</span>, fxsize - <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; yy1 = <span style="color: #ffff00; font-weight: bold;">Max</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>y1# - <span style="color: #FFFFFF;">0.5</span><span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; yy2 = <span style="color: #ffff00; font-weight: bold;">Min</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>y2# + <span style="color: #FFFFFF;">0.5</span><span style=" ">&#41;</span>, fysize - <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> y = yy1 <span style="color: #ffff00; font-weight: bold;">To</span> yy2<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> x = xx1 <span style="color: #ffff00; font-weight: bold;">To</span> xx2<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> o:base_obj = <span style="color: #ffff00; font-weight: bold;">EachIn</span> objects<span style=" ">&#91;</span>x, y<span style=" ">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">draw</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; reset_transformations<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Type</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Const</span> CT_IMMATERIAL = <span style="color: #FFFFFF;">0</span> <span style="color: #B1E7EB;">' Тип коллизионной модели - нематериальный</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> CT_CIRCULAR = <span style="color: #FFFFFF;">1</span> <span style="color: #B1E7EB;">' Тип коллизионной модели - круг</span><br />
<span style="color: #ffff00; font-weight: bold;">Const</span> CT_SQUARE = <span style="color: #FFFFFF;">2</span> <span style="color: #B1E7EB;">' Тип коллизионной модели - квадрат</span><br />
<span style="color: #B1E7EB;">' Базовый тип для объектов</span><br />
<span style="color: #ffff00; font-weight: bold;">Type</span> base_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> x#, y#, size# = <span style="color: #FFFFFF;">1</span>, angle# <span style="color: #B1E7EB;">' Kоординаты, размер (в тайлах), угол поворота спрайта объекта</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> speed# <span style="color: #B1E7EB;">' Скорость объекта (тайлов / сек)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> moving_angle# <span style="color: #B1E7EB;">' Текущий угол движения</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> r = <span style="color: #FFFFFF;">255</span>, g = <span style="color: #FFFFFF;">255</span>, b = <span style="color: #FFFFFF;">255</span> <span style="color: #B1E7EB;">' Цвет объекта (по умолчанию белый)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> image:TImage, frame <span style="color: #B1E7EB;">' Изображение для объекта, кадр</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> tilex, tiley <span style="color: #B1E7EB;">' Kоординаты тайла, на котором находится объект</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> act_link:<span style="color: #ffff00; font-weight: bold;">TLink</span>, tile_link:<span style="color: #ffff00; font-weight: bold;">TLink</span> <span style="color: #B1E7EB;">' Ссылки на этот объект из списков активных объектов и объектов клетки</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> layer:object_layer_obj <span style="color: #B1E7EB;">' Слой объекта</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> coll_type = CT_CIRCULAR, radius# = <span style="color: #FFFFFF;">0.5</span> <span style="color: #B1E7EB;">' Тип модели коллизии и ее радиус</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> health# <span style="color: #B1E7EB;">' Здоровье объекта</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> death = NOT_YET, damage_end <span style="color: #B1E7EB;">' Время смерти (еще не определено), время окончания &quot;покраснения&quot;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Const</span> ONLY_ON_GROUND = <span style="color: #ffff00; font-weight: bold;">True</span> <span style="color: #B1E7EB;">' Kонстанта для размещения объекта только на суше</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> place_find<span style=" ">&#40;</span>onlyonground = <span style="color: #ffff00; font-weight: bold;">False</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Поиск места для размещения объекта</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Repeat</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; x = <span style="color: #ffff00; font-weight: bold;">Rnd</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">1.0</span>, fxsize - <span style="color: #FFFFFF;">1.01</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; y = <span style="color: #ffff00; font-weight: bold;">Rnd</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">1.0</span>, fysize - <span style="color: #FFFFFF;">1.01</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tilex = <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>x<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tiley = <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>y<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Определение сухопутности / подводности колобка</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> layer_sand.<span style="">collision</span><span style=" ">&#40;</span>tilex, tiley<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> layer = layer_ground_koloboks <span style="color: #ffff00; font-weight: bold;">Else</span> layer = layer_water_koloboks<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Проверка нахождения на суше (для размещения только на суше) и на отсутствие коллизий</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> layer = layer_ground_koloboks <span style="color: #ffff00; font-weight: bold;">Or</span> onlyonground = <span style="color: #ffff00; font-weight: bold;">False</span> <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">Not</span> collision<span style=" ">&#40;</span>x#, y#<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #ffff00; font-weight: bold;">Exit</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Forever</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> random_color<span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Задание случайного (но не очень темного) цвета для объекта</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Repeat</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r = <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">255</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; g = <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">255</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b = <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">255</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Until</span> r + g + b &gt;= <span style="color: #FFFFFF;">255</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Const</span> ACTIVE = <span style="color: #ffff00; font-weight: bold;">True</span>, INACTIVE = <span style="color: #ffff00; font-weight: bold;">False</span> <span style="color: #B1E7EB;">' Kонстанты &quot;Активный&quot;, &quot;Не активный&quot;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> register<span style=" ">&#40;</span>acting = ACTIVE<span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Занесение объекта в списки (регистрация)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tilex = <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>x#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tiley = <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>y#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tile_link = layer.<span style="">objects</span><span style=" ">&#40;</span>tilex, tiley<span style=" ">&#41;</span>.<span style="">addlast</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Self</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Занесение в список объектов клетки</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> acting <span style="color: #ffff00; font-weight: bold;">Then</span> act_link = actingobj.<span style="">addlast</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Self</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Занесение в список активных объектов</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; objcnt:<span style="color: #FFFFFF;">+1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> draw<span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Рисование объекта</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; field2scr x#, y#, sx#, sy#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetScale</span> size# * tilesc#, size# * tilesc#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetRotation</span> angle#<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dmg = damage_end - <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' &quot;Покраснение&quot; от повреждений</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> dmg &gt; <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; k1# = <span style="color: #FFFFFF;">1.0</span> * dmg / damage_time; k2# = <span style="color: #FFFFFF;">1.0</span> - k1#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetColor</span> k1# * <span style="color: #FFFFFF;">255</span> + k2# * r, k2# * g, k2# * b<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetColor</span> r, g, b <span style="color: #B1E7EB;">' Установка естественного цвета</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> death = NOT_YET <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetAlpha</span> <span style="color: #FFFFFF;">1</span> <span style="color: #B1E7EB;">' Если еще не начал исчезать, то непрозрачный</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetAlpha</span> limit<span style=" ">&#40;</span>.<span style="color: #FFFFFF;">001</span> * <span style=" ">&#40;</span>death - <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span><span style=" ">&#41;</span>, <span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Иначе потихоньку исчезает</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> death&lt;MilliSecs<span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> destroy <span style="color: #B1E7EB;">' И в конце уничтожается совсем</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">Self</span> = player <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> temporary_firepower &gt; <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; col = <span style="color: #FFFFFF;">191</span> + <span style="color: #FFFFFF;">64</span> * <span style="color: #ffff00; font-weight: bold;">Sin</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Мерцающий желтый цвет игрока с огневой мощью</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetColor</span> col, col, <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> temporary_invulnerability &gt; <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #ffff00; font-weight: bold;">SetAlpha</span> <span style="color: #FFFFFF;">0.5</span> <span style="color: #B1E7EB;">' Полупрозрачность неуязвимого</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Select</span> teleport_mode<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Case</span> TM_READY; <span style="color: #ffff00; font-weight: bold;">SetAlpha</span> <span style="color: #FFFFFF;">0.75</span> + <span style="color: #FFFFFF;">0.25</span> * <span style="color: #ffff00; font-weight: bold;">Sin</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Циклическое изменение прозрачности во время подготовки к телепортации</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Case</span> TM_DECREASING; s# = sc# * size# / tilesize * <span style="color: #ffff00; font-weight: bold;">Max</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0.0</span>, <span style="color: #FFFFFF;">1.0</span> * <span style=" ">&#40;</span>teleport - <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span><span style=" ">&#41;</span> / fading_time<span style=" ">&#41;</span>; <span style="color: #ffff00; font-weight: bold;">SetScale</span> s#, s# <span style="color: #B1E7EB;">' Уменьшение</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Case</span> TM_ENLARGING; s# = sc# * size# / tilesize * <span style="color: #ffff00; font-weight: bold;">Min</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">1.0</span>, <span style="color: #FFFFFF;">1.0</span> - <span style="color: #FFFFFF;">1.0</span> * <span style=" ">&#40;</span>teleport - <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span><span style=" ">&#41;</span> / fading_time<span style=" ">&#41;</span>; <span style="color: #ffff00; font-weight: bold;">SetScale</span> s#, s# <span style="color: #B1E7EB;">' Появление в новом месте</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Select</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawImage</span> image, sx#, sy#, frame<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> move<span style=" ">&#40;</span>newx#, newy#<span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Kорректное перемещение</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; newtilex = <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>newx#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; newtiley = <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>newy#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> tilex &lt;&gt; newtilex <span style="color: #ffff00; font-weight: bold;">Or</span> tiley &lt;&gt; newtiley <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Если объект переместился в другую клетку, то</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">removeLink</span> tile_link <span style="color: #B1E7EB;">' Удаление из списка старой клетки</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tilex = newtilex<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tiley = newtiley<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tile_link = layer.<span style="">objects</span><span style=" ">&#91;</span>tilex, tiley<span style=" ">&#93;</span>.<span style="">addlast</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Self</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Занесение в список новой</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; x# = newx#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; y# = newy#<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> try_move<span style=" ">&#40;</span>newx#, newy#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">Not</span> collision<span style=" ">&#40;</span>newx#, newy#<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> move newx#, newy#; <span style="color: #ffff00; font-weight: bold;">Return</span> <span style="color: #ffff00; font-weight: bold;">True</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> try_move_ang<span style=" ">&#40;</span>ang#, spd#, ma_change = <span style="color: #ffff00; font-weight: bold;">False</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> try_move<span style=" ">&#40;</span>x# + timspeed# * <span style="color: #ffff00; font-weight: bold;">Cos</span><span style=" ">&#40;</span>ang#<span style=" ">&#41;</span> * spd#, y# + timspeed# * <span style="color: #ffff00; font-weight: bold;">Sin</span><span style=" ">&#40;</span>ang#<span style=" ">&#41;</span> * spd#<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> ma_change <span style="color: #ffff00; font-weight: bold;">Then</span> moving_angle# = ang#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> <span style="color: #ffff00; font-weight: bold;">True</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> collision2<span style=" ">&#40;</span>o:base_obj, newx#, newy#<span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Проверка объекта на столкновение с другим</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Select</span> <span style="color: #ffff00; font-weight: bold;">True</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Case</span> coll_type = CT_CIRCULAR <span style="color: #B1E7EB;">' Если модель данного объекта - круг</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Select</span> <span style="color: #ffff00; font-weight: bold;">True</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Case</span> o.<span style="">coll_type</span> = CT_CIRCULAR <span style="color: #B1E7EB;">' И модель второго объекта - тоже круг (круг с кругом)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dx# = newx# - o.<span style="">x</span>#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dy# = newy# - o.<span style="">y</span>#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Проверяем, меньше ли расстояние между объектами, чем сумма их радиусов</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">Sqr</span><span style=" ">&#40;</span>dx# * dx# + dy# * dy#<span style=" ">&#41;</span> &lt; o.<span style="">radius</span># + radius# <span style="color: #ffff00; font-weight: bold;">Then</span> ccnt:<span style="color: #FFFFFF;">+1</span>; <span style="color: #ffff00; font-weight: bold;">Return</span> <span style="color: #ffff00; font-weight: bold;">True</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Case</span> o.<span style="">coll_type</span> = CT_SQUARE <span style="color: #B1E7EB;">' А если модель второго объекта - квадрат (круг с квадратом)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style=" ">&#40;</span>o.<span style="">x</span># - o.<span style="">radius</span># &lt;= newx# <span style="color: #ffff00; font-weight: bold;">And</span> newx# &lt;= o.<span style="">x</span># + o.<span style="">radius</span>#<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Or</span> <span style=" ">&#40;</span>o.<span style="">y</span># - o.<span style="">radius</span># &lt;= newy# <span style="color: #ffff00; font-weight: bold;">And</span> newy# &lt;= o.<span style="">y</span># + o.<span style="">radius</span>#<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dx# = <span style="color: #ffff00; font-weight: bold;">Abs</span><span style=" ">&#40;</span>newx# - o.<span style="">x</span>#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dy# = <span style="color: #ffff00; font-weight: bold;">Abs</span><span style=" ">&#40;</span>newy# - o.<span style="">y</span>#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sumr# = o.<span style="">radius</span># + radius#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> dx# &lt; sumr# <span style="color: #ffff00; font-weight: bold;">And</span> dy# &lt; sumr# <span style="color: #ffff00; font-weight: bold;">Then</span> ccnt:<span style="color: #FFFFFF;">+1</span>; <span style="color: #ffff00; font-weight: bold;">Return</span> <span style="color: #ffff00; font-weight: bold;">True</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dx# = <span style="color: #ffff00; font-weight: bold;">Min</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Abs</span><span style=" ">&#40;</span>newx# - o.<span style="">x</span># - o.<span style="">radius</span>#<span style=" ">&#41;</span>, <span style="color: #ffff00; font-weight: bold;">Abs</span><span style=" ">&#40;</span>newx# - o.<span style="">x</span># + o.<span style="">radius</span>#<span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dy# = <span style="color: #ffff00; font-weight: bold;">Min</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Abs</span><span style=" ">&#40;</span>newy# - o.<span style="">y</span># - o.<span style="">radius</span>#<span style=" ">&#41;</span>, <span style="color: #ffff00; font-weight: bold;">Abs</span><span style=" ">&#40;</span>newy# - o.<span style="">y</span># + o.<span style="">radius</span>#<span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">Sqr</span><span style=" ">&#40;</span>dx# * dx# + dy# * dy#<span style=" ">&#41;</span> &lt; radius# <span style="color: #ffff00; font-weight: bold;">Then</span> ccnt:<span style="color: #FFFFFF;">+1</span>; <span style="color: #ffff00; font-weight: bold;">Return</span> <span style="color: #ffff00; font-weight: bold;">True</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Default</span> <span style="color: #B1E7EB;">' Но вот если второй объект нематериален - столкновения нет</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> <span style="color: #ffff00; font-weight: bold;">False</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Select</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Case</span> coll_type = CT_SQUARE <span style="color: #B1E7EB;">' Если модель данного объекта - квадрат</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> o.<span style="">coll_type</span> = CT_SQUARE <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' И модель второго объекта - тоже квадрат</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dx# = <span style="color: #ffff00; font-weight: bold;">Abs</span><span style=" ">&#40;</span>newx# - o.<span style="">x</span>#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dy# = <span style="color: #ffff00; font-weight: bold;">Abs</span><span style=" ">&#40;</span>newy# - o.<span style="">y</span>#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sumr# = o.<span style="">radius</span># + radius#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Проверяем, меньше ли модуль разности соотв. координат, чем сумма радиусов</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> dx# &lt; sumr# <span style="color: #ffff00; font-weight: bold;">And</span> dy# &lt; sumr# <span style="color: #ffff00; font-weight: bold;">Then</span> ccnt:<span style="color: #FFFFFF;">+1</span>; <span style="color: #ffff00; font-weight: bold;">Return</span> <span style="color: #ffff00; font-weight: bold;">True</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span> <span style="color: #B1E7EB;">' Иначе проверяем столкновение второго объекта с данным (меняем местами)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> o.<span style="">collision2</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Self</span>, newx#, newy#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Default</span> <span style="color: #B1E7EB;">' Нематериальный объект не коллизирует</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> <span style="color: #ffff00; font-weight: bold;">False</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Select</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> collision<span style=" ">&#40;</span>newx#, newy#<span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Проверка данного объекта на столкновение с чем бы то ни было</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Столкновение с границами поля (это осложнит другие проверки, поэтому выходим)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> newx# &lt; <span style="color: #FFFFFF;">1.0</span> <span style="color: #ffff00; font-weight: bold;">Or</span> newy# &lt; <span style="color: #FFFFFF;">1.0</span> <span style="color: #ffff00; font-weight: bold;">Or</span> newx# &gt;= fxsize - <span style="color: #FFFFFF;">1.0</span> <span style="color: #ffff00; font-weight: bold;">Or</span> newy# &gt;= fysize - <span style="color: #FFFFFF;">1.0</span> <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; boundaries_collision_act<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> <span style="color: #ffff00; font-weight: bold;">True</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> l:layer_obj = <span style="color: #ffff00; font-weight: bold;">EachIn</span> layer.<span style="">collision_with</span> <span style="color: #B1E7EB;">' Цикл по всем слоям коллизии</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tl:tile_collision_layer_obj = tile_collision_layer_obj<span style=" ">&#40;</span>l<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> tl <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Если слой - тайлово-коллизионный, то</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> yy = <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>newy# - radius#<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>newy# + radius#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> xx = <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>newx# - radius#<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>newx# + radius#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> tl.<span style="">collision</span><span style=" ">&#40;</span>xx, yy<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tile_object.<span style="">x</span># = xx + <span style="color: #FFFFFF;">0.5</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tile_object.<span style="">y</span># = yy + <span style="color: #FFFFFF;">0.5</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> collision2<span style=" ">&#40;</span>tile_object, newx#, newy#<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> collided = <span style="color: #ffff00; font-weight: bold;">True</span>; tile_collision_act xx, yy<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span> <span style="color: #B1E7EB;">' Иначе слой - объектный, тогда</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ol:object_layer_obj = object_layer_obj<span style=" ">&#40;</span>l<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; x2 = <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>newx#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; y2 = <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>newy#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> yy = y2 - <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">To</span> y2 + <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> xx = x2 - <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">To</span> x2 + <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> o:base_obj = <span style="color: #ffff00; font-weight: bold;">EachIn</span> ol.<span style="">objects</span><span style=" ">&#91;</span>xx, yy<span style=" ">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> Self&lt;&gt;o <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; chcnt:<span style="color: #FFFFFF;">+1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> showcollisions <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Показ проверок коллизий линиями</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; field2scr o.<span style="">x</span>#, o.<span style="">y</span>#, sx1#, sy1#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; field2scr newx#, newy#, sx2#, sy2#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawLine</span> sx1#, sy1#, sx2#, sy2#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> collision2<span style=" ">&#40;</span>o, newx#, newy#<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> collided = <span style="color: #ffff00; font-weight: bold;">True</span>; object_collision_act o<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> collided<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> act<span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Действия объектов</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> object_collision_act<span style=" ">&#40;</span>o:base_obj<span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Действия при столкновении с объектами</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> tile_collision_act<span style=" ">&#40;</span>xx, yy<span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Действия при столкновении с тайлами</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> boundaries_collision_act<span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Действия при столкновении с границами карты</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> damage<span style=" ">&#40;</span>amount#<span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Получение повреждений</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> death &lt; NOT_YET <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #ffff00; font-weight: bold;">Return</span> <span style="color: #B1E7EB;">' Если уже исчезает, то с него хватит</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> health# = INDESTRUCTIBLE <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #ffff00; font-weight: bold;">Return</span> <span style="color: #B1E7EB;">' Если в принципе неуязвим, тогда тоже выходим</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">Self</span>=player <span style="color: #ffff00; font-weight: bold;">And</span> temporary_invulnerability&gt;MilliSecs<span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #ffff00; font-weight: bold;">Return</span> <span style="color: #B1E7EB;">' Если временно неуязвим - выходим</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; health# = health# - amount# <span style="color: #B1E7EB;">' Уменьшаем здоровье</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; damage_end = damage_time + <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Задаем &quot;покраснение&quot;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> health &lt;= <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Если здоровье на нуле, то</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; death = fading_time + <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Объект начинает исчезать</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Ящик исчезает сразу, остальные становятся нематериальными</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> crate_obj<span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Self</span><span style=" ">&#41;</span>=<span style="color: #ffff00; font-weight: bold;">Null</span> <span style="color: #ffff00; font-weight: bold;">Then</span> coll_type = CT_IMMATERIAL <span style="color: #ffff00; font-weight: bold;">Else</span> death = <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> destroy<span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Kорректное уничтожение объекта</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> act_link&lt;&gt;Null <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #ffff00; font-weight: bold;">removeLink</span> act_link <span style="color: #B1E7EB;">' Удаление объекта из списка активных</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">removeLink</span> tile_link <span style="color: #B1E7EB;">' Удаление объекта из списка объектов клетки</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; objcnt:<span style="color: #FFFFFF;">-1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Type</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Global</span> tile_object:base_obj = <span style="color: #ffff00; font-weight: bold;">New</span> base_obj<br />
tile_object.<span style="">radius</span># = <span style="color: #FFFFFF;">0.5</span><br />
tile_object.<span style="">coll_type</span> = CT_SQUARE<br />
<br />
<span style="color: #B1E7EB;">' Базовый тип для колобков</span><br />
<span style="color: #ffff00; font-weight: bold;">Type</span> kolobok_obj <span style="color: #ffff00; font-weight: bold;">Extends</span> base_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> bullet_reload, bullet_reload_time <span style="color: #B1E7EB;">' Время окончания перезарядки, время перезарядки</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> bullet_speed#, bullet_lifetime = <span style="color: #FFFFFF;">2000</span> <span style="color: #B1E7EB;">' Скорость и время жизни пули этого колобка</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> bullet_damage# <span style="color: #B1E7EB;">' Повреждения от попадания пулей</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> max_health# = <span style="color: #FFFFFF;">1</span> <span style="color: #B1E7EB;">' Максимальное здоровье</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> bite_damage#, bite_reload <span style="color: #B1E7EB;">' Повреждение от укуса и время возможности следующего укуса</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> bite_reload_time, bite <span style="color: #B1E7EB;">' Интервал между укусами, вспомогательный флаг</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Function</span> create:kolobok_obj<span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Создание дикого колобка</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o:kolobok_obj = <span style="color: #ffff00; font-weight: bold;">New</span> kolobok_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">random_color</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">image</span> = kolobok<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">moving_angle</span># = <span style="color: #ffff00; font-weight: bold;">Rnd</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">360</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">1</span>, <span style="color: #FFFFFF;">100</span><span style=" ">&#41;</span> &gt; fireable_percent <span style="color: #ffff00; font-weight: bold;">And</span> o.<span style="">frame</span> = <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Параметры для не умеющих стрелять</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">bullet_reload</span> = <span style="color: #FFFFFF;">1000000000</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">bullet_reload_time</span> = <span style="color: #FFFFFF;">1000</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">bullet_lifetime</span> = <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">bullet_damage</span># = <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">bullet_speed</span># = <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span> <span style="color: #B1E7EB;">' Параметры для умеющих стрелять</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">bullet_reload_time</span> = <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">300</span>, <span style="color: #FFFFFF;">1000</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">bullet_lifetime</span> = <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">1000</span>, <span style="color: #FFFFFF;">4000</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">bullet_damage</span># = <span style="color: #ffff00; font-weight: bold;">Rnd</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">1</span>, <span style="color: #FFFFFF;">5</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">bullet_speed</span># = <span style="color: #ffff00; font-weight: bold;">Rnd</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0.5</span>, <span style="color: #FFFFFF;">1.5</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">max_health</span> = <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">50</span>, <span style="color: #FFFFFF;">200</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">health</span> = o.<span style="">max_health</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">bite_damage</span># = <span style="color: #ffff00; font-weight: bold;">Rnd</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">4</span>, <span style="color: #FFFFFF;">12</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">bite_reload_time</span> = <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">200</span>, <span style="color: #FFFFFF;">500</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Расчет размера и скорости по совокупности параметров</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">size</span># = <span style=" ">&#40;</span>o.<span style="">max_health</span> - <span style="color: #FFFFFF;">50</span><span style=" ">&#41;</span> / <span style="color: #FFFFFF;">150.0</span> + o_bullet_speed# / <span style="color: #FFFFFF;">1.5</span> &nbsp;+ o.<span style="">bullet_lifetime</span> / <span style="color: #FFFFFF;">4000.0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">size</span>#:+ o.<span style="">bullet_damage</span># / <span style="color: #FFFFFF;">5.0</span> + <span style=" ">&#40;</span>o.<span style="">bite_damage</span># - <span style="color: #FFFFFF;">4.0</span><span style=" ">&#41;</span> / <span style="color: #FFFFFF;">8.0</span> + <span style=" ">&#40;</span><span style="color: #FFFFFF;">500</span> - o.<span style="">bite_reload_time</span><span style=" ">&#41;</span> / <span style="color: #FFFFFF;">300.0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">size</span>#:+ <span style=" ">&#40;</span><span style="color: #FFFFFF;">1000.0</span> - o.<span style="">bullet_reload_time</span><span style=" ">&#41;</span> / <span style="color: #FFFFFF;">1000.0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">size</span># = limit<span style=" ">&#40;</span>o.<span style="">size</span> / <span style="color: #FFFFFF;">7.0</span> * <span style="color: #FFFFFF;">1.0</span> + <span style="color: #FFFFFF;">0.25</span>, <span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">1.0</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">speed</span># = <span style=" ">&#40;</span><span style="color: #FFFFFF;">1.25</span> - o.<span style="">size</span>#<span style=" ">&#41;</span> * <span style="color: #FFFFFF;">2</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">radius</span># = <span style="color: #FFFFFF;">0.4</span> * o.<span style="">size</span>#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">place_find</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">frame</span> = <span style=" ">&#40;</span>o.<span style="">layer</span> = layer_ground_koloboks<span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Для водных колобков - 0-й кадр, для наземных - 1-й</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">register</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> o<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> draw<span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Рисование колобка</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">super</span>.<span style="">draw</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bar_draw<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> bar_draw<span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Рисование полоски здоровья</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; field2scr x#, y#, sx#, sy#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; barsize = <span style="color: #FFFFFF;">1.0</span> * size# * sc# <span style="color: #B1E7EB;">' Определение длины (по размеру колобка в пикселах)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> barsize &gt; <span style="color: #FFFFFF;">4</span> <span style="color: #ffff00; font-weight: bold;">And</span> max_health &lt;&gt; health <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; barsize2 = barsize / <span style="color: #FFFFFF;">2</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; barheight = limit<span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>max_health / <span style="color: #FFFFFF;">50</span><span style=" ">&#41;</span> + <span style="color: #FFFFFF;">1</span>, <span style="color: #FFFFFF;">1</span>, <span style="color: #FFFFFF;">6</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Определение высоты по максимуму здоровья</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetRotation</span> <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetScale</span> <span style="color: #FFFFFF;">1</span>, <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SetGrayColor <span style="color: #FFFFFF;">255</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; k# = <span style="color: #FFFFFF;">1.0</span> * health / max_health<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DrawEmptyRect sx# - barsize2, sy# - barsize2 - <span style="color: #FFFFFF;">6</span>, barsize<span style="color: #FFFFFF;">-1</span>, barheight + <span style="color: #FFFFFF;">2</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetColor</span> <span style="color: #FFFFFF;">255</span> * <span style=" ">&#40;</span><span style="color: #FFFFFF;">1.0</span> - k#<span style=" ">&#41;</span>, <span style="color: #FFFFFF;">255</span> * k#, <span style="color: #FFFFFF;">0</span> <span style="color: #B1E7EB;">' Задание цвета: ближе к максимуму - зеленый, ближе к 0 - красный</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawRect</span> sx# - barsize2 + <span style="color: #FFFFFF;">1</span>, sy# - barsize2 - <span style="color: #FFFFFF;">5</span>, k# * <span style=" ">&#40;</span>barsize - <span style="color: #FFFFFF;">2</span><span style=" ">&#41;</span>, barheight<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> act<span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Действия колобка</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> death &lt; NOT_YET <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #ffff00; font-weight: bold;">Return</span> <span style="color: #B1E7EB;">' Если исчезает, то действовать прекращает</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; angle# = <span style="color: #ffff00; font-weight: bold;">ATan2</span><span style=" ">&#40;</span>player.<span style="">y</span> - y#, player.<span style="">x</span> - x#<span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Угол &quot;наведения&quot; на игрока</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> force_effect &gt; <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Определение расстояния до игрока, если действует Сила</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rad# = <span style="color: #ffff00; font-weight: bold;">Sqr</span><span style=" ">&#40;</span><span style=" ">&#40;</span>player.<span style="">x</span># - x#<span style=" ">&#41;</span> * <span style=" ">&#40;</span>player.<span style="">x</span># - x#<span style=" ">&#41;</span> + <span style=" ">&#40;</span>player.<span style="">y</span># - y#<span style=" ">&#41;</span> * <span style=" ">&#40;</span>player.<span style="">y</span># - y#<span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rad# = <span style="color: #FFFFFF;">10000</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> rad# &lt;= force_radius# <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Если расстояние до игрока меньше радиуса действия Силы, то</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Пытаемся удалиться от игрока</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; try_move_ang angle# + <span style="color: #FFFFFF;">180.0</span>, force_power# * <span style="color: #ffff00; font-weight: bold;">Sin</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">90.0</span> * <span style=" ">&#40;</span>force_radius# - rad#<span style=" ">&#41;</span> / force_radius#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Иначе определяем, в какую сторону вращаться</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dang# = calc_dangle<span style=" ">&#40;</span>moving_angle#, angle# + <span style="color: #FFFFFF;">180</span> * <span style=" ">&#40;</span>temporary_firepower &gt; <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span><span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' И пробуем переместиться, повернувшись</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">Not</span> try_move_ang<span style=" ">&#40;</span>moving_angle# + timang# * <span style=" ">&#40;</span><span style="color: #FFFFFF;">1</span> - <span style="color: #FFFFFF;">2</span> * <span style=" ">&#40;</span>dang# &lt; <span style="color: #FFFFFF;">0</span><span style=" ">&#41;</span><span style=" ">&#41;</span>, speed#, <span style="color: #ffff00; font-weight: bold;">True</span><span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #B1E7EB;">' Если переместиться не удалось, то</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> bite <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Если можно укусить, то стоим и кусаем...</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; moving_angle# = angle#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bite = <span style="color: #ffff00; font-weight: bold;">False</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span> <span style="color: #B1E7EB;">' Если нельзя, то пробуем сместиться в сторону</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">Not</span> try_move_ang<span style=" ">&#40;</span>moving_angle# + <span style="color: #FFFFFF;">90.0</span> * <span style=" ">&#40;</span><span style="color: #FFFFFF;">1</span> - <span style="color: #FFFFFF;">2</span> * <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><span style=" ">&#41;</span>, speed#, <span style="color: #ffff00; font-weight: bold;">True</span><span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #B1E7EB;">' Если не получается, пробуем сместиться в другую</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">Not</span> try_move_ang<span style=" ">&#40;</span>moving_angle# + <span style="color: #FFFFFF;">180.0</span>, speed#, <span style="color: #ffff00; font-weight: bold;">True</span><span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> moving_angle# = <span style="color: #ffff00; font-weight: bold;">Rnd</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0.0</span>, <span style="color: #FFFFFF;">360.0</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Если совсем нас зажали, в следующий раз попробуем случайный угол</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> bullet_reload &lt; <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Если пришло время стрелять</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' И расстояние до игрока меньше максимального</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">Sqr</span><span style=" ">&#40;</span><span style=" ">&#40;</span>player.<span style="">x</span># - x#<span style=" ">&#41;</span> * <span style=" ">&#40;</span>player.<span style="">x</span># - x#<span style=" ">&#41;</span> + <span style=" ">&#40;</span>player.<span style="">y</span># - y#<span style=" ">&#41;</span> * <span style=" ">&#40;</span>player.<span style="">y</span># - y#<span style=" ">&#41;</span><span style=" ">&#41;</span> &lt;= min_fire_distance# <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Создаем список и заносим туда всех подыодных колобков</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; near:<span style="color: #ffff00; font-weight: bold;">TList</span> = nearly_objects<span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">CreateList</span><span style=" ">&#40;</span><span style=" ">&#41;</span>, tilex, tiley, <span style="color: #FFFFFF;">2</span>, layer_water_koloboks<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' А также наземных</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; near = nearly_objects<span style=" ">&#40;</span>near, tilex, tiley, <span style="color: #FFFFFF;">2</span>, layer_ground_koloboks<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Но удаляем себя и игрока</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; near.<span style="">remove</span> player<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; near.<span style="">remove</span> <span style="color: #ffff00; font-weight: bold;">Self</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Потому что будем проверять, не находится ли другой колобок на пути пули, выпущенной в игрока</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> o:base_obj = <span style="color: #ffff00; font-weight: bold;">EachIn</span> near<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> kolobok_obj<span style=" ">&#40;</span>o<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Вычисляем угол между вектором выстрела и отрезком, соединяющим центры стреляющего и проверяемого колобка</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dang# = <span style="color: #ffff00; font-weight: bold;">Abs</span><span style=" ">&#40;</span>calc_dangle<span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">ATan2</span><span style=" ">&#40;</span>y# - o.<span style="">y</span>#, x# - o.<span style="">x</span>#<span style=" ">&#41;</span>, <span style="color: #ffff00; font-weight: bold;">ATan2</span><span style=" ">&#40;</span>y# - player.<span style="">y</span>#, x# - player.<span style="">x</span>#<span style=" ">&#41;</span><span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Проверяем не меньше ли радиуса колобка длина дуги</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">Pi</span> * <span style="color: #ffff00; font-weight: bold;">Sqr</span><span style=" ">&#40;</span><span style=" ">&#40;</span>x# - o.<span style="">x</span>#<span style=" ">&#41;</span> * <span style=" ">&#40;</span>x# - o.<span style="">x</span>#<span style=" ">&#41;</span> + <span style=" ">&#40;</span>y# - o.<span style="">y</span>#<span style=" ">&#41;</span> * <span style=" ">&#40;</span>y# - o.<span style="">y</span>#<span style=" ">&#41;</span><span style=" ">&#41;</span> * dang# / <span style="color: #FFFFFF;">180.0</span> &lt; o.<span style="">radius</span> <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #ffff00; font-weight: bold;">Return</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Если на пути выстрела нет колобков - смело стреляем</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fire<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> object_collision_act<span style=" ">&#40;</span>o:base_obj<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> o = player <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Проверяем, столкнулись ли с игроком</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> bite_reload &lt; <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' И готовы ли кусать</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; player.<span style="">damage</span><span style=" ">&#40;</span>bite_damage<span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Если да, то кусаем</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bite_reload = <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> + bite_reload_time<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bite = <span style="color: #ffff00; font-weight: bold;">True</span> <span style="color: #B1E7EB;">' Флаг показывает, что мы вцепились в игрока и можно стоять на месте</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> fire<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Поправка на скорость при временном ускорении</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">Self</span>=player <span style="color: #ffff00; font-weight: bold;">And</span> temporary_speed &gt; <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> spd# = <span style="color: #FFFFFF;">6.0</span> <span style="color: #ffff00; font-weight: bold;">Else</span> spd# = speed# &nbsp;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">Self</span>=player <span style="color: #ffff00; font-weight: bold;">And</span> temporary_firepower &gt; <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Стрельба при огневой мощи</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bullet_obj.<span style="">create</span> x#, y#, <span style="color: #FFFFFF;">0.75</span>, angle#, <span style="color: #FFFFFF;">4.0</span> + spd#, <span style="color: #FFFFFF;">2000</span>, <span style="color: #FFFFFF;">25</span>, <span style="color: #ffff00; font-weight: bold;">Self</span>, <span style="color: #FFFFFF;">0.5</span> * <span style="color: #FFFFFF;">0.3</span>, r, g, b<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bullet_reload = <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> + <span style="color: #FFFFFF;">40</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span> <span style="color: #B1E7EB;">' Стрельба в обычном режиме</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bullet_obj.<span style="">create</span> x#, y#, <span style="color: #FFFFFF;">0.5</span> * size#, angle#, bullet_speed# + spd#, bullet_lifetime, bullet_damage, <span style="color: #ffff00; font-weight: bold;">Self</span>, size# * <span style="color: #FFFFFF;">0.3</span>, r, g, b<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bullet_reload = <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> + bullet_reload_time<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Type</span><br />
<br />
<span style="color: #B1E7EB;">' Игрок</span><br />
<span style="color: #ffff00; font-weight: bold;">Type</span> player_obj <span style="color: #ffff00; font-weight: bold;">Extends</span> kolobok_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Function</span> create:player_obj<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o:player_obj = <span style="color: #ffff00; font-weight: bold;">New</span> player_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">x</span># = <span style="color: #FFFFFF;">0.5</span> * fxsize <span style="color: #B1E7EB;">' Помещаем игрока в центре</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">y</span># = <span style="color: #FFFFFF;">0.5</span> * fysize<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">size</span># = <span style="color: #FFFFFF;">0.75</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">radius</span># = <span style="color: #FFFFFF;">0.4</span> * o.<span style="">size</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">image</span> = kolobok<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">frame</span> = <span style="color: #FFFFFF;">2</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">speed</span># = <span style="color: #FFFFFF;">2.0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">bullet_reload_time</span> = <span style="color: #FFFFFF;">450</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">bullet_speed</span># = <span style="color: #FFFFFF;">1.0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">bullet_damage</span># = <span style="color: #FFFFFF;">2.5</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">max_health</span># = <span style="color: #FFFFFF;">300</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">health</span># = o.<span style="">max_health</span>#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">layer</span> = layer_ground_koloboks<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Repeat</span> <span style="color: #B1E7EB;">' Двигаем игрока вправо, пока он не окажется полностью на суше</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">x</span>:<span style="color: #FFFFFF;">+0.5</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Until</span> <span style="color: #ffff00; font-weight: bold;">Not</span> o.<span style="">collision</span><span style=" ">&#40;</span>o.<span style="">x</span>#, o.<span style="">y</span>#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">register</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> o<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> act<span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Действия игрока</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> death &lt; NOT_YET <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #ffff00; font-weight: bold;">Return</span> <span style="color: #B1E7EB;">' Если уже &quot;замочили&quot;, то плюем в потолок</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> teleport_mode = TM_IDLE <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Если телепортация не в процессе, то</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">KeyHit</span><span style=" ">&#40;</span>KEY_SPACE<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Если нажат пробел</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">Sqr</span><span style=" ">&#40;</span>targetx# * targetx# + targety# * targety#<span style=" ">&#41;</span> &lt;= max_teleport_radius <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' И расстояние не больше максимума</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">Not</span> collision<span style=" ">&#40;</span>player.<span style="">x</span># + targetx#, player.<span style="">y</span># + targety#<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' А также в месте появления нет коллизий</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; teleport_mode = TM_READY <span style="color: #B1E7EB;">' То готовимся к телепортации</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; teleport = <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> + teleport_ready_time <span style="color: #B1E7EB;">' В течение заданного времени</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> teleport &lt;= <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Если цикл завершился, то</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; teleport_mode = teleport_mode + <span style="color: #FFFFFF;">1</span> <span style="color: #B1E7EB;">' Переходим к следующему</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; teleport = <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> + fading_time <span style="color: #B1E7EB;">' Задаем время цикла</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> teleport_mode = TM_ENLARGING <span style="color: #ffff00; font-weight: bold;">And</span> <span style="color: #ffff00; font-weight: bold;">Not</span> collision<span style=" ">&#40;</span>player.<span style="">x</span># + targetx#, player.<span style="">y</span># + targety#<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; move player.<span style="">x</span># + targetx#, player.<span style="">y</span># + targety# <span style="color: #B1E7EB;">' Перемещаемся в точку телепортации после уменьшения</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fdx2# = fdx2# - targetx#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fdy2# = fdy2# - targety#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; targetx# = <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; targety# = <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">ElseIf</span> teleport_mode &gt; TM_ENLARGING <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Если цикл увеличения завершен</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; teleport_mode = TM_IDLE <span style="color: #B1E7EB;">' то сбрасываем режим</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> <span style="color: #B1E7EB;">' При телепортации нужно стоять смирно, поэтому выходим из метода</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> bullet_reload &lt; <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">And</span> <span style="color: #ffff00; font-weight: bold;">MouseDown</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> fire <span style="color: #B1E7EB;">' Если подошло время стрелять и нажат &quot;огонь&quot; - стреляем</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">MouseDown</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">2</span><span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">And</span> force_reload &lt;= <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Используем Силу если нажата кнопка и колобок готов</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; force_reload = force_reload_time + <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; force_effect = force_time + <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> force_effect &gt; <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> size# = <span style="color: #FFFFFF;">0.75</span> + <span style="color: #FFFFFF;">0.5</span> * <span style=" ">&#40;</span>force_effect - <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span><span style=" ">&#41;</span> / force_time <span style="color: #ffff00; font-weight: bold;">Else</span> size# = <span style="color: #FFFFFF;">0.75</span> <span style="color: #B1E7EB;">' &quot;Пухнем&quot; от Силы</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov = <span style="color: #ffff00; font-weight: bold;">False</span> <span style="color: #B1E7EB;">' Определяем угол вектора движения, основываясь на нажатых клавишах</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">KeyDown</span><span style=" ">&#40;</span>KEY_S<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> ang2# = <span style="color: #FFFFFF;">90.0</span>; mov = <span style="color: #ffff00; font-weight: bold;">True</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">KeyDown</span><span style=" ">&#40;</span>KEY_W<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> ang2# = - <span style="color: #FFFFFF;">90.0</span>; mov = <span style="color: #ffff00; font-weight: bold;">True</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Если одна из предыдущих клавиш нажата - модифицируем угол с учетом этого</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">KeyDown</span><span style=" ">&#40;</span>KEY_A<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> ang2# = <span style="color: #FFFFFF;">180.0</span> - <span style="color: #FFFFFF;">0.5</span> * ang2#; mov = <span style="color: #ffff00; font-weight: bold;">True</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">KeyDown</span><span style=" ">&#40;</span>KEY_D<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> ang2# = <span style="color: #FFFFFF;">0.5</span> * ang2#; mov = <span style="color: #ffff00; font-weight: bold;">True</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">Not</span> mov <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #ffff00; font-weight: bold;">Return</span> <span style="color: #B1E7EB;">' Если стоим, то больше здесь делать нечего</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Модификатор скорости для временного ускорения</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> temporary_speed &gt; <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> spd# = <span style="color: #FFFFFF;">6.0</span> <span style="color: #ffff00; font-weight: bold;">Else</span> spd# = speed#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #B1E7EB;">' Если нет коллизий, перемещаемся</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; try_move_ang ang2#, spd#<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> destroy<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Нам задали взбучку - истошно орем</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Notify</span> <span style="color: #00FF66;">&quot;AAAAAAAAAAAAAA!!! Whyyyyy???!!!&quot;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> object_collision_act<span style=" ">&#40;</span>o:base_obj<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Если столкнулись с бонусом и он еще не взят - берем</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bo:bonus_obj = bonus_obj<span style=" ">&#40;</span>o<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> bo <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #ffff00; font-weight: bold;">If</span> bo.<span style="">death</span> = NOT_YET <span style="color: #ffff00; font-weight: bold;">Then</span> bo.<span style="">get</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Type</span><br />
<br />
<span style="color: #B1E7EB;">' Пуля</span><br />
<span style="color: #ffff00; font-weight: bold;">Type</span> bullet_obj <span style="color: #ffff00; font-weight: bold;">Extends</span> base_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> parent:base_obj, damage# <span style="color: #B1E7EB;">' Указатель на стреляющего и коэффициент повреждения</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Создаем пулю: начальные координаты, размер, угол, скорость, время жизни, повреждения, стреляющий, отступ от координат</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Function</span> create:bullet_obj<span style=" ">&#40;</span>bx#, by#, bsize#, bangle#, bspeed#, blifetime, bdamage#, bparent:base_obj=<span style="color: #ffff00; font-weight: bold;">Null</span>, d#=<span style="color: #FFFFFF;">0</span>, br=<span style="color: #FFFFFF;">255</span>, bg=<span style="color: #FFFFFF;">255</span>, bb=<span style="color: #FFFFFF;">255</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bul:bullet_obj = <span style="color: #ffff00; font-weight: bold;">New</span> bullet_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bul.<span style="">layer</span> = layer_bullets<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bul.<span style="">x</span># = bx# + <span style="color: #ffff00; font-weight: bold;">Cos</span><span style=" ">&#40;</span>bangle#<span style=" ">&#41;</span> * d# <span style="color: #B1E7EB;">' Смещение отн. данных координат</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bul.<span style="">y</span># = by# + <span style="color: #ffff00; font-weight: bold;">Sin</span><span style=" ">&#40;</span>bangle#<span style=" ">&#41;</span> * d#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bul.<span style="">r</span> = br<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bul.<span style="">g</span> = bg<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bul.<span style="">b</span> = bb<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bul.<span style="">image</span> = bullet<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bul.<span style="">parent</span> = bparent<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bul.<span style="">angle</span># = bangle#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bul.<span style="">size</span># = bsize# <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bul.<span style="">speed</span># = bspeed#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bul.<span style="">radius</span> = bsize# * <span style="color: #FFFFFF;">0.25</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bul.<span style="">death</span> = <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> + blifetime<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bul.<span style="">damage</span># = bdamage#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bul.<span style="">register</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> act<span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Действует просто - летит вперед до столкновения</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; move x# + timspeed# * <span style="color: #ffff00; font-weight: bold;">Cos</span><span style=" ">&#40;</span>angle#<span style=" ">&#41;</span> * speed#, y# + timspeed# * <span style="color: #ffff00; font-weight: bold;">Sin</span><span style=" ">&#40;</span>angle#<span style=" ">&#41;</span> * speed#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; collision x#, y#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> &gt; death <span style="color: #ffff00; font-weight: bold;">Then</span> destroy <span style="color: #B1E7EB;">' Время жизни ограничено с появления</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> object_collision_act<span style=" ">&#40;</span>o:base_obj<span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Повреждение встреченного объекта</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> o &lt;&gt; parent <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ccnt:<span style="color: #FFFFFF;">+1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">damage</span><span style=" ">&#40;</span>damage<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; destroy<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> boundaries_collision_act<span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Уничтожается при столкновении с границами</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; destroy<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Type</span><br />
<br />
<span style="color: #B1E7EB;">' Ящик</span><br />
<span style="color: #ffff00; font-weight: bold;">Type</span> crate_obj <span style="color: #ffff00; font-weight: bold;">Extends</span> base_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> bonus_type <span style="color: #B1E7EB;">' Тип бонуса внутри</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Function</span> create:crate_obj<span style=" ">&#40;</span>b_type<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o:crate_obj = <span style="color: #ffff00; font-weight: bold;">New</span> crate_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">image</span> = crate<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">place_find</span> ONLY_ON_GROUND<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">bonus_type</span> = b_type<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">coll_type</span> = CT_SQUARE<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">health</span> = <span style="color: #FFFFFF;">10</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> o.<span style="">speed</span> &gt;= bonustypeq <span style="color: #ffff00; font-weight: bold;">Then</span> o.<span style="">speed</span> = <span style="color: #FFFFFF;">-1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">register</span> INACTIVE<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> destroy<span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Взрыв ящика</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> bonus_type &gt;= <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Then</span> bonus_obj.<span style="">create</span> x#, y#, bonus_type <span style="color: #B1E7EB;">' Создание бонуса на его месте</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; offset = <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, crate_bits_packq - <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span> * <span style="color: #FFFFFF;">16</span> <span style="color: #B1E7EB;">' Случайный выбор пакета кусочков</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> yy = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #FFFFFF;">3</span> <span style="color: #B1E7EB;">' Создание 16 разлетающихся кусочков</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> xx = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #FFFFFF;">3</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o:crate_bits_obj = <span style="color: #ffff00; font-weight: bold;">New</span> crate_bits_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">dx</span># = <span style="color: #ffff00; font-weight: bold;">Rnd</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">-1.0</span>, <span style="color: #FFFFFF;">1.0</span><span style=" ">&#41;</span> + xx - <span style="color: #FFFFFF;">1.5</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">dy</span># = <span style="color: #ffff00; font-weight: bold;">Rnd</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">-1.0</span>, <span style="color: #FFFFFF;">1.0</span><span style=" ">&#41;</span> + yy - <span style="color: #FFFFFF;">1.5</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">x</span># = x# + <span style="color: #FFFFFF;">0.125</span> * <span style=" ">&#40;</span>xx * <span style="color: #FFFFFF;">2</span> - <span style="color: #FFFFFF;">3</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">y</span># = y# + <span style="color: #FFFFFF;">0.125</span> * <span style=" ">&#40;</span>yy * <span style="color: #FFFFFF;">2</span> - <span style="color: #FFFFFF;">3</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">image</span> = crate_bits<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">frame</span> = xx + yy * <span style="color: #FFFFFF;">4</span> + offset<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">layer</span> = layer_top_scenery<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">death</span> = <span style="color: #FFFFFF;">2000</span> + <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">register</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">super</span>.<span style="">destroy</span> <span style="color: #B1E7EB;">' Уничтожение объекта ящика - вызов процедуры из base_obj</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Type</span><br />
<br />
<span style="color: #B1E7EB;">' Kусочки ящика</span><br />
<span style="color: #ffff00; font-weight: bold;">Type</span> crate_bits_obj <span style="color: #ffff00; font-weight: bold;">Extends</span> base_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> dx#, dy# <span style="color: #B1E7EB;">' Приращения для движения</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> act<span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Kусочки просто летят 2 секунды</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; x# = x# + dx# * timspeed#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; y# = y# + dy# * timspeed#<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Type</span><br />
<br />
<span style="color: #B1E7EB;">' Бонус</span><br />
<span style="color: #ffff00; font-weight: bold;">Type</span> bonus_obj <span style="color: #ffff00; font-weight: bold;">Extends</span> base_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> dangle#, rotation_period!, pulsing_period! <span style="color: #B1E7EB;">' Переменные для шевеления</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Function</span> create:bonus_obj<span style=" ">&#40;</span>x#, y#, b_type<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o:bonus_obj = <span style="color: #ffff00; font-weight: bold;">New</span> bonus_obj<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">x</span>=x#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">y</span>=y#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">image</span> = bonus<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">frame</span> = b_type<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">health</span> = INDESTRUCTIBLE <span style="color: #B1E7EB;">' Бонус неуничтожим</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">dangle</span># = <span style="color: #ffff00; font-weight: bold;">Rnd</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">5</span>, <span style="color: #FFFFFF;">30</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">rotation_period</span>! = <span style="color: #ffff00; font-weight: bold;">Rnd</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0.5</span>, <span style="color: #FFFFFF;">0.1</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">pulsing_period</span>! = <span style="color: #ffff00; font-weight: bold;">Rnd</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0.5</span>, <span style="color: #FFFFFF;">0.1</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">layer</span> = layer_ground_koloboks<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">register</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> draw<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; angle# = dangle# * <span style="color: #ffff00; font-weight: bold;">Sin</span><span style=" ">&#40;</span>rotation_period! * <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Kолебания угла</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size# = <span style="color: #FFFFFF;">0.8</span> + <span style="color: #FFFFFF;">0.2</span> * <span style="color: #ffff00; font-weight: bold;">Sin</span><span style=" ">&#40;</span>pulsing_period! * <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Kолебания размера</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">super</span>.<span style="">draw</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> get<span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Берем бонус</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Постоянные бонусы изменяют характеристики на значение, зависящее</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' от количества таких бонусов на карте (если собрать все бонусы, то характеристики изменятся</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' от начального до фиксированного значения, они указаны в комментариях</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Select</span> frame<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Case</span> BONUS_BULLET_DAMAGE; player.<span style="">bullet_damage</span>:+ <span style="color: #FFFFFF;">10.0</span> / constant_bonus_crateq <span style="color: #B1E7EB;">' 2.5 - 12.5 ед</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Case</span> BONUS_BULLET_SPEED; player.<span style="">bullet_speed</span>:+ <span style="color: #FFFFFF;">3.0</span> / constant_bonus_crateq <span style="color: #B1E7EB;">' 1.0 - 4.0 тайлов / сек</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Case</span> BONUS_BULLET_LIFETIME; player.<span style="">bullet_lifetime</span>:+ <span style="color: #FFFFFF;">3000</span> / constant_bonus_crateq <span style="color: #B1E7EB;">' 2 - 5 сек</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Case</span> BONUS_RELOAD_TIME; player.<span style="">bullet_reload_time</span>:- <span style="color: #FFFFFF;">400</span> / constant_bonus_crateq <span style="color: #B1E7EB;">' 0.5 - 0.1 сек</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Case</span> BONUS_MAX_HEALTH; player.<span style="">max_health</span>:+ <span style="color: #FFFFFF;">500.0</span> / constant_bonus_crateq; player.<span style="">health</span> = player.<span style="">max_health</span> <span style="color: #B1E7EB;">' 300 - 800 ед</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Case</span> BONUS_SPEED; player.<span style="">speed</span>:+ <span style="color: #FFFFFF;">2.0</span> / constant_bonus_crateq <span style="color: #B1E7EB;">' 2.0 - 4.0 тайлов / сек</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Case</span> BONUS_HEALTH<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> player.<span style="">health</span> = player.<span style="">max_health</span> <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #ffff00; font-weight: bold;">Return</span> <span style="color: #B1E7EB;">' Если полное здоровье - бонус не берем</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; player.<span style="">health</span> = limit<span style=" ">&#40;</span>player.<span style="">health</span> + <span style="color: #FFFFFF;">0.15</span> * player.<span style="">max_health</span>, <span style="color: #FFFFFF;">0</span>, player.<span style="">max_health</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' +15% от максимума</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Case</span> BONUS_TEMPORARY_FIREPOWER; temporary_firepower=<span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> + <span style="color: #FFFFFF;">10000</span> <span style="color: #B1E7EB;">' 10 секунд огневой мощи</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Case</span> BONUS_TEMPORARY_SPEED; temporary_speed=<span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> + <span style="color: #FFFFFF;">15000</span> <span style="color: #B1E7EB;">' 15 секунд ускорения</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Case</span> BONUS_TEMPORARY_INVULNERABILITY; temporary_invulnerability=<span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> + <span style="color: #FFFFFF;">20000</span> <span style="color: #B1E7EB;">' 20 секунд неуязвимости</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Case</span> BONUS_BOMB<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> n1 = <span style="color: #FFFFFF;">2</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #FFFFFF;">4</span> <span style="color: #B1E7EB;">' Генерация осколков бомбы</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n2 = <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">While</span> n2 &lt; <span style="color: #FFFFFF;">360</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bullet_obj.<span style="">create</span> x#, y#, <span style="color: #FFFFFF;">1</span>, n2, n1, <span style=" ">&#40;</span><span style="color: #FFFFFF;">5</span> - n1<span style=" ">&#41;</span> * <span style="color: #FFFFFF;">800</span>, <span style="color: #FFFFFF;">35</span>, player, player.<span style="">size</span># * <span style="color: #FFFFFF;">0.4</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n2 = n2 + <span style="color: #FFFFFF;">10</span> * <span style=" ">&#40;</span>n1 - <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Wend</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Case</span> BONUS_ESOURCE<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; esource_collected = esource_collected + <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> esource_collected = constant_bonus_crateq <span style="color: #ffff00; font-weight: bold;">Then</span> light = <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> + fading_time <span style="color: #B1E7EB;">' Да будет свет, если собрана вся мана</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Select</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; death = fading_time + <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Исчезновение бонуса</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; coll_type = CT_IMMATERIAL <span style="color: #B1E7EB;">' Бонус становится нематериальным</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Type</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">SeedRnd</span> <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Для того, чтобы каждый раз получать новую последовательность случайных чисел</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">SetGraphicsDriver</span> <span style="color: #ffff00; font-weight: bold;">GLMax2DDriver</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Установка драйвера отображения графики OpenGL</span><br />
<span style="color: #ffff00; font-weight: bold;">Graphics</span> sxsize, sysize, color_depth<br />
<span style="color: #ffff00; font-weight: bold;">AutoImageFlags</span> FILTEREDIMAGE | MIPMAPPEDIMAGE | DYNAMICIMAGE<br />
<span style="color: #ffff00; font-weight: bold;">SetBlend</span> ALPHABLEND<br />
reset_transformations<br />
<br />
<span style="color: #B1E7EB;">' Загружаем изображения с альфа-каналом из exe-файла</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> images:<span style="color: #ffff00; font-weight: bold;">TPixmap</span> = <span style="color: #ffff00; font-weight: bold;">LoadPixmapPNG</span><span style=" ">&#40;</span><span style="color: #00FF66;">&quot;incbin::2DEngine-NewImages.png&quot;</span><span style=" ">&#41;</span><br />
<br />
<span style="color: #B1E7EB;">' Создаем текстуры для тайлов</span><br />
tex_water:TImage = tiles_grab<span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">1</span>, <span style="color: #ffff00; font-weight: bold;">False</span><span style=" ">&#41;</span><br />
tex_sand:TImage = tiles_grab<span style=" ">&#40;</span><span style="color: #FFFFFF;">1</span>, <span style="color: #FFFFFF;">1</span>, <span style="color: #ffff00; font-weight: bold;">False</span><span style=" ">&#41;</span><br />
tex_grass:TImage = tiles_grab<span style=" ">&#40;</span><span style="color: #FFFFFF;">2</span>, <span style="color: #FFFFFF;">1</span>, <span style="color: #ffff00; font-weight: bold;">False</span><span style=" ">&#41;</span><br />
<br />
<span style="color: #B1E7EB;">' Вырезаем изображения</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> kolobok:TImage = tiles_grab<span style=" ">&#40;</span><span style="color: #FFFFFF;">3</span>, <span style="color: #FFFFFF;">3</span><span style=" ">&#41;</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> bullet:TImage = tiles_grab<span style=" ">&#40;</span><span style="color: #FFFFFF;">6</span><span style=" ">&#41;</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> bonus:TImage = tiles_grab<span style=" ">&#40;</span><span style="color: #FFFFFF;">7</span>, <span style="color: #FFFFFF;">12</span><span style=" ">&#41;</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> crate:TImage = tiles_grab<span style=" ">&#40;</span><span style="color: #FFFFFF;">19</span><span style=" ">&#41;</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> crate_bits:TImage = <span style="color: #ffff00; font-weight: bold;">CreateImage</span><span style=" ">&#40;</span>tilesize4, tilesize4, crate_bits_packq * <span style="color: #FFFFFF;">16</span><span style=" ">&#41;</span><br />
<span style="color: #ffff00; font-weight: bold;">For</span> n = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #FFFFFF;">3</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> yy = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #FFFFFF;">3</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> xx = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #FFFFFF;">3</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; new_grab crate_bits, n * tilesize + xx * tilesize4, yy * tilesize4 + tilesize * <span style="color: #FFFFFF;">5</span>, n * <span style="color: #FFFFFF;">16</span> + yy * <span style="color: #FFFFFF;">4</span> + xx<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
<span style="color: #ffff00; font-weight: bold;">Next</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> target:TImage = tiles_grab<span style=" ">&#40;</span><span style="color: #FFFFFF;">24</span><span style=" ">&#41;</span>, targetx#, targety#<br />
<br />
<span style="color: #B1E7EB;">' Создаем в пакете изображений тайлов текстуру воды</span><br />
tile_tex:TImage = <span style="color: #ffff00; font-weight: bold;">CreateImage</span><span style=" ">&#40;</span>tilesize, tilesize, <span style="color: #FFFFFF;">513</span><span style=" ">&#41;</span><br />
pixmap:<span style="color: #ffff00; font-weight: bold;">TPixmap</span> = <span style="color: #ffff00; font-weight: bold;">LockImage</span><span style=" ">&#40;</span>tile_tex,<span style="color: #FFFFFF;">0</span><span style=" ">&#41;</span><br />
pixmap.<span style="">paste</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">LockImage</span><span style=" ">&#40;</span>tex_water<span style=" ">&#41;</span><span style=" ">&#41;</span>, <span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">0</span><br />
<span style="color: #ffff00; font-weight: bold;">UnlockImage</span> tile_tex, <span style="color: #FFFFFF;">0</span><br />
<span style="color: #ffff00; font-weight: bold;">UnlockImage</span> tex_water<br />
<span style="color: #B1E7EB;">' И две библиотеки - переход от воды к песку и от песка к траве</span><br />
tile_lib_create tex_water, tex_sand, <span style="color: #FFFFFF;">4.0</span> / tilesize, <span style="color: #FFFFFF;">360.0</span>, tile_tex, <span style="color: #FFFFFF;">1</span><br />
tile_lib_create tex_sand, tex_grass, <span style="color: #FFFFFF;">4.0</span> / tilesize, <span style="color: #FFFFFF;">720.0</span>, tile_tex, <span style="color: #FFFFFF;">257</span><br />
<br />
<span style="color: #B1E7EB;">' Делаем &quot;пирог&quot; из слоев</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> layer_tiles:tile_layer_obj = tile_layer_obj.<span style="">add</span><span style=" ">&#40;</span>tile_tex<span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Сначала - тайлы</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> layer_bullets:object_layer_obj = object_layer_obj.<span style="">add</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Затем пули и осколки бомб</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> layer_water_koloboks:object_layer_obj = object_layer_obj.<span style="">add</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' После - водные колобки</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> layer_ground_koloboks:object_layer_obj = object_layer_obj.<span style="">add</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Потом - наземные колобки, ящики и бонусы</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> layer_top_scenery:object_layer_obj = object_layer_obj.<span style="">add</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Сверху - осколки ящиков</span><br />
<br />
<span style="color: #B1E7EB;">' Создаем слои тайловой коллизии</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> layer_water:tile_collision_layer_obj = tile_collision_layer_obj.<span style="">add</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Слой &quot;твердой&quot; воды</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> layer_sand:tile_collision_layer_obj = tile_collision_layer_obj.<span style="">add</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Слой &quot;твердого&quot; песка</span><br />
<br />
<span style="color: #B1E7EB;">' Определяем что с чем коллизирует</span><br />
layer_water_koloboks.<span style="">collides_with</span> layer_water_koloboks <span style="color: #B1E7EB;">' Водные колобки - между собой</span><br />
layer_water_koloboks.<span style="">collides_with</span> layer_sand <span style="color: #B1E7EB;">' Водные колобки - с коллизионным слоем песка</span><br />
layer_ground_koloboks.<span style="">collides_with</span> layer_ground_koloboks <span style="color: #B1E7EB;">' Сухопутные колобки - между собой</span><br />
layer_ground_koloboks.<span style="">collides_with</span> layer_water <span style="color: #B1E7EB;">' Сухопутные колобки - с коллизионным слоем воды</span><br />
layer_bullets.<span style="">collides_with</span> layer_water_koloboks <span style="color: #B1E7EB;">' Пули - с сухопутными колобками</span><br />
layer_bullets.<span style="">collides_with</span> layer_ground_koloboks <span style="color: #B1E7EB;">' Пули - с водными колобками</span><br />
<br />
field_generate <span style="color: #B1E7EB;">' Генерируем поле</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> player:player_obj = player_obj.<span style="">create</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Создаем игрока</span><br />
objects_generate <span style="color: #B1E7EB;">' Создаем колобков и ящики</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">HideMouse</span><br />
<br />
sc# = <span style="color: #FFFFFF;">64.0</span><br />
fdx# = player.<span style="">x</span> + sxsize2 / sc#<br />
fdy# = player.<span style="">y</span> + sysize2 / sc#<br />
<span style="color: #ffff00; font-weight: bold;">Repeat</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; tim = <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Засекаем время</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">MoveMouse</span> sxsize2, sysize2 <span style="color: #B1E7EB;">' Установка курсора мыши в центр экрана</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Плавное изменение координат камеры (при телепортации камера фиксируется на игроке, иначе - на средней точке между игроком и мишенью)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; camera_change <span style="color: #FFFFFF;">0.5</span> * targetx# * <span style=" ">&#40;</span>teleport_mode = TM_IDLE<span style=" ">&#41;</span>, <span style="color: #FFFFFF;">0.5</span> * targety# * <span style=" ">&#40;</span>teleport_mode = TM_IDLE<span style=" ">&#41;</span>, <span style="color: #FFFFFF;">1.1</span> ^ <span style="color: #ffff00; font-weight: bold;">MouseZ</span><span style=" ">&#40;</span><span style=" ">&#41;</span> * <span style="color: #FFFFFF;">64.0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; player.<span style="">angle</span> = <span style="color: #ffff00; font-weight: bold;">ATan2</span><span style=" ">&#40;</span>targety#, targetx#<span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Нацеливание спрайта игрока на мишень</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; timspeed# = speedpersec# * dtim# <span style="color: #B1E7EB;">' Определение множителя к скорости на основе прошедшего времени</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; timang# = angpersec# * dtim# <span style="color: #B1E7EB;">' То же для угловой скорости</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Прорисовка слоев</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> l:layer_obj = <span style="color: #ffff00; font-weight: bold;">EachIn</span> layer_order<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; l.<span style="">draw</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Действия активных объектов</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> o:base_obj = <span style="color: #ffff00; font-weight: bold;">EachIn</span> actingobj<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">act</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Отображение счетчиков</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawText</span> <span style="color: #00FF66;">&quot;Frames/sec:&quot;</span> + fps + <span style="color: #00FF66;">&quot;, objects:&quot;</span> + objcnt + <span style="color: #00FF66;">&quot;, collision checks/frame:&quot;</span> + chcnt + <span style="color: #00FF66;">&quot;, collisions/frame:&quot;</span> + ccnt, <span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; ccnt = <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; chcnt = <span style="color: #FFFFFF;">0</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Отображение мишени</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; field2scr targetx# + player.<span style="">x</span>, targety# + player.<span style="">y</span>, sx#, sy#<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawImage</span> target, sx#, sy#<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Осветление экрана при сборе всех источников энергии</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> light &gt; <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Устанавливаем прозрачность</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetAlpha</span> <span style="color: #FFFFFF;">1.0</span> - <span style="color: #FFFFFF;">1.0</span> * <span style=" ">&#40;</span>light - <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span><span style=" ">&#41;</span> / fading_time<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' И рисуем белый прямоугольник на весь экран</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawRect</span> <span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">0</span>, sxsize, sysize<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; reset_transformations<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">ElseIf</span> light&lt;&gt;<span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Поздравляем игрока с победой</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Notify</span> <span style="color: #00FF66;">&quot;Congratulations!!!&quot;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Flip</span> <span style="color: #ffff00; font-weight: bold;">False</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Обновление счетчика кадров в секунду</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> fpstim&lt;= <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fpstim = <span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> + <span style="color: #FFFFFF;">1000</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fps = cnt<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cnt = <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cnt:<span style="color: #FFFFFF;">+1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> teleport_mode = TM_IDLE <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; targetx#:+<span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">MouseX</span><span style=" ">&#40;</span><span style=" ">&#41;</span> - sxsize2<span style=" ">&#41;</span> / sc#&nbsp; &nbsp; <span style="color: #B1E7EB;">' Изменение координат мишени</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; targety#:+<span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">MouseY</span><span style=" ">&#40;</span><span style=" ">&#41;</span> - sysize2<span style=" ">&#41;</span> / sc#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Ограничения на перемещение цели</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; targetx# = limit<span style=" ">&#40;</span>targetx#, <span style="color: #ffff00; font-weight: bold;">Max</span><span style=" ">&#40;</span>-sxsize / sc# * <span style="color: #FFFFFF;">0.75</span>, -player.<span style="">x</span><span style=" ">&#41;</span>, <span style="color: #ffff00; font-weight: bold;">Min</span><span style=" ">&#40;</span>sxsize / sc# * <span style="color: #FFFFFF;">0.75</span>, fxsize - player.<span style="">x</span><span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; targety# = limit<span style=" ">&#40;</span>targety#, <span style="color: #ffff00; font-weight: bold;">Max</span><span style=" ">&#40;</span>-sysize / sc# * <span style="color: #FFFFFF;">0.75</span>, -player.<span style="">y</span><span style=" ">&#41;</span>, <span style="color: #ffff00; font-weight: bold;">Min</span><span style=" ">&#40;</span>sysize / sc# * <span style="color: #FFFFFF;">0.75</span>, fysize - player.<span style="">y</span><span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Вычисление времени, затраченного на виток цикла (в секундах) для вычисления множителей скоростей</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; dtim# = <span style="color: #FFFFFF;">0.001</span> * <span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Min</span><span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">MilliSecs</span><span style=" ">&#40;</span><span style=" ">&#41;</span> - tim, minms<span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Время ограниченно пределом для недопущения слишком больших множителей, отрицательно</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' &nbsp;сказывающихся на определении столкновений</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Until</span> <span style="color: #ffff00; font-weight: bold;">KeyHit</span><span style=" ">&#40;</span>KEY_ESCAPE<span style=" ">&#41;</span><br />
<br />
<span style="color: #B1E7EB;">' Генерация поля</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> field_generate<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Const</span> tile_water = <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Const</span> tile_sand = <span style="color: #FFFFFF;">256</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Const</span> tile_grass = <span style="color: #FFFFFF;">512</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Local</span> ff#<span style=" ">&#91;</span>fxsize, fysize, <span style="color: #FFFFFF;">2</span><span style=" ">&#93;</span> <span style="color: #B1E7EB;">' Вспомогательный буферизованный массив высот для тайловой карты</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Local</span> pos2bit<span style=" ">&#91;</span><span style=" ">&#93;</span> = <span style=" ">&#91;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">6</span>, <span style="color: #FFFFFF;">1</span>, <span style="color: #FFFFFF;">4</span>, <span style="color: #FFFFFF;">5</span>, <span style="color: #FFFFFF;">2</span>, <span style="color: #FFFFFF;">7</span>, <span style="color: #FFFFFF;">3</span><span style=" ">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; fmin# = <span style="color: #FFFFFF;">1.0</span>; fmax# = <span style="color: #FFFFFF;">0</span> <span style="color: #B1E7EB;">' Переменные минимума и максимума значений высот</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> n = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">To</span> fblurq + <span style="color: #FFFFFF;">3</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; loadingbar <span style="color: #00FF66;">&quot;Generating field...&quot;</span>, n, fblurq + <span style="color: #FFFFFF;">4</span> <span style="color: #B1E7EB;">' Индикатор завершенности процесса</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; maxd# = <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> y = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> fysize <span style="color: #B1E7EB;">' Цикл по всем тайлам</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> x = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> fxsize<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Select</span> n<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Case</span> <span style="color: #FFFFFF;">0</span> <span style="color: #B1E7EB;">' Сначала заполняем массив высот случайными значениями</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ff#<span style=" ">&#91;</span>x, y, <span style="color: #FFFFFF;">1</span><span style=" ">&#93;</span> = <span style="color: #ffff00; font-weight: bold;">Rnd</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Case</span> fblurq + <span style="color: #FFFFFF;">1</span> <span style="color: #B1E7EB;">' После этапов сглаживания - этап формирования тайловых слоев</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; d# = <span style=" ">&#40;</span>ff#<span style=" ">&#91;</span>x, y, k<span style=" ">&#93;</span> - fmin#<span style=" ">&#41;</span> / <span style=" ">&#40;</span>fmax# - fmin#<span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Kорректируем значение высоты, чтобы минимум соответствовал значению 0.0, максимум - 1.0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> d# &lt; sand_threshold# <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' До порога песка</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> = tile_water <span style="color: #B1E7EB;">' Отображаем чистый тайл воды</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; layer_water.<span style="">collision</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> = <span style="color: #ffff00; font-weight: bold;">True</span> <span style="color: #B1E7EB;">' Установка коллизии с этим тайлом в водном слое</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">ElseIf</span> d# &lt; grass_threshold# <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' От порога песка до порога травы</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> = tile_sand <span style="color: #B1E7EB;">' Пока отображаем чистый тайл песка</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; layer_sand.<span style="">collision</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> = <span style="color: #ffff00; font-weight: bold;">True</span> <span style="color: #B1E7EB;">' Установка коллизии с этим тайлом в слое песка</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span> <span style="color: #B1E7EB;">' После порога травы</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> = tile_grass <span style="color: #B1E7EB;">' Пока отображаем чистый тайл травы</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; layer_sand.<span style="">collision</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> = <span style="color: #ffff00; font-weight: bold;">True</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Case</span> fblurq + <span style="color: #FFFFFF;">2</span> <span style="color: #B1E7EB;">' Этап устранения травы, примыкающей к воде</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x,y<span style=" ">&#93;</span> = tile_grass <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Если тайл - трава, то</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> yy = - <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #FFFFFF;">1</span> <span style="color: #B1E7EB;">' Цикл по всем соседним тайлам</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> xx = - <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; x2 = <span style=" ">&#40;</span>x + xx + fxsize<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Mod</span> fxsize <span style="color: #B1E7EB;">' Расчет координат соседнего тайла</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; y2 = <span style=" ">&#40;</span>y + yy + fysize<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Mod</span> fysize <span style="color: #B1E7EB;">' &nbsp;(поле зациклено)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x2, y2<span style=" ">&#93;</span> = tile_water <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Если один из тайлов - вода</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> = tile_sand <span style="color: #B1E7EB;">' То меняем тайл травы на тайл песка</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Case</span> fblurq + <span style="color: #FFFFFF;">3</span> <span style="color: #B1E7EB;">' Этап сглаживания тайлов (выбора кадра из библиотеки)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> &gt; tile_water <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Если чистая вода, то пропускаем этот тайл</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bitpos = <span style="color: #FFFFFF;">0</span>; mask = <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> yy = - <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #FFFFFF;">1</span> <span style="color: #B1E7EB;">' Цикл по всем соседним тайлам</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> xx = - <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> xx&lt;&gt;<span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Or</span> yy&lt;&gt;<span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; x2 = <span style=" ">&#40;</span>x + xx + fxsize<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Mod</span> fxsize<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; y2 = <span style=" ">&#40;</span>y + yy + fysize<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Mod</span> fysize<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> &gt; tile_sand <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Если данный тайл - трава, то</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Если соседний тайл - трава, то включаем бит присутствия соседа для данного тайла</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x2, y2<span style=" ">&#93;</span> &gt; tile_sand <span style="color: #ffff00; font-weight: bold;">Then</span> setbit mask, pos2bit<span style=" ">&#91;</span>bitpos<span style=" ">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span> <span style="color: #B1E7EB;">' Иначе это тайл песка</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Если соседний тайл - песок, то включаем бит присутствия соседа для данного тайла</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x2, y2<span style=" ">&#93;</span> &gt; tile_water <span style="color: #ffff00; font-weight: bold;">Then</span> setbit mask, pos2bit<span style=" ">&#91;</span>bitpos<span style=" ">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bitpos:<span style="color: #FFFFFF;">+1</span> <span style="color: #B1E7EB;">' Увеличиваем счетчик номера бита</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> = <span style="color: #FFFFFF;">1</span> + <span style="color: #FFFFFF;">256</span> &nbsp;* <span style=" ">&#40;</span>layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> = tile_grass<span style=" ">&#41;</span> + mask<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Default</span> <span style="color: #B1E7EB;">' Этапы сглаживания массива высот</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sum# = <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> yy = - <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #FFFFFF;">1</span> <span style="color: #B1E7EB;">' Суммируем значения высот соседних тайлов и высоту данного тайла * 8</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> xx = - <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sum# = sum# + ff#<span style=" ">&#91;</span><span style=" ">&#40;</span>x + xx + fxsize<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Mod</span> fxsize, <span style=" ">&#40;</span>y + yy + fysize<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Mod</span> fysize, k<span style=" ">&#93;</span> * <span style=" ">&#40;</span><span style="color: #FFFFFF;">1.0</span> + <span style="color: #FFFFFF;">7.0</span> * <span style=" ">&#40;</span>xx = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">And</span> yy = <span style="color: #FFFFFF;">0</span><span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sum# = sum# / <span style="color: #FFFFFF;">16.0</span> <span style="color: #B1E7EB;">' Вычисляем среднее значение (центральный тайл имеет такой же вес, что и все 8 соседних в сумме)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> n = fblurq <span style="color: #ffff00; font-weight: bold;">Then</span> setminmax sum#, fmin#, fmax# <span style="color: #B1E7EB;">' Kорректируем значения максимума и минимума высоты</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ff#<span style=" ">&#91;</span>x, y, <span style="color: #FFFFFF;">1</span> - k<span style=" ">&#93;</span> = sum# <span style="color: #B1E7EB;">' Устанавливаем значение высоты в буфере</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Select</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; k = <span style="color: #FFFFFF;">1</span> - k <span style="color: #B1E7EB;">' Меняем буфер и текущую карту местами</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> n = fblurq + <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #B1E7EB;">' Окантовка карты водой после этапа формирования слоев</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> x = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> fxsize<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; waterize x, <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; waterize x, fysize - <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> y = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> fysize<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; waterize <span style="color: #FFFFFF;">0</span>, y<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; waterize fxsize - <span style="color: #FFFFFF;">1</span>, y<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Залитие тайла водой</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> waterize<span style=" ">&#40;</span>x, y<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; layer_tiles.<span style="">frame</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> = <span style="color: #FFFFFF;">0</span> <span style="color: #B1E7EB;">' Рисуем тайл воды</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; layer_water.<span style="">collision</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> = <span style="color: #ffff00; font-weight: bold;">True</span> <span style="color: #B1E7EB;">' Kоллизия для тайла водного слоя</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; layer_sand.<span style="">collision</span><span style=" ">&#91;</span>x, y<span style=" ">&#93;</span> = <span style="color: #ffff00; font-weight: bold;">False</span> <span style="color: #B1E7EB;">' Нет коллизии для тайла песка</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Создание библиотеки тайлов перехода между текстурами</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> tile_lib_create<span style=" ">&#40;</span>bottom_tile:TImage, top_tile:TImage, rowd#, period#, tile_lib:TImage, offset = <span style="color: #FFFFFF;">0</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Local</span> dt#<span style=" ">&#91;</span>tilesize2<span style=" ">&#93;</span> <span style="color: #B1E7EB;">' Заполнение массива колебаний ровной границы</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> dn = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> tilesize2<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dt#<span style=" ">&#91;</span>dn<span style=" ">&#93;</span> = <span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Sin</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">90</span> + dn * period# / tilesize2<span style=" ">&#41;</span> - <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span> * tilesize32<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; bottom_pixmap:<span style="color: #ffff00; font-weight: bold;">TPixmap</span> = <span style="color: #ffff00; font-weight: bold;">LockImage</span><span style=" ">&#40;</span>bottom_tile<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; top_pixmap:<span style="color: #ffff00; font-weight: bold;">TPixmap</span> = <span style="color: #ffff00; font-weight: bold;">LockImage</span><span style=" ">&#40;</span>top_tile<span style=" ">&#41;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> n = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #FFFFFF;">255</span> <span style="color: #B1E7EB;">' Восемь клеток вокруг тайла могут быть такими же либо отличными (2 состояния),</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #B1E7EB;">' поэтому всего - 2 ^ 8 = 256 вариантов</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; loadingbar <span style="color: #00FF66;">&quot;Generating transition tiles...&quot;</span>, n, <span style="color: #FFFFFF;">256</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lib_pixmap:<span style="color: #ffff00; font-weight: bold;">TPixmap</span> = <span style="color: #ffff00; font-weight: bold;">LockImage</span><span style=" ">&#40;</span>tile_lib, n + offset<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> n1 = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> n2 = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v = biton<span style=" ">&#40;</span>n, n1 + n2 * <span style="color: #FFFFFF;">2</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vx = biton<span style=" ">&#40;</span>n, n1 + <span style="color: #FFFFFF;">4</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vy = biton<span style=" ">&#40;</span>n, n2 + <span style="color: #FFFFFF;">6</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> yy = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> tilesize2<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> xx = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Until</span> tilesize2<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> vx <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> vy <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> v <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; k1# = <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; k1# = rowd# * <span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Sqr</span><span style=" ">&#40;</span>xx * xx + yy * yy<span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; k1# = <span style=" ">&#40;</span>yy + dt#<span style=" ">&#91;</span>xx<span style=" ">&#93;</span><span style=" ">&#41;</span> * rowd#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span> <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> vy <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; k1# = <span style=" ">&#40;</span>xx + dt#<span style=" ">&#91;</span>yy<span style=" ">&#93;</span><span style=" ">&#41;</span> * rowd#<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; k1# = <span style="color: #FFFFFF;">2.0</span> - rowd# * <span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">Sqr</span><span style=" ">&#40;</span><span style=" ">&#40;</span>tilesize2 - xx<span style=" ">&#41;</span> * <span style=" ">&#40;</span>tilesize2 - xx<span style=" ">&#41;</span> + <span style=" ">&#40;</span>tilesize2 - yy<span style=" ">&#41;</span> * <span style=" ">&#40;</span>tilesize2 - yy<span style=" ">&#41;</span><span style=" ">&#41;</span> + <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span> <span style="color: #FFFFFF;">-1</span>, <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> k1# &gt; <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">Then</span> k1# = <span style="color: #FFFFFF;">1</span> <span style="color: #B1E7EB;">' Ограничиваем коэффициент в пределах интервала [0, 1]</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> k1# &lt; <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Then</span> k1# = <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; k2# = <span style="color: #FFFFFF;">1.0</span> - k1# <span style="color: #B1E7EB;">' Kоэффициент прозрачности для пикселей другого тайла</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> n1 <span style="color: #ffff00; font-weight: bold;">Then</span> x = tilesize - <span style="color: #FFFFFF;">1</span> - xx <span style="color: #ffff00; font-weight: bold;">Else</span> x = xx <span style="color: #B1E7EB;">' Отражения отн. осей (если нужно)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> n2 <span style="color: #ffff00; font-weight: bold;">Then</span> y = tilesize - <span style="color: #FFFFFF;">1</span> - yy <span style="color: #ffff00; font-weight: bold;">Else</span> y = yy<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fromrgba <span style="color: #ffff00; font-weight: bold;">ReadPixel</span><span style=" ">&#40;</span>top_pixmap, x, y<span style=" ">&#41;</span>, r1, g1, b1, dummy <span style="color: #B1E7EB;">' Получаем цветовые компоненты пикселей тайлов</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fromrgba <span style="color: #ffff00; font-weight: bold;">ReadPixel</span><span style=" ">&#40;</span>bottom_pixmap, x, y<span style=" ">&#41;</span>, r2, g2, b2, dummy<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Печатаем пиксел, смешивая цвета с заданными коэффициентами</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">WritePixel</span> lib_pixmap, x, y, torgba<span style=" ">&#40;</span>k1# * r1 + k2# * r2, k1# * g1 + k2# * g2, k1# * b1 + k2# * b2, <span style="color: #FFFFFF;">255</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">UnlockImage</span> bottom_tile<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">UnlockImage</span> top_tile<br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Генерация ящиков и колобков</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> objects_generate<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Kолобки</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> n = <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">To</span> kolobokq<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style=" ">&#40;</span>n <span style="color: #ffff00; font-weight: bold;">Mod</span> <span style="color: #FFFFFF;">100</span><span style=" ">&#41;</span> = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Then</span> loadingbar <span style="color: #00FF66;">&quot;Generating objects...&quot;</span>, n, kolobokq * <span style="color: #FFFFFF;">3</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Repeat</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o:kolobok_obj = kolobok_obj.<span style="">create</span><span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Расстояние до игрока должно быть не меньше минимума</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">Sqr</span><span style=" ">&#40;</span><span style=" ">&#40;</span>o.<span style="">x</span> - player.<span style="">x</span><span style=" ">&#41;</span> * <span style=" ">&#40;</span>o.<span style="">x</span> - player.<span style="">x</span><span style=" ">&#41;</span> + <span style=" ">&#40;</span>o.<span style="">y</span> - player.<span style="">y</span><span style=" ">&#41;</span> * <span style=" ">&#40;</span>o.<span style="">y</span> - player.<span style="">y</span><span style=" ">&#41;</span><span style=" ">&#41;</span> &gt;= min_enemy_distance <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #ffff00; font-weight: bold;">Exit</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o.<span style="">destroy</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Forever</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Ящики с постоянными бонусами</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> n1 = <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">To</span> constant_bonustypeq <span style="color: #B1E7EB;">' Цикл по всем типам бонусов</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style=" ">&#40;</span>n <span style="color: #ffff00; font-weight: bold;">Mod</span> <span style="color: #FFFFFF;">100</span><span style=" ">&#41;</span> = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">Then</span> loadingbar <span style="color: #00FF66;">&quot;Generating objects...&quot;</span>, n1 + constant_bonustypeq, constant_bonustypeq * <span style="color: #FFFFFF;">3</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> n2 = <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">To</span> constant_bonus_crateq <span style="color: #B1E7EB;">' Создаем заданное кол-во ящиков каждого типа</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; crate_obj.<span style="">create</span><span style=" ">&#40;</span>n1 - <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Ящики с временными бонусами</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> n = <span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">To</span> temporary_bonus_crateq<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; loadingbar <span style="color: #00FF66;">&quot;Generating objects...&quot;</span>, n + temporary_bonus_crateq * <span style="color: #FFFFFF;">2</span>, temporary_bonus_crateq * <span style="color: #FFFFFF;">3</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">1</span>,<span style="color: #FFFFFF;">100</span><span style=" ">&#41;</span> &gt; empty_crates_percent <span style="color: #ffff00; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; crate_obj.<span style="">create</span> <span style="color: #ffff00; font-weight: bold;">Rand</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">0</span>, temporary_bonustypeq - <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span> + bonus_threshold<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; crate_obj.<span style="">create</span> <span style="color: #FFFFFF;">-1</span> <span style="color: #B1E7EB;">' Часть ящиков пусты</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Занесение в список объектов находящихся в пределах заданного кол-ва тайлов</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> nearly_objects:<span style="color: #ffff00; font-weight: bold;">TList</span><span style=" ">&#40;</span>lst:<span style="color: #ffff00; font-weight: bold;">TList</span>, x, y, radius, layer:object_layer_obj<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> yy = <span style="color: #ffff00; font-weight: bold;">Max</span><span style=" ">&#40;</span>y - radius, <span style="color: #FFFFFF;">0</span><span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #ffff00; font-weight: bold;">Min</span><span style=" ">&#40;</span>y + radius, fysize - <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> xx = <span style="color: #ffff00; font-weight: bold;">Max</span><span style=" ">&#40;</span>x - radius, <span style="color: #FFFFFF;">0</span><span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">To</span> <span style="color: #ffff00; font-weight: bold;">Min</span><span style=" ">&#40;</span>x + radius, fxsize - <span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> o:base_obj = <span style="color: #ffff00; font-weight: bold;">EachIn</span><span style=" ">&#40;</span>layer.<span style="">objects</span><span style=" ">&#91;</span>xx, yy<span style=" ">&#93;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lst.<span style="">addlast</span> o<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> lst<br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Функция вырезания изображения из другого изображения</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> new_grab:TImage<span style=" ">&#40;</span>image:TImage, x, y, frame<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; pixmap:<span style="color: #ffff00; font-weight: bold;">TPixmap</span> = <span style="color: #ffff00; font-weight: bold;">LockImage</span><span style=" ">&#40;</span>image, frame<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; w:<span style="color: #ffff00; font-weight: bold;">TPixmap</span> = images.<span style="">window</span><span style=" ">&#40;</span>x, y, <span style="color: #ffff00; font-weight: bold;">ImageWidth</span><span style=" ">&#40;</span>image<span style=" ">&#41;</span>, <span style="color: #ffff00; font-weight: bold;">ImageHeight</span><span style=" ">&#40;</span>image<span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; pixmap.<span style="">paste</span> w, <span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">UnlockImage</span> image<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> image<br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Функция вырезания тайла или серии тайлов из изображения</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> tiles_grab:TImage<span style=" ">&#40;</span>num, frameq = <span style="color: #FFFFFF;">1</span>, midhn = <span style="color: #ffff00; font-weight: bold;">True</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; image:TImage = <span style="color: #ffff00; font-weight: bold;">CreateImage</span><span style=" ">&#40;</span>tilesize, tilesize, frameq<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> midhn <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #ffff00; font-weight: bold;">MidHandleImage</span> image <span style="color: #B1E7EB;">' флаг midhn означает, что изображение нужно отцентровать</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">For</span> n = <span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">To</span> frameq - <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pos = num + n<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; new_grab image, <span style=" ">&#40;</span>pos <span style="color: #ffff00; font-weight: bold;">Mod</span> <span style="color: #FFFFFF;">4</span><span style=" ">&#41;</span> * tilesize, <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>pos / <span style="color: #FFFFFF;">4</span><span style=" ">&#41;</span> * tilesize, n <span style="color: #B1E7EB;">' По умолчанию тайлы располагаются на изображении в 4 столбца</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> image<br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Функция сброса трансформаций</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> reset_transformations<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; SetGrayColor <span style="color: #FFFFFF;">255</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetRotation</span> <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetAlpha</span> <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetScale</span> <span style="color: #FFFFFF;">1.0</span>, <span style="color: #FFFFFF;">1.0</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Function</span> camera_change<span style=" ">&#40;</span>x#, y#, scale#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">' Приращения координат камеры и увеличения</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; sc# = sc# + magn_speed# * <span style=" ">&#40;</span>scale# - sc#<span style=" ">&#41;</span> * dtim#<br />
&nbsp; &nbsp; &nbsp; &nbsp; camx# = camx# + cam_speed# * <span style=" ">&#40;</span>x# - camx#<span style=" ">&#41;</span> * dtim#<br />
&nbsp; &nbsp; &nbsp; &nbsp; camy# = camy# + cam_speed# * <span style=" ">&#40;</span>y# - camy#<span style=" ">&#41;</span> * dtim#<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; sc# = limit<span style=" ">&#40;</span>sc#, <span style="color: #ffff00; font-weight: bold;">Max</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">1.0</span> * sxsize / fxsize, <span style="color: #FFFFFF;">1.0</span> * sysize / fysize<span style=" ">&#41;</span>, <span style="color: #FFFFFF;">256.0</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Ограничение увеличения</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; tilesc# = sc# / tilesize <span style="color: #B1E7EB;">' Вычисление коэффициента увеличения для тайлов</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; xsize# = sxsize / sc#&nbsp; &nbsp;<span style="color: #B1E7EB;">' Размеры отображаемого прямоугольного куска поля</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; ysize# = sysize / sc#<br />
&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; fdx# = limit<span style=" ">&#40;</span>player.<span style="">x</span> + camx# - xsize# * <span style="color: #FFFFFF;">0.5</span>, <span style="color: #FFFFFF;">0</span>, fxsize - xsize#<span style=" ">&#41;</span> <span style="color: #B1E7EB;">' Ограничения смещения поля (по границам)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; fdy# = limit<span style=" ">&#40;</span>player.<span style="">y</span> + camy# - ysize# * <span style="color: #FFFFFF;">0.5</span>, <span style="color: #FFFFFF;">0</span>, fysize - ysize#<span style=" ">&#41;</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Установка цвета - оттенка серого</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> SetGrayColor<span style=" ">&#40;</span>col<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetColor</span> col, col, col<br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Полоса отображения завершенности процесса</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> loadingbar<span style=" ">&#40;</span>txt$, pos, maximum<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Cls</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetColor</span> <span style="color: #FFFFFF;">128</span>, <span style="color: #FFFFFF;">128</span>, <span style="color: #FFFFFF;">255</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawText</span> txt$, <span style=" ">&#40;</span>sxsize - <span style="color: #ffff00; font-weight: bold;">TextWidth</span><span style=" ">&#40;</span>txt$<span style=" ">&#41;</span><span style=" ">&#41;</span> / <span style="color: #FFFFFF;">2</span>, sysize34<br />
&nbsp; &nbsp; &nbsp; &nbsp; col = <span style="color: #FFFFFF;">255</span> * pos / maximum<br />
&nbsp; &nbsp; &nbsp; &nbsp; SetGrayColor <span style="color: #FFFFFF;">255</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; DrawEmptyRect sxsize4, sysize34 + <span style="color: #FFFFFF;">20</span>, sxsize2, <span style="color: #FFFFFF;">30</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetColor</span> <span style="color: #FFFFFF;">255</span> - col, col, <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawRect</span> sxsize4 + <span style="color: #FFFFFF;">2</span>, sysize34 + <span style="color: #FFFFFF;">22</span>, sxsize24 * pos / maximum, <span style="color: #FFFFFF;">26</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Flip</span> <span style="color: #ffff00; font-weight: bold;">False</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; SetGrayColor <span style="color: #FFFFFF;">255</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Функция, рисующая пустой прямоугольник</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> DrawEmptyRect<span style=" ">&#40;</span>x#, y#, xsize#, ysize#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; xsize# = xsize# - <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; ysize# = ysize# - <span style="color: #FFFFFF;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawLine</span> x#, y#, x# + xsize#, y#<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawLine</span> x# + xsize#, y#, x# + xsize#,y# + ysize#<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawLine</span> x# + xsize#, y# + ysize#, x#, y# + ysize#<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawLine</span> x#, y# + ysize#, x#, y#<br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Функция, переводящая Write/ReadPixel-значение в значения цветовых компонент и альфа канала</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> fromRGBa<span style=" ">&#40;</span>from, r <span style="color: #ffff00; font-weight: bold;">Var</span>, g <span style="color: #ffff00; font-weight: bold;">Var</span>, b <span style="color: #ffff00; font-weight: bold;">Var</span>, a <span style="color: #ffff00; font-weight: bold;">Var</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; b = from &amp; $FF<br />
&nbsp; &nbsp; &nbsp; &nbsp; g = <span style=" ">&#40;</span>from <span style="color: #ffff00; font-weight: bold;">Shr</span> <span style="color: #FFFFFF;">8</span><span style=" ">&#41;</span> &amp; $FF<br />
&nbsp; &nbsp; &nbsp; &nbsp; r = <span style=" ">&#40;</span>from <span style="color: #ffff00; font-weight: bold;">Shr</span> <span style="color: #FFFFFF;">16</span><span style=" ">&#41;</span> &amp; $FF<br />
&nbsp; &nbsp; &nbsp; &nbsp; a = <span style=" ">&#40;</span>from <span style="color: #ffff00; font-weight: bold;">Shr</span> <span style="color: #FFFFFF;">24</span><span style=" ">&#41;</span> &amp; $FF<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Функция, переводящая значения цветовых компонент и альфа канала в Write/ReadPixel-значение</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> toRGBa<span style=" ">&#40;</span>r, g, b, a = <span style="color: #FFFFFF;">255</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> b | <span style=" ">&#40;</span>g <span style="color: #ffff00; font-weight: bold;">Shl</span> <span style="color: #FFFFFF;">8</span><span style=" ">&#41;</span> | <span style=" ">&#40;</span>r <span style="color: #ffff00; font-weight: bold;">Shl</span> <span style="color: #FFFFFF;">16</span><span style=" ">&#41;</span> | <span style=" ">&#40;</span>a <span style="color: #ffff00; font-weight: bold;">Shl</span> <span style="color: #FFFFFF;">24</span><span style=" ">&#41;</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Меняем местами значения двух переменных</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> swap<span style=" ">&#40;</span>v1 <span style="color: #ffff00; font-weight: bold;">Var</span>, v2 <span style="color: #ffff00; font-weight: bold;">Var</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; z = v2<br />
&nbsp; &nbsp; &nbsp; &nbsp; v2 = v1<br />
&nbsp; &nbsp; &nbsp; &nbsp; v1 = z<br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Изменение минимума и максимума на основе переменной</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> setminmax<span style=" ">&#40;</span>v#, vmin# <span style="color: #ffff00; font-weight: bold;">Var</span>, vmax# <span style="color: #ffff00; font-weight: bold;">Var</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> v#&lt;vmin# <span style="color: #ffff00; font-weight: bold;">Then</span> vmin# = v#<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> v#&gt;vmax# <span style="color: #ffff00; font-weight: bold;">Then</span> vmax# = v#<br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Перевод из экранных координат в тайловые</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> scr2field<span style=" ">&#40;</span>sx#, sy#, tx# <span style="color: #ffff00; font-weight: bold;">Var</span>, ty# <span style="color: #ffff00; font-weight: bold;">Var</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; tx# = sx# / sc# + fdx#<br />
&nbsp; &nbsp; &nbsp; &nbsp; ty# = sy# / sc# + fdy#<br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Перевод из тайловых координат в экранные</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> field2scr<span style=" ">&#40;</span>tx#, ty#, sx# <span style="color: #ffff00; font-weight: bold;">Var</span>, sy# <span style="color: #ffff00; font-weight: bold;">Var</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; sx# = <span style=" ">&#40;</span>tx# - fdx#<span style=" ">&#41;</span> * sc#<br />
&nbsp; &nbsp; &nbsp; &nbsp; sy# = <span style=" ">&#40;</span>ty# - fdy#<span style=" ">&#41;</span> * sc#<br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Ограничение переменной минимальным и максимальным значениями</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> limit#<span style=" ">&#40;</span>v#, vmin#, vmax#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> v# &lt; vmin# <span style="color: #ffff00; font-weight: bold;">Then</span> v = vmin# <span style="color: #ffff00; font-weight: bold;">ElseIf</span> v# &gt; vmax# <span style="color: #ffff00; font-weight: bold;">Then</span> v# = vmax#<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> v#<br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Функция, возвращающая значение бита под номером bitnum</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> biton<span style=" ">&#40;</span>v, bitnum<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> v &amp; <span style=" ">&#40;</span><span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">Shl</span> bitnum<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #ffff00; font-weight: bold;">Return</span> <span style="color: #ffff00; font-weight: bold;">True</span> <span style="color: #ffff00; font-weight: bold;">Else</span> <span style="color: #ffff00; font-weight: bold;">Return</span> <span style="color: #ffff00; font-weight: bold;">False</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Включение бита под номером bitnum в значении переменной</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> setbit<span style=" ">&#40;</span>v <span style="color: #ffff00; font-weight: bold;">Var</span>, bitnum<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; v = v | <span style=" ">&#40;</span><span style="color: #FFFFFF;">1</span> <span style="color: #ffff00; font-weight: bold;">Shl</span> bitnum<span style=" ">&#41;</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #B1E7EB;">' Вычисление минимальной разности углов</span><br />
<span style="color: #ffff00; font-weight: bold;">Function</span> calc_dangle#<span style=" ">&#40;</span>ang1#, ang2#<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; dang# = ang2# - ang1#<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Return</span> dang# - <span style="color: #ffff00; font-weight: bold;">Floor</span><span style=" ">&#40;</span>dang# / <span style="color: #FFFFFF;">360</span> + <span style="color: #FFFFFF;">0.5</span><span style=" ">&#41;</span> * <span style="color: #FFFFFF;">360</span><br />
</p>
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span></div>
<div align="right"><a href="http://blitzetcetera.org/images/f/f6/2D_Engine.zip" class="internal" title="2D Engine.zip">скачать архив с файлами к статье</a></div>
<hr />
<p>Автор: <a href="http://blitzetcetera.org/index.php/%D0%A3%D1%87%D0%B0%D1%81%D1%82%D0%BD%D0%B8%D0%BA:Matt_Merkulov" title="Участник:Matt Merkulov">Матвей Меркулов</a> (E-mail: MattMerk@mail.ru, ICQ: 392-274-050)
</p><!-- 
Pre-expand include size: 134210 bytes
Post-expand include size: 559 bytes
Template argument size: 20 bytes
Maximum: 2097152 bytes
-->

<!-- Saved in parser cache with key db1:pcache:idhash:662-0!1!0!!ru!2 and timestamp 20071110032252 -->
<div class="printfooter">
Получено с <a href="uqyay3io.html">http://blitzetcetera.org/index.php/%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B4%D0%B2%D1%83%D0%BC%D0%B5%D1%80%D0%BD%D0%BE%D0%B3%D0%BE_%D0%B4%D0%B2%D0%B8%D0%B6%D0%BA%D0%B0_%D0%BD%D0%B0_%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D0%B5_%D0%B8%D0%B3%D1%80%D1%8B_%C2%AB%D0%97%D0%B2%D0%B5%D1%80%D1%81%D0%BA%D0%B8%D0%B5_%D0%BA%D0%BE%D0%BB%D0%BE%D0%B1%D0%BA%D0%B8%C2%BB</a></div>
			<!-- end content -->			<div class="visualClear"></div>				</td>				<td class="rightside">				</td>			</tr>		</table>		</div>	</div>		</div>	
		<script type="text/javascript">if (window.runOnloadHook) runOnloadHook();</script>
</div></body>
<!-- Mirrored from localhost/index.php/%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B4%D0%B2%D1%83%D0%BC%D0%B5%D1%80%D0%BD%D0%BE%D0%B3%D0%BE_%D0%B4%D0%B2%D0%B8%D0%B6%D0%BA%D0%B0_%D0%BD%D0%B0_%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D0%B5_%D0%B8%D0%B3%D1%80%D1%8B_%22%D0%97%D0%B2%D0%B5%D1%80%D1%81%D0%BA%D0%B8%D0%B5_%D0%BA%D0%BE%D0%BB%D0%BE%D0%B1%D0%BA%D0%B8%22 by HTTrack Website Copier/3.x [XR&CO'2007], Sat, 10 Nov 2007 05:15:20 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8"><!-- /Added by HTTrack -->
</html>