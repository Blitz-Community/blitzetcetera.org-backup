<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ru" lang="ru" dir="ltr">	
<!-- Mirrored from localhost/index.php/%D0%9A%D0%BE%D0%BB%D0%BB%D0%B8%D0%B7%D0%B8%D0%B8_%D0%B8%D0%BB%D0%B8_%D1%81%D1%82%D0%BE%D0%BB%D0%BA%D0%BD%D0%BE%D0%B2%D0%B5%D0%BD%D0%B8%D1%8F_%D0%BF%D0%BE_%D0%BD%D0%B0%D1%88%D0%B5%D0%BC%D1%83 by HTTrack Website Copier/3.x [XR&CO'2007], Sat, 10 Nov 2007 05:15:49 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8"><!-- /Added by HTTrack -->
<head>		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />				<meta name="keywords" content="Коллизии или столкновения по нашему" />
		<link rel="shortcut icon" href="http://blitzetcetera.org/favicon.ico" />
		<link rel="search" type="application/opensearchdescription+xml" href="http://blitzetcetera.org/opensearch_desc.php" title="Blitz Et Cetera (Русский)" />
		<title>Коллизии или столкновения по нашему — Blitz Et Cetera</title>		<style type="text/css" media="screen,projection">/*<![CDATA[*/ @import "bvih5rde.css?63"; /*]]>*/</style>		<link rel="stylesheet" type="text/css" media="print" href="gcxktlm6.css?63" />		<link rel="stylesheet" type="text/css" media="handheld" href="zumsslq_.css?63" />		<!--[if lt IE 5.5000]><style type="text/css">@import "/skins/OfflineNew/IE50Fixes.css?63";</style><![endif]-->		<!--[if IE 5.5000]><style type="text/css">@import "/skins/OfflineNew/IE55Fixes.css?63";</style><![endif]-->		<!--[if IE 6]><style type="text/css">@import "/skins/OfflineNew/IE60Fixes.css?63";</style><![endif]-->		<!--[if IE 7]><style type="text/css">@import "/skins/OfflineNew/IE70Fixes.css?63";</style><![endif]-->		<!--[if lt IE 7]><script type="text/javascript" src="/skins/common/IEFixes.js?63"></script>		<meta http-equiv="imagetoolbar" content="no" /><![endif]-->		<script type= "text/javascript">/*<![CDATA[*/
var skin = "OfflineNew";
var stylepath = "/skins";
var wgArticlePath = "/index.php/$1";
var wgScriptPath = "";
var wgServer = "http://blitzetcetera.org/";
var wgCanonicalNamespace = "";
var wgCanonicalSpecialPageName = false;
var wgNamespaceNumber = 0;
var wgPageName = "Коллизии_или_столкновения_по_нашему";
var wgTitle = "Коллизии или столкновения по нашему";
var wgAction = "view";
var wgArticleId = "735";
var wgIsArticle = true;
var wgUserName = null;
var wgUserGroups = null;
var wgUserLanguage = "ru";
var wgContentLanguage = "ru";
var wgBreakFrames = false;
var wgCurRevisionId = "3382";
/*]]>*/</script>
		<script type="text/javascript" src="2nq-6cel.js?63"><!-- wikibits js --></script>		<script type="text/javascript" src="http://blitzetcetera.org/index.php?title=-&amp;action=raw&amp;gen=js"><!-- site js --></script>		<style type="text/css">/*<![CDATA[*/
@import "http://blitzetcetera.org/index.php?title=MediaWiki:Common.css&amp;usemsgcache=yes&amp;action=raw&amp;ctype=text/css&amp;smaxage=18000";
@import "http://blitzetcetera.org/index.php?title=MediaWiki:OfflineNew.css&amp;usemsgcache=yes&amp;action=raw&amp;ctype=text/css&amp;smaxage=18000";
@import "http://blitzetcetera.org/index.php?title=-&amp;action=raw&amp;gen=css&amp;maxage=18000";
/*]]>*/</style>		<!-- Head Scripts -->	</head><body  class="mediawiki ns-0 ltr page-Коллизии_или_столкновения_по_нашему">	<div id="globalWrapper">	<div id="logocontainer">		<table align="center">		  <tr>				<td id="blitzetclogo">				</td>			</tr>		</table>	</div>	<div id="magbar">	Журнал о программированнии на языках Blitz3D, BlitzMax, BlitzPlus	</div>		<div id="column-content">	<div id="content">		<a name="top" id="top"></a>				<div id="bodyContent">		<table cellspacing=0 cellpadding=0 width=100%>			<tr>			  <td class="leftside">				</td>				<td class="sheetbody">					<h1 class="sheet">Коллизии или столкновения по нашему</h1>			<h3 id="siteSub">Материал из Blitz Et Cetera.</h3>			<div id="contentSub"></div>			<!-- start content -->			<table id="toc" class="toc" summary="Содержание"><tr><td><div id="toctitle"><h2>Содержание</h2></div>
<ul>
<li class="toclevel-1"><a href="#.D0.A2.D0.B5.D0.BE.D1.80.D0.B8.D1.8F"><span class="tocnumber">1</span> <span class="toctext">Теория</span></a></li>
<li class="toclevel-1"><a href="#.D0.9F.D1.80.D0.B8.D0.BC.D0.B5.D1.80.D1.8B"><span class="tocnumber">2</span> <span class="toctext">Примеры</span></a></li>
<li class="toclevel-1"><a href="#.D0.91.D0.B0.D0.B3.D0.B8"><span class="tocnumber">3</span> <span class="toctext">Баги</span></a></li>
<li class="toclevel-1"><a href="#.D0.A1.D0.BE.D0.B2.D0.B5.D1.82.D1.8B"><span class="tocnumber">4</span> <span class="toctext">Советы</span></a></li>
</ul>
</td></tr></table><script type="text/javascript"> if (window.showTocToggle) { var tocShowText = "показать"; var tocHideText = "убрать"; showTocToggle(); } </script>
<a name=".D0.A2.D0.B5.D0.BE.D1.80.D0.B8.D1.8F"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%9A%D0%BE%D0%BB%D0%BB%D0%B8%D0%B7%D0%B8%D0%B8_%D0%B8%D0%BB%D0%B8_%D1%81%D1%82%D0%BE%D0%BB%D0%BA%D0%BD%D0%BE%D0%B2%D0%B5%D0%BD%D0%B8%D1%8F_%D0%BF%D0%BE_%D0%BD%D0%B0%D1%88%D0%B5%D0%BC%D1%83&amp;action=edit&amp;section=1" title="Править секцию: Теория">править</a>]</span> <span class="mw-headline">Теория</span></h2>
<p>Для работы с коллизиями (столкновениями) есть две методики: непосредственное определение и отложенное. Непосредственное использует функции ImagesCollide и ImagesCollide2 и служит для определения столкновения именно в данный момент. Отложенное основано на работе со слоями и может использоваться для определения столкновения с объектом, который уже обрабатывался.
</p><p>Подробнее о функциях для непосредственного определения столкновения:
</p>
<ul><li>ImagesCollide( image1:TImage,x1,y1,frame1,image2:TImage,x2,y2,frame2 )
<ul><li>image1 - первая картинка;
</li><li>x1,y1,frame1 - координаты и кадр первой картинки.
</li><li>image2 - вторая картинка
</li><li>x2,y2,frame2 - координаты и кадр второй картинки.
</li><li>Возвращает: True если картинки пересекаются.
</li><li>Использование: Это одна из простейших функций определения попиксельной коллизии и подходит больше для не объектно-ориентированного подхода к программированию или когда у нас небольшое количество объектов.
</li><li>Особенности: Для тестирования используются текущие величины поворота и размера, которые будут применяться одинаково и к первой и ко второй картинке. Поэтому при необходимости их надо определить перед использованием этой функции, используя SetScale и SetRotation.
</li></ul>
</li><li>ImagesCollide2( image1:TImage, x1, y1, frame1, rot1#, scalex1#, scaley1#, image2:TImage, x2, y2, frame2, rot2#, scalex2#, scaley2# )
<ul><li>image1 - первая картинка;
</li><li>x1,y1,frame1 - координаты и кадр первой картинки.
</li><li>rot1#, scalex1#, scaley1# - величины поворота, размера по x и y для первой картинки.
</li><li>image2 - вторая картинка
</li><li>x2,y2,frame2 - координаты и кадр второй картинки.
</li><li>rot2#, scalex2#, scaley2# - величины поворота, размера по x и y для второй картинки.
</li><li>Возвращает: True, если картинки пересекаются.
</li><li>Использование: Это продвинутый вариант предыдущей функции. Подходит лучше для не объектно-ориентированного программирования или когда мы работаем с небольшим количеством объектов.
</li><li>Особенности: Мы можем задать поворот и размер каждой картинке индивидуально.
</li></ul>
</li></ul>
<p>Теперь о работе со слоями. Есть 32 слоя для определения столкновений. Слои представлены масками, поэтому задавать их надо соответственно. Хотя для облегчения работы с ними есть константы, эти маски задающие. Формат их таков: COLLISION_LAYER_ххх, где ххх - число от 1 до 32 или слово &lt;ALL&gt;, обозначающее все слои сразу. Мы можем записывать и считывать в слои информацию о столкновениях. Другими словами, посылать и получать данные о столкновениях. Алгоритм работы такой: сначала мы очищаем нужные слои. Потом во время прохода по игровым объектам записываем и (или) считываем информацию о столкновениях. Получив данные столкновения, мы можем вызвать у объектов столкновения соответствующие методы. Объекты можно распределить по трем группам: только отсылающие данные о себе, принимающие данные о столкновении с другими объектами, и смешанные - принимающие и отсылающие данные столкновений. Тут такой нюанс: если мы не знаем четкого порядка обработки объектов, то мы должны делать и отсылку и прием данных. На примере: если объект(ы) только принимает столкновения и обработался первым, то он не получит данных от остальных объектов, которые только отсылают данные столкновения.
</p><p>Используемые функции:
</p>
<ul><li>ResetCollisions ( mask%=0 )
<ul><li>mask - маска слоев для очистки, по умолчанию - все слои. Маска задаются в виде комбинации следующих величин: COLLISION_LAYER_ALL, COLLISION_LAYER_1&nbsp;: COLLISION_LAYER_32.
</li><li>Использование: Служит для очистки слоев коллизий. Используется в начале цикла обработки столкновений.
</li><li>Примеры:
<ul><li>ResetCollisions - очищает все слои
</li><li>ResetCollisions ( COLLISION_LAYER_ALL ) - очищает все слои
</li><li>ResetCollisions ( COLLISION_LAYER_1 ) - очищает слой 1
</li><li>ResetCollisions ( COLLISION_LAYER_1 | COLLISION_LAYER_2 ) - очищает слой 1 и 2
</li></ul>
</li></ul>
</li><li>CollideImage:Object[]( image:TImage,x,y,frame,collidemask%,writemask%,id:Object=Null )
<ul><li>image - наша картинка
</li><li>x,y,frame - ее координаты и кадр
</li><li>collidemask - маска для слоев, где будем проверять коллизии (прием)
</li><li>writemask - маска для слоев, куда будем рисовать картинку (отсылка)
</li><li>id - ссылка на наш объект, который будет сохраняться для последующей обработки.
</li><li>Возвращает: массив базовых объектов Object[] с которыми столкнулась картинка. Если столкновений нет, то возвращается NULL.
</li><li>Описание: функция тестирует на пересечение текущую картинку с другими в слоях, заданных collidemask и сохраняет ее данные в слоях, заданных writemask. Пи сохранении данных в слое, они накапливаются и его надо очищать перед новым циклом обработки. Для этого и используется ResetCollisions.
</li><li>Использование: благодаря возвращаемому значению и параметру id, используется при объектно-ориентированном программировании (ООП).
</li><li>Особенности: Для отрисовки в слои коллизий используются текущие установки поворота и размера, поэтому удобно использовать функцию в методе отрисовки объекта. При использовании 0 (COLLISION_LAYER_ALL) в качестве параметра маски слоя, происходит игнорирование операции. Т.е. если мы выставим collidemask = 0, то будет производиться только запись в слои по writemask.
</li></ul>
</li><li>CollideRect:Object[](x,y,w,h,collidemask%,writemask%,id:Object=Null) - эта функция полностью аналогична предыдущей с той только разницей, что для определения столкновения задается не картинка, а прямоугольник.
</li></ul>
<a name=".D0.9F.D1.80.D0.B8.D0.BC.D0.B5.D1.80.D1.8B"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%9A%D0%BE%D0%BB%D0%BB%D0%B8%D0%B7%D0%B8%D0%B8_%D0%B8%D0%BB%D0%B8_%D1%81%D1%82%D0%BE%D0%BB%D0%BA%D0%BD%D0%BE%D0%B2%D0%B5%D0%BD%D0%B8%D1%8F_%D0%BF%D0%BE_%D0%BD%D0%B0%D1%88%D0%B5%D0%BC%D1%83&amp;action=edit&amp;section=2" title="Править секцию: Примеры">править</a>]</span> <span class="mw-headline">Примеры</span></h2>
<ul><li>Простейшее определение коллизии двух объектов:
</li></ul>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #B1E7EB;">'сбрасываем угол поворота и размеры (если надо)</span><br />
<p><span style="color: #ffff00; font-weight: bold;">SetRotation</span> <span style="color: #FFFFFF;">0</span><br />
<span style="color: #ffff00; font-weight: bold;">SetScale</span> <span style="color: #FFFFFF;">1</span>, <span style="color: #FFFFFF;">1</span><br />
<span style="color: #B1E7EB;">'определяем коллизию</span><br />
<span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">ImagesCollide</span><span style=" ">&#40;</span>BulletImage, BulletX, BulletY, BulletFrame, EnemyImage, EnemyX, EnemyY, EnemyFrame <span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span><br />
... <span style="color: #B1E7EB;">'делаем доброе дело</span><br />
</p>
<span style="color: #ffff00; font-weight: bold;">EndIf</span></div>
<p>Или так:
</p>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #B1E7EB;">'определяем коллизию</span><br />
<p><span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">ImagesCollide2</span><span style=" ">&#40;</span>BulletImage, BulletX, BulletY, BulletFrame, BulletAngle, &nbsp;BulletScaleX,..<br />
&nbsp;<span style="">BulletScaleY</span>, EnemyImage, EnemyX, EnemyY, EnemyFrame, EnemyAngle, &nbsp;EnemyScaleX, EnemyScaleY<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Then</span><br />
... <span style="color: #B1E7EB;">'делаем доброе дело</span><br />
</p>
<span style="color: #ffff00; font-weight: bold;">EndIf</span></div>
<ul><li>Отложенное определение коллизий с ООП:
</li></ul>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #B1E7EB;">'начало цикла</span><br />
<p><span style="color: #ffff00; font-weight: bold;">ResetCollisions</span> <span style="color: #B1E7EB;">'очищаем слои коллизий</span><br />
... <span style="color: #B1E7EB;">'что-нибудь делаем</span><br />
<span style="color: #ffff00; font-weight: bold;">For</span> i=<span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">To</span> Enemyes.<span style="">Count</span><span style="color: #FFFFFF;">-1</span> <span style="color: #B1E7EB;">'цикл отрисовки врагов</span><br />
<span style="color: #ffff00; font-weight: bold;">SetScale</span> EnemyScaleX, EnemyScaleY <span style="color: #B1E7EB;">'размер</span><br />
<span style="color: #ffff00; font-weight: bold;">SetRotation</span> EnemyAngle <span style="color: #B1E7EB;">'угол поворота</span><br />
<span style="color: #B1E7EB;">'рисуем супостата в соответсвии с его местом и текущим кадровым положением</span><br />
<span style="color: #ffff00; font-weight: bold;">DrawImage</span><span style=" ">&#40;</span> Enemy<span style=" ">&#91;</span>i<span style=" ">&#93;</span>.<span style="">Image</span>, Enemy<span style=" ">&#91;</span>i<span style=" ">&#93;</span>.<span style="">X</span>, Enemy<span style=" ">&#91;</span>i<span style=" ">&#93;</span>.<span style="">Y</span>, Enemy<span style=" ">&#91;</span>i<span style=" ">&#93;</span>.<span style="">Frame</span> <span style=" ">&#41;</span><br />
<br />
<span style="color: #B1E7EB;">'сохраяем картинку противника в коллизионном слое 1</span><br />
<span style="color: #B1E7EB;">'и сохраняем на него ссылку</span><br />
<span style="color: #ffff00; font-weight: bold;">CollideImage</span><span style=" ">&#40;</span> EnemyImage, EnemyX, EnemyY, EnemyFrame, <span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">1</span>, Enemy<span style=" ">&#91;</span>i<span style=" ">&#93;</span> <span style=" ">&#41;</span><br />
<span style="color: #ffff00; font-weight: bold;">Next</span><br />
... <span style="color: #B1E7EB;">'что-нибудь делаем</span><br />
<span style="color: #B1E7EB;">'получаем массив врагов из слоя №1 с которыми столкнулась пуля</span><br />
<span style="color: #ffff00; font-weight: bold;">Local</span> obj<span style=" ">&#91;</span><span style=" ">&#93;</span> = <span style="color: #ffff00; font-weight: bold;">CollideImage</span> <span style=" ">&#40;</span>BulletImage, BulletX, BulletY, BulletFrame, <span style="color: #FFFFFF;">1</span>, <span style="color: #FFFFFF;">0</span><span style=" ">&#41;</span><br />
<span style="color: #B1E7EB;">'проверяем не пуст ли массив - а было ли столкновение</span><br />
<span style="color: #ffff00; font-weight: bold;">If</span> obj<br />
&nbsp; &nbsp;<span style="color: #B1E7EB;">'проходим по полученному массиву</span><br />
<span style="color: #ffff00; font-weight: bold;">For</span> <span style="color: #ffff00; font-weight: bold;">Local</span> i%=<span style="color: #FFFFFF;">0</span> <span style="color: #ffff00; font-weight: bold;">To</span> obj.<span style="">length</span><span style="color: #FFFFFF;">-1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #ffff00; font-weight: bold;">Local</span> e: TEnemy = TEnemy<span style=" ">&#40;</span>obj<span style=" ">&#91;</span>i<span style=" ">&#93;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">'получаем врага, используя приведение типов</span><br />
<span style="color: #ffff00; font-weight: bold;">If</span> e <span style="color: #ffff00; font-weight: bold;">Then</span> e.<span style="">Kick</span><span style=" ">&#40;</span>BulletPower<span style=" ">&#41;</span> <span style="color: #B1E7EB;">'если это враг, а не кто-то другой, бьем его</span><br />
&nbsp; &nbsp;<span style="color: #ffff00; font-weight: bold;">Next</span><br />
&nbsp; &nbsp;DestroyBullet<span style=" ">&#40;</span><span style=" ">&#41;</span> <span style="color: #B1E7EB;">'пуля сделала свое дело - она должна исчезнуть</span><br />
</p>
<span style="color: #ffff00; font-weight: bold;">EndIf</span></div>
<p><a href="http://blitzmax.3dn.ru/publ/3-1-0-6" class="external text" title="http://blitzmax.3dn.ru/publ/3-1-0-6" rel="nofollow">оригинал главы</a><br />
<a href="http://blitzmax.3dn.ru/publ/3-1-0-6#comments" class="external text" title="http://blitzmax.3dn.ru/publ/3-1-0-6#comments" rel="nofollow">комментарии на сайте автора</a>
</p>
<a name=".D0.91.D0.B0.D0.B3.D0.B8"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%9A%D0%BE%D0%BB%D0%BB%D0%B8%D0%B7%D0%B8%D0%B8_%D0%B8%D0%BB%D0%B8_%D1%81%D1%82%D0%BE%D0%BB%D0%BA%D0%BD%D0%BE%D0%B2%D0%B5%D0%BD%D0%B8%D1%8F_%D0%BF%D0%BE_%D0%BD%D0%B0%D1%88%D0%B5%D0%BC%D1%83&amp;action=edit&amp;section=3" title="Править секцию: Баги">править</a>]</span> <span class="mw-headline">Баги</span></h2>
<p>Куда ж без них-то. Сколько пишут, а все никак не поисправлют. Хотя это еще ничего в сравнении с некоторыми (GarageGames). Но об этом в другой раз. Вот код:
</p>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #B1E7EB;">Rem<br />
<p>Collision Test<br />
EndRem</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Strict</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Import</span> birdie.<span style="">pixmaptools</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Graphics</span> <span style="color: #FFFFFF;">800</span> , <span style="color: #FFFFFF;">600</span>, <span style="color: #FFFFFF;">0</span>, <span style="color: #FFFFFF;">50</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Global</span> gbLayerCollision = <span style="color: #ffff00; font-weight: bold;">False</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> gbImagesCollide = <span style="color: #ffff00; font-weight: bold;">False</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> gbImagesCollide2 = <span style="color: #ffff00; font-weight: bold;">False</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> gbCollideRect = <span style="color: #ffff00; font-weight: bold;">False</span><br />
&nbsp;<br />
<br />
<span style="color: #ffff00; font-weight: bold;">AutoMidHandle</span> <span style="color: #ffff00; font-weight: bold;">True</span><br />
<span style="color: #ffff00; font-weight: bold;">Local</span> im1:TImage = <span style="color: #ffff00; font-weight: bold;">CreateImage</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">40</span>,<span style="color: #FFFFFF;">40</span><span style=" ">&#41;</span><br />
<span style="color: #ffff00; font-weight: bold;">Local</span> pm:<span style="color: #ffff00; font-weight: bold;">TPixmap</span> = <span style="color: #ffff00; font-weight: bold;">CreatePixmap</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">40</span>,<span style="color: #FFFFFF;">40</span>,PF_RGBA8888<span style=" ">&#41;</span><br />
PixmapRect<span style=" ">&#40;</span> pm , <span style="color: #FFFFFF;">0</span>,<span style="color: #FFFFFF;">0</span>, pm.<span style="">width</span>,pm.<span style="">height</span>, $FFFFFF00<span style=" ">&#41;</span><br />
im1.<span style="">SetPixmap</span><span style=" ">&#40;</span> <span style="color: #FFFFFF;">0</span>, pm.<span style="">Copy</span><span style=" ">&#40;</span><span style=" ">&#41;</span> <span style=" ">&#41;</span><br />
<span style="color: #B1E7EB;">'SetImageHandle(im1,10,50)</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Type</span> TEntity<br />
&nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> img:TImage<br />
&nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> x#, y#<br />
&nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Field</span> rotation#<br />
&nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Method</span> Draw<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetRotation</span> rotation<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetColor</span> <span style="color: #FFFFFF;">255</span>,<span style="color: #FFFFFF;">255</span>,<span style="color: #FFFFFF;">255</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawImage</span><span style=" ">&#40;</span>img,x,y<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetColor</span> <span style="color: #FFFFFF;">255</span>,<span style="color: #FFFFFF;">0</span>,<span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">DrawOval</span><span style=" ">&#40;</span>x,y,<span style="color: #FFFFFF;">4</span>,<span style="color: #FFFFFF;">4</span><span style=" ">&#41;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">Self</span> = e2<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">'send collisions</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">CollideImage</span><span style=" ">&#40;</span>img,x,y,<span style="color: #FFFFFF;">0</span>,<span style="color: #FFFFFF;">0</span>,COLLISION_LAYER_1,<span style="color: #ffff00; font-weight: bold;">Self</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">CollideRect</span><span style=" ">&#40;</span>x,y,img.<span style="">width</span>, img.<span style="">height</span>, <span style="color: #FFFFFF;">0</span>,COLLISION_LAYER_2,<span style="color: #ffff00; font-weight: bold;">Self</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Else</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">'responce collisions</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gbLayerCollision=<span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">CollideImage</span><span style=" ">&#40;</span>img,x,y,<span style="color: #FFFFFF;">0</span>,COLLISION_LAYER_1,<span style="color: #FFFFFF;">0</span>,<span style="color: #ffff00; font-weight: bold;">Self</span><span style=" ">&#41;</span>&lt;&gt;Null<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gbCollideRect=<span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">CollideRect</span><span style=" ">&#40;</span>x,y,img.<span style="">width</span>, img.<span style="">height</span>, COLLISION_LAYER_2,<span style="color: #FFFFFF;">0</span>,<span style="color: #ffff00; font-weight: bold;">Self</span><span style=" ">&#41;</span>&lt;&gt;Null<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">If</span><br />
<br />
&nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Method</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Type</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Global</span> e1:TEntity = <span style="color: #ffff00; font-weight: bold;">New</span> TEntity<br />
e1.<span style="">img</span> = im1<br />
e1.<span style="">y</span> = <span style="color: #FFFFFF;">300</span><br />
e1.<span style="">x</span> = <span style="color: #FFFFFF;">450</span><br />
e1.<span style="">rotation</span> = <span style="color: #FFFFFF;">45</span><br />
<span style="color: #ffff00; font-weight: bold;">Global</span> e2:TEntity = <span style="color: #ffff00; font-weight: bold;">New</span> TEntity<br />
e2.<span style="">img</span> = im1<br />
e2.<span style="">y</span> = <span style="color: #FFFFFF;">300</span><br />
e2.<span style="">x</span> = <span style="color: #FFFFFF;">350</span><br />
e2.<span style="">rotation</span> = <span style="color: #FFFFFF;">0</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">While</span> <span style="color: #ffff00; font-weight: bold;">Not</span> <span style=" ">&#40;</span><span style="color: #ffff00; font-weight: bold;">KeyHit</span><span style=" ">&#40;</span>key_escape<span style=" ">&#41;</span> <span style="color: #ffff00; font-weight: bold;">Or</span> <span style="color: #ffff00; font-weight: bold;">AppTerminate</span><span style=" ">&#40;</span><span style=" ">&#41;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; Update<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; Draw<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
<span style="color: #ffff00; font-weight: bold;">Wend</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Function</span> Update<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">KeyDown</span><span style=" ">&#40;</span> KEY_LEFT <span style=" ">&#41;</span><span style="color: #ffff00; font-weight: bold;">Then</span> e1.<span style="">x</span>:<span style="color: #FFFFFF;">-1</span><br />
&nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">KeyDown</span><span style=" ">&#40;</span> KEY_RIGHT <span style=" ">&#41;</span><span style="color: #ffff00; font-weight: bold;">Then</span> e1.<span style="">x</span>:<span style="color: #FFFFFF;">+1</span><br />
&nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">KeyDown</span><span style=" ">&#40;</span> KEY_UP <span style=" ">&#41;</span><span style="color: #ffff00; font-weight: bold;">Then</span> e1.<span style="">y</span>:<span style="color: #FFFFFF;">-1</span><br />
&nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> <span style="color: #ffff00; font-weight: bold;">KeyDown</span><span style=" ">&#40;</span> KEY_DOWN <span style=" ">&#41;</span><span style="color: #ffff00; font-weight: bold;">Then</span> e1.<span style="">y</span>:<span style="color: #FFFFFF;">+1</span><br />
<br />
&nbsp; &nbsp; &nbsp; gbImagesCollide = <span style="color: #ffff00; font-weight: bold;">ImagesCollide</span><span style=" ">&#40;</span>e1.<span style="">img</span>,e1.<span style="">x</span>,e1.<span style="">y</span>,<span style="color: #FFFFFF;">0</span>, e2.<span style="">img</span>,e2.<span style="">x</span>,e2.<span style="">y</span>,<span style="color: #FFFFFF;">0</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; gbImagesCollide2 = <span style="color: #ffff00; font-weight: bold;">ImagesCollide2</span><span style=" ">&#40;</span>e1.<span style="">img</span>,e1.<span style="">x</span>,e1.<span style="">y</span>,<span style="color: #FFFFFF;">0</span>,e1.<span style="">rotation</span>,<span style="color: #FFFFFF;">1</span>,<span style="color: #FFFFFF;">1</span>, e2.<span style="">img</span>,e2.<span style="">x</span>,e2.<span style="">y</span>,<span style="color: #FFFFFF;">0</span>,e2.<span style="">rotation</span>,<span style="color: #FFFFFF;">1</span>,<span style="color: #FFFFFF;">1</span><span style=" ">&#41;</span><br />
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span><br />
<br />
<span style="color: #ffff00; font-weight: bold;">Function</span> Draw<span style=" ">&#40;</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Cls</span><br />
&nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">ResetCollisions</span><br />
&nbsp; &nbsp; &nbsp; e2.<span style="">Draw</span><br />
&nbsp; &nbsp; &nbsp; e1.<span style="">Draw</span><br />
&nbsp; &nbsp; &nbsp; <span style="color: #B1E7EB;">'info</span><br />
&nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetRotation</span> <span style="color: #FFFFFF;">0</span><br />
&nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">SetColor</span> <span style="color: #FFFFFF;">255</span>,<span style="color: #FFFFFF;">255</span>,<span style="color: #FFFFFF;">255</span><br />
&nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> gbImagesCollide <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #ffff00; font-weight: bold;">DrawText</span> <span style="color: #00FF66;">&quot;ImagesCollide&quot;</span>,<span style="color: #FFFFFF;">8</span>,<span style="color: #FFFFFF;">8</span><br />
&nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> gbLayerCollision <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #ffff00; font-weight: bold;">DrawText</span> <span style="color: #00FF66;">&quot;CollideImage (Layers collision)&quot;</span>,<span style="color: #FFFFFF;">8</span>,<span style="color: #FFFFFF;">28</span><br />
&nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> gbImagesCollide2 <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #ffff00; font-weight: bold;">DrawText</span> <span style="color: #00FF66;">&quot;ImagesCollide2&quot;</span>,<span style="color: #FFFFFF;">8</span>,<span style="color: #FFFFFF;">48</span><br />
&nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">If</span> gbCollideRect <span style="color: #ffff00; font-weight: bold;">Then</span> <span style="color: #ffff00; font-weight: bold;">DrawText</span> <span style="color: #00FF66;">&quot;CollideRect&quot;</span>,<span style="color: #FFFFFF;">8</span>,<span style="color: #FFFFFF;">68</span><br />
&nbsp; &nbsp; &nbsp; <span style="color: #ffff00; font-weight: bold;">Flip</span><span style=" ">&#40;</span><span style="color: #FFFFFF;">-1</span><span style=" ">&#41;</span><br />
</p>
<span style="color: #ffff00; font-weight: bold;">End</span> <span style="color: #ffff00; font-weight: bold;">Function</span></div>
<p>Кратко суть: определение коллизий глючит при использовании отрисовки с изменением хэндла картинки (AutoMidHandle(True) и SetImageHandle). С поворотами тоже наблюдаются странности.
</p><p>Как проверить? - очень просто! Запускаем код и жмем курсор влево. Правый квадратик, который повернут (ромбик) начинает двигаться влево и не доезжая до цели срабатывает коллизия по CollideRect. А не должна. Ну в общем, поиграйтесь с поворотами (e1.rotation, e1.rotation), хэндлами (AutoMidHandle, SetImageHandle), если есть желание, а я уже наигрался. На ImagesCollide можно особо не смотреть - она без учета поворотов и прочего. Попробуйте найти ошибки в коде. А кому не интересно - читайте сразу советы.
</p>
<a name=".D0.A1.D0.BE.D0.B2.D0.B5.D1.82.D1.8B"></a><h2><span class="editsection">[<a href="http://blitzetcetera.org/index.php?title=%D0%9A%D0%BE%D0%BB%D0%BB%D0%B8%D0%B7%D0%B8%D0%B8_%D0%B8%D0%BB%D0%B8_%D1%81%D1%82%D0%BE%D0%BB%D0%BA%D0%BD%D0%BE%D0%B2%D0%B5%D0%BD%D0%B8%D1%8F_%D0%BF%D0%BE_%D0%BD%D0%B0%D1%88%D0%B5%D0%BC%D1%83&amp;action=edit&amp;section=4" title="Править секцию: Советы">править</a>]</span> <span class="mw-headline">Советы</span></h2>
<p>Из-за того, что функции для непосредственного определения столкновений (ImagesCollide и ImagesCollide2) используют 32-й слой, то мы должны будем ограничиться остальными слоями, не трогая 32, если будем применять их в работе.
</p><p>Попиксельное определение столкновений, достаточно ресурсоемкий процесс и надо оптимизировать работу по приему-отсылке данных столкновений. Сделать сортировку обработки объектов по отношению к приему-передаче данных столкновения. Так объекты, отсылающие данные, должны обрабатываться сначала, а потом - объекты, принимающие столкновения. Это позволит избежать дополнительных перекрестных проверок на столкновения у всех объектов, участвующих в группе столкновения и сэкономить ресурсы. И, следовательно, повысить быстродействие свого кода.
</p><p>При работе с CollideRect и CollideImage, можно одновременно и записывать и считывать данные столкновений. Как показала практика, этого лучше не делать - быстродействие получается заметно ниже, чем при использовании отдельно двух команд: одну для записи, другую для считывания. Т.е. не
</p>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #ffff00; font-weight: bold;">CollideRect</span><span style=" ">&#40;</span>x,y,width,height, COLLISION_LAYER_1, COLLISION_LAYER_2, <span style="color: #ffff00; font-weight: bold;">self</span><span style=" ">&#41;</span>,</div>
<p>а вот так:
</p>
<div class="bmx" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#01516B;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #ffff00; font-weight: bold;">CollideRect</span><span style=" ">&#40;</span>x,y,width,height, <span style="color: #FFFFFF;">0</span>, COLLISION_LAYER_2, <span style="color: #ffff00; font-weight: bold;">self</span><span style=" ">&#41;</span><br />
CollidedObjects = <span style="color: #ffff00; font-weight: bold;">CollideRect</span><span style=" ">&#40;</span>x,y,width,height, COLLISION_LAYER_1, <span style="color: #FFFFFF;">0</span><span style=" ">&#41;</span></div>
<p>При работе с функциями определения столкновений, наблюдаются неточности: если изменять хэндл (центрирование) картинки (AutoMidHandle, SetImageHandle) и вращать саму картинку. Наиболее точные функции: CollideImage и ImagesCollide2. Соответственно рекомендуется: не использовать CollideRect и ImagesCollide; вращение делать с помощью спрайтов, а не команды SetRotation; осторожнее быть с центрированием картинок при определении столкновений; использовать сторонние либы (я их не знаю, но, думаю, они есть). Хотя в большинстве стандартных проектов эти ошибки не встретятся. Я вот юзал CollideImage и все было хорошо. Решил тестик написать - и жуки полезли.
</p><p><a href="http://blitzmax.3dn.ru/publ/3-1-0-7" class="external text" title="http://blitzmax.3dn.ru/publ/3-1-0-7" rel="nofollow">оригинал главы</a><br />
<a href="http://blitzmax.3dn.ru/publ/3-1-0-7#comments" class="external text" title="http://blitzmax.3dn.ru/publ/3-1-0-7#comments" rel="nofollow">комментарии на сайте автора</a>
</p>
<hr />
<p>Автор: Oxid
</p>
<!-- Saved in parser cache with key db1:pcache:idhash:735-0!1!0!!ru!2 and timestamp 20071110033030 -->
<div class="printfooter">
Получено с <a href="-v9dzda3.html">http://blitzetcetera.org/index.php/%D0%9A%D0%BE%D0%BB%D0%BB%D0%B8%D0%B7%D0%B8%D0%B8_%D0%B8%D0%BB%D0%B8_%D1%81%D1%82%D0%BE%D0%BB%D0%BA%D0%BD%D0%BE%D0%B2%D0%B5%D0%BD%D0%B8%D1%8F_%D0%BF%D0%BE_%D0%BD%D0%B0%D1%88%D0%B5%D0%BC%D1%83</a></div>
			<!-- end content -->			<div class="visualClear"></div>				</td>				<td class="rightside">				</td>			</tr>		</table>		</div>	</div>		</div>	
		<script type="text/javascript">if (window.runOnloadHook) runOnloadHook();</script>
</div></body>
<!-- Mirrored from localhost/index.php/%D0%9A%D0%BE%D0%BB%D0%BB%D0%B8%D0%B7%D0%B8%D0%B8_%D0%B8%D0%BB%D0%B8_%D1%81%D1%82%D0%BE%D0%BB%D0%BA%D0%BD%D0%BE%D0%B2%D0%B5%D0%BD%D0%B8%D1%8F_%D0%BF%D0%BE_%D0%BD%D0%B0%D1%88%D0%B5%D0%BC%D1%83 by HTTrack Website Copier/3.x [XR&CO'2007], Sat, 10 Nov 2007 05:15:50 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8"><!-- /Added by HTTrack -->
</html>