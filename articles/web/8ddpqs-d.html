<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ru" lang="ru" dir="ltr">	
<!-- Mirrored from localhost/index.php/%D0%A0%D0%B0%D0%B1%D0%BE%D1%82%D0%B0_%D1%81_%D0%A1%D0%B5%D1%82%D1%8C%D1%8E_%D0%B2_Blitz3D:_TCP by HTTrack Website Copier/3.x [XR&CO'2007], Sat, 10 Nov 2007 05:16:44 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8"><!-- /Added by HTTrack -->
<head>		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />				<meta name="keywords" content="Работа с Сетью в Blitz3D: TCP,Tadeus" />
		<link rel="shortcut icon" href="http://blitzetcetera.org/favicon.ico" />
		<link rel="search" type="application/opensearchdescription+xml" href="http://blitzetcetera.org/opensearch_desc.php" title="Blitz Et Cetera (Русский)" />
		<title>Работа с Сетью в Blitz3D: TCP — Blitz Et Cetera</title>		<style type="text/css" media="screen,projection">/*<![CDATA[*/ @import "bvih5rde.css?63"; /*]]>*/</style>		<link rel="stylesheet" type="text/css" media="print" href="gcxktlm6.css?63" />		<link rel="stylesheet" type="text/css" media="handheld" href="zumsslq_.css?63" />		<!--[if lt IE 5.5000]><style type="text/css">@import "/skins/OfflineNew/IE50Fixes.css?63";</style><![endif]-->		<!--[if IE 5.5000]><style type="text/css">@import "/skins/OfflineNew/IE55Fixes.css?63";</style><![endif]-->		<!--[if IE 6]><style type="text/css">@import "/skins/OfflineNew/IE60Fixes.css?63";</style><![endif]-->		<!--[if IE 7]><style type="text/css">@import "/skins/OfflineNew/IE70Fixes.css?63";</style><![endif]-->		<!--[if lt IE 7]><script type="text/javascript" src="/skins/common/IEFixes.js?63"></script>		<meta http-equiv="imagetoolbar" content="no" /><![endif]-->		<script type= "text/javascript">/*<![CDATA[*/
var skin = "OfflineNew";
var stylepath = "/skins";
var wgArticlePath = "/index.php/$1";
var wgScriptPath = "";
var wgServer = "http://blitzetcetera.org/";
var wgCanonicalNamespace = "";
var wgCanonicalSpecialPageName = false;
var wgNamespaceNumber = 0;
var wgPageName = "Работа_с_Сетью_в_Blitz3D:_TCP";
var wgTitle = "Работа с Сетью в Blitz3D: TCP";
var wgAction = "view";
var wgArticleId = "1739";
var wgIsArticle = true;
var wgUserName = null;
var wgUserGroups = null;
var wgUserLanguage = "ru";
var wgContentLanguage = "ru";
var wgBreakFrames = false;
var wgCurRevisionId = "3256";
/*]]>*/</script>
		<script type="text/javascript" src="2nq-6cel.js?63"><!-- wikibits js --></script>		<script type="text/javascript" src="http://blitzetcetera.org/index.php?title=-&amp;action=raw&amp;gen=js"><!-- site js --></script>		<style type="text/css">/*<![CDATA[*/
@import "http://blitzetcetera.org/index.php?title=MediaWiki:Common.css&amp;usemsgcache=yes&amp;action=raw&amp;ctype=text/css&amp;smaxage=18000";
@import "http://blitzetcetera.org/index.php?title=MediaWiki:OfflineNew.css&amp;usemsgcache=yes&amp;action=raw&amp;ctype=text/css&amp;smaxage=18000";
@import "http://blitzetcetera.org/index.php?title=-&amp;action=raw&amp;gen=css&amp;maxage=18000";
/*]]>*/</style>		<!-- Head Scripts -->	</head><body  class="mediawiki ns-0 ltr page-Работа_с_Сетью_в_Blitz3D_TCP">	<div id="globalWrapper">	<div id="logocontainer">		<table align="center">		  <tr>				<td id="blitzetclogo">				</td>			</tr>		</table>	</div>	<div id="magbar">	Журнал о программированнии на языках Blitz3D, BlitzMax, BlitzPlus	</div>		<div id="column-content">	<div id="content">		<a name="top" id="top"></a>				<div id="bodyContent">		<table cellspacing=0 cellpadding=0 width=100%>			<tr>			  <td class="leftside">				</td>				<td class="sheetbody">					<h1 class="sheet">Работа с Сетью в Blitz3D: TCP</h1>			<h3 id="siteSub">Материал из Blitz Et Cetera.</h3>			<div id="contentSub"></div>			<!-- start content -->			<p>Итак, вы решили изучить основу многих протоколов высшего уровня, то бишь ТСР? Хорошо! Чем он хорош? Гарантией того, что сообщение придет в целости и сохранности. Однако, в результате этого мы теряем скорость. Целеобразно использовать ТСР там, где надежность важнее скорости. В ином случае - используйте UDP(я уже написал туториал по нему - почитайте).
</p><p>Начнем, пожалуй, с пары нюансов. Во-первых, ТСР использует архитектуру "клиент-сервер", что облегчает нам жизнь, и на нужно знать IP-адресс только сервера. Всмысле, сначала. Во-вторых, тут насчет портов такой же принцип как и в UDP.
Порты до 1024 являются системными и использовать их в сетевых играх не стоит. Также следует поберечься от портов с номерами от 1024 до 49151 - они зарезервированны. Рекомендуется использовать порты с номерами от 49152 до 65535 - они динамические. В отличие от UDP, в ТСР вам надо сразу определится с портом, ибо тут нет таких вольностей, как "обнаружение свободных портов". 
</p><p>Рассмотрев моменты, приступим к рассмотру команд. Итак, так как в ТСР архитектура "клиент-сервер", значит у нас имеется две команды инициализации сеанса: для сервера и для клиента. Для начала давайте разберемся с сервером.
</p>
<div class="bb" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#225588;color:#FFFFFF;border:1px solid #003040;padding:10px;">поток_сервера=<span style="color: #aaffff; font-weight: bold;">CreateTCPServer</span><span style=" ">&#40;</span>порт<span style=" ">&#41;</span></div>
<p>Создает сервер потока ТСР на указанный порт и возвращает хэндл потока сервера. Возвращает 0, если неудачно, поток - если удачно. Про порты уже говорилось выше. Далее, для сервера, чтобы получать и писать сообщение, надо принимать входящий поток. Делается это коммандой AcceptTCPStream вот так:
</p>
<div class="bb" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#225588;color:#FFFFFF;border:1px solid #003040;padding:10px;">поток=<span style="color: #aaffff; font-weight: bold;">AcceptTCPStream</span><span style=" ">&#40;</span>поток_сервера<span style=" ">&#41;</span></div>
<p>Думаю, в примере это будет смотрется понятнее:
</p>
<div class="bb" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#225588;color:#FFFFFF;border:1px solid #003040;padding:10px;">svr=<span style="color: #aaffff; font-weight: bold;">CreateTCPServer</span><span style=" ">&#40;</span><span style="color: #33ffdd;">80</span><span style=" ">&#41;</span><br />
<p><span style="color: #aaffff; font-weight: bold;">While</span> <span style="color: #aaffff; font-weight: bold;">Not</span> <span style="color: #aaffff; font-weight: bold;">KeyHit</span><span style=" ">&#40;</span><span style="color: #33ffdd;">1</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; pot=<span style="color: #aaffff; font-weight: bold;">AcceptTCPStream</span><span style=" ">&#40;</span>svr<span style=" ">&#41;</span><br />
</p>
<span style="color: #aaffff; font-weight: bold;">Wend</span></div>
<p>Таким образом, мы создали сервер на порте 80. К слову, если вы на блице пишете программу для работы с сетью (броузер, почтовый клиент и т.д.), то вы конечно же можете использовать системные порты - они для того и предназначены. Однако, если вы создаете игру - берите динамический и только. Вернемся к коду. Мы каждый цикл пытаемся принять входящий поток, чтобы в цикле можно было соответственно читать и посылать информацию. Чтобы получить IP-адресс пославшего, используем функцию TCPStreamIP. Синтаксис:
</p>
<div class="bb" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#225588;color:#FFFFFF;border:1px solid #003040;padding:10px;">переменная=<span style="color: #aaffff; font-weight: bold;">TCPStreamIP</span><span style=" ">&#40;</span>поток<span style=" ">&#41;</span></div>
<p>Возвращает целочисленный IP в переменную. Если вам надо получить точечный IP - смотрите в справке DottedIP$()
</p><p>Также можно получить порт машины клиента функцией TCPStreamPort:
</p>
<div class="bb" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#225588;color:#FFFFFF;border:1px solid #003040;padding:10px;">переменная=<span style="color: #aaffff; font-weight: bold;">TCPStreamPort</span><span style=" ">&#40;</span>поток<span style=" ">&#41;</span></div>
<p>Обьяснять, думаю не надо?
</p><p>Теперь о передаче информации. А как же эта информация собственно посылается и получается? Очень просто! Вы, я думаю, уже работали с файлами, не так ли? Так вот, представьте, что ТСР-поток - это ваш файл и просто используйте команды для чтения в или из потока. Правда, с чтением есть еще один нюанс - надо проверять, пришла ли какая-то информация. Это очень просто! AcceptTCPStream возвращает 0, если ничего не пришло и поток для того, кто послал сообщение, если оно, собсно, было посланно. И нужно учесть еще вот что - человек мог сделать запрос вот таким:
</p>
<div class="bb" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#225588;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #aaffff; font-weight: bold;">WriteLine</span> pot,<span style="color: #00ff66;">&quot;1&quot;</span><br />
<p><span style="color: #aaffff; font-weight: bold;">WriteLine</span> pot,<span style="color: #00ff66;">&quot;2&quot;</span><br />
</p>
<span style="color: #aaffff; font-weight: bold;">WriteLine</span> pot,<span style="color: #00ff66;">&quot;3&quot;</span></div>
<p>Как его считать? Опять таки, очень просто! С помощью, думаю, знакомой вам функции Eof:
</p>
<div class="bb" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#225588;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #aaffff; font-weight: bold;">Eof</span><span style=" ">&#40;</span>поток<span style=" ">&#41;</span></div>
<p>Возвращает False если информация в потоке еще не закончилась и True, если вся уже пришла и считана. Вот как это:
</p>
<div class="bb" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#225588;color:#FFFFFF;border:1px solid #003040;padding:10px;">svr=<span style="color: #aaffff; font-weight: bold;">CreateTCPServer</span><span style=" ">&#40;</span><span style="color: #33ffdd;">50000</span><span style=" ">&#41;</span><br />
<p><span style="color: #aaffff; font-weight: bold;">While</span> <span style="color: #aaffff; font-weight: bold;">Not</span> <span style="color: #aaffff; font-weight: bold;">KeyHit</span><span style=" ">&#40;</span><span style="color: #33ffdd;">1</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; pot=<span style="color: #aaffff; font-weight: bold;">AcceptTCPStream</span><span style=" ">&#40;</span>svr<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">If</span> pot <span style="color: #aaffff; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">While</span> <span style="color: #aaffff; font-weight: bold;">Not</span> <span style="color: #aaffff; font-weight: bold;">Eof</span><span style=" ">&#40;</span>pot<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Print</span> <span style="color: #aaffff; font-weight: bold;">Readline</span>$<span style=" ">&#40;</span>pot<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Wend</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Endif</span><br />
</p>
<span style="color: #aaffff; font-weight: bold;">Wend</span></div>
<p>Чтобы написать игроку, нужно писать именно на уникальный поток. Сейчас я вам покажу, как собсно получить этот поток:
</p>
<div class="bb" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#225588;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #aaffff; font-weight: bold;">Type</span> Player<br />
<p>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Field</span> &nbsp;stream<br />
<span style="color: #aaffff; font-weight: bold;">End Type</span><br />
<br />
svr=<span style="color: #aaffff; font-weight: bold;">CreateTCPServer</span><span style=" ">&#40;</span><span style="color: #33ffdd;">50000</span><span style=" ">&#41;</span><br />
<span style="color: #aaffff; font-weight: bold;">While</span> <span style="color: #aaffff; font-weight: bold;">Not</span> <span style="color: #aaffff; font-weight: bold;">Keyhit</span><span style=" ">&#40;</span><span style="color: #33ffdd;">1</span><span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; pot=<span style="color: #aaffff; font-weight: bold;">AcceptTCPStream</span><span style=" ">&#40;</span>svr<span style=" ">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">If</span> pot <span style="color: #aaffff; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p.Player=<span style="color: #aaffff; font-weight: bold;">New</span> Player<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p\stream=pot<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Endif</span><br />
</p>
<span style="color: #aaffff; font-weight: bold;">Wend</span></div>
<p>Далее, чтобы получать сообщения не от новых игроков, а от тех, что уже записаны, используем следующую схему:
</p>
<div class="bb" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#225588;color:#FFFFFF;border:1px solid #003040;padding:10px;"><span style="color: #aaffff; font-weight: bold;">For</span> p.Player=<span style="color: #aaffff; font-weight: bold;">Each</span> Player<br />
<p>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">If</span> <span style="color: #aaffff; font-weight: bold;">ReadAvail</span><span style=" ">&#40;</span>p\stream<span style=" ">&#41;</span> <span style="color: #aaffff; font-weight: bold;">Then</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ...<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #aaffff; font-weight: bold;">Endif</span><br />
</p>
<span style="color: #aaffff; font-weight: bold;">Next</span></div>
<p>Думаю, все ясно как пень. Самая сложная часть позади. Теперь давайте о клиенте.
</p><p>Подключается он командой OpenTCPStream. Синтаксис:
</p>
<div class="bb" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#225588;color:#FFFFFF;border:1px solid #003040;padding:10px;">поток=<span style="color: #aaffff; font-weight: bold;">OpenTCPStream</span><span style=" ">&#40;</span>IP_сервера,порт<span style=" ">&#41;</span></div>
<p>Возвращает 0 если неуспешно, и поток  - если успешно. Тут все проще, нежели у сервера. Просто посылаем информацию на этот же поток и все! Для наглядности пример:
</p>
<div class="bb" style="font-family: monospace;background-color:#FFFFFF;border:1px dashed #CCCCCC;padding:10px;background-color:#225588;color:#FFFFFF;border:1px solid #003040;padding:10px;">pot=<span style="color: #aaffff; font-weight: bold;">OpenTCPStream</span><span style=" ">&#40;</span><span style="color: #00ff66;">&quot;prevedmedved.ru&quot;</span>,<span style="color: #33ffdd;">80</span><span style=" ">&#41;</span><br />
<span style="color: #aaffff; font-weight: bold;">WriteLine</span> pot,<span style="color: #00ff66;">&quot;PREVED!&quot;</span></div>
<p>Вот и все! Что еще хотелось бы сказать, так это насчет посылания сообщения другим клиентам. Так вот. ВСЕ передается через сервер. Вот так вот. Если надо послать мэссагу кому-то одному - шлем запрос серверу. Хотим всем - шлем запрос к серверу. И сервер должен все эти запросы отрабатывать. 
</p><p>Вот и закончили  мы долбить второй основной протокол, поддерживаемый блицем. А что это нам дает? Очень многое. Ведь нам открывается дорога к протоколам более высокого уровня. Но об этом в следующих статьях.
</p><p>С Уважением, <a href="http://blitzetcetera.org/index.php/%D0%A3%D1%87%D0%B0%D1%81%D1%82%D0%BD%D0%B8%D0%BA:Tadeus" title="Участник:Tadeus">Волошин Леонид аka Tadeus</a>
</p>
<!-- Saved in parser cache with key db1:pcache:idhash:1739-0!1!0!!ru!2 and timestamp 20071110040828 -->
<div class="printfooter">
Получено с <a href="8ddpqs-d.html">http://blitzetcetera.org/index.php/%D0%A0%D0%B0%D0%B1%D0%BE%D1%82%D0%B0_%D1%81_%D0%A1%D0%B5%D1%82%D1%8C%D1%8E_%D0%B2_Blitz3D:_TCP</a></div>
			<!-- end content -->			<div class="visualClear"></div>				</td>				<td class="rightside">				</td>			</tr>		</table>		</div>	</div>		</div>	
		<script type="text/javascript">if (window.runOnloadHook) runOnloadHook();</script>
</div></body>
<!-- Mirrored from localhost/index.php/%D0%A0%D0%B0%D0%B1%D0%BE%D1%82%D0%B0_%D1%81_%D0%A1%D0%B5%D1%82%D1%8C%D1%8E_%D0%B2_Blitz3D:_TCP by HTTrack Website Copier/3.x [XR&CO'2007], Sat, 10 Nov 2007 05:16:44 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8"><!-- /Added by HTTrack -->
</html>